<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MX Fantasy League</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="relative font-sans min-h-screen text-gray-200">
  <!-- Bakgrund -->
  <div
    class="absolute inset-0 bg-cover bg-center"
    style="background-image: url('{{ url_for("static", filename="images/huvudsida.jpg") }}');"
  ></div>
  <div class="absolute inset-0 bg-black bg-opacity-70"></div>

  <!-- Innehåll -->
  <div class="relative z-10">
    <div class="container mx-auto p-4 md:p-8">
      <!-- Header - Responsiv layout -->
      <div class="mb-6 md:mb-8">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
          <header class="text-center sm:text-left">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-yellow-400">MX Fantasy League</h1>
            <p class="text-base md:text-lg mt-2 text-gray-200">
              Välkommen, <strong>{{ username }}</strong>!
            </p>
          </header>
          
          <!-- Navigation - Responsiv knapplayout -->
          <div class="flex flex-wrap justify-center sm:justify-end gap-2 sm:gap-4">
            {% if username == 'test' %}
            <a
              href="{{ url_for('admin') }}"
              class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-3 sm:px-4 rounded shadow nav-sound text-sm sm:text-base"
            >
              Admin
            </a>
            {% endif %}
            <a
              href="{{ url_for('season_team') }}"
              class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 sm:px-4 rounded shadow nav-sound text-sm sm:text-base"
              >Mina Ligor</a
            >
            <a
              href="{{ url_for('my_scores') }}"
              class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-3 sm:px-4 rounded shadow nav-sound text-sm sm:text-base"
              >Mina Poäng</a
            >
            <a
              href="{{ url_for('logout') }}"
              class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 sm:px-4 rounded shadow nav-sound text-sm sm:text-base"
              >Logga ut</a
            >
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 lg:gap-8 mb-6 md:mb-8">
        <!-- Aktuellt race -->
        <div class="bg-white bg-opacity-90 dark:bg-gray-800 dark:bg-opacity-90 p-4 sm:p-6 rounded-lg shadow-lg">
          {% if upcoming_race %}
          <h2 class="text-xl sm:text-2xl font-bold text-blue-500 mb-2">Aktuellt Race</h2>
          <p class="text-base sm:text-lg font-semibold break-words text-gray-800 dark:text-gray-200">{{ upcoming_race.name }}</p>
          <p class="text-sm sm:text-base text-gray-700 dark:text-gray-300 mb-4">
            {{ upcoming_race.event_date.strftime('%Y-%m-%d') if upcoming_race.event_date else '' }}
          </p>
          <a
            href="{{ url_for('race_picks') }}"
            class="block bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 sm:py-3 px-4 rounded text-center nav-sound text-sm sm:text-base"
            >Dina picks</a
          >
          {% else %}
          <h2 class="text-xl sm:text-2xl font-bold text-blue-500 mb-2">Race Picks</h2>
          <p class="text-gray-600 dark:text-gray-300">Säsongen är över!</p>
          {% endif %}
        </div>

        <!-- Mitt säsongsteam -->
        <div class="bg-white bg-opacity-90 dark:bg-gray-800 dark:bg-opacity-90 p-4 sm:p-6 rounded-lg shadow-lg">
          {% if my_team %}
          <h2 class="text-xl sm:text-2xl font-bold text-green-500 mb-3 sm:mb-4">Mitt Säsongsteam</h2>
          <p class="mb-1 text-sm sm:text-base text-gray-800 dark:text-gray-200 break-words">
            Teamnamn: <strong>{{ my_team.team_name }}</strong>
          </p>
          <p class="font-bold text-base sm:text-lg text-green-600 dark:text-green-400 mb-3 sm:mb-4">
            Totala poäng: {{ my_team.total_points or 0 }}
          </p>

          <!-- Rider-lista med logga, nummer och namn -->
          {% if team_riders and team_riders|length > 0 %}
          <div class="mt-3 sm:mt-4 space-y-1 sm:space-y-2">
            {% for r in team_riders %}
            <div class="flex items-center gap-2 sm:gap-3 bg-gray-900/30 rounded px-2 sm:px-3 py-1.5 sm:py-2">
              {% if r.image_url %}
                <img src="{{ url_for('static', filename=r.image_url) }}"
                     alt="{{ r.name }} headshot"
                     class="w-5 h-5 sm:w-6 sm:h-6 object-cover rounded-full flex-shrink-0" width="24" height="24" />
              {% elif r.bike_brand %}
                <img src="{{ url_for('static', filename='brand_logos/' ~ r.bike_brand ~ '.png') }}"
                     alt="{{ r.bike_brand }} logo"
                     class="w-5 h-5 sm:w-6 sm:h-6 object-contain opacity-90 flex-shrink-0" width="24" height="24" />
              {% else %}
                <div class="w-5 h-5 sm:w-6 sm:h-6 rounded bg-gray-700 flex-shrink-0"></div>
              {% endif %}

              <span class="text-xs sm:text-sm text-gray-300 truncate">
                #{{ r.number }} {{ r.name }}
                <span class="ml-1 sm:ml-2 text-xs text-gray-400">({{ r.class }})</span>
              </span>
            </div>
            {% endfor %}
          </div>

          {% else %}
          <p class="text-xs sm:text-sm text-gray-400 mt-2">Inga förare i teamet ännu.</p>
          {% endif %}

          <a
            href="{{ url_for('season_team') }}"
            class="mt-3 sm:mt-4 block bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded text-center text-sm sm:text-base"
            >Visa mer detaljer</a
          >
          {% else %}
          <h2 class="text-xl sm:text-2xl font-bold text-green-500 mb-2">Inget team än</h2>
          <p class="text-sm sm:text-base text-gray-700 dark:text-gray-300 mb-3 sm:mb-4">
            Bygg ditt drömteam för hela säsongen.
          </p>
          <!-- VIKTIGT: pekar till buildersidan -->
          <a
            href="{{ url_for('season_team_builder') }}"
            class="mt-3 sm:mt-4 block bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-center text-sm sm:text-base"
            >Skapa Team</a
          >
          {% endif %}
        </div>
      </div>

      <!-- Säsongens Leaderboard -->
      <div class="bg-white bg-opacity-90 dark:bg-gray-800 dark:bg-opacity-90 p-4 sm:p-6 rounded-lg shadow-lg mb-6 md:mb-8">
        <div class="flex justify-between items-center mb-3 sm:mb-4">
          <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 dark:text-gray-200">Säsongens Leaderboard</h2>
        </div>
        <div id="season-leaderboard-list" class="space-y-1 sm:space-y-2"></div>
      </div>
    </div>
  </div>

  <!-- Ljudkälla: lägg en fil på static/sfx/moto.mp3 för MC-ljud -->
  <audio id="nav-audio" preload="auto" playsinline>
    <source src="{{ url_for('static', filename='sfx/moto.mp3') }}" type="audio/mpeg">
    <source src="{{ url_for('static', filename='sfx/moto.ogg') }}" type="audio/ogg">
  </audio>

  <script>
    // Litet klickljud vid navigering till t.ex. "Dina picks"
    (function(){
      let ctx = null;
      function getCtx(){
        if (!ctx) {
          const C = window.AudioContext || window.webkitAudioContext;
          if (!C) return null;
          ctx = new C();
        }
        return ctx;
      }
      function playNavSound(durationMs = 350) {
        const el = document.getElementById('nav-audio');
        // 1) Försök spela upp mp3 om den finns
        if (el) {
          try {
            el.volume = 1.0;
            el.currentTime = 0;
            const p = el.play();
            if (p && typeof p.then === 'function') {
              p.catch(() => { /* ignorerar fel */ });
            }
          } catch(_) { /* ignore */ }
        }
        // 2) Spela ALLTID en kort Web Audio‑ton parallellt som säker fallback
        try {
          const ac = getCtx();
          if (ac) {
            if (ac.state === 'suspended') ac.resume();
            const osc = ac.createOscillator();
            const gain = ac.createGain();
            osc.type = 'square';
            osc.frequency.value = 520; // tydligare klick
            gain.gain.setValueAtTime(0.25, ac.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime + 0.25);
            osc.connect(gain); gain.connect(ac.destination);
            osc.start(); osc.stop(ac.currentTime + 0.25);
          }
        } catch(_) { /* ignore */ }
        return durationMs;
      }
      function attachNavSound(){
        document.querySelectorAll('a.nav-sound').forEach(a => {
          a.addEventListener('click', (e) => {
            // Spela ton och fördröj navigationen lite så ljudet hinner höras
            e.preventDefault();
            const d = playNavSound(300);
            const href = a.getAttribute('href');
            setTimeout(() => { window.location.href = href; }, d);
          });
        });
      }
      document.addEventListener('DOMContentLoaded', attachNavSound);
    })();
  </script>

  <script>
    function deltaIcon(d){
      if (d > 0) return `<span class=\"text-green-500\">▲ ${d}</span>`;
      if (d < 0) return `<span class=\"text-red-500\">▼ ${Math.abs(d)}</span>`;
      return `<span class=\"text-gray-400\">•</span>`;
    }

    async function fetchSeasonLeaderboard() {
      const c = document.getElementById("season-leaderboard-list");
        c.innerHTML = '<p class="text-gray-600 dark:text-gray-300">Laddar...</p>';
        try {
          console.log("Fetching leaderboard...");
          const res = await fetch(`/get_season_leaderboard`);
          console.log("Response status:", res.status);
          const leaderboard = await res.json();
          console.log("Leaderboard data:", leaderboard);
          c.innerHTML = "";
          if (leaderboard.length === 0) {
            c.innerHTML = '<p class="text-gray-600 dark:text-gray-300">Inga säsongsteam ännu.</p>';
        } else {
          leaderboard.forEach((row, i) => {
            const el = document.createElement("div");
            el.className =
              "flex flex-col sm:flex-row sm:justify-between sm:items-center bg-gray-100 dark:bg-gray-700 p-2 sm:p-3 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 gap-1 sm:gap-0";
            el.innerHTML = `
              <a class="flex-1 flex items-center gap-2" href="/user/${encodeURIComponent(row.username)}">
                <span class="font-bold w-6 text-right text-sm sm:text-base text-gray-800 dark:text-gray-200">${i + 1}.</span>
                <span class="text-sm sm:text-base truncate text-gray-800 dark:text-gray-200">${row.team_name || "—"} <span class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">/ ${row.username}</span></span>
              </a>
              <span class="flex items-center gap-2 text-sm sm:text-base">
                ${deltaIcon(row.delta)}
                <span class="font-bold text-green-600 dark:text-green-400">${row.total_points} poäng</span>
              </span>`;
            c.appendChild(el);
          });
        }
      } catch (e) {
        console.error("Leaderboard error:", e);
        c.innerHTML = '<p class="text-red-500">Kunde inte hämta leaderboard: ' + e.message + '</p>';
      }
    }
    document.addEventListener("DOMContentLoaded", function() {
      console.log("DOM loaded, fetching leaderboard...");
      fetchSeasonLeaderboard();
    });
  </script>
</body>
</html>