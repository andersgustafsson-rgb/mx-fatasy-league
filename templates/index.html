<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MX Fantasy League</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Suppress Tailwind CDN warning in production
    if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
      console.warn = function() {}; // Suppress console warnings in production
    }
  </script>
  <style>
    /* Countdown Widget Animations */
    #countdown-widget {
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
      animation: pulse-glow 2s ease-in-out infinite alternate;
    }
    
    @keyframes pulse-glow {
      from {
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
      }
      to {
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
      }
    }
    
    #race-countdown, #deadline-countdown {
      text-shadow: 0 0 10px currentColor;
      animation: countdown-pulse 1s ease-in-out infinite alternate;
    }
    
    @keyframes countdown-pulse {
      from {
        text-shadow: 0 0 10px currentColor;
      }
      to {
        text-shadow: 0 0 15px currentColor, 0 0 20px currentColor;
      }
    }
    
    /* Responsive countdown positioning */
    @media (min-width: 1024px) {
      #countdown-widget {
        position: relative;
        transform: scale(1.1);
        z-index: 10;
      }
    }
    
    /* Tab hover effects */
    .tab-btn {
      transition: all 0.3s ease;
    }
    
    .tab-btn:hover {
      transform: translateY(-2px);
    }
    
    .tab-btn.active {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
    }
  </style>
</head>
<body class="relative font-sans min-h-screen text-gray-200">
  <!-- Bakgrund -->
  <div
    class="absolute inset-0 bg-cover bg-center"
    style="background-image: url('{{ url_for("static", filename="images/huvudsida.jpg") }}');"
  ></div>
  <div class="absolute inset-0 bg-black bg-opacity-70"></div>

  <!-- Innehåll -->
  <div class="relative z-10">
    <div class="container mx-auto p-4 md:p-8">
      <!-- Header - Responsiv layout -->
      <div class="mb-6 md:mb-8">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
          <header class="text-center sm:text-left">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-yellow-400">MX Fantasy League</h1>
            <div class="flex items-center gap-3 mt-2">
              {% if user_profile_picture %}
                {% if user_profile_picture.startswith('data:') %}
                  <img src="{{ user_profile_picture }}" 
                       alt="Profilbild" 
                       class="w-8 h-8 rounded-full object-cover border-2 border-yellow-400">
                {% elif user_profile_picture.startswith('uploaded_') %}
                  <div class="w-8 h-8 rounded-full bg-green-600 flex items-center justify-center border-2 border-yellow-400">
                    <span class="text-yellow-400 text-xs">📷</span>
                  </div>
                {% else %}
                  <img src="{{ url_for('static', filename=user_profile_picture) }}" 
                       alt="Profilbild" 
                       class="w-8 h-8 rounded-full object-cover border-2 border-yellow-400"
                       onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                  <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center border-2 border-yellow-400" style="display:none;">
                    <span class="text-yellow-400 text-xs">📷</span>
                  </div>
                {% endif %}
              {% else %}
                <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center border-2 border-yellow-400">
                  <span class="text-yellow-400 text-sm font-bold">{{ username[0].upper() }}</span>
                </div>
              {% endif %}
              <p class="text-base md:text-lg text-gray-200">
                Välkommen, <strong>{{ username }}</strong>!
              </p>
            </div>
          </header>
          
          <!-- Race Countdown Widget -->
          <div id="countdown-widget" class="bg-black bg-opacity-60 rounded-lg p-4 border border-yellow-400 min-w-[280px] sm:min-w-[400px] lg:min-w-[500px]">
            <div class="text-center">
              <h3 class="text-yellow-400 font-bold text-lg sm:text-xl lg:text-2xl mb-3" id="countdown-race-name">Laddar...</h3>
              <div class="grid grid-cols-2 gap-3 sm:gap-4 text-sm sm:text-base lg:text-lg">
                <div class="bg-red-900 bg-opacity-50 rounded-lg p-3 sm:p-4 border border-red-700">
                  <div class="text-red-300 font-semibold text-xs sm:text-sm lg:text-base mb-1">🏁 Race Start</div>
                  <div id="race-countdown" class="text-red-200 font-mono text-lg sm:text-xl lg:text-2xl font-bold">--:--:--</div>
                </div>
                <div class="bg-orange-900 bg-opacity-50 rounded-lg p-3 sm:p-4 border border-orange-700">
                  <div class="text-orange-300 font-semibold text-xs sm:text-sm lg:text-base mb-1">⏰ Pick Deadline</div>
                  <div id="deadline-countdown" class="text-orange-200 font-mono text-lg sm:text-xl lg:text-2xl font-bold">--:--:--</div>
                </div>
              </div>
              <div id="picks-status" class="mt-3 text-xs sm:text-sm">
                <span id="picks-locked-status" class="hidden bg-red-600 text-white px-3 py-2 rounded-lg font-semibold">🔒 Picks låsta</span>
                <span id="picks-open-status" class="hidden bg-green-600 text-white px-3 py-2 rounded-lg font-semibold">✅ Picks öppna</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="mb-6">
          <div class="flex flex-wrap justify-center gap-1 bg-black bg-opacity-40 rounded-lg p-1">
            <button 
              class="tab-btn active px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 bg-yellow-500 text-white"
              data-tab="race-info"
            >
              🏁 Race Info
            </button>
            <button 
              class="tab-btn px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 text-gray-300 hover:text-white hover:bg-gray-700"
              data-tab="leaderboard"
            >
              👥 Leaderboard
            </button>
            <button 
              class="tab-btn px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 text-gray-300 hover:text-white hover:bg-gray-700"
              data-tab="stats"
            >
              📊 Stats
            </button>
            <button 
              class="tab-btn px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 text-gray-300 hover:text-white hover:bg-gray-700"
              data-tab="settings"
            >
              ⚙️ Settings
            </button>
          </div>
        </div>
        
        <!-- Tab Content -->
        <div class="tab-content">
          <!-- Race Info Tab -->
          <div id="race-info" class="tab-panel active">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 lg:gap-8 mb-6 md:mb-8">
              <!-- Quick Actions -->
              <div class="bg-white bg-opacity-90 dark:bg-gray-800 dark:bg-opacity-90 p-4 sm:p-6 rounded-lg shadow-lg">
                <h2 class="text-xl sm:text-2xl font-bold text-blue-500 mb-4">🚀 Snabba Åtgärder</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <a href="{{ url_for('race_picks_page', competition_id=upcoming_race.id) if upcoming_race else '#' }}" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded shadow text-center text-sm">
                    🏁 Race Picks
                  </a>
                  <a href="{{ url_for('season_team_page') }}" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded shadow text-center text-sm">
                    👥 Säsongsteam
                  </a>
                  <a href="{{ url_for('race_results_page') }}" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded shadow text-center text-sm">
                    📊 Race Resultat
                  </a>
                  <a href="{{ url_for('my_scores') }}" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded shadow text-center text-sm">
                    🏆 Mina Poäng
                  </a>
                </div>
              </div>
              
              <!-- Race Info -->
              <div class="bg-white bg-opacity-90 dark:bg-gray-800 dark:bg-opacity-90 p-4 sm:p-6 rounded-lg shadow-lg">
                {% if upcoming_race %}
                <h2 class="text-xl sm:text-2xl font-bold text-blue-500 mb-2">Aktuellt Race</h2>
                <p class="text-base sm:text-lg font-semibold break-words text-gray-800 dark:text-gray-200">{{ upcoming_race.name }}</p>
                <p class="text-sm sm:text-base text-gray-700 dark:text-gray-300 mb-4">
                  {{ upcoming_race.event_date.strftime('%Y-%m-%d') if upcoming_race.event_date else '' }}
                </p>
                
                <!-- Picks Status -->
                {% if picks_status == "has_picks" %}
                  <div class="mb-4">
                    <div class="flex items-center gap-2 mb-3">
                      <span class="text-green-500 text-lg">✅</span>
                      <span class="text-green-600 font-semibold">Dina val är gjorda!</span>
                    </div>
                    
                    <!-- Show picks for both classes (user can always see their own picks) -->
                    <div class="space-y-3 mb-3">
                      <!-- 450cc picks -->
                      {% if current_picks_450 %}
                      <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3">
                        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Dina topp 6 (450cc):</h4>
                        <div class="space-y-1">
                          {% for pick in current_picks_450[:6] %}
                          <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">{{ pick.position }}.</span>
                            <span class="font-medium text-gray-800 dark:text-gray-200">#{{ pick.rider_number }} {{ pick.rider_name }}</span>
                          </div>
                          {% endfor %}
                        </div>
                      </div>
                      {% endif %}
                      
                      <!-- 250cc picks -->
                      {% if current_picks_250 %}
                      <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3">
                        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Dina topp 6 (250cc):</h4>
                        <div class="space-y-1">
                          {% for pick in current_picks_250[:6] %}
                          <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">{{ pick.position }}.</span>
                            <span class="font-medium text-gray-800 dark:text-gray-200">#{{ pick.rider_number }} {{ pick.rider_name }}</span>
                          </div>
                          {% endfor %}
                        </div>
                      </div>
                      {% endif %}
                    </div>
                    
                    <!-- Show deadline status -->
                    {% if picks_locked %}
                      <div class="mt-3 p-2 bg-red-100 dark:bg-red-900 rounded-lg">
                        <p class="text-sm text-red-700 dark:text-red-300">
                          🔒 <strong>Picks låsta!</strong> Andra användares picks visas nu.
                        </p>
                      </div>
                    {% else %}
                      <div class="mt-3 p-2 bg-blue-100 dark:bg-blue-900 rounded-lg">
                        <p class="text-sm text-blue-700 dark:text-blue-300">
                          ⏰ <strong>Picks öppna.</strong> Andra användares picks är dolda tills deadline.
                        </p>
                      </div>
                    {% endif %}
                  </div>
                {% elif picks_status == "no_picks" %}
                  <div class="mb-4">
                    <div class="flex items-center gap-2 mb-3">
                      <span class="text-orange-500 text-lg">⚠️</span>
                      <span class="text-orange-600 font-semibold">Inga val gjorda än</span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                      Gör dina picks innan racet startar!
                    </p>
                  </div>
                {% else %}
                  <div class="mb-4">
                    <div class="flex items-center gap-2 mb-3">
                      <span class="text-blue-500 text-lg">ℹ️</span>
                      <span class="text-blue-600 font-semibold">Laddar picks-status...</span>
                    </div>
                  </div>
                {% endif %}
                {% else %}
                <h2 class="text-xl sm:text-2xl font-bold text-blue-500 mb-2">Inget kommande race</h2>
                <p class="text-gray-600 dark:text-gray-400">Inga races planerade just nu.</p>
                {% endif %}
              </div>
            </div>
          </div>
          
          <!-- Leaderboard Tab -->
          <div id="leaderboard" class="tab-panel hidden">
            <div class="bg-white bg-opacity-90 dark:bg-gray-800 dark:bg-opacity-90 p-4 sm:p-6 rounded-lg shadow-lg mb-6">
              <h2 class="text-xl sm:text-2xl font-bold text-blue-500 mb-4">🏆 Säsong Leaderboard</h2>
              <div id="season-leaderboard-list">
                <p class="text-gray-600 dark:text-gray-300">Laddar...</p>
              </div>
              <div class="mt-4 text-center">
                <a href="{{ url_for('my_scores') }}" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded shadow text-sm">
                  Visa alla poäng
                </a>
              </div>
            </div>
          </div>
          
          <!-- Stats Tab -->
          <div id="stats" class="tab-panel hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 lg:gap-8 mb-6 md:mb-8">
              <div class="bg-white bg-opacity-90 dark:bg-gray-800 dark:bg-opacity-90 p-4 sm:p-6 rounded-lg shadow-lg">
                <h2 class="text-xl sm:text-2xl font-bold text-blue-500 mb-4">📊 Dina Stats</h2>
                <div class="space-y-3">
                  <div class="flex justify-between items-center">
                    <span class="text-gray-600 dark:text-gray-400">Totalt antal poäng:</span>
                    <span class="font-bold text-green-600">-</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-600 dark:text-gray-400">Antal races:</span>
                    <span class="font-bold text-blue-600">-</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-600 dark:text-gray-400">Bästa placering:</span>
                    <span class="font-bold text-yellow-600">-</span>
                  </div>
                </div>
                <div class="mt-4">
                  <a href="{{ url_for('my_scores') }}" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded shadow text-sm w-full text-center block">
                    Visa detaljerade stats
                  </a>
                </div>
              </div>
              
              <div class="bg-white bg-opacity-90 dark:bg-gray-800 dark:bg-opacity-90 p-4 sm:p-6 rounded-lg shadow-lg">
                <h2 class="text-xl sm:text-2xl font-bold text-blue-500 mb-4">👥 Säsongsteam</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-4">
                  Hantera ditt säsongsteam och se hur det presterar.
                </p>
                <div class="space-y-3">
                  <a href="{{ url_for('season_team_page') }}" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow text-sm w-full text-center block">
                    Hantera Säsongsteam
                  </a>
                  <a href="{{ url_for('leagues_page') }}" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded shadow text-sm w-full text-center block">
                    Mina Ligor
                  </a>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Settings Tab -->
          <div id="settings" class="tab-panel hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 lg:gap-8 mb-6 md:mb-8">
              <div class="bg-white bg-opacity-90 dark:bg-gray-800 dark:bg-opacity-90 p-4 sm:p-6 rounded-lg shadow-lg">
                <h2 class="text-xl sm:text-2xl font-bold text-blue-500 mb-4">👤 Profil & Inställningar</h2>
                <div class="space-y-3">
                  <a href="{{ url_for('profile_page') }}" class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded shadow text-sm w-full text-center block">
                    Min Profil
                  </a>
                  <a href="{{ url_for('bulletin_board') }}" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded shadow text-sm w-full text-center block">
                    Anslagstavla
                  </a>
                  <a href="{{ url_for('trackmaps_page') }}" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded shadow text-sm w-full text-center block">
                    Track Maps
                  </a>
                </div>
              </div>
              
              <div class="bg-white bg-opacity-90 dark:bg-gray-800 dark:bg-opacity-90 p-4 sm:p-6 rounded-lg shadow-lg">
                <h2 class="text-xl sm:text-2xl font-bold text-blue-500 mb-4">🔧 Admin & System</h2>
                <div class="space-y-3">
                  {% if username == 'test' %}
                  <a href="{{ url_for('admin_page') }}" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded shadow text-sm w-full text-center block">
                    Admin Panel
                  </a>
                  {% endif %}
                  <a href="{{ url_for('logout') }}" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded shadow text-sm w-full text-center block">
                    Logga ut
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ljudkälla: lägg en fil på static/sfx/moto.mp3 för MC-ljud -->
  <audio id="nav-audio" preload="auto" playsinline>
    <source src="{{ url_for('static', filename='sfx/moto.mp3') }}" type="audio/mpeg">
  </audio>

  <script>
    // Litet klickljud vid navigering till t.ex. "Dina picks"
    (function(){
      let ctx = null;
      function getCtx(){
        if (!ctx) {
          const C = window.AudioContext || window.webkitAudioContext;
          if (!C) return null;
          ctx = new C();
        }
        return ctx;
      }
      function playNavSound(durationMs = 350) {
        const el = document.getElementById('nav-audio');
        // 1) Försök spela upp mp3 om den finns
        if (el) {
          try {
            el.volume = 1.0;
            el.currentTime = 0;
            const p = el.play();
            if (p && typeof p.then === 'function') {
              p.catch(() => { /* ignorerar fel */ });
            }
          } catch(_) { /* ignore */ }
        }
        // 2) Spela ALLTID en kort Web Audio‑ton parallellt som säker fallback
        try {
          const ac = getCtx();
          if (ac) {
            if (ac.state === 'suspended') ac.resume();
            const osc = ac.createOscillator();
            const gain = ac.createGain();
            osc.type = 'square';
            osc.frequency.value = 520; // tydligare klick
            gain.gain.setValueAtTime(0.25, ac.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime + 0.25);
            osc.connect(gain); gain.connect(ac.destination);
            osc.start(); osc.stop(ac.currentTime + 0.25);
          }
        } catch(_) { /* ignore */ }
        return durationMs;
      }
      function attachNavSound(){
        document.querySelectorAll('a.nav-sound').forEach(a => {
          a.addEventListener('click', (e) => {
            console.log('DEBUG: Nav sound click handler triggered for:', a.href);
            // Spela ton och fördröj navigationen lite så ljudet hinner höras
            e.preventDefault();
            const d = playNavSound(300);
            const href = a.getAttribute('href');
            console.log('DEBUG: Navigating to:', href, 'after', d, 'ms');
            setTimeout(() => { 
              console.log('DEBUG: Actually navigating now to:', href);
              window.location.href = href; 
            }, d);
          });
        });
      }
      document.addEventListener('DOMContentLoaded', attachNavSound);
    })();
  </script>

  <script>
    function deltaIcon(d){
      if (d > 0) return `<span class="text-green-500">▲ ${d}</span>`;
      if (d < 0) return `<span class="text-red-500">▼ ${Math.abs(d)}</span>`;
      return `<span class="text-gray-400">•</span>`;
    }

    async function fetchSeasonLeaderboard() {
      const c = document.getElementById("season-leaderboard-list");
      c.innerHTML = '<p class="text-gray-600 dark:text-gray-300">Laddar...</p>';
      try {
        console.log("Fetching leaderboard...");
        const res = await fetch(`/get_season_leaderboard`);
        console.log("Response status:", res.status);
        const leaderboard = await res.json();
        console.log("Leaderboard data:", leaderboard);
        c.innerHTML = "";
        if (leaderboard.length === 0) {
          c.innerHTML = '<p class="text-gray-600 dark:text-gray-300">Inga säsongsteam ännu.</p>';
        } else {
          leaderboard.forEach((row, i) => {
            const el = document.createElement("div");
            el.className = "flex flex-col sm:flex-row sm:justify-between sm:items-center bg-gray-100 dark:bg-gray-700 p-2 sm:p-3 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 gap-1 sm:gap-0";
            el.innerHTML = `
              <a class="flex-1 flex items-center gap-2" href="/profile/${row.user_id}">
                <span class="font-bold w-6 text-right text-sm sm:text-base text-gray-800 dark:text-gray-200">${i + 1}.</span>
                <span class="text-sm sm:text-base truncate text-gray-800 dark:text-gray-200">${row.team_name || "—"} <span class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">/ ${row.username}</span></span>
              </a>
              <span class="flex items-center gap-2 text-sm sm:text-base">
                ${deltaIcon(row.delta)}
                <span class="font-bold text-green-600 dark:text-green-400">${row.total_points} poäng</span>
              </span>`;
            c.appendChild(el);
          });
        }
      } catch (e) {
        console.error("Leaderboard error:", e);
        c.innerHTML = '<p class="text-red-500">Kunde inte hämta leaderboard: ' + e.message + '</p>';
      }
    }
    
    // Race Countdown System
    let countdownInterval;
    
    async function fetchCountdownData() {
      try {
        const response = await fetch('/race_countdown');
        const data = await response.json();
        
        if (data.error) {
          document.getElementById('countdown-race-name').textContent = 'Inga races';
          document.getElementById('race-countdown').textContent = '--:--:--';
          document.getElementById('deadline-countdown').textContent = '--:--:--';
          return;
        }
        
        // Update race name
        document.getElementById('countdown-race-name').textContent = data.next_race.name;
        
        // Update countdowns
        updateCountdowns(data);
        
        // Update picks status
        const lockedStatus = document.getElementById('picks-locked-status');
        const openStatus = document.getElementById('picks-open-status');
        
        if (data.picks_locked) {
          lockedStatus.classList.remove('hidden');
          openStatus.classList.add('hidden');
        } else {
          lockedStatus.classList.add('hidden');
          openStatus.classList.remove('hidden');
        }
        
      } catch (error) {
        console.error('Error fetching countdown data:', error);
        document.getElementById('countdown-race-name').textContent = 'Fel vid laddning';
      }
    }
    
    function updateCountdowns(data) {
      const raceCountdown = data.countdown.race_start;
      const deadlineCountdown = data.countdown.pick_deadline;
      
      // Format time display
      function formatTime(countdown) {
        if (countdown.total_seconds <= 0) {
          return '00:00:00';
        }
        
        const days = countdown.days;
        const hours = countdown.hours;
        const minutes = countdown.minutes;
        const seconds = countdown.seconds;
        
        if (days > 0) {
          return `${days}d ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        } else {
          return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
      }
      
      document.getElementById('race-countdown').textContent = formatTime(raceCountdown);
      document.getElementById('deadline-countdown').textContent = formatTime(deadlineCountdown);
    }
    
    function startCountdown() {
      // Fetch initial data
      fetchCountdownData();
      
      // Update every second
      countdownInterval = setInterval(() => {
        fetchCountdownData();
      }, 1000);
    }
    
    function stopCountdown() {
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
    }
    
    // Tab System
    function initTabs() {
      const tabButtons = document.querySelectorAll('.tab-btn');
      const tabPanels = document.querySelectorAll('.tab-panel');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const targetTab = button.getAttribute('data-tab');
          
          // Remove active class from all buttons and panels
          tabButtons.forEach(btn => {
            btn.classList.remove('active', 'bg-yellow-500', 'text-white');
            btn.classList.add('text-gray-300', 'hover:text-white', 'hover:bg-gray-700');
          });
          
          tabPanels.forEach(panel => {
            panel.classList.add('hidden');
            panel.classList.remove('active');
          });
          
          // Add active class to clicked button and corresponding panel
          button.classList.add('active', 'bg-yellow-500', 'text-white');
          button.classList.remove('text-gray-300', 'hover:text-white', 'hover:bg-gray-700');
          
          const targetPanel = document.getElementById(targetTab);
          if (targetPanel) {
            targetPanel.classList.remove('hidden');
            targetPanel.classList.add('active');
          }
          
          // Load leaderboard data when leaderboard tab is clicked
          if (targetTab === 'leaderboard') {
            fetchSeasonLeaderboard();
          }
        });
      });
    }
    
    document.addEventListener("DOMContentLoaded", function() {
      console.log("DOM loaded, fetching leaderboard...");
      fetchSeasonLeaderboard();
      
      // Start countdown system
      startCountdown();
      
      // Initialize tabs
      initTabs();
    });
    
    // Clean up on page unload
    window.addEventListener('beforeunload', stopCountdown);
  </script>
</body>
</html>