<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MX Fantasy League</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Suppress Tailwind CDN warning in production
    if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
      console.warn = function() {}; // Suppress console warnings in production
    }
  </script>
</head>
<body class="relative font-sans min-h-screen text-gray-200">
  <!-- Bakgrund -->
  <div
    class="absolute inset-0 bg-cover bg-center"
    style="background-image: url('{{ url_for("static", filename="images/huvudsida.jpg") }}');"
  ></div>
  <div class="absolute inset-0 bg-black bg-opacity-70"></div>

  <!-- Inneh√•ll -->
  <div class="relative z-10">
    <div class="container mx-auto p-4 md:p-8">
      <!-- Header - Responsiv layout -->
      <div class="mb-6 md:mb-8">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
          <header class="text-center sm:text-left">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-yellow-400">MX Fantasy League</h1>
            <div class="flex items-center gap-3 mt-2">
              {% if user_profile_picture %}
                {% if user_profile_picture.startswith('data:') %}
                  <img src="{{ user_profile_picture }}" 
                       alt="Profilbild" 
                       class="w-8 h-8 rounded-full object-cover border-2 border-yellow-400">
                {% elif user_profile_picture.startswith('uploaded_') %}
                  <div class="w-8 h-8 rounded-full bg-green-600 flex items-center justify-center border-2 border-yellow-400">
                    <span class="text-yellow-400 text-xs">üì∑</span>
                  </div>
                {% else %}
                  <img src="{{ url_for('static', filename=user_profile_picture) }}" 
                       alt="Profilbild" 
                       class="w-8 h-8 rounded-full object-cover border-2 border-yellow-400"
                       onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                  <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center border-2 border-yellow-400" style="display:none;">
                    <span class="text-yellow-400 text-xs">üì∑</span>
                  </div>
                {% endif %}
              {% else %}
                <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center border-2 border-yellow-400">
                  <span class="text-yellow-400 text-sm font-bold">{{ username[0].upper() }}</span>
                </div>
              {% endif %}
              <p class="text-base md:text-lg text-gray-200">
                V√§lkommen, <strong>{{ username }}</strong>!
              </p>
            </div>
          </header>
          
          <!-- Navigation - Responsiv knapplayout -->
          <div class="flex flex-wrap justify-center sm:justify-end gap-2 sm:gap-4">
            {% if username == 'test' %}
            <a
              href="{{ url_for('admin_page') }}"
              class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-3 sm:px-4 rounded shadow nav-sound text-sm sm:text-base"
            >
              Admin
            </a>
            {% endif %}
            <a
              href="{{ url_for('leagues_page') }}"
              class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 sm:px-4 rounded shadow nav-sound text-sm sm:text-base"
              >Mina Ligor</a
            >
            <a
              href="{{ url_for('my_scores') }}"
              class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-3 sm:px-4 rounded shadow nav-sound text-sm sm:text-base"
              >Mina Po√§ng</a
            >
            <a
              href="{{ url_for('season_team_page') }}"
              class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 sm:px-4 rounded shadow nav-sound text-sm sm:text-base"
              >S√§songsteam</a
            >
            <a
              href="{{ url_for('profile_page') }}"
              class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-3 sm:px-4 rounded shadow nav-sound text-sm sm:text-base"
              onclick="console.log('DEBUG: Profile link clicked, href:', this.href); return true;"
              >Min Profil</a
            >
            <a
              href="{{ url_for('bulletin_board') }}"
              class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-3 sm:px-4 rounded shadow nav-sound text-sm sm:text-base"
              >Anslagstavla</a
            >
        <a
          href="{{ url_for('trackmaps_page') }}"
          class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-3 sm:px-4 rounded shadow nav-sound text-sm sm:text-base"
          >Track Maps</a
        >
        <a
          href="{{ url_for('race_results_page') }}"
          class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 sm:px-4 rounded shadow nav-sound text-sm sm:text-base"
          >Race Results</a
        >
            <a
              href="{{ url_for('logout') }}"
              class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 sm:px-4 rounded shadow nav-sound text-sm sm:text-base"
              >Logga ut</a
            >
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 lg:gap-8 mb-6 md:mb-8">
        <!-- Aktuellt race -->
        <div class="bg-white bg-opacity-90 dark:bg-gray-800 dark:bg-opacity-90 p-4 sm:p-6 rounded-lg shadow-lg">
          {% if upcoming_race %}
          <h2 class="text-xl sm:text-2xl font-bold text-blue-500 mb-2">Aktuellt Race</h2>
          <p class="text-base sm:text-lg font-semibold break-words text-gray-800 dark:text-gray-200">{{ upcoming_race.name }}</p>
          <p class="text-sm sm:text-base text-gray-700 dark:text-gray-300 mb-4">
            {{ upcoming_race.event_date.strftime('%Y-%m-%d') if upcoming_race.event_date else '' }}
          </p>
          
          <!-- Picks Status -->
          {% if picks_status == "has_picks" %}
            <div class="mb-4">
              <div class="flex items-center gap-2 mb-3">
                <span class="text-green-500 text-lg">‚úÖ</span>
                <span class="text-green-600 font-semibold">Dina val √§r gjorda!</span>
              </div>
              
              <!-- Show picks for both classes -->
              <div class="space-y-3 mb-3">
                <!-- 450cc picks -->
                {% if current_picks_450 %}
                <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3">
                  <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Dina topp 6 (450cc):</h4>
                  <div class="space-y-1">
                    {% for pick in current_picks_450[:6] %}
                    <div class="flex items-center justify-between text-sm">
                      <span class="text-gray-600 dark:text-gray-400">{{ pick.position }}.</span>
                      <span class="font-medium text-gray-800 dark:text-gray-200">#{{ pick.rider_number }} {{ pick.rider_name }}</span>
                    </div>
                    {% endfor %}
                  </div>
                </div>
                {% endif %}
                
                <!-- 250cc picks -->
                {% if current_picks_250 %}
                <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3">
                  <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Dina topp 6 (250cc):</h4>
                  <div class="space-y-1">
                    {% for pick in current_picks_250[:6] %}
                    <div class="flex items-center justify-between text-sm">
                      <span class="text-gray-600 dark:text-gray-400">{{ pick.position }}.</span>
                      <span class="font-medium text-gray-800 dark:text-gray-200">#{{ pick.rider_number }} {{ pick.rider_name }}</span>
                    </div>
                    {% endfor %}
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
          {% else %}
            <div class="mb-4">
              <div class="flex items-center gap-2 mb-3">
                <span class="text-orange-500 text-lg">‚ö†Ô∏è</span>
                <span class="text-orange-600 font-semibold">Inga val gjorda √§n</span>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-400">G√∂r dina picks f√∂r topp 6, holeshot och wildcard!</p>
            </div>
          {% endif %}
          
          <a
            href="{{ url_for('race_picks_page', competition_id=upcoming_race.id) if upcoming_race else '#' }}"
            class="block bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 sm:py-3 px-4 rounded text-center nav-sound text-sm sm:text-base"
            >{% if picks_status == "has_picks" %}Uppdatera picks{% else %}G√∂r dina picks{% endif %}</a
          >
          {% else %}
          <h2 class="text-xl sm:text-2xl font-bold text-blue-500 mb-2">Race Picks</h2>
          <p class="text-gray-600 dark:text-gray-300">S√§songen √§r √∂ver!</p>
          {% endif %}
        </div>

        <!-- Mitt s√§songsteam -->
        <div class="bg-white bg-opacity-90 dark:bg-gray-800 dark:bg-opacity-90 p-4 sm:p-6 rounded-lg shadow-lg">
          {% if my_team %}
          <h2 class="text-xl sm:text-2xl font-bold text-green-500 mb-3 sm:mb-4">Mitt S√§songsteam</h2>
          <p class="mb-1 text-sm sm:text-base text-gray-800 dark:text-gray-200 break-words">
            Teamnamn: <strong>{{ my_team.team_name }}</strong>
          </p>
          <p class="font-bold text-base sm:text-lg text-green-600 dark:text-green-400 mb-3 sm:mb-4">
            Totala po√§ng: {{ my_team.total_points or 0 }}
          </p>

          <!-- Rider-lista med logga, nummer och namn -->
          {% if team_riders and team_riders|length > 0 %}
          <div class="mt-3 sm:mt-4 space-y-1 sm:space-y-2">
            {% for r in team_riders %}
            <div class="flex items-center gap-2 sm:gap-3 bg-gray-900/30 rounded px-2 sm:px-3 py-1.5 sm:py-2">
              {% if r.image_url %}
                <img src="{{ url_for('static', filename=r.image_url) }}"
                     alt="{{ r.name }} headshot"
                     class="w-7 h-7 sm:w-8 sm:h-8 object-cover rounded-full flex-shrink-0" width="32" height="32" />
              {% elif r.bike_brand %}
                <img src="{{ url_for('static', filename='brand_logos/' ~ r.bike_brand ~ '.png') }}"
                     alt="{{ r.bike_brand }} logo"
                     class="w-7 h-7 sm:w-8 sm:h-8 object-contain opacity-90 flex-shrink-0" width="32" height="32" />
              {% else %}
                <div class="w-7 h-7 sm:w-8 sm:h-8 rounded bg-gray-700 flex-shrink-0"></div>
              {% endif %}

              <span class="text-xs sm:text-sm text-gray-300 truncate">
                #{{ r.number }} {{ r.name }}
                <span class="ml-1 sm:ml-2 text-xs text-gray-400">({{ r.class }})</span>
              </span>
            </div>
            {% endfor %}
          </div>

          {% else %}
          <p class="text-xs sm:text-sm text-gray-400 mt-2">Inga f√∂rare i teamet √§nnu.</p>
          {% endif %}

          <a
            href="{{ url_for('season_team_page') }}"
            class="mt-3 sm:mt-4 block bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded text-center text-sm sm:text-base"
            >Visa mer detaljer</a
          >
          {% else %}
          <h2 class="text-xl sm:text-2xl font-bold text-green-500 mb-2">Inget team √§n</h2>
          <p class="text-sm sm:text-base text-gray-700 dark:text-gray-300 mb-3 sm:mb-4">
            Bygg ditt dr√∂mteam f√∂r hela s√§songen.
          </p>
          <!-- VIKTIGT: pekar till buildersidan -->
          <a
            href="{{ url_for('season_team_builder') }}"
            class="mt-3 sm:mt-4 block bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-center text-sm sm:text-base"
            >Skapa Team</a
          >
          {% endif %}
        </div>
      </div>

      <!-- S√§songens Leaderboard -->
      <div class="bg-white bg-opacity-90 dark:bg-gray-800 dark:bg-opacity-90 p-4 sm:p-6 rounded-lg shadow-lg mb-6 md:mb-8">
        <div class="flex justify-between items-center mb-3 sm:mb-4">
          <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 dark:text-gray-200">S√§songens Leaderboard</h2>
        </div>
        <div id="season-leaderboard-list" class="space-y-1 sm:space-y-2"></div>
      </div>
    </div>
  </div>

  <!-- Ljudk√§lla: l√§gg en fil p√• static/sfx/moto.mp3 f√∂r MC-ljud -->
  <audio id="nav-audio" preload="auto" playsinline>
    <source src="{{ url_for('static', filename='sfx/moto.mp3') }}" type="audio/mpeg">
  </audio>

  <script>
    // Litet klickljud vid navigering till t.ex. "Dina picks"
    (function(){
      let ctx = null;
      function getCtx(){
        if (!ctx) {
          const C = window.AudioContext || window.webkitAudioContext;
          if (!C) return null;
          ctx = new C();
        }
        return ctx;
      }
      function playNavSound(durationMs = 350) {
        const el = document.getElementById('nav-audio');
        // 1) F√∂rs√∂k spela upp mp3 om den finns
        if (el) {
          try {
            el.volume = 1.0;
            el.currentTime = 0;
            const p = el.play();
            if (p && typeof p.then === 'function') {
              p.catch(() => { /* ignorerar fel */ });
            }
          } catch(_) { /* ignore */ }
        }
        // 2) Spela ALLTID en kort Web Audio‚Äëton parallellt som s√§ker fallback
        try {
          const ac = getCtx();
          if (ac) {
            if (ac.state === 'suspended') ac.resume();
            const osc = ac.createOscillator();
            const gain = ac.createGain();
            osc.type = 'square';
            osc.frequency.value = 520; // tydligare klick
            gain.gain.setValueAtTime(0.25, ac.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime + 0.25);
            osc.connect(gain); gain.connect(ac.destination);
            osc.start(); osc.stop(ac.currentTime + 0.25);
          }
        } catch(_) { /* ignore */ }
        return durationMs;
      }
      function attachNavSound(){
        document.querySelectorAll('a.nav-sound').forEach(a => {
          a.addEventListener('click', (e) => {
            console.log('DEBUG: Nav sound click handler triggered for:', a.href);
            // Spela ton och f√∂rdr√∂j navigationen lite s√• ljudet hinner h√∂ras
            e.preventDefault();
            const d = playNavSound(300);
            const href = a.getAttribute('href');
            console.log('DEBUG: Navigating to:', href, 'after', d, 'ms');
            setTimeout(() => { 
              console.log('DEBUG: Actually navigating now to:', href);
              window.location.href = href; 
            }, d);
          });
        });
      }
      document.addEventListener('DOMContentLoaded', attachNavSound);
    })();
  </script>

  <script>
    function deltaIcon(d){
      if (d > 0) return `<span class="text-green-500">‚ñ≤ ${d}</span>`;
      if (d < 0) return `<span class="text-red-500">‚ñº ${Math.abs(d)}</span>`;
      return `<span class="text-gray-400">‚Ä¢</span>`;
    }

    async function fetchSeasonLeaderboard() {
      const c = document.getElementById("season-leaderboard-list");
      c.innerHTML = '<p class="text-gray-600 dark:text-gray-300">Laddar...</p>';
      try {
        console.log("Fetching leaderboard...");
        const res = await fetch(`/get_season_leaderboard`);
        console.log("Response status:", res.status);
        const leaderboard = await res.json();
        console.log("Leaderboard data:", leaderboard);
        c.innerHTML = "";
        if (leaderboard.length === 0) {
          c.innerHTML = '<p class="text-gray-600 dark:text-gray-300">Inga s√§songsteam √§nnu.</p>';
        } else {
          leaderboard.forEach((row, i) => {
            const el = document.createElement("div");
            el.className = "flex flex-col sm:flex-row sm:justify-between sm:items-center bg-gray-100 dark:bg-gray-700 p-2 sm:p-3 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 gap-1 sm:gap-0";
            el.innerHTML = `
              <a class="flex-1 flex items-center gap-2" href="/profile/${row.user_id}">
                <span class="font-bold w-6 text-right text-sm sm:text-base text-gray-800 dark:text-gray-200">${i + 1}.</span>
                <span class="text-sm sm:text-base truncate text-gray-800 dark:text-gray-200">${row.team_name || "‚Äî"} <span class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">/ ${row.username}</span></span>
              </a>
              <span class="flex items-center gap-2 text-sm sm:text-base">
                ${deltaIcon(row.delta)}
                <span class="font-bold text-green-600 dark:text-green-400">${row.total_points} po√§ng</span>
              </span>`;
            c.appendChild(el);
          });
        }
      } catch (e) {
        console.error("Leaderboard error:", e);
        c.innerHTML = '<p class="text-red-500">Kunde inte h√§mta leaderboard: ' + e.message + '</p>';
      }
    }
    
    document.addEventListener("DOMContentLoaded", function() {
      console.log("DOM loaded, fetching leaderboard...");
      fetchSeasonLeaderboard();
    });
  </script>
</body>
</html>