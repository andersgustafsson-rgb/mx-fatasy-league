<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mina Poäng - MX Fantasy League</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-200 font-sans min-h-screen">
  <div class="container mx-auto p-4 md:p-8">
    
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-4xl font-bold text-blue-500">Poänghistorik</h1>
      <a href="{{ url_for('index') }}" 
         class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
        ⬅ Tillbaka
      </a>
    </div>

    {% if scores %}
      <!-- Resultattabell -->
      <div class="overflow-x-auto">
        <table class="w-full border-collapse bg-white dark:bg-gray-800 shadow-lg rounded">
          <thead class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
            <tr>
              <th class="p-2 text-left">Datum</th>
              <th class="p-2 text-left">Tävling</th>
              <th class="p-2">Serie</th>
              <th class="p-2 text-right">Poäng</th>
            </tr>
          </thead>
          <tbody>
            {% for row in scores %}
            <tr onclick="showDetails({{ row['competition_id'] }})"
                class="cursor-pointer border-t border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700">
              <td class="p-2">{{ row.event_date }}</td>
              <td class="p-2">{{ row.name }}</td>
              <td class="p-2 text-center">{{ row.series }}</td>
              <td class="p-2 text-right font-bold 
                         {% if row.total_points > 0 %} text-green-500 
                         {% else %} text-gray-400 {% endif %}">
                {{ row.total_points }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot class="bg-gray-100 dark:bg-gray-700">
            <tr>
              <td colspan="3" class="p-2 text-right font-bold">Totalt</td>
              <td class="p-2 text-right font-bold text-green-500">{{ total_points }}</td>
            </tr>
          </tfoot>
        </table>
      </div>
    {% else %}
      <!-- Ingen data -->
      <p class="text-gray-400 text-center">
        Inga racepoäng registrerade ännu.<br>
        <a href="{{ url_for('index') }}" class="text-blue-500 hover:underline">
          Gör dina picks inför nästa race!
        </a>
      </p>
    {% endif %}
  </div>

  <!-- Modal för detaljvy -->
  <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded shadow-lg max-w-lg w-full">
      <h3 class="text-xl font-bold mb-4">Detaljerad poäng</h3>
      <ul id="detail-list" class="space-y-1 mb-4 text-sm text-gray-800 dark:text-gray-200"></ul>
      <button onclick="closeModal()" class="bg-red-600 text-white px-4 py-2 rounded">Stäng</button>
    </div>
  </div>

  <script>
    async function showDetails(compId){
      try{
        const res = await fetch(`/get_my_race_results/${compId}`);
        const data = await res.json();
        const ul=document.getElementById("detail-list");
        ul.innerHTML="";
        data.breakdown.forEach(item=>{
          const li=document.createElement("li");
          li.textContent=item;
          // färgsättning
          if(item.startsWith("✅")) li.className="text-green-600";
          if(item.startsWith("❌")) li.className="text-red-500";
          if(item.startsWith("⚠")) li.className="text-yellow-500";
          ul.appendChild(li);
        });
        // Visa totalpoäng
        const total=document.createElement("li");
        total.className="font-bold mt-2";
        total.textContent="Totalt: "+data.total+"p";
        ul.appendChild(total);

        document.getElementById("detail-modal").classList.remove("hidden");
        document.getElementById("detail-modal").classList.add("flex");
      }catch(e){
        alert("Kunde inte hämta detaljer");
      }
    }

    function closeModal(){
      const m=document.getElementById("detail-modal");
      m.classList.add("hidden");
      m.classList.remove("flex");
    }
  </script>
</body>
</html>