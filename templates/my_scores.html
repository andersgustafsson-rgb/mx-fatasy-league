<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mina Po√§ng - MX Fantasy League</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-200 font-sans min-h-screen">
  <div class="container mx-auto p-4 md:p-8">
    
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-4xl font-bold text-blue-500">
        {% if viewing_user %}
          Po√§nghistorik - {{ viewing_user }}
        {% else %}
          Po√§nghistorik
        {% endif %}
      </h1>
      <a href="{% if viewing_user %}{{ url_for('user_stats_page', username=viewing_user) }}{% else %}{{ url_for('index') }}{% endif %}" 
         class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
        ‚¨Ö Tillbaka
      </a>
    </div>

    {% if scores %}
      <!-- Info text -->
      <div class="bg-blue-100 dark:bg-blue-900 border border-blue-300 dark:border-blue-700 rounded-lg p-3 mb-4">
        <p class="text-sm text-blue-800 dark:text-blue-200">
          üí° <strong>Tips:</strong> Klicka p√• en t√§vling f√∂r att se detaljerad po√§ngf√∂rdelning - vilka f√∂rare du fick po√§ng p√•, f√∂rv√§ntad vs faktisk position, och mer.
        </p>
      </div>
      
      <!-- Resultattabell -->
      <div class="overflow-x-auto">
        <table class="w-full border-collapse bg-white dark:bg-gray-800 shadow-lg rounded">
          <thead class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
            <tr>
              <th class="p-2 text-left">Datum</th>
              <th class="p-2 text-left">T√§vling</th>
              <th class="p-2">Serie</th>
              <th class="p-2 text-center">Status</th>
              <th class="p-2 text-right">Po√§ng</th>
            </tr>
          </thead>
          <tbody>
            {% for row in scores %}
            <tr onclick="showDetails({{ row['competition_id'] }})"
                class="cursor-pointer border-t border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors group">
              <td class="p-2">{{ row.event_date }}</td>
              <td class="p-2">
                <div class="flex items-center gap-2">
                  <span>{{ row.name }}</span>
                  {% if row.has_results %}
                  <span class="text-xs text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-400">üëÜ Klicka f√∂r detaljer</span>
                  {% endif %}
                </div>
              </td>
              <td class="p-2 text-center">{{ row.series }}</td>
              <td class="p-2 text-center">
                {% if row.has_results %}
                  <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                    ‚úÖ K√∂rt
                  </span>
                {% else %}
                  <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">
                    ‚è≥ V√§ntar
                  </span>
                {% endif %}
              </td>
              <td class="p-2 text-right font-bold 
                         {% if row.has_results and row.total_points > 0 %} text-green-500 
                         {% elif row.has_results and row.total_points == 0 %} text-red-500 
                         {% else %} text-gray-400 {% endif %}">
                {{ row.total_points }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot class="bg-gray-100 dark:bg-gray-700">
            <tr>
              <td colspan="4" class="p-2 text-right font-bold">Totalt</td>
              <td class="p-2 text-right font-bold text-green-500">{{ total_points }}</td>
            </tr>
          </tfoot>
        </table>
      </div>
    {% else %}
      <!-- Ingen data -->
      <p class="text-gray-400 text-center">
        Inga racepo√§ng registrerade √§nnu.<br>
        <a href="{{ url_for('index') }}" class="text-blue-500 hover:underline">
          G√∂r dina picks inf√∂r n√§sta race!
        </a>
      </p>
    {% endif %}
  </div>

  <!-- Modal f√∂r detaljvy -->
  <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-4 rounded shadow-lg max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col">
      <h3 class="text-lg font-bold mb-3">Detaljerad po√§ng</h3>
      <ul id="detail-list" class="space-y-1 mb-3 text-xs text-gray-800 dark:text-gray-200 overflow-y-auto flex-1"></ul>
      <button onclick="closeModal()" class="bg-red-600 text-white px-4 py-2 rounded text-sm">St√§ng</button>
    </div>
  </div>

  <script>
    const viewingUser = {% if viewing_user %}'{{ viewing_user }}'{% else %}null{% endif %};
    
    async function showDetails(compId){
      try{
        const url = viewingUser 
          ? `/get_user_race_results/${viewingUser}/${compId}`
          : `/get_my_race_results/${compId}`;
        const res = await fetch(url);
        const data = await res.json();
        const ul=document.getElementById("detail-list");
        ul.innerHTML="";
        data.breakdown.forEach(item=>{
          const li=document.createElement("li");
          li.className = "flex items-center gap-2 py-2 border-b border-gray-200 dark:border-gray-700";
          
          // Parse structured format: icon|TYPE|rider|predicted|actual|points
          if (item.includes("|") && item.split("|").length >= 6) {
            const parts = item.split("|");
            const icon = parts[0];
            const type = parts[1];
            const rider = parts[2];
            const predicted = parts[3];
            const actual = parts[4];
            const points = parts[5];
            
            // Icon
            const iconSpan = document.createElement("span");
            iconSpan.textContent = icon;
            iconSpan.className = "text-base flex-shrink-0";
            li.appendChild(iconSpan);
            
            // Rider name
            const riderSpan = document.createElement("span");
            riderSpan.textContent = rider;
            riderSpan.className = "font-semibold flex-1 text-gray-800 dark:text-white min-w-0 truncate";
            li.appendChild(riderSpan);
            
            // Position badges
            const posContainer = document.createElement("div");
            posContainer.className = "flex items-center gap-1 flex-shrink-0";
            
            const predBadge = document.createElement("span");
            predBadge.textContent = `F√∂rv: ${predicted}`;
            predBadge.className = "px-1.5 py-0.5 rounded text-xs font-medium bg-blue-200 text-blue-900 dark:bg-blue-800 dark:text-blue-100 whitespace-nowrap";
            posContainer.appendChild(predBadge);
            
            const arrow = document.createElement("span");
            arrow.textContent = "‚Üí";
            arrow.className = "text-gray-500 text-xs";
            posContainer.appendChild(arrow);
            
            const actualBadge = document.createElement("span");
            actualBadge.textContent = `Fakt: ${actual}`;
            if (predicted === actual) {
              // Perfekt match - skarp gr√∂n
              actualBadge.className = "px-1.5 py-0.5 rounded text-xs font-medium bg-green-400 text-green-900 dark:bg-green-600 dark:text-white whitespace-nowrap font-bold";
            } else if (parseInt(actual) <= 6) {
              // Top6 - skarp gul
              actualBadge.className = "px-1.5 py-0.5 rounded text-xs font-medium bg-yellow-400 text-yellow-900 dark:bg-yellow-600 dark:text-white whitespace-nowrap font-bold";
            } else {
              // Miss - skarp r√∂d
              actualBadge.className = "px-1.5 py-0.5 rounded text-xs font-medium bg-red-400 text-red-900 dark:bg-red-600 dark:text-white whitespace-nowrap font-bold";
            }
            posContainer.appendChild(actualBadge);
            
            li.appendChild(posContainer);
            
            // Points
            if (points !== "0") {
              const pointsSpan = document.createElement("span");
              pointsSpan.textContent = points;
              pointsSpan.className = "font-bold text-green-600 dark:text-green-400 ml-auto flex-shrink-0";
              li.appendChild(pointsSpan);
            }
            
            // Color based on type
            if (type === "PERFEKT") li.classList.add("bg-green-50", "dark:bg-green-900/20");
            else if (type === "TOP6") li.classList.add("bg-orange-50", "dark:bg-orange-900/20");
            else if (type === "MISS") li.classList.add("bg-red-50", "dark:bg-red-900/20");
          } else {
            // Fallback for non-structured items (holeshot, wildcard, etc.)
            li.textContent = item;
            if(item.startsWith("‚úÖ")) li.className += " text-green-600 dark:text-green-400";
            else if(item.startsWith("‚ùå")) li.className += " text-red-500 dark:text-red-400";
            else if(item.startsWith("‚ñ≤") || item.startsWith("‚ö†")) li.className += " text-orange-500 dark:text-orange-400";
            else if(item.startsWith("üéØ")) li.className += " text-yellow-600 dark:text-yellow-400 font-bold";
          }
          
          ul.appendChild(li);
        });
        // Visa totalpo√§ng
        const total=document.createElement("li");
        total.className="font-bold mt-2";
        total.textContent="Totalt: "+data.total+"p";
        ul.appendChild(total);

        document.getElementById("detail-modal").classList.remove("hidden");
        document.getElementById("detail-modal").classList.add("flex");
      }catch(e){
        alert("Kunde inte h√§mta detaljer");
      }
    }

    function closeModal(){
      const m=document.getElementById("detail-modal");
      m.classList.add("hidden");
      m.classList.remove("flex");
    }
  </script>
</body>
</html>