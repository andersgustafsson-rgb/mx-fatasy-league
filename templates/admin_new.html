<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - MX Fantasy League</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            background-attachment: fixed;
        }
        
        .cyberpunk-header {
            font-family: 'Orbitron', monospace;
            text-shadow: 0 0 10px rgba(34, 211, 238, 0.8);
        }
        
        .tab-btn {
            @apply px-4 py-2 text-sm font-medium border-b-2 border-transparent transition-all duration-300;
            color: #94a3b8;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 500;
        }
        .tab-btn:hover {
            color: #22d3ee;
            border-color: #22d3ee;
            text-shadow: 0 0 8px rgba(34, 211, 238, 0.6);
        }
        .tab-btn.active {
            color: #22d3ee;
            border-color: #22d3ee;
            text-shadow: 0 0 10px rgba(34, 211, 238, 0.8);
            box-shadow: 0 2px 0 rgba(34, 211, 238, 0.3);
        }
        .tab-panel {
            @apply hidden;
        }
        .tab-panel.active {
            @apply block;
        }
        
        .cyberpunk-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 2px solid #22d3ee;
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.3);
        }
        
        .cyberpunk-button {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 2px solid #22d3ee;
            color: #22d3ee;
            box-shadow: 0 0 10px rgba(34, 211, 238, 0.3);
            transition: all 0.3s ease;
        }
        
        .cyberpunk-button:hover {
            background: linear-gradient(135deg, #22d3ee 0%, #0891b2 100%);
            color: #0f172a;
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.6);
            text-shadow: none;
        }
        
        .neon-text {
            text-shadow: 0 0 10px rgba(34, 211, 238, 0.8);
        }
        
        .neon-input {
            background: #0f172a;
            border: 2px solid #22d3ee;
            color: #e2e8f0;
            box-shadow: 0 0 10px rgba(34, 211, 238, 0.2);
        }
        
        .neon-input:focus {
            box-shadow: 0 0 15px rgba(34, 211, 238, 0.4);
            outline: none;
        }
        
        .neon-select {
            background: #0f172a;
            border: 2px solid #22d3ee;
            color: #e2e8f0;
            box-shadow: 0 0 10px rgba(34, 211, 238, 0.2);
        }
        
        .neon-textarea {
            background: #0f172a;
            border: 2px solid #22d3ee;
            color: #e2e8f0;
            box-shadow: 0 0 10px rgba(34, 211, 238, 0.2);
        }
        
        .neon-textarea:focus {
            box-shadow: 0 0 15px rgba(34, 211, 238, 0.4);
            outline: none;
        }
        
        .cyberpunk-table {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 2px solid #22d3ee;
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.3);
        }
        
        .cyberpunk-table th {
            background: linear-gradient(135deg, #22d3ee 0%, #0891b2 100%);
            color: #0f172a;
            font-weight: 600;
            text-shadow: none;
        }
        
        .cyberpunk-table td {
            border-color: #22d3ee;
            color: #e2e8f0;
        }
        
        .cyberpunk-table tr:hover {
            background: rgba(34, 211, 238, 0.1);
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="cyberpunk-card rounded-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold cyberpunk-header text-cyan-400 mb-2">‚ö° ADMIN PANEL ‚ö°</h1>
                    <p class="text-cyan-300 neon-text">Hantera t√§vlingar, anv√§ndare och systeminst√§llningar</p>
                </div>
                <div>
                    <a href="{{ url_for('index') }}" class="cyberpunk-button font-medium py-2 px-4 rounded-lg">
                        üè† Till huvudsidan
                    </a>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="cyberpunk-card rounded-lg mb-6">
            <!-- Admin Sections Header -->
            <div class="border-b border-cyan-400 px-6 py-4">
                <h2 class="text-xl font-bold text-cyan-400 neon-text">Admin Panel - Kollapsbara Sektioner</h2>
                <p class="text-gray-400 text-sm mt-1">Klicka p√• sektioner f√∂r att expandera/kollapsa</p>
            </div>
        </div>

        <!-- Admin Sections -->
        <div class="space-y-6">
            <!-- T√§vlingssimulering Section -->
            <div class="cyberpunk-card rounded-lg">
                <button onclick="toggleSection('race-simulation')" class="w-full bg-gray-800 hover:bg-gray-700 text-white px-6 py-4 rounded-t-lg border-b border-gray-600 flex justify-between items-center">
                    <span class="text-xl font-medium">üèÅ T√§vlingssimulering</span>
                    <span id="race-simulation-toggle">‚ñº</span>
                </button>
                
                <div id="race-simulation-section" class="hidden p-6">
                    
                    <!-- Simulated Date Section -->
                    <div class="mb-6 p-4 bg-gray-800 border-l-4 border-cyan-400 rounded-r-lg" style="box-shadow: 0 0 15px rgba(34, 211, 238, 0.2);">
                        <h3 class="text-lg font-medium text-cyan-400 neon-text mb-3">üìÖ Simulerat Datum</h3>
                        <p class="text-sm text-cyan-300 mb-3">
                            S√§tt ett simulerat datum (YYYY-MM-DD) f√∂r att styra vilket race som anses vara "n√§sta/aktuellt".
                        </p>
                        
                        <form action="/admin/set_sim_date" method="POST" class="flex flex-col sm:flex-row gap-3">
                            <input type="text" name="sim_date" placeholder="2026-01-17" 
                                   class="flex-1 px-3 py-2 neon-input rounded-md">
                            <button type="submit" class="cyberpunk-button px-4 py-2 rounded-md">
                                S√§tt Datum
                            </button>
                            <button type="submit" name="sim_date" value="" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md border border-gray-500">
                                Rensa
                            </button>
                        </form>
                        
                        <div class="mt-3 p-2 bg-gray-800 border border-cyan-400 rounded" style="box-shadow: 0 0 10px rgba(34, 211, 238, 0.2);">
                            <span class="text-sm font-medium text-cyan-400">Aktuellt simulerat datum: </span>
                            <span id="current-sim-date" class="font-bold text-cyan-300 neon-text">{{ today if today else 'Idag' }}</span>
                        </div>
                    </div>

                    <!-- Competition Selection -->
                    <div class="mb-6">
                        <h3 class="text-lg font-medium text-cyan-400 neon-text mb-3">üèÜ V√§lj T√§vling</h3>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <select id="competition-select" class="flex-1 px-3 py-2 neon-select rounded-md">
                                <option value="">-- V√§lj t√§vling --</option>
                            </select>
                            <button onclick="simulateForSelected()" class="cyberpunk-button px-4 py-2 rounded-md">
                                ‚öôÔ∏è Simulera
                            </button>
                            <button onclick="clearCurrentCompetitionResults()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md border border-red-500">
                                üóëÔ∏è Rensa
                            </button>
                            <button onclick="syncWithHomepage()" class="cyberpunk-button px-4 py-2 rounded-md">
                                üîÑ Synka med huvudsida
                            </button>
                        </div>
                        
                        <div id="selected-competition-info" class="mt-3 p-3 bg-gray-800 border-l-4 border-cyan-400 rounded-r-lg" style="display: none; box-shadow: 0 0 10px rgba(34, 211, 238, 0.2);">
                            <span class="text-sm font-medium text-cyan-400">Aktuell t√§vling: </span>
                            <span id="selected-competition-name" class="font-bold text-cyan-300 neon-text"></span>
                        </div>
                    </div>

                    <!-- Results Form -->
                    <div class="mb-6">
                        <button type="button" onclick="toggleRaceResults()" class="w-full cyberpunk-button font-bold py-3 px-4 rounded-lg text-lg flex items-center justify-between">
                            <span>üèÅ Race Results & Holeshot</span>
                            <span id="race-results-toggle">‚ñº</span>
                        </button>
                    </div>

                    <div id="race-results-section" class="hidden">
                        <form method="POST" action="/admin/submit_results" onsubmit="return validateResults()" onsubmit="return submitResultsAndReload()">
                            <input type="hidden" id="competition_id_hidden" name="competition_id" value="">
                            
                            <!-- Holeshot Winners -->
                            <div class="mb-6 p-4 bg-gray-800 border-l-4 border-cyan-400 rounded-r-lg" style="box-shadow: 0 0 15px rgba(34, 211, 238, 0.2);">
                                <h3 class="text-lg font-medium text-cyan-400 neon-text mb-3">üèÅ Holeshot Vinnare</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-cyan-300 mb-2">450cc:</label>
                                    <select name="holeshot_450" id="holeshot_450" class="w-full px-3 py-2 neon-select rounded-md">
                                        <option value="">-- V√§lj f√∂rare --</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-cyan-300 mb-2">250cc:</label>
                                    <select name="holeshot_250" id="holeshot_250" class="w-full px-3 py-2 neon-select rounded-md">
                                        <option value="">-- V√§lj f√∂rare --</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Race Results -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-lg font-medium text-cyan-400 neon-text mb-3">450cc Resultat (Top 20)</h3>
                                <div id="results-container-450" class="space-y-2">
                                    <div class="p-4 bg-gray-800 border border-cyan-400 rounded-lg text-center text-cyan-300" style="box-shadow: 0 0 10px rgba(34, 211, 238, 0.2);">
                                        V√§lj en t√§vling ovan f√∂r att l√§gga in resultat
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium text-cyan-400 neon-text mb-3">250cc Resultat (Top 6)</h3>
                                <div id="results-container-250" class="space-y-2">
                                    <div class="p-4 bg-gray-800 border border-cyan-400 rounded-lg text-center text-cyan-300" style="box-shadow: 0 0 10px rgba(34, 211, 238, 0.2);">
                                        V√§lj en t√§vling ovan f√∂r att l√§gga in resultat
                                    </div>
                                </div>
                            </div>
                        </div>

                            <div class="mt-6">
                                <button type="submit" class="w-full cyberpunk-button px-4 py-3 rounded-md font-medium">
                                    ‚úÖ Spara Resultat & R√§kna Po√§ng
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- OUT-status hantering -->
                    <div class="mt-8 p-4 bg-gray-800 border-l-4 border-cyan-400 rounded-r-lg" style="box-shadow: 0 0 15px rgba(34, 211, 238, 0.2);">
                        <h3 class="text-lg font-medium text-cyan-400 neon-text mb-3">üö´ OUT-status (skador/sjukdom)</h3>
                        <div class="flex flex-col sm:flex-row gap-3 mb-4">
                            <button type="button" onclick="loadOutList()" 
                                    class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md">
                                Ladda lista
                            </button>
                            <button type="button" onclick="saveAllOutStatus()" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">
                                Spara alla √§ndringar
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <div>
                                <h4 class="text-md font-medium text-gray-700 mb-2">450cc OUT-status</h4>
                                <div id="out-list-450" class="space-y-2 max-h-60 overflow-y-auto">
                                    <!-- OUT checkboxes will be populated here -->
                                </div>
                            </div>
                            <div>
                                <h4 class="text-md font-medium text-gray-700 mb-2">250cc OUT-status</h4>
                                <div id="out-list-250" class="space-y-2 max-h-60 overflow-y-auto">
                                    <!-- OUT checkboxes will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Anv√§ndarhantering Section -->
            <div class="cyberpunk-card rounded-lg">
                <button onclick="toggleSection('user-management')" class="w-full bg-gray-800 hover:bg-gray-700 text-white px-6 py-4 rounded-t-lg border-b border-gray-600 flex justify-between items-center">
                    <span class="text-xl font-medium">üë• Anv√§ndarhantering</span>
                    <span id="user-management-toggle">‚ñº</span>
                </button>
                
                <div id="user-management-section" class="hidden p-6">
                    
                    <div class="space-y-4">
                        <a href="/admin/users" class="inline-block cyberpunk-button px-4 py-2 rounded-md">
                            Visa alla anv√§ndare
                        </a>
                        <a href="/cleanup_duplicate_users" class="inline-block bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-md border border-yellow-500">
                            Rensa duplicerade anv√§ndare
                        </a>
                        <a href="/admin_old" class="inline-block bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">
                            G√• till gamla admin-sidan
                        </a>
                    </div>
                </div>
            </div>

            <!-- Systemverktyg Section -->
            <div class="cyberpunk-card rounded-lg">
                <button onclick="toggleSection('system-tools')" class="w-full bg-gray-800 hover:bg-gray-700 text-white px-6 py-4 rounded-t-lg border-b border-gray-600 flex justify-between items-center">
                    <span class="text-xl font-medium">üîß Systemverktyg</span>
                    <span id="system-tools-toggle">‚ñº</span>
                </button>
                
                <div id="system-tools-section" class="hidden p-6">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-3">
                            <h3 class="text-lg font-medium text-cyan-400 neon-text">Rider Data</h3>
                            <a href="/fix_existing_riders" class="block cyberpunk-button px-4 py-2 rounded-md text-center">
                                Fixa rider data
                            </a>
                            <a href="/fix_rider_coasts" class="block cyberpunk-button px-4 py-2 rounded-md text-center">
                                Fixa rider coasts
                            </a>
                            <a href="/debug_rider_coasts" class="block bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md border border-gray-500 text-center">
                                Debug rider coasts
                            </a>
                        </div>
                        
                        <div class="space-y-3">
                            <h3 class="text-lg font-medium text-cyan-400 neon-text">Database</h3>
                            <a href="/fix_bulletin_columns" class="block cyberpunk-button px-4 py-2 rounded-md text-center">
                                Fixa bulletin kolumner
                            </a>
                            <a href="/create_admin" class="block bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md border border-red-500 text-center">
                                Skapa admin anv√§ndare
                            </a>
                        </div>
                        
                        <div class="space-y-3">
                            <h3 class="text-lg font-medium text-cyan-400 neon-text">Rider Management</h3>
                            <a href="/rider_management" class="block cyberpunk-button px-4 py-2 rounded-md text-center">
                                üë• Hantera F√∂rare
                            </a>
                        </div>
                        
                        <div class="space-y-3">
                            <h3 class="text-lg font-medium text-cyan-400 neon-text">SMX Series</h3>
                            <button onclick="createDefaultSeries2025()" class="block w-full cyberpunk-button px-4 py-2 rounded-md text-center">
                                üèÅ Skapa SMX 2026 Serier
                            </button>
                            <button onclick="showSeriesManager()" class="block w-full cyberpunk-button px-4 py-2 rounded-md text-center">
                                ‚öôÔ∏è Hantera Serier
                            </button>
                        </div>
                        
                        <div class="space-y-3">
                            <h3 class="text-lg font-medium text-cyan-400 neon-text">Competitions</h3>
                            <button onclick="createMotocrossCompetitions()" class="block w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-center">
                                üèçÔ∏è Skapa Motocross 2026
                            </button>
                            <button onclick="createSMXFinalsCompetitions()" class="block w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-center">
                                üèÜ Skapa SMX Finals 2026
                            </button>
                        </div>
                        
                        <!-- Debug & Tools Section -->
                        <div class="space-y-3">
                            <button onclick="toggleSection('debug-tools')" class="w-full bg-gray-800 hover:bg-gray-700 text-white px-4 py-3 rounded-lg border border-gray-600 flex justify-between items-center">
                                <span class="text-lg font-medium">üîß Debug & Tools</span>
                                <span id="debug-tools-toggle">‚ñº</span>
                            </button>
                        </div>

                        <div id="debug-tools-section" class="hidden space-y-4">
                            <div class="space-y-3">
                                <h3 class="text-lg font-medium text-cyan-400 neon-text">üîß Database Fix</h3>
                                <button onclick="fixDatabaseTables()" class="block w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md border border-red-500 text-center">
                                    üîß Fixa Databas Tabeller
                                </button>
                            </div>
                            
                            <div class="space-y-3">
                                <h3 class="text-lg font-medium text-cyan-400 neon-text">üîç Debug Anv√§ndare</h3>
                                <div class="flex space-x-2">
                                    <input type="text" id="debug-username" placeholder="Anv√§ndarnamn" class="flex-1 bg-gray-700 text-white px-3 py-2 rounded border border-gray-600">
                                    <button onclick="debugUserScores()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md border border-purple-500">
                                        üîç Kolla Po√§ng
                                    </button>
                                </div>
                                <div id="debug-user-results" class="hidden mt-3 p-3 bg-gray-800 rounded border border-gray-600">
                                    <!-- Debug results will be shown here -->
                                </div>
                            </div>
                        </div>

            <!-- SMX Kvalificering Section -->
            <div class="space-y-3">
                <button onclick="toggleSection('smx-qualification')" class="w-full bg-gray-800 hover:bg-gray-700 text-white px-4 py-3 rounded-lg border border-gray-600 flex justify-between items-center">
                    <span class="text-lg font-medium">üèÜ SMX Kvalificering</span>
                    <span id="smx-qualification-toggle">‚ñº</span>
                </button>
            </div>

            <div id="smx-qualification-section" class="hidden space-y-4">
                <div class="space-y-3">
                    <button onclick="loadSMXQualification()" class="block w-full bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded-md border border-cyan-500 text-center">
                        üèÜ Visa SMX Kvalificering
                    </button>
                </div>
            </div>
                        
                        <!-- Cross Jump Game Section -->
                        <div class="space-y-3">
                            <button onclick="toggleSection('cross-jump')" class="w-full bg-gray-800 hover:bg-gray-700 text-white px-4 py-3 rounded-lg border border-gray-600 flex justify-between items-center">
                                <span class="text-lg font-medium">üéÆ Cross Jump Game</span>
                                <span id="cross-jump-toggle">‚ñº</span>
                            </button>
                        </div>

                        <div id="cross-jump-section" class="hidden space-y-4">
                            <div class="space-y-3">
                                <a href="/dino_game" class="block cyberpunk-button px-4 py-2 rounded-md text-center">
                                    üéÆ Live Version
                                </a>
                                <button onclick="resetCrossDinoHighscores()" class="w-full bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700 text-center">
                                    üéÆ Nollst√§ll Highscore
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Countdown Test Section -->
            <div class="cyberpunk-card rounded-lg">
                <button onclick="toggleSection('countdown-test')" class="w-full bg-gray-800 hover:bg-gray-700 text-white px-6 py-4 rounded-t-lg border-b border-gray-600 flex justify-between items-center">
                    <span class="text-xl font-medium">‚è∞ Countdown Test</span>
                    <span id="countdown-test-toggle">‚ñº</span>
                </button>
                
                <div id="countdown-test-section" class="hidden p-6">
                    
                    <div class="space-y-4">
                        <a href="/test_countdown_page" class="inline-block cyberpunk-button px-4 py-2 rounded-md">
                            Testa Countdown Scenarios
                        </a>
                        
                        <div class="mt-6 p-4 bg-gray-800 border border-cyan-400 rounded-lg" style="box-shadow: 0 0 10px rgba(34, 211, 238, 0.2);">
                            <h3 class="text-lg font-medium text-cyan-400 neon-text mb-2">Snabb Test</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                <button onclick="testScenario('race_in_3h')" class="cyberpunk-button px-3 py-2 rounded text-sm">
                                    3h till race
                                </button>
                                <button onclick="testScenario('race_in_1h')" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded text-sm border border-orange-500">
                                    1h till race
                                </button>
                                <button onclick="testScenario('race_in_30m')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm border border-red-500">
                                    30m till race
                                </button>
                                <button onclick="testScenario('race_tomorrow')" class="cyberpunk-button px-3 py-2 rounded text-sm">
                                    Imorgon
                                </button>
                            </div>
                            <button onclick="resetToRealTime()" class="mt-3 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded border border-gray-500">
                                √Öterst√§ll till riktig tid
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab functionality
        function initSections() {
            // All sections start collapsed by default
            console.log('Admin sections initialized - all collapsed by default');
        }

        // Make coast map available to JavaScript
        window.__COMP_COAST_MAP__ = {{ comp_coast_map | tojson | safe }};
        let currentCompetitionCoast = null;
        let isSaving = false; // Prevent multiple simultaneous saves
        let originalOutStatus = {}; // Store original OUT status to detect changes
        
        // Initialize sections when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initSections();
            loadRaces();
            loadRiders();
            setupCompetitionListener();
            loadSavedResults();
            updateSelectedCompetitionInfo();
        });

        // Load races for simulation
        async function loadRaces() {
            try {
                // Use the same data as the old admin page
                const competitions = {{ competitions | tojson }};
                
                const select = document.getElementById('competition-select');
                select.innerHTML = '<option value="">-- V√§lj t√§vling --</option>';
                
                competitions.forEach(comp => {
                    const option = document.createElement('option');
                    option.value = comp.id;
                    let text = `${comp.name} (${comp.event_date})`;
                    if (comp.coast_250 === 'both') {
                        text += ' [Showdown]';
                    } else if (comp.coast_250) {
                        text += ` [250SX ${comp.coast_250.charAt(0).toUpperCase() + comp.coast_250.slice(1)}]`;
                    }
                    option.textContent = text;
                    select.appendChild(option);
                });
                
                // Restore previously selected competition from localStorage, but prioritize upcoming race
                const savedCompetition = localStorage.getItem('admin_selected_competition');
                if (savedCompetition) {
                    // Check if saved competition is still available
                    const savedOption = Array.from(select.options).find(opt => opt.value === savedCompetition);
                    if (savedOption) {
                        select.value = savedCompetition;
                        // Trigger change event to load results for saved competition
                        select.dispatchEvent(new Event('change'));
                    } else {
                        // If saved competition is not found, select first upcoming race
                        if (select.options.length > 1) {
                            select.selectedIndex = 1;
                            select.dispatchEvent(new Event('change'));
                        }
                    }
                } else {
                    // If no saved competition, select first upcoming race
                    if (select.options.length > 1) {
                        select.selectedIndex = 1;
                        select.dispatchEvent(new Event('change'));
                    }
                }
            } catch (error) {
                console.error('Error loading races:', error);
            }
        }

        // Load riders for picks
        async function loadRiders() {
            try {
                // Use the same data as the old admin page
                const riders_450 = {{ riders_450 | tojson }};
                const riders_250 = {{ riders_250 | tojson }};
                
                // Store riders data globally for use in other functions
                window.riders_450_data = riders_450;
                window.riders_250_data = riders_250;

                // Populate holeshot dropdowns
                const holeshot450 = document.getElementById('holeshot_450');
                holeshot450.innerHTML = '<option value="">-- V√§lj f√∂rare --</option>';
                riders_450.forEach(rider => {
                    const option = document.createElement('option');
                    option.value = rider.id;
                    option.textContent = `#${rider.rider_number} ${rider.name} (${rider.bike_brand})`;
                    option.setAttribute('data-coast', rider.coast_250 || '');
                    holeshot450.appendChild(option);
                });

                const holeshot250 = document.getElementById('holeshot_250');
                holeshot250.innerHTML = '<option value="">-- V√§lj f√∂rare --</option>';
                riders_250.forEach(rider => {
                    const option = document.createElement('option');
                    option.value = rider.id;
                    option.textContent = `#${rider.rider_number} ${rider.name} (${rider.bike_brand})`;
                    option.setAttribute('data-coast', rider.coast_250 || '');
                    holeshot250.appendChild(option);
                });

            } catch (error) {
                console.error('Error loading riders:', error);
            }
        }


        // Countdown test functions
        async function testScenario(scenario) {
            try {
                const response = await fetch(`/test_countdown?scenario=${scenario}`, {
                    method: 'GET'
                });
                
                const result = await response.json();
                
                if (result.error) {
                    alert(`Fel: ${result.error}`);
                } else {
                    alert(`Scenario "${scenario}" aktiverat!`);
                    // Reload the page to see the countdown changes
                    window.location.reload();
                }
            } catch (error) {
                console.error('Error testing scenario:', error);
                alert('Fel vid testning av scenario');
            }
        }

        async function resetToRealTime() {
            try {
                const response = await fetch('/reset_simulation', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('√Öterst√§llt till riktig tid!');
                } else {
                    alert('Fel vid √•terst√§llning');
                }
            } catch (error) {
                console.error('Error resetting time:', error);
                alert('Fel vid √•terst√§llning');
            }
        }

        async function resetCrossDinoHighscores() {
            if (!confirm('√Ñr du s√§ker p√• att du vill nollst√§lla alla Cross Jump highscores? Detta g√•r inte att √•ngra!')) {
                return;
            }
            
            try {
                const response = await fetch('/api/cross_dino/reset_highscores', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('Alla Cross Dino highscores har nollst√§llts!');
                } else {
                    const error = await response.json();
                    alert('Fel vid nollst√§llning: ' + (error.error || 'Ok√§nt fel'));
                }
            } catch (error) {
                console.error('Error resetting highscores:', error);
                alert('Fel vid nollst√§llning av highscores');
            }
        }

        // Core admin functions from old admin page
        async function submitResultsAndReload() {
            // First validate results
            if (!validateResults()) {
                return false;
            }
            
            // Submit the form
            const form = document.querySelector('form[action="/admin/submit_results"]');
            const formData = new FormData(form);
            
            try {
                const response = await fetch('/admin/submit_results', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    // Reload the results after successful submission
                    await loadSavedResults();
                    // Update dropdowns to show all available riders
                    updateAllDropdowns();
                    showToast("Resultat sparade!", true);
                    return false; // Prevent default form submission
                } else {
                    showToast("Fel vid sparande av resultat", false);
                    return false;
                }
            } catch (error) {
                console.error('Error submitting results:', error);
                showToast("Fel vid sparande av resultat", false);
                return false;
            }
        }

        function updateAllDropdowns() {
            // Update all dropdowns to show all available riders
            console.log('DEBUG: Updating all dropdowns after results submission');
            
            // Update 450cc dropdowns
            validateAndUpdateDropdowns('450');
            
            // Update 250cc dropdowns  
            validateAndUpdateDropdowns('250');
            
            // Update holeshot dropdowns
            updateHoleshotDropdowns();
        }

        async function loadSavedResults() {
            syncHiddenCompetitionId();
            const comp = document.getElementById("competition-select").value;
            const c450 = document.getElementById("results-container-450");
            const c250 = document.getElementById("results-container-250");
            const hs450 = document.getElementById("holeshot_450");
            const hs250 = document.getElementById("holeshot_250");

            c450.innerHTML = "";
            c250.innerHTML = "";
            if (hs450) hs450.value = "";
            if (hs250) hs250.value = "";
            
            // Clear any existing status text from options
            document.querySelectorAll('option').forEach(opt => {
                opt.textContent = opt.textContent.replace(/ \(OUT\)| \(Fel coast\)/g, '');
            });
            
            // Clear all result dropdowns
            document.querySelectorAll('select[name="riders_450[]"], select[name="riders_250[]"]').forEach(select => {
                select.value = '';
            });
            
            // Get competition coast reliably using a map rendered from backend
            const selectEl = document.getElementById("competition-select");
            const selectedId = selectEl.value;
            const compMap = window.__COMP_COAST_MAP__ || {};
            currentCompetitionCoast = compMap[selectedId] || null;
            console.log(`DEBUG: Competition coast set to: ${currentCompetitionCoast}`);
            
            // Update competition info display
            updateSelectedCompetitionInfo();
            
            if (!comp) return;

            // Always ensure we have exactly 20 rows for 450cc and 6 rows for 250cc
            // Use setTimeout to prevent blocking the UI
            setTimeout(async () => {
                while (document.getElementById("results-container-450").children.length < 20) {
                    addResultRow("450");
                }
                while (document.getElementById("results-container-250").children.length < 6) {
                    addResultRow("250");
                }
                
                // Add event listeners after all rows are created
                addEventListeners();
                
                // Apply coast filtering to all dropdowns
                validateAndUpdateDropdowns('450');
                validateAndUpdateDropdowns('250');
                
                // Load existing results after rows are created
                await loadExistingResults(comp);
            }, 10);
        }

        function addResultRow(cls, position = null) {
            const container = document.getElementById(`results-container-${cls}`);
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            
            const selectName = `riders_${cls}[]`;
            const currentPosition = position || (container.children.length + 1);
            
            div.innerHTML = `
                <span class="w-8 text-sm font-medium text-gray-600">${currentPosition}.</span>
                <input type="hidden" name="positions_${cls}[]" value="${currentPosition}">
                <select name="${selectName}" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- V√§lj f√∂rare --</option>
                </select>
            `;
            
            const select = div.querySelector('select');
            
            // Populate with riders
            const riders = cls === '450' ? window.riders_450_data : window.riders_250_data;
            if (riders) {
                riders.forEach(rider => {
                    const option = document.createElement('option');
                    option.value = rider.id;
                    option.textContent = `#${rider.rider_number} ${rider.name} (${rider.bike_brand})`;
                    option.setAttribute('data-coast', rider.coast_250 || '');
                    select.appendChild(option);
                });
            }
            
            container.appendChild(div);
        }

        function addEventListeners() {
            // Add event listeners to all dropdowns
            document.querySelectorAll('select[name="riders_450[]"]').forEach(select => {
                select.addEventListener('change', function() {
                    validateAndUpdateDropdowns('450');
                });
            });
            document.querySelectorAll('select[name="riders_250[]"]').forEach(select => {
                select.addEventListener('change', function() {
                    validateAndUpdateDropdowns('250');
                });
            });
            
            // Update holeshot dropdowns with coast validation
            updateHoleshotDropdowns();
        }

        // Update holeshot dropdowns with coast validation
        function updateHoleshotDropdowns() {
            const holeshot250 = document.getElementById('holeshot_250');
            if (holeshot250 && currentCompetitionCoast && currentCompetitionCoast !== 'both') {
                for (const opt of holeshot250.options) {
                    if (!opt.value) continue;
                    const riderCoast = opt.getAttribute('data-coast');
                    if (riderCoast) {
                        const isWrongCoast = riderCoast !== currentCompetitionCoast && riderCoast !== 'both';
                        opt.disabled = isWrongCoast;
                        opt.style.color = isWrongCoast ? '#999' : '';
                        
                        if (isWrongCoast && !opt.textContent.includes('(Fel coast)')) {
                            opt.textContent = opt.textContent + ' (Fel coast)';
                            console.log(`DEBUG: Holeshot - Disabling rider ${opt.textContent} - rider coast: ${riderCoast}, competition coast: ${currentCompetitionCoast}`);
                        } else if (!isWrongCoast && opt.textContent.includes('(Fel coast)')) {
                            opt.textContent = opt.textContent.replace(' (Fel coast)', '');
                        }
                    }
                }
            }
        }

        async function loadExistingResults(compId) {
            try {
                console.log(`DEBUG: Loading existing results for competition ${compId}`);
                
                // FIRST: Clear all dropdowns to prevent old results from staying
                console.log('DEBUG: Clearing all dropdowns first');
                document.querySelectorAll('select[name="riders_450[]"]').forEach(select => {
                    select.value = '';
                });
                document.querySelectorAll('select[name="riders_250[]"]').forEach(select => {
                    select.value = '';
                });
                const hs450Select = document.getElementById("holeshot_450");
                const hs250Select = document.getElementById("holeshot_250");
                if (hs450Select) hs450Select.value = '';
                if (hs250Select) hs250Select.value = '';
                
                const response = await fetch(`/admin/get_results/${compId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('DEBUG: Got results data:', data);
                    
                    // Load 450cc results
                    if (data.results_450 && data.results_450.length > 0) {
                        console.log(`DEBUG: Loading ${data.results_450.length} 450cc results`);
                        data.results_450.forEach((result, index) => {
                            const selects = document.querySelectorAll('select[name="riders_450[]"]');
                            if (selects[index]) {
                                selects[index].value = result.rider_id;
                                console.log(`DEBUG: Set 450cc position ${index + 1} to rider ${result.rider_id}`);
                            }
                        });
                    }
                    
                    // Load 250cc results
                    if (data.results_250 && data.results_250.length > 0) {
                        console.log(`DEBUG: Loading ${data.results_250.length} 250cc results`);
                        data.results_250.forEach((result, index) => {
                            const selects = document.querySelectorAll('select[name="riders_250[]"]');
                            if (selects[index]) {
                                selects[index].value = result.rider_id;
                                console.log(`DEBUG: Set 250cc position ${index + 1} to rider ${result.rider_id}`);
                            }
                        });
                    }
                    
                    // Load holeshot results
                    if (data.holeshot_450) {
                        const hs450Select = document.getElementById("holeshot_450");
                        if (hs450Select) {
                            hs450Select.value = data.holeshot_450;
                            console.log(`DEBUG: Set 450cc holeshot to ${data.holeshot_450}`);
                        }
                    }
                    if (data.holeshot_250) {
                        const hs250Select = document.getElementById("holeshot_250");
                        if (hs250Select) {
                            hs250Select.value = data.holeshot_250;
                            console.log(`DEBUG: Set 250cc holeshot to ${data.holeshot_250}`);
                        }
                    }
                    
                    // Update dropdowns after loading results
                    validateAndUpdateDropdowns('450');
                    validateAndUpdateDropdowns('250');
                    
                } else {
                    console.log('DEBUG: No existing results found or error loading');
                }
            } catch (error) {
                console.error('Error loading existing results:', error);
            }
        }

        async function simulateForSelected() {
            const comp = document.getElementById("competition-select").value;
            if (!comp) {
                alert("V√§lj en t√§vling f√∂rst.");
                return;
            }
            try {
                const res = await fetch(`/admin/simulate/${comp}`, { method: "POST" });
                if (res.redirected) {
                    window.location.href = res.url;
                    return;
                }
                await loadSavedResults();
                showToast("Simulering klar!", true);
            } catch (e) {
                console.error(e);
                showToast("Kunde inte k√∂ra simuleringen.", false);
            }
        }

        async function clearCurrentCompetitionResults() {
            const comp = document.getElementById("competition-select").value;
            if (!comp) {
                alert("V√§lj en t√§vling f√∂rst.");
                return;
            }
            
            if (!confirm("√Ñr du s√§ker p√• att du vill rensa alla resultat f√∂r denna t√§vling?")) {
                return;
            }
            
            try {
                const res = await fetch(`/clear_competition_results/${comp}`, { method: "POST" });
                if (res.ok) {
                    await loadSavedResults();
                    showToast("Resultat rensade!", true);
                } else {
                    showToast("Kunde inte rensa resultat.", false);
                }
            } catch (e) {
                console.error(e);
                showToast("Kunde inte rensa resultat.", false);
            }
        }

        function syncHiddenCompetitionId() {
            const comp = document.getElementById("competition-select").value;
            const hidden = document.getElementById("competition_id_hidden");
            if (hidden) {
                hidden.value = comp;
            }
        }

        function validateAndUpdateDropdowns(cls) {
            const selects = document.querySelectorAll(`select[name="riders_${cls}[]"]`);
            const selectedValues = Array.from(selects)
                .map(sel => sel.value)
                .filter(val => val);
            
            // Get current OUT riders for this competition
            const outCheckboxes = document.querySelectorAll('#out-list-450 input[type="checkbox"]:checked, #out-list-250 input[type="checkbox"]:checked');
            const outRiderIds = Array.from(outCheckboxes).map(cb => cb.id.replace('out-', ''));
            
            // Remove options that are selected elsewhere, OUT, or wrong coast
            selects.forEach(select => {
                const currentValue = select.value;
                const optionsToRemove = [];
                
                Array.from(select.options).forEach(option => {
                    if (option.value && option.value !== currentValue) {
                        // Check if this option is selected in another dropdown
                        const isSelectedElsewhere = Array.from(selects)
                            .some(otherSelect => otherSelect !== select && otherSelect.value === option.value);
                        
                        // Check if this rider is OUT
                        const isOut = outRiderIds.includes(option.value);
                        
                        // Check coast for 250cc riders
                        let isWrongCoast = false;
                        if (cls === '250' && currentCompetitionCoast && currentCompetitionCoast !== 'both') {
                            const riderCoast = option.getAttribute('data-coast');
                            if (riderCoast) {
                                isWrongCoast = riderCoast !== currentCompetitionCoast && riderCoast !== 'both';
                                if (isWrongCoast) {
                                    console.log(`DEBUG: Removing rider ${option.textContent} - rider coast: ${riderCoast}, competition coast: ${currentCompetitionCoast}`);
                                }
                            }
                        }
                        
                        // Remove option if it's selected elsewhere, OUT, or wrong coast
                        if (isSelectedElsewhere || isOut || isWrongCoast) {
                            optionsToRemove.push(option);
                        }
                    }
                });
                
                // Remove options that shouldn't be shown
                optionsToRemove.forEach(opt => {
                    if (opt.value !== currentValue) {
                        opt.remove();
                    }
                });
            });
        }

        function validateResults() {
            console.log("DEBUG: validateResults called");
            
            // Check for duplicates in 450cc results
            const riders450 = Array.from(document.querySelectorAll('select[name="riders_450[]"]'))
                .map(sel => sel.value)
                .filter(val => val);
            
            if (riders450.length !== new Set(riders450).size) {
                alert("Du kan inte s√§tta samma 450cc-f√∂rare flera g√•nger.");
                return false;
            }
            
            // Check for duplicates in 250cc results
            const riders250 = Array.from(document.querySelectorAll('select[name="riders_250[]"]'))
                .map(sel => sel.value)
                .filter(val => val);
            
            if (riders250.length !== new Set(riders250).size) {
                alert("Du kan inte s√§tta samma 250cc-f√∂rare flera g√•nger.");
                return false;
            }
            
            // Check that exactly 20 riders are selected for 450cc and 6 for 250cc
            if (riders450.length !== 20) {
                alert("Du m√•ste v√§lja exakt 20 f√∂rare f√∂r 450cc (f√∂r wildcard-funktionen).");
                return false;
            }
            
            if (riders250.length !== 6) {
                alert("Du m√•ste v√§lja exakt 6 f√∂rare f√∂r 250cc (Top 6).");
                return false;
            }
            
            console.log("DEBUG: Validation passed, submitting form");
            return true;
        }

        function showToast(msg, ok = true) {
            let t = document.getElementById("toast");
            if (!t) {
                t = document.createElement("div");
                t.id = "toast";
                t.style.position = "fixed";
                t.style.bottom = "20px";
                t.style.right = "20px";
                t.style.padding = "12px 16px";
                t.style.borderRadius = "8px";
                t.style.color = "#fff";
                t.style.fontWeight = "bold";
                t.style.zIndex = "9999";
                t.style.transition = "opacity .25s ease";
                document.body.appendChild(t);
            }
            t.style.background = ok ? "#16a34a" : "#dc2626";
            t.textContent = msg;
            t.style.opacity = "1";
            setTimeout(() => (t.style.opacity = "0"), 1800);
        }

        function updateSelectedCompetitionInfo() {
            const comp = document.getElementById("competition-select").value;
            const info = document.getElementById("selected-competition-info");
            const name = document.getElementById("selected-competition-name");
            
            if (comp && info && name) {
                const selectedOption = document.querySelector(`#competition-select option[value="${comp}"]`);
                if (selectedOption) {
                    name.textContent = selectedOption.textContent;
                    info.style.display = "block";
                }
            } else if (info) {
                info.style.display = "none";
            }
        }

        // Initialize result rows when competition is selected
        function setupCompetitionListener() {
            const competitionSelect = document.getElementById("competition-select");
            if (competitionSelect) {
                competitionSelect.addEventListener('change', function() {
                    // Save selected competition to localStorage
                    const selectedValue = this.value;
                    if (selectedValue) {
                        localStorage.setItem('admin_selected_competition', selectedValue);
                    } else {
                        localStorage.removeItem('admin_selected_competition');
                    }
                    
                    loadSavedResults();
                });
            }
        }
        
        function syncWithHomepage() {
            // Force select the first upcoming race to match homepage logic
            const select = document.getElementById('competition-select');
            if (select && select.options.length > 1) {
                select.selectedIndex = 1; // First upcoming race (skip "-- V√§lj t√§vling --")
                select.dispatchEvent(new Event('change'));
            }
        }
        
        function toggleSection(sectionName) {
            const section = document.getElementById(sectionName + '-section');
            const toggle = document.getElementById(sectionName + '-toggle');
            
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                toggle.textContent = '‚ñ≤';
            } else {
                section.classList.add('hidden');
                toggle.textContent = '‚ñº';
            }
        }

        function toggleRaceResults() {
            toggleSection('race-results');
        }

        // OUT-status functions
        async function loadOutList() {
            const comp = document.getElementById("competition-select").value;
            if (!comp) { 
                alert("V√§lj en t√§vling f√∂rst."); 
                return; 
            }
            try {
                const res = await fetch(`/admin/get_out_status/${comp}`);
                if (!res.ok) throw new Error("fetch failed");
                const riders = await res.json();

                const c450 = document.getElementById("out-list-450");
                const c250 = document.getElementById("out-list-250");
                c450.innerHTML = "";
                c250.innerHTML = "";

                const render = (container, list) => {
                    list.forEach(r => {
                        const id = `out-${r.id}`;
                        const row = document.createElement("label");
                        row.className = "flex items-center gap-2 bg-white p-2 rounded border";
                        row.innerHTML = `
                            <input type="checkbox" id="${id}" ${r.is_out ? "checked" : ""}>
                            <span class="flex-1 text-sm">#${r.rider_number || "-"} ${r.name} <span class="text-gray-400 text-xs">(${r.bike_brand || "‚Äî"})</span></span>
                        `;
                        container.appendChild(row);
                    });
                };

                render(c450, riders.filter(r => r.class === "450cc"));
                render(c250, riders.filter(r => r.class === "250cc"));
                
                // Store original OUT status for change detection
                originalOutStatus = {};
                riders.forEach(r => {
                    originalOutStatus[r.id] = r.is_out;
                });
            } catch (e) {
                console.error(e);
                showToast("Kunde inte ladda OUT-lista", false);
            }
        }

        async function saveAllOutStatus() {
            if (isSaving) {
                console.log("Already saving, ignoring duplicate call");
                return;
            }
            
            isSaving = true;
            console.log("saveAllOutStatus called");
            
            const comp = document.getElementById("competition-select").value;
            if (!comp) { 
                alert("V√§lj en t√§vling f√∂rst."); 
                isSaving = false;
                return; 
            }
            
            console.log("Competition selected:", comp);
            
            // Get all checkboxes and only save those that have changed
            const checkboxes = document.querySelectorAll('#out-list-450 input[type="checkbox"], #out-list-250 input[type="checkbox"]');
            console.log("Found checkboxes:", checkboxes.length);
            
            let saved = 0;
            let errors = 0;
            let changes = 0;
            
            for (const checkbox of checkboxes) {
                const riderId = checkbox.id.replace('out-', '');
                const isOut = checkbox.checked;
                const originalStatus = originalOutStatus[riderId];
                
                console.log(`DEBUG: Rider ${riderId}, current: ${isOut}, original: ${originalStatus}`);
                
                // Only save if status has changed
                if (originalStatus !== isOut) {
                    changes++;
                    console.log(`Processing rider ${riderId}, isOut: ${isOut} (changed from ${originalStatus})`);
                    
                    try {
                        const res = await fetch("/admin/set_out_status", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                competition_id: parseInt(comp, 10),
                                rider_id: parseInt(riderId, 10),
                                status: isOut ? "OUT" : "CLEAR",
                            }),
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || "save failed");
                        saved++;
                        console.log(`Saved rider ${riderId}`);
                    } catch (e) {
                        console.error(`Error saving rider ${riderId}:`, e);
                        errors++;
                    }
                }
            }
            
            console.log(`Final result: ${saved} saved, ${errors} errors, ${changes} changes detected`);
            
            if (changes === 0) {
                alert("Inga √§ndringar att spara.");
            } else if (errors === 0) {
                alert(`${saved} √§ndringar sparade!`);
                
                // Update original status to current status
                checkboxes.forEach(checkbox => {
                    const riderId = checkbox.id.replace('out-', '');
                    originalOutStatus[riderId] = checkbox.checked;
                });
                
                // Update dropdowns to reflect OUT status changes
                validateAndUpdateDropdowns('450');
                validateAndUpdateDropdowns('250');
            } else {
                alert(`${saved} sparade, ${errors} fel`);
            }
            
            isSaving = false;
        }

        // SMX Series Management Functions
        async function createDefaultSeries2025() {
            if (!confirm('Skapa standard SMX-serier f√∂r 2026? Detta skapar Supercross, Motocross och SMX Finals.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/series/create_default_2025', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ SMX-serier skapade f√∂r 2026!\n\n${result.series_created.map(s => `‚Ä¢ ${s.name}`).join('\n')}`);
                } else {
                    alert(`‚ùå Fel: ${result.error}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Fel vid skapande av serier');
            }
        }

        function showSeriesManager() {
            // Create modal for series management
            const modal = document.createElement('div');
            modal.id = 'series-manager-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-gray-900 rounded-lg border-2 border-cyan-400 p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto" style="box-shadow: 0 0 20px rgba(34, 211, 238, 0.3);">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-cyan-400 neon-text">üèÅ SMX Series Manager</h2>
                        <button onclick="closeSeriesManager()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Series List -->
                        <div>
                            <h3 class="text-lg font-semibold text-cyan-400 mb-4">üìã Befintliga Serier</h3>
                            <div id="series-list" class="space-y-3">
                                <div class="text-center text-gray-400 py-8">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-cyan-400 mx-auto mb-2"></div>
                                    Laddar serier...
                                </div>
                            </div>
                        </div>
                        
                        <!-- Series Form -->
                        <div>
                            <h3 class="text-lg font-semibold text-cyan-400 mb-4">‚ûï Skapa Ny Serie</h3>
                            <form id="series-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-cyan-300 mb-1">Namn</label>
                                    <input type="text" id="series-name" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white" placeholder="t.ex. Supercross 2026" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-cyan-300 mb-1">√Ör</label>
                                    <input type="number" id="series-year" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white" value="2026" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-cyan-300 mb-1">Startdatum</label>
                                    <input type="date" id="series-start-date" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-cyan-300 mb-1">Slutdatum</label>
                                    <input type="date" id="series-end-date" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-cyan-300 mb-1">Po√§ngsystem</label>
                                    <select id="series-points-system" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white">
                                        <option value="standard">Standard</option>
                                        <option value="double">Dubbel po√§ng</option>
                                        <option value="triple">Trippel po√§ng</option>
                                    </select>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="series-active" class="mr-2" checked>
                                    <label class="text-cyan-300">Aktiv serie</label>
                                </div>
                                <button type="submit" class="w-full cyberpunk-button px-4 py-2 rounded-md">
                                    üèÅ Skapa Serie
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            loadSeriesList();
            setupSeriesForm();
        }
        
        function closeSeriesManager() {
            const modal = document.getElementById('series-manager-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function loadSeriesList() {
            try {
                const response = await fetch('/api/series');
                const series = await response.json();
                
                const seriesList = document.getElementById('series-list');
                if (series.length === 0) {
                    seriesList.innerHTML = '<div class="text-center text-gray-400 py-8">Inga serier hittades</div>';
                    return;
                }
                
                seriesList.innerHTML = series.map(serie => `
                    <div class="bg-gray-800 border border-cyan-400 rounded-lg p-4" style="box-shadow: 0 0 10px rgba(34, 211, 238, 0.2);">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold text-cyan-300">${serie.name}</h4>
                            <span class="text-xs px-2 py-1 rounded ${serie.is_active ? 'bg-green-600' : 'bg-gray-600'} text-white">
                                ${serie.is_active ? 'Aktiv' : 'Inaktiv'}
                            </span>
                        </div>
                        <p class="text-sm text-gray-300 mb-2">√Ör: ${serie.year}</p>
                        <p class="text-sm text-gray-300 mb-2">Po√§ngsystem: ${serie.points_system}</p>
                        ${serie.start_date ? `<p class="text-sm text-gray-300 mb-2">Start: ${new Date(serie.start_date).toLocaleDateString('sv-SE')}</p>` : ''}
                        ${serie.end_date ? `<p class="text-sm text-gray-300 mb-2">Slut: ${new Date(serie.end_date).toLocaleDateString('sv-SE')}</p>` : ''}
                        <div class="flex space-x-2 mt-3">
                            <button onclick="editSeries(${serie.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs">
                                Redigera
                            </button>
                            <button onclick="deleteSeries(${serie.id}, '${serie.name}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">
                                Ta bort
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading series:', error);
                document.getElementById('series-list').innerHTML = '<div class="text-center text-red-400 py-8">Fel vid laddning av serier</div>';
            }
        }
        
        function setupSeriesForm() {
            document.getElementById('series-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const data = {
                    name: document.getElementById('series-name').value,
                    year: parseInt(document.getElementById('series-year').value),
                    start_date: document.getElementById('series-start-date').value || null,
                    end_date: document.getElementById('series-end-date').value || null,
                    points_system: document.getElementById('series-points-system').value,
                    is_active: document.getElementById('series-active').checked
                };
                
                try {
                    const response = await fetch('/api/series', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        alert('‚úÖ Serie skapad!');
                        loadSeriesList();
                        document.getElementById('series-form').reset();
                        document.getElementById('series-year').value = '2026';
                    } else {
                        alert(`‚ùå Fel: ${result.error}`);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('‚ùå Fel vid skapande av serie');
                }
            });
        }
        
        function editSeries(seriesId) {
            alert('üöß Redigering av serier kommer snart!');
        }
        
        function deleteSeries(seriesId, seriesName) {
            if (confirm(`√Ñr du s√§ker p√• att du vill ta bort serien "${seriesName}"?`)) {
                fetch(`/api/series/${seriesId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('‚úÖ Serie borttagen!');
                        loadSeriesList();
                    } else {
                        alert(`‚ùå Fel: ${result.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('‚ùå Fel vid borttagning av serie');
                });
            }
        }
        
        async function createMotocrossCompetitions() {
            if (!confirm('Skapa alla Motocross competitions f√∂r 2026?\n\nDetta skapar 11 Motocross races fr√•n maj till augusti.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/competitions/create_motocross_2025', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ Motocross competitions skapade!\n\n${result.competitions_created.join('\n')}`);
                } else {
                    alert(`‚ùå Fel: ${result.error}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Fel vid skapande av Motocross competitions');
            }
        }
        
        async function createSMXFinalsCompetitions() {
            if (!confirm('Skapa SMX Finals competitions f√∂r 2026?\n\nDetta skapar 3 SMX races (Playoff 1, Playoff 2, Final) i september.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/competitions/create_smx_finals_2025', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ SMX Finals competitions skapade!\n\n${result.competitions_created.join('\n')}`);
                } else {
                    alert(`‚ùå Fel: ${result.error}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Fel vid skapande av SMX Finals competitions');
            }
        }

        async function fixDatabaseTables() {
            if (!confirm('‚ö†Ô∏è VARNING: Detta kommer att skapa saknade databas-tabeller.\n\n√Ñr du s√§ker p√• att du vill forts√§tta?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/fix_database_tables', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ Databas fixad!\n\n${result.message}`);
                    // Reload page to refresh
                    location.reload();
                } else {
                    alert(`‚ùå Fel: ${result.error}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Fel vid fixning av databas');
            }
        }

        async function loadSMXQualification() {
            try {
                const response = await fetch('/api/smx_qualification');
                const result = await response.json();
                
                if (result.success) {
                    displaySMXQualification(result.qualification);
                } else {
                    alert('‚ùå Fel vid laddning av SMX kvalificering: ' + (result.error || 'Ok√§nt fel'));
                }
            } catch (error) {
                console.error('Error loading SMX qualification:', error);
                alert('‚ùå Fel vid laddning av SMX kvalificering: ' + error.message);
            }
        }

        async function debugUserScores() {
            const username = document.getElementById('debug-username').value.trim();
            if (!username) {
                alert('Ange ett anv√§ndarnamn');
                return;
            }
            
            try {
                const response = await fetch(`/debug_user_scores/${username}`);
                const result = await response.json();
                
                if (result.error) {
                    alert(`Fel: ${result.error}`);
                    return;
                }
                
                displayDebugResults(result);
            } catch (error) {
                console.error('Error debugging user scores:', error);
                alert('Fel vid debug av anv√§ndare');
            }
        }

        function displayDebugResults(data) {
            const container = document.getElementById('debug-user-results');
            
            let html = `
                <h4 class="text-lg font-bold text-cyan-400 mb-3">üîç Debug: ${data.user.username}</h4>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-300">User ID:</span>
                        <span class="text-white">${data.user.id}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Team Name:</span>
                        <span class="text-white">${data.season_team.team_name || 'Ingen'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Season Team Points:</span>
                        <span class="text-yellow-400 font-bold">${data.season_team.total_points}</span>
                    </div>
                </div>
            `;
            
            if (data.competition_scores.length > 0) {
                html += `
                    <div class="mt-4">
                        <h5 class="text-md font-bold text-green-400 mb-2">üìä Competition Scores:</h5>
                        <div class="space-y-1">
                `;
                
                data.competition_scores.forEach(score => {
                    html += `
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-300">${score.competition_name}:</span>
                            <span class="text-green-400">${score.points} pts</span>
                        </div>
                    `;
                });
                
                const totalFromScores = data.competition_scores.reduce((sum, score) => sum + score.points, 0);
                html += `
                        </div>
                        <div class="mt-2 pt-2 border-t border-gray-600">
                            <div class="flex justify-between font-bold">
                                <span class="text-gray-300">Total fr√•n CompetitionScore:</span>
                                <span class="text-green-400">${totalFromScores} pts</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="mt-4">
                        <p class="text-gray-400">Inga CompetitionScore poster hittades</p>
                    </div>
                `;
            }
            
            html += `
                <div class="mt-4">
                    <h5 class="text-md font-bold text-blue-400 mb-2">üéØ Picks Summary:</h5>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-300">Race Picks:</span>
                            <span class="text-blue-400">${data.picks_summary.race_picks}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Holeshot Picks:</span>
                            <span class="text-blue-400">${data.picks_summary.holeshot_picks}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Wildcard Picks:</span>
                            <span class="text-blue-400">${data.picks_summary.wildcard_picks}</span>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            container.classList.remove('hidden');
        }

        function displaySMXQualification(qualification) {
            const container = document.getElementById('smx-qualification-container');
            if (!container) {
                // Create container if it doesn't exist
                const newContainer = document.createElement('div');
                newContainer.id = 'smx-qualification-container';
                newContainer.className = 'space-y-2 mt-4';
                
                // Find a good place to insert it
                const smxButton = document.querySelector('button[onclick="loadSMXQualification()"]');
                if (smxButton && smxButton.parentElement) {
                    smxButton.parentElement.appendChild(newContainer);
                }
                return displaySMXQualification(qualification); // Retry with new container
            }
            
            let html = '<div class="bg-gray-900 border border-cyan-400 rounded-lg p-4">';
            html += '<h4 class="text-lg font-bold text-cyan-400 mb-3">üèÜ SMX Finals Kvalificering (Top 20)</h4>';
            
            if (qualification.length === 0) {
                html += '<p class="text-gray-400">Inga resultat √§nnu. L√§gg in race resultat f√∂r att se kvalificering.</p>';
            } else {
                html += '<div class="space-y-2">';
                qualification.forEach((rider, index) => {
                    const isQualified = rider.qualified;
                    const bgColor = isQualified ? 'bg-green-900 border-green-500' : 'bg-gray-800 border-gray-600';
                    const textColor = isQualified ? 'text-green-400' : 'text-gray-400';
                    
                    html += `
                        <div class="${bgColor} border rounded-lg p-3 flex justify-between items-center">
                            <div class="flex items-center space-x-3">
                                <span class="text-cyan-400 font-bold">${rider.position}.</span>
                                <span class="text-white font-semibold">#${rider.rider_number} ${rider.rider_name}</span>
                                <span class="text-gray-400">(${rider.bike_brand})</span>
                            </div>
                            <div class="text-right">
                                <div class="${textColor} font-bold">${rider.total_points} pts</div>
                                <div class="text-xs text-gray-500">SX: ${rider.sx_points} | MX: ${rider.mx_points}</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
    </script>
</body>
</html>
