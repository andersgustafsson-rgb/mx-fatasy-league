<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Mitt Fantasy Spel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-btn {
            @apply px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800 border-b-2 border-transparent hover:border-gray-300 transition-colors;
        }
        .tab-btn.active {
            @apply text-blue-600 border-blue-600;
        }
        .tab-panel {
            @apply hidden;
        }
        .tab-panel.active {
            @apply block;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Admin Panel</h1>
                    <p class="text-gray-600">Hantera tävlingar, användare och systeminställningar</p>
                </div>
                <div>
                    <a href="{{ url_for('index') }}" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        🏠 Till huvudsidan
                    </a>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-white rounded-lg shadow-sm mb-6">
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8 px-6">
                    <button class="tab-btn active" data-tab="race-management">
                        🏁 Race Management
                    </button>
                    <button class="tab-btn" data-tab="user-management">
                        👥 Användare
                    </button>
                    <button class="tab-btn" data-tab="system-tools">
                        🔧 Systemverktyg
                    </button>
                    <button class="tab-btn" data-tab="countdown-test">
                        ⏰ Countdown Test
                    </button>
                </nav>
            </div>
        </div>

        <!-- Tab Panels -->
        <div class="space-y-6">
            <!-- Race Management Tab -->
            <div id="race-management" class="tab-panel active">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">🏁 Race Management</h2>
                    
                    <!-- Simulated Date Section -->
                    <div class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-r-lg">
                        <h3 class="text-lg font-medium text-blue-800 mb-3">📅 Simulerat Datum</h3>
                        <p class="text-sm text-blue-700 mb-3">
                            Sätt ett simulerat datum (YYYY-MM-DD) för att styra vilket race som anses vara "nästa/aktuellt".
                        </p>
                        
                        <form action="/admin/set_sim_date" method="POST" class="flex flex-col sm:flex-row gap-3">
                            <input type="text" name="sim_date" placeholder="2026-01-17" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                Sätt Datum
                            </button>
                            <button type="submit" name="sim_date" value="" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">
                                Rensa
                            </button>
                        </form>
                        
                        <div class="mt-3 p-2 bg-blue-100 rounded">
                            <span class="text-sm font-medium text-blue-800">Aktuellt simulerat datum: </span>
                            <span id="current-sim-date" class="font-bold text-blue-900">{{ today if today else 'Idag' }}</span>
                        </div>
                    </div>

                    <!-- Competition Selection -->
                    <div class="mb-6">
                        <h3 class="text-lg font-medium text-gray-800 mb-3">🏆 Välj Tävling</h3>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <select id="competition-select" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">-- Välj tävling --</option>
                            </select>
                            <button onclick="simulateForSelected()" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">
                                ⚙️ Simulera
                            </button>
                            <button onclick="clearCurrentCompetitionResults()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                                🗑️ Rensa
                            </button>
                            <button onclick="syncWithHomepage()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                🔄 Synka med huvudsida
                            </button>
                        </div>
                        
                        <div id="selected-competition-info" class="mt-3 p-3 bg-green-50 border-l-4 border-green-500 rounded-r-lg" style="display: none;">
                            <span class="text-sm font-medium text-green-800">Aktuell tävling: </span>
                            <span id="selected-competition-name" class="font-bold text-green-900"></span>
                        </div>
                    </div>

                    <!-- Results Form -->
                    <form method="POST" action="/admin/submit_results" onsubmit="return validateResults()">
                        <input type="hidden" id="competition_id_hidden" name="competition_id" value="">
                        
                        <!-- Holeshot Winners -->
                        <div class="mb-6 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-r-lg">
                            <h3 class="text-lg font-medium text-yellow-800 mb-3">🏁 Holeshot Vinnare</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">450cc:</label>
                                    <select name="holeshot_450" id="holeshot_450" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">-- Välj förare --</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">250cc:</label>
                                    <select name="holeshot_250" id="holeshot_250" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">-- Välj förare --</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Race Results -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-3">450cc Resultat (Top 20)</h3>
                                <div id="results-container-450" class="space-y-2">
                                    <div class="p-4 bg-gray-100 rounded-lg text-center text-gray-600">
                                        Välj en tävling ovan för att lägga in resultat
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium text-gray-800 mb-3">250cc Resultat (Top 6)</h3>
                                <div id="results-container-250" class="space-y-2">
                                    <div class="p-4 bg-gray-100 rounded-lg text-center text-gray-600">
                                        Välj en tävling ovan för att lägga in resultat
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-6">
                            <button type="submit" class="w-full bg-green-600 text-white px-4 py-3 rounded-md hover:bg-green-700 font-medium">
                                ✅ Spara Resultat & Räkna Poäng
                            </button>
                        </div>
                    </form>

                    <!-- OUT-status hantering -->
                    <div class="mt-8 p-4 bg-gray-50 border-l-4 border-gray-500 rounded-r-lg">
                        <h3 class="text-lg font-medium text-gray-800 mb-3">🚫 OUT-status (skador/sjukdom)</h3>
                        <div class="flex flex-col sm:flex-row gap-3 mb-4">
                            <button type="button" onclick="loadOutList()" 
                                    class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md">
                                Ladda lista
                            </button>
                            <button type="button" onclick="saveAllOutStatus()" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">
                                Spara alla ändringar
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <div>
                                <h4 class="text-md font-medium text-gray-700 mb-2">450cc OUT-status</h4>
                                <div id="out-list-450" class="space-y-2 max-h-60 overflow-y-auto">
                                    <!-- OUT checkboxes will be populated here -->
                                </div>
                            </div>
                            <div>
                                <h4 class="text-md font-medium text-gray-700 mb-2">250cc OUT-status</h4>
                                <div id="out-list-250" class="space-y-2 max-h-60 overflow-y-auto">
                                    <!-- OUT checkboxes will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Management Tab -->
            <div id="user-management" class="tab-panel">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">👥 Användarhantering</h2>
                    
                    <div class="space-y-4">
                        <a href="/admin/users" class="inline-block bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                            Visa alla användare
                        </a>
                        <a href="/cleanup_duplicate_users" class="inline-block bg-yellow-600 text-white px-4 py-2 rounded-md hover:bg-yellow-700">
                            Rensa duplicerade användare
                        </a>
                        <a href="/admin_old" class="inline-block bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">
                            Gå till gamla admin-sidan
                        </a>
                    </div>
                </div>
            </div>

            <!-- System Tools Tab -->
            <div id="system-tools" class="tab-panel">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">🔧 Systemverktyg</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-3">
                            <h3 class="text-lg font-medium text-gray-800">Rider Data</h3>
                            <a href="/fix_existing_riders" class="block bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-center">
                                Fixa rider data
                            </a>
                            <a href="/fix_rider_coasts" class="block bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 text-center">
                                Fixa rider coasts
                            </a>
                            <a href="/debug_rider_coasts" class="block bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 text-center">
                                Debug rider coasts
                            </a>
                        </div>
                        
                        <div class="space-y-3">
                            <h3 class="text-lg font-medium text-gray-800">Database</h3>
                            <a href="/fix_bulletin_columns" class="block bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 text-center">
                                Fixa bulletin kolumner
                            </a>
                            <a href="/create_admin" class="block bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 text-center">
                                Skapa admin användare
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Countdown Test Tab -->
            <div id="countdown-test" class="tab-panel">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">⏰ Countdown Test</h2>
                    
                    <div class="space-y-4">
                        <a href="/test_countdown_page" class="inline-block bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                            Testa Countdown Scenarios
                        </a>
                        
                        <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                            <h3 class="text-lg font-medium text-gray-800 mb-2">Snabb Test</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                <button onclick="testScenario('race_in_3h')" class="bg-blue-500 text-white px-3 py-2 rounded text-sm hover:bg-blue-600">
                                    3h till race
                                </button>
                                <button onclick="testScenario('race_in_1h')" class="bg-orange-500 text-white px-3 py-2 rounded text-sm hover:bg-orange-600">
                                    1h till race
                                </button>
                                <button onclick="testScenario('race_in_30m')" class="bg-red-500 text-white px-3 py-2 rounded text-sm hover:bg-red-600">
                                    30m till race
                                </button>
                                <button onclick="testScenario('race_tomorrow')" class="bg-green-500 text-white px-3 py-2 rounded text-sm hover:bg-green-600">
                                    Imorgon
                                </button>
                            </div>
                            <button onclick="resetToRealTime()" class="mt-3 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                                Återställ till riktig tid
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab functionality
        function initTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabPanels = document.querySelectorAll('.tab-panel');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and panels
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabPanels.forEach(p => p.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding panel
                    btn.classList.add('active');
                    document.getElementById(targetTab).classList.add('active');
                });
            });
        }

        // Make coast map available to JavaScript
        window.__COMP_COAST_MAP__ = {{ comp_coast_map | tojson | safe }};
        let currentCompetitionCoast = null;
        let isSaving = false; // Prevent multiple simultaneous saves
        let originalOutStatus = {}; // Store original OUT status to detect changes
        
        // Initialize tabs when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initTabs();
            loadRaces();
            loadRiders();
            setupCompetitionListener();
            loadSavedResults();
            updateSelectedCompetitionInfo();
        });

        // Load races for simulation
        async function loadRaces() {
            try {
                // Use the same data as the old admin page
                const competitions = {{ competitions | tojson }};
                
                const select = document.getElementById('competition-select');
                select.innerHTML = '<option value="">-- Välj tävling --</option>';
                
                competitions.forEach(comp => {
                    const option = document.createElement('option');
                    option.value = comp.id;
                    let text = `${comp.name} (${comp.event_date})`;
                    if (comp.coast_250 === 'both') {
                        text += ' [Showdown]';
                    } else if (comp.coast_250) {
                        text += ` [250SX ${comp.coast_250.charAt(0).toUpperCase() + comp.coast_250.slice(1)}]`;
                    }
                    option.textContent = text;
                    select.appendChild(option);
                });
                
                // Restore previously selected competition from localStorage, but prioritize upcoming race
                const savedCompetition = localStorage.getItem('admin_selected_competition');
                if (savedCompetition) {
                    // Check if saved competition is still available
                    const savedOption = Array.from(select.options).find(opt => opt.value === savedCompetition);
                    if (savedOption) {
                        select.value = savedCompetition;
                        // Trigger change event to load results for saved competition
                        select.dispatchEvent(new Event('change'));
                    } else {
                        // If saved competition is not found, select first upcoming race
                        if (select.options.length > 1) {
                            select.selectedIndex = 1;
                            select.dispatchEvent(new Event('change'));
                        }
                    }
                } else {
                    // If no saved competition, select first upcoming race
                    if (select.options.length > 1) {
                        select.selectedIndex = 1;
                        select.dispatchEvent(new Event('change'));
                    }
                }
            } catch (error) {
                console.error('Error loading races:', error);
            }
        }

        // Load riders for picks
        async function loadRiders() {
            try {
                // Use the same data as the old admin page
                const riders_450 = {{ riders_450 | tojson }};
                const riders_250 = {{ riders_250 | tojson }};
                
                // Store riders data globally for use in other functions
                window.riders_450_data = riders_450;
                window.riders_250_data = riders_250;

                // Populate holeshot dropdowns
                const holeshot450 = document.getElementById('holeshot_450');
                holeshot450.innerHTML = '<option value="">-- Välj förare --</option>';
                riders_450.forEach(rider => {
                    const option = document.createElement('option');
                    option.value = rider.id;
                    option.textContent = `#${rider.rider_number} ${rider.name} (${rider.bike_brand})`;
                    option.setAttribute('data-coast', rider.coast_250 || '');
                    holeshot450.appendChild(option);
                });

                const holeshot250 = document.getElementById('holeshot_250');
                holeshot250.innerHTML = '<option value="">-- Välj förare --</option>';
                riders_250.forEach(rider => {
                    const option = document.createElement('option');
                    option.value = rider.id;
                    option.textContent = `#${rider.rider_number} ${rider.name} (${rider.bike_brand})`;
                    option.setAttribute('data-coast', rider.coast_250 || '');
                    holeshot250.appendChild(option);
                });

            } catch (error) {
                console.error('Error loading riders:', error);
            }
        }


        // Countdown test functions
        async function testScenario(scenario) {
            try {
                const response = await fetch(`/test_countdown?scenario=${scenario}`, {
                    method: 'GET'
                });
                
                const result = await response.json();
                
                if (result.error) {
                    alert(`Fel: ${result.error}`);
                } else {
                    alert(`Scenario "${scenario}" aktiverat!`);
                    // Reload the page to see the countdown changes
                    window.location.reload();
                }
            } catch (error) {
                console.error('Error testing scenario:', error);
                alert('Fel vid testning av scenario');
            }
        }

        async function resetToRealTime() {
            try {
                const response = await fetch('/reset_simulation', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('Återställt till riktig tid!');
                } else {
                    alert('Fel vid återställning');
                }
            } catch (error) {
                console.error('Error resetting time:', error);
                alert('Fel vid återställning');
            }
        }

        // Core admin functions from old admin page
        async function loadSavedResults() {
            syncHiddenCompetitionId();
            const comp = document.getElementById("competition-select").value;
            const c450 = document.getElementById("results-container-450");
            const c250 = document.getElementById("results-container-250");
            const hs450 = document.getElementById("holeshot_450");
            const hs250 = document.getElementById("holeshot_250");

            c450.innerHTML = "";
            c250.innerHTML = "";
            if (hs450) hs450.value = "";
            if (hs250) hs250.value = "";
            
            // Clear any existing status text from options
            document.querySelectorAll('option').forEach(opt => {
                opt.textContent = opt.textContent.replace(/ \(OUT\)| \(Fel coast\)/g, '');
            });
            
            // Clear all result dropdowns
            document.querySelectorAll('select[name="riders_450[]"], select[name="riders_250[]"]').forEach(select => {
                select.value = '';
            });
            
            // Get competition coast reliably using a map rendered from backend
            const selectEl = document.getElementById("competition-select");
            const selectedId = selectEl.value;
            const compMap = window.__COMP_COAST_MAP__ || {};
            currentCompetitionCoast = compMap[selectedId] || null;
            console.log(`DEBUG: Competition coast set to: ${currentCompetitionCoast}`);
            
            // Update competition info display
            updateSelectedCompetitionInfo();
            
            if (!comp) return;

            // Always ensure we have exactly 20 rows for 450cc and 6 rows for 250cc
            // Use setTimeout to prevent blocking the UI
            setTimeout(async () => {
                while (document.getElementById("results-container-450").children.length < 20) {
                    addResultRow("450");
                }
                while (document.getElementById("results-container-250").children.length < 6) {
                    addResultRow("250");
                }
                
                // Add event listeners after all rows are created
                addEventListeners();
                
                // Apply coast filtering to all dropdowns
                validateAndUpdateDropdowns('450');
                validateAndUpdateDropdowns('250');
                
                // Load existing results after rows are created
                await loadExistingResults(comp);
            }, 10);
        }

        function addResultRow(cls, position = null) {
            const container = document.getElementById(`results-container-${cls}`);
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            
            const selectName = `riders_${cls}[]`;
            const currentPosition = position || (container.children.length + 1);
            
            div.innerHTML = `
                <span class="w-8 text-sm font-medium text-gray-600">${currentPosition}.</span>
                <input type="hidden" name="positions_${cls}[]" value="${currentPosition}">
                <select name="${selectName}" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Välj förare --</option>
                </select>
            `;
            
            const select = div.querySelector('select');
            
            // Populate with riders
            const riders = cls === '450' ? window.riders_450_data : window.riders_250_data;
            if (riders) {
                riders.forEach(rider => {
                    const option = document.createElement('option');
                    option.value = rider.id;
                    option.textContent = `#${rider.rider_number} ${rider.name} (${rider.bike_brand})`;
                    option.setAttribute('data-coast', rider.coast_250 || '');
                    select.appendChild(option);
                });
            }
            
            container.appendChild(div);
        }

        function addEventListeners() {
            // Add event listeners to all dropdowns
            document.querySelectorAll('select[name="riders_450[]"]').forEach(select => {
                select.addEventListener('change', function() {
                    validateAndUpdateDropdowns('450');
                });
            });
            document.querySelectorAll('select[name="riders_250[]"]').forEach(select => {
                select.addEventListener('change', function() {
                    validateAndUpdateDropdowns('250');
                });
            });
            
            // Update holeshot dropdowns with coast validation
            updateHoleshotDropdowns();
        }

        // Update holeshot dropdowns with coast validation
        function updateHoleshotDropdowns() {
            const holeshot250 = document.getElementById('holeshot_250');
            if (holeshot250 && currentCompetitionCoast && currentCompetitionCoast !== 'both') {
                for (const opt of holeshot250.options) {
                    if (!opt.value) continue;
                    const riderCoast = opt.getAttribute('data-coast');
                    if (riderCoast) {
                        const isWrongCoast = riderCoast !== currentCompetitionCoast && riderCoast !== 'both';
                        opt.disabled = isWrongCoast;
                        opt.style.color = isWrongCoast ? '#999' : '';
                        
                        if (isWrongCoast && !opt.textContent.includes('(Fel coast)')) {
                            opt.textContent = opt.textContent + ' (Fel coast)';
                            console.log(`DEBUG: Holeshot - Disabling rider ${opt.textContent} - rider coast: ${riderCoast}, competition coast: ${currentCompetitionCoast}`);
                        } else if (!isWrongCoast && opt.textContent.includes('(Fel coast)')) {
                            opt.textContent = opt.textContent.replace(' (Fel coast)', '');
                        }
                    }
                }
            }
        }

        async function loadExistingResults(compId) {
            try {
                console.log(`DEBUG: Loading existing results for competition ${compId}`);
                
                // FIRST: Clear all dropdowns to prevent old results from staying
                console.log('DEBUG: Clearing all dropdowns first');
                document.querySelectorAll('select[name="riders_450[]"]').forEach(select => {
                    select.value = '';
                });
                document.querySelectorAll('select[name="riders_250[]"]').forEach(select => {
                    select.value = '';
                });
                const hs450Select = document.getElementById("holeshot_450");
                const hs250Select = document.getElementById("holeshot_250");
                if (hs450Select) hs450Select.value = '';
                if (hs250Select) hs250Select.value = '';
                
                const response = await fetch(`/admin/get_results/${compId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('DEBUG: Got results data:', data);
                    
                    // Load 450cc results
                    if (data.results_450 && data.results_450.length > 0) {
                        console.log(`DEBUG: Loading ${data.results_450.length} 450cc results`);
                        data.results_450.forEach((result, index) => {
                            const selects = document.querySelectorAll('select[name="riders_450[]"]');
                            if (selects[index]) {
                                selects[index].value = result.rider_id;
                                console.log(`DEBUG: Set 450cc position ${index + 1} to rider ${result.rider_id}`);
                            }
                        });
                    }
                    
                    // Load 250cc results
                    if (data.results_250 && data.results_250.length > 0) {
                        console.log(`DEBUG: Loading ${data.results_250.length} 250cc results`);
                        data.results_250.forEach((result, index) => {
                            const selects = document.querySelectorAll('select[name="riders_250[]"]');
                            if (selects[index]) {
                                selects[index].value = result.rider_id;
                                console.log(`DEBUG: Set 250cc position ${index + 1} to rider ${result.rider_id}`);
                            }
                        });
                    }
                    
                    // Load holeshot results
                    if (data.holeshot_450) {
                        const hs450Select = document.getElementById("holeshot_450");
                        if (hs450Select) {
                            hs450Select.value = data.holeshot_450;
                            console.log(`DEBUG: Set 450cc holeshot to ${data.holeshot_450}`);
                        }
                    }
                    if (data.holeshot_250) {
                        const hs250Select = document.getElementById("holeshot_250");
                        if (hs250Select) {
                            hs250Select.value = data.holeshot_250;
                            console.log(`DEBUG: Set 250cc holeshot to ${data.holeshot_250}`);
                        }
                    }
                    
                    // Update dropdowns after loading results
                    validateAndUpdateDropdowns('450');
                    validateAndUpdateDropdowns('250');
                    
                } else {
                    console.log('DEBUG: No existing results found or error loading');
                }
            } catch (error) {
                console.error('Error loading existing results:', error);
            }
        }

        async function simulateForSelected() {
            const comp = document.getElementById("competition-select").value;
            if (!comp) {
                alert("Välj en tävling först.");
                return;
            }
            try {
                const res = await fetch(`/admin/simulate/${comp}`, { method: "POST" });
                if (res.redirected) {
                    window.location.href = res.url;
                    return;
                }
                await loadSavedResults();
                showToast("Simulering klar!", true);
            } catch (e) {
                console.error(e);
                showToast("Kunde inte köra simuleringen.", false);
            }
        }

        async function clearCurrentCompetitionResults() {
            const comp = document.getElementById("competition-select").value;
            if (!comp) {
                alert("Välj en tävling först.");
                return;
            }
            
            if (!confirm("Är du säker på att du vill rensa alla resultat för denna tävling?")) {
                return;
            }
            
            try {
                const res = await fetch(`/admin/clear_results/${comp}`, { method: "POST" });
                if (res.ok) {
                    await loadSavedResults();
                    showToast("Resultat rensade!", true);
                } else {
                    showToast("Kunde inte rensa resultat.", false);
                }
            } catch (e) {
                console.error(e);
                showToast("Kunde inte rensa resultat.", false);
            }
        }

        function syncHiddenCompetitionId() {
            const comp = document.getElementById("competition-select").value;
            const hidden = document.getElementById("competition_id_hidden");
            if (hidden) {
                hidden.value = comp;
            }
        }

        function validateAndUpdateDropdowns(cls) {
            const selects = document.querySelectorAll(`select[name="riders_${cls}[]"]`);
            const selectedValues = Array.from(selects)
                .map(sel => sel.value)
                .filter(val => val);
            
            // Get current OUT riders for this competition
            const outCheckboxes = document.querySelectorAll('#out-list-450 input[type="checkbox"]:checked, #out-list-250 input[type="checkbox"]:checked');
            const outRiderIds = Array.from(outCheckboxes).map(cb => cb.id.replace('out-', ''));
            
            // Remove options that are selected elsewhere, OUT, or wrong coast
            selects.forEach(select => {
                const currentValue = select.value;
                const optionsToRemove = [];
                
                Array.from(select.options).forEach(option => {
                    if (option.value && option.value !== currentValue) {
                        // Check if this option is selected in another dropdown
                        const isSelectedElsewhere = Array.from(selects)
                            .some(otherSelect => otherSelect !== select && otherSelect.value === option.value);
                        
                        // Check if this rider is OUT
                        const isOut = outRiderIds.includes(option.value);
                        
                        // Check coast for 250cc riders
                        let isWrongCoast = false;
                        if (cls === '250' && currentCompetitionCoast && currentCompetitionCoast !== 'both') {
                            const riderCoast = option.getAttribute('data-coast');
                            if (riderCoast) {
                                isWrongCoast = riderCoast !== currentCompetitionCoast && riderCoast !== 'both';
                                if (isWrongCoast) {
                                    console.log(`DEBUG: Removing rider ${option.textContent} - rider coast: ${riderCoast}, competition coast: ${currentCompetitionCoast}`);
                                }
                            }
                        }
                        
                        // Remove option if it's selected elsewhere, OUT, or wrong coast
                        if (isSelectedElsewhere || isOut || isWrongCoast) {
                            optionsToRemove.push(option);
                        }
                    }
                });
                
                // Remove options that shouldn't be shown
                optionsToRemove.forEach(opt => {
                    if (opt.value !== currentValue) {
                        opt.remove();
                    }
                });
            });
        }

        function validateResults() {
            console.log("DEBUG: validateResults called");
            
            // Check for duplicates in 450cc results
            const riders450 = Array.from(document.querySelectorAll('select[name="riders_450[]"]'))
                .map(sel => sel.value)
                .filter(val => val);
            
            if (riders450.length !== new Set(riders450).size) {
                alert("Du kan inte sätta samma 450cc-förare flera gånger.");
                return false;
            }
            
            // Check for duplicates in 250cc results
            const riders250 = Array.from(document.querySelectorAll('select[name="riders_250[]"]'))
                .map(sel => sel.value)
                .filter(val => val);
            
            if (riders250.length !== new Set(riders250).size) {
                alert("Du kan inte sätta samma 250cc-förare flera gånger.");
                return false;
            }
            
            // Check that exactly 20 riders are selected for 450cc and 6 for 250cc
            if (riders450.length !== 20) {
                alert("Du måste välja exakt 20 förare för 450cc (för wildcard-funktionen).");
                return false;
            }
            
            if (riders250.length !== 6) {
                alert("Du måste välja exakt 6 förare för 250cc (Top 6).");
                return false;
            }
            
            console.log("DEBUG: Validation passed, submitting form");
            return true;
        }

        function showToast(msg, ok = true) {
            let t = document.getElementById("toast");
            if (!t) {
                t = document.createElement("div");
                t.id = "toast";
                t.style.position = "fixed";
                t.style.bottom = "20px";
                t.style.right = "20px";
                t.style.padding = "12px 16px";
                t.style.borderRadius = "8px";
                t.style.color = "#fff";
                t.style.fontWeight = "bold";
                t.style.zIndex = "9999";
                t.style.transition = "opacity .25s ease";
                document.body.appendChild(t);
            }
            t.style.background = ok ? "#16a34a" : "#dc2626";
            t.textContent = msg;
            t.style.opacity = "1";
            setTimeout(() => (t.style.opacity = "0"), 1800);
        }

        function updateSelectedCompetitionInfo() {
            const comp = document.getElementById("competition-select").value;
            const info = document.getElementById("selected-competition-info");
            const name = document.getElementById("selected-competition-name");
            
            if (comp && info && name) {
                const selectedOption = document.querySelector(`#competition-select option[value="${comp}"]`);
                if (selectedOption) {
                    name.textContent = selectedOption.textContent;
                    info.style.display = "block";
                }
            } else if (info) {
                info.style.display = "none";
            }
        }

        // Initialize result rows when competition is selected
        function setupCompetitionListener() {
            const competitionSelect = document.getElementById("competition-select");
            if (competitionSelect) {
                competitionSelect.addEventListener('change', function() {
                    // Save selected competition to localStorage
                    const selectedValue = this.value;
                    if (selectedValue) {
                        localStorage.setItem('admin_selected_competition', selectedValue);
                    } else {
                        localStorage.removeItem('admin_selected_competition');
                    }
                    
                    loadSavedResults();
                });
            }
        }
        
        function syncWithHomepage() {
            // Force select the first upcoming race to match homepage logic
            const select = document.getElementById('competition-select');
            if (select && select.options.length > 1) {
                select.selectedIndex = 1; // First upcoming race (skip "-- Välj tävling --")
                select.dispatchEvent(new Event('change'));
            }
        }

        // OUT-status functions
        async function loadOutList() {
            const comp = document.getElementById("competition-select").value;
            if (!comp) { 
                alert("Välj en tävling först."); 
                return; 
            }
            try {
                const res = await fetch(`/admin/get_out_status/${comp}`);
                if (!res.ok) throw new Error("fetch failed");
                const riders = await res.json();

                const c450 = document.getElementById("out-list-450");
                const c250 = document.getElementById("out-list-250");
                c450.innerHTML = "";
                c250.innerHTML = "";

                const render = (container, list) => {
                    list.forEach(r => {
                        const id = `out-${r.id}`;
                        const row = document.createElement("label");
                        row.className = "flex items-center gap-2 bg-white p-2 rounded border";
                        row.innerHTML = `
                            <input type="checkbox" id="${id}" ${r.is_out ? "checked" : ""}>
                            <span class="flex-1 text-sm">#${r.rider_number || "-"} ${r.name} <span class="text-gray-400 text-xs">(${r.bike_brand || "—"})</span></span>
                        `;
                        container.appendChild(row);
                    });
                };

                render(c450, riders.filter(r => r.class === "450cc"));
                render(c250, riders.filter(r => r.class === "250cc"));
                
                // Store original OUT status for change detection
                originalOutStatus = {};
                riders.forEach(r => {
                    originalOutStatus[r.id] = r.is_out;
                });
            } catch (e) {
                console.error(e);
                showToast("Kunde inte ladda OUT-lista", false);
            }
        }

        async function saveAllOutStatus() {
            if (isSaving) {
                console.log("Already saving, ignoring duplicate call");
                return;
            }
            
            isSaving = true;
            console.log("saveAllOutStatus called");
            
            const comp = document.getElementById("competition-select").value;
            if (!comp) { 
                alert("Välj en tävling först."); 
                isSaving = false;
                return; 
            }
            
            console.log("Competition selected:", comp);
            
            // Get all checkboxes and only save those that have changed
            const checkboxes = document.querySelectorAll('#out-list-450 input[type="checkbox"], #out-list-250 input[type="checkbox"]');
            console.log("Found checkboxes:", checkboxes.length);
            
            let saved = 0;
            let errors = 0;
            let changes = 0;
            
            for (const checkbox of checkboxes) {
                const riderId = checkbox.id.replace('out-', '');
                const isOut = checkbox.checked;
                const originalStatus = originalOutStatus[riderId];
                
                console.log(`DEBUG: Rider ${riderId}, current: ${isOut}, original: ${originalStatus}`);
                
                // Only save if status has changed
                if (originalStatus !== isOut) {
                    changes++;
                    console.log(`Processing rider ${riderId}, isOut: ${isOut} (changed from ${originalStatus})`);
                    
                    try {
                        const res = await fetch("/admin/set_out_status", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                competition_id: parseInt(comp, 10),
                                rider_id: parseInt(riderId, 10),
                                status: isOut ? "OUT" : "CLEAR",
                            }),
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || "save failed");
                        saved++;
                        console.log(`Saved rider ${riderId}`);
                    } catch (e) {
                        console.error(`Error saving rider ${riderId}:`, e);
                        errors++;
                    }
                }
            }
            
            console.log(`Final result: ${saved} saved, ${errors} errors, ${changes} changes detected`);
            
            if (changes === 0) {
                alert("Inga ändringar att spara.");
            } else if (errors === 0) {
                alert(`${saved} ändringar sparade!`);
                
                // Update original status to current status
                checkboxes.forEach(checkbox => {
                    const riderId = checkbox.id.replace('out-', '');
                    originalOutStatus[riderId] = checkbox.checked;
                });
                
                // Update dropdowns to reflect OUT status changes
                validateAndUpdateDropdowns('450');
                validateAndUpdateDropdowns('250');
            } else {
                alert(`${saved} sparade, ${errors} fel`);
            }
            
            isSaving = false;
        }
    </script>
</body>
</html>
