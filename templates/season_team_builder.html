<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Skapa ditt Säsongsteam</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .rider-card { 
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    .rider-card:hover { 
      transform: translateY(-6px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      border-color: #3b82f6;
    }
    .rider-card.selected {
      border-color: #10b981;
      background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
    }
    .btn-add {
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    .btn-add:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    .btn-add:disabled { 
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      cursor: not-allowed; 
      opacity: 0.6; 
    }
    .btn-add.selected {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    .rule-valid { color: #10b981; font-weight: 600; }
    .rule-invalid { color: #ef4444; font-weight: 600; }
    .budget-bar {
      height: 8px;
      background: linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #ef4444 100%);
      border-radius: 4px;
      transition: all 0.3s ease;
    }
    .budget-fill {
      height: 100%;
      background: linear-gradient(90deg, #1f2937 0%, #374151 100%);
      border-radius: 4px;
      transition: all 0.3s ease;
    }
    .team-card {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 2px solid #e2e8f0;
      transition: all 0.3s ease;
    }
    .team-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 10px 25px rgba(59, 130, 246, 0.1);
    }
    .filter-btn {
      transition: all 0.2s ease;
      position: relative;
    }
    .filter-btn.active {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    .filter-btn:hover:not(.active) {
      transform: scale(1.02);
    }
    #toast { 
      position: fixed; 
      bottom: 20px; 
      left: 50%;
             transform: translateX(-50%) translateY(100px);
      padding: 16px 24px; 
      border-radius: 12px;
      color: white; 
      font-weight: bold;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
      z-index: 1000; 
    }
    #toast.show { transform: translateX(-50%) translateY(0) scale(1.05); }
    #toast.success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    #toast.error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    .rider-image {
      border: 3px solid #e5e7eb;
      transition: all 0.3s ease;
    }
    .rider-card:hover .rider-image {
      border-color: #3b82f6;
      transform: scale(1.1);
    }
    .price-tag {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .header-gradient {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #06b6d4 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-sans">
  <div id="toast"></div>

  <div class="container mx-auto p-3 sm:p-4 md:p-8">
    <!-- Header - Responsiv layout -->
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 sm:mb-8 gap-4">
      <header>
        {% if has_existing_team %}
        <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold header-gradient">Redigera Säsongsteam</h1>
        <p class="text-base sm:text-lg mt-2 text-gray-600 dark:text-gray-400">
          Inloggad som: <strong class="text-blue-600">{{ username }}</strong>
        </p>
        <div class="mt-3 p-3 bg-yellow-100 border border-yellow-300 rounded-lg">
          <p class="text-yellow-800 text-sm font-medium">
            ⚠️ <strong>Teamändring kostar 50 poäng per byte!</strong> Du har redan ett team: <strong>{{ existing_team.team_name }}</strong>
          </p>
        </div>
        {% else %}
        <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold header-gradient">Skapa ditt Säsongsteam</h1>
        <p class="text-base sm:text-lg mt-2 text-gray-600 dark:text-gray-400">
          Inloggad som: <strong class="text-blue-600">{{ username }}</strong>
        </p>
        {% endif %}
        
        <!-- Poängvisning -->
        <div id="points-display" class="mt-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-lg font-semibold text-blue-800">💰 Dina Poäng</h3>
              <p class="text-sm text-blue-600">Totalt tillgängliga poäng</p>
            </div>
            <div class="text-right">
              <div id="current-points" class="text-2xl font-bold text-blue-800">Laddar...</div>
              <div id="penalty-preview" class="text-sm text-red-600 font-medium hidden">
                -<span id="penalty-amount">0</span><span class="penalty-text"> poäng för byten</span>
              </div>
            </div>
          </div>
          <div class="mt-2">
            <div class="text-xs text-gray-600">
              <span id="points-after-change" class="font-medium">Efter ändring: <span id="points-after-amount">-</span> poäng</span>
            </div>
          </div>
        </div>
      </header>
      <a href="{{ url_for('index') }}"
         class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 sm:px-4 rounded text-sm sm:text-base self-start sm:self-center">
        Tillbaka
      </a>
    </div>

    <main class="space-y-4 sm:space-y-6">
      <!-- Nuvarande team (om det finns) - kompakt version ovanför -->
      {% if has_existing_team %}
      <div class="current-team-card bg-white dark:bg-gray-800 p-3 rounded-lg shadow-lg border-2 border-yellow-400">
        <h2 class="text-lg font-semibold mb-2 border-b border-yellow-200 pb-1 text-yellow-600">⭐ Nuvarande Team</h2>
        <div id="current-team-list" class="grid grid-cols-4 gap-2">
          <!-- Current team riders will be loaded here -->
        </div>
        <div class="mt-2 p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded border border-yellow-200">
          <p class="text-xs text-yellow-800 dark:text-yellow-200 mb-1">
            💡 <strong>Tips:</strong> Klicka "Byt ut" för att ersätta en förare, eller kopiera teamet som start.
          </p>
          <button onclick="copyCurrentTeam()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-2 py-1 rounded text-xs font-medium transition-colors">
            📋 Kopiera nuvarande team som start
          </button>
        </div>
      </div>
      {% endif %}

      <!-- Huvudlayout med grid -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6 lg:gap-8">
        <!-- Riderlista -->
        <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg">
          <h2 class="text-xl sm:text-2xl font-semibold mb-3 sm:mb-4 border-b pb-2">Välj Förare</h2>

          <div class="mb-3 sm:mb-4 flex flex-wrap gap-2 items-center">
            <button id="tab-all" class="filter-btn px-3 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium active" onclick="setFilter('all')">
              🏍️ Alla
            </button>
            <button id="tab-450" class="filter-btn px-3 py-2 rounded-lg bg-gray-600 text-white text-sm font-medium" onclick="setFilter('450cc')">
              🔥 450cc
            </button>
            <button id="tab-250" class="filter-btn px-3 py-2 rounded-lg bg-gray-600 text-white text-sm font-medium" onclick="setFilter('250cc')">
              ⚡ 250cc
            </button>
            <span class="text-xs text-gray-500 ml-2 bg-gray-100 px-2 py-1 rounded">💡 Klicka på + för att lägga till</span>
        </div>

          <div id="rider-list" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-3 sm:gap-4"></div>
      </div>

      <!-- Ditt team -->
      <div class="team-card bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-xl h-fit sticky top-4 sm:top-8">
        <h2 class="text-xl sm:text-2xl font-semibold mb-4 border-b-2 border-blue-200 pb-3 text-blue-600">
          {% if has_existing_team %}🔄 Nytt Team{% else %}🏆 Ditt Team{% endif %}
        </h2>

        <div class="mb-4">
          <label for="team-name-input" class="block dark:text-gray-300 mb-2 text-sm font-medium">Teamnamn:</label>
          <input type="text" id="team-name-input"
                 class="w-full p-3 border-2 border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                 placeholder="T.ex. Team Awesome" 
                 {% if has_existing_team %}value="{{ existing_team.team_name }}"{% endif %}
                 oninput="validateAndRender()" />
        </div>

        <div class="mb-4 p-4 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-gray-700 dark:to-gray-600 rounded-lg border border-blue-200">
          <h4 class="font-semibold mb-3 text-sm text-blue-700 dark:text-blue-300">📋 Regler:</h4>
          <ul class="space-y-2 text-sm">
            <li id="rule-total" class="flex justify-between items-center">
              <span>👥 Totalt:</span><span class="font-mono">0 / 4</span>
            </li>
            <li id="rule-450" class="flex justify-between items-center">
              <span>🔥 450cc:</span><span class="font-mono">0 / 2</span>
            </li>
            <li id="rule-250" class="flex justify-between items-center">
              <span>⚡ 250cc:</span><span class="font-mono">0 / 2</span>
            </li>
            <li id="rule-budget" class="flex justify-between items-center">
              <span>💰 Budget:</span>
              <span id="budget-remaining" class="font-mono text-green-600 font-bold">1 500 000</span>
            </li>
          </ul>
          
          <!-- Budget Progress Bar -->
          <div class="mt-3">
            <div class="budget-bar">
              <div class="budget-fill" id="budget-progress" style="width: 0%"></div>
            </div>
          </div>
        </div>

        <div id="your-team-list" class="space-y-2 sm:space-y-3"></div>

        <button onclick="saveSeasonTeam()"
                id="save-team-btn"
                class="mt-6 w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 font-bold py-3 px-4 rounded-lg text-white disabled:opacity-60 disabled:cursor-not-allowed text-sm sm:text-base transition-all duration-200 transform hover:scale-105 shadow-lg"
                disabled>
          {% if has_existing_team %}
          ⚠️ Uppdatera Team (-50 poäng)
          {% else %}
          💾 Spara Team
          {% endif %}
        </button>
      </div>
      </div> <!-- End grid container -->
    </main>
  </div>

  <script>
    // Data från servern (se till att du skickar 'riders' i samma format som tidigare)
    const allRiders = {{ riders | tojson | safe }};
    const hasExistingTeam = {{ has_existing_team | tojson | safe }};
    const existingTeamRiders = {{ existing_team_riders | tojson | safe }};

    // Konfiguration
    const totalBudget = 1500000;

    // App-state
    let budget = totalBudget;
    let myTeam = [];
    let classFilter = "all";
    let currentTeam = []; // Store current team riders

    function showToast(msg, ok = true) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.className = ok ? "success" : "error";
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 2500);
    }

    function setFilter(cls) {
      classFilter = cls;
      
      // Update filter buttons with new classes
      const allBtn = document.getElementById("tab-all");
      const btn450 = document.getElementById("tab-450");
      const btn250 = document.getElementById("tab-250");
      
      allBtn.className = "filter-btn px-3 py-2 rounded-lg text-white text-sm font-medium " + 
        (cls === "all" ? "bg-blue-600 active" : "bg-gray-600");
      btn450.className = "filter-btn px-3 py-2 rounded-lg text-white text-sm font-medium " + 
        (cls === "450cc" ? "bg-blue-600 active" : "bg-gray-600");
      btn250.className = "filter-btn px-3 py-2 rounded-lg text-white text-sm font-medium " + 
        (cls === "250cc" ? "bg-blue-600 active" : "bg-gray-600");

      renderRiderList();
    }

    function formatCurrency(v) {
      return new Intl.NumberFormat("sv-SE").format(v);
    }

    function riderCardHTML(r) {
      const isSelected = myTeam.some(x => x.id === r.id);
      const canAdd = canAddRider(r);
      
      // In replacement mode, no rider is too expensive since we're swapping
      let isTooExpensive = false;
      
      // Bygg HTML för rider-kortet: visa image_url om finns, annars logga/placeholder
      const imgHtml = r.image_url
        ? `<img src="${window.location.origin}${window.location.pathname.includes('/static') ? '' : ''}${(r.image_url.startsWith('/') ? '/static' : '/static/') + r.image_url}"
                alt="${r.name} headshot"
                class="rider-image w-12 h-12 object-cover rounded-full" width="48" height="48"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="w-12 h-12 bg-gradient-to-br from-gray-600 to-gray-700 rounded-full flex items-center justify-center" style="display: none;">
              ${r.bike_brand 
                ? `<img src="/static/brand_logos/${r.bike_brand.toLowerCase()}.png" 
                       alt="${r.bike_brand} logo" 
                       class="w-8 h-8 object-contain"
                       onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                  <span class="text-white text-xs font-bold" style="display: none;">#${r.rider_number}</span>`
                : `<span class="text-white text-xs font-bold">#${r.rider_number}</span>`}
            </div>`
        : (r.bike_brand
            ? `<img src="{{ url_for('static', filename='brand_logos') }}/${(r.bike_brand || '').toLowerCase()}.png"
                   alt="${r.bike_brand} logo"
                   class="rider-image w-12 h-12 object-contain" width="48" height="48" />`
            : `<div class="w-12 h-12 bg-gradient-to-br from-gray-600 to-gray-700 rounded-full flex items-center justify-center">
                 <span class="text-white text-xs font-bold">#${r.rider_number}</span>
               </div>`);

      // Bygg HTML för nummer-cirkeln med olika färger för 450cc och 250cc
      const numberBgClass = r.class === "450cc" 
        ? "bg-gradient-to-br from-orange-500 to-red-600" 
        : "bg-gradient-to-br from-yellow-400 to-orange-500";
      
      const numberHtml = `<div class="w-10 h-10 ${numberBgClass} rounded-full flex items-center justify-center shadow-lg">
        <span class="text-white text-sm font-bold">#${r.rider_number || "-"}</span>
      </div>`;

      return `
        <div class="rider-card bg-white dark:bg-gray-700 p-4 rounded-xl shadow-lg flex items-center gap-4 ${isSelected ? 'selected' : ''} ${isTooExpensive ? 'opacity-60' : ''}">
          <div class="flex-shrink-0 flex items-center gap-3">
            ${imgHtml}
            ${numberHtml}
          </div>
          <div class="flex-1">
            <div class="font-bold text-gray-800 dark:text-gray-200">${r.name}</div>
            <div class="text-xs text-gray-600 dark:text-gray-300 mb-1">
              ${r.class === '450cc' ? '🔥' : '⚡'} ${r.class}
            </div>
            <div class="text-xs text-gray-500 dark:text-gray-400 mb-2">${r.bike_brand || "—"}</div>
            <div class="price-tag inline-block ${isTooExpensive ? 'text-red-600 font-bold' : ''}">${formatCurrency(r.price)} kr</div>
            ${isTooExpensive ? '<div class="text-xs text-red-600 font-medium mt-1">För dyr att byta till!</div>' : ''}
          </div>
          <button class="btn-add px-4 py-2 text-white rounded-lg font-medium text-sm ${isSelected ? 'selected' : isTooExpensive ? 'bg-red-500 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600'}"
                  ${!canAdd ? "disabled" : ""}>
            ${isSelected ? "✅ Vald" : isTooExpensive ? "❌ För dyr" : "➕ Lägg till"}
          </button>
        </div>
      `;
    }

    function renderRiderList() {
      const container = document.getElementById("rider-list");
      container.innerHTML = "";
      const filtered = allRiders.filter(
        (r) => classFilter === "all" || r.class === classFilter
      );

      filtered.forEach((r) => {
        const wrapper = document.createElement("div");
        wrapper.innerHTML = riderCardHTML(r);
        const btn = wrapper.querySelector(".btn-add");
        btn.onclick = (event) => {
          console.log("🖱️ Button clicked for rider:", r.name, "ID:", r.id);
          event.stopPropagation();
          addRider(r);
        };
        container.appendChild(wrapper.firstElementChild);
      });
    }

    function canAddRider(r) {
      // If we're in replacement mode, check price and class restrictions
      if (window.replacingRiderId) {
        const riderToReplace = currentTeam.find(rt => rt.id === window.replacingRiderId);
        if (riderToReplace && r.class === riderToReplace.class) {
          // In replacement mode, we can replace with any rider of the same class
          // regardless of price, since we're swapping riders
          return true; // Allow replacement of same class with any price
        }
        return false; // Don't allow different class
      }
      
      // Normal validation
      if (myTeam.length >= 4) return false;
      if (r.price > budget) return false;
      const c450 = myTeam.filter((x) => x.class === "450cc").length;
      const c250 = myTeam.filter((x) => x.class === "250cc").length;
      if (r.class === "450cc" && c450 >= 2) return false;
      if (r.class === "250cc" && c250 >= 2) return false;
      return true;
    }

    function addRider(r) {
      console.log("🎯 addRider called with:", r.name, "ID:", r.id);
      console.log("🎯 window.replacingRiderId:", window.replacingRiderId);
      console.log("💰 BUDGET BEFORE addRider:", budget);
      
      // Check if we're replacing a rider
      if (window.replacingRiderId) {
        // Find the rider being replaced
        const riderToReplace = currentTeam.find(rt => rt.id === window.replacingRiderId);
        console.log("🎯 riderToReplace in addRider:", riderToReplace);
        
        // Don't allow selecting the same rider that's being replaced
        if (r.id === window.replacingRiderId) {
          showToast(`Du kan inte ersätta ${r.name} med sig själv!`, false);
          return;
        }
        
        if (riderToReplace && r.class === riderToReplace.class) {
          // Check if user has enough points for this change
          const ridersChanged = calculateRidersChanged() + 1; // +1 because we're about to change one more rider
          const penaltyPoints = ridersChanged * 50;
          
          // Get current user points
          fetch("/get_user_total_points")
            .then(response => response.json())
            .then(pointsData => {
              if (pointsData.total_points < penaltyPoints) {
                showToast(`Du har inte tillräckligt med poäng! Du har ${pointsData.total_points} poäng men behöver ${penaltyPoints} poäng för att byta ${ridersChanged} förare.`, false);
                return;
              }
              
              // User has enough points, proceed with the replacement
              // Remove the old rider from myTeam first
              const oldRiderIndex = myTeam.findIndex(rt => rt.id === window.replacingRiderId);
              if (oldRiderIndex > -1) {
                const oldRider = myTeam[oldRiderIndex];
                budget += oldRider.price; // Return budget for old rider
                myTeam.splice(oldRiderIndex, 1); // Remove old rider
                console.log("🗑️ Removed old rider:", oldRider.name, "from myTeam");
                console.log("💰 Budget after removing old rider:", budget);
              }
              
              // Add the new rider
              myTeam.push(r);
              budget -= r.price;
              console.log("➕ Added new rider:", r.name, "to myTeam");
              console.log("💰 BUDGET AFTER adding new rider:", budget);
              
              // Clear the replacement mode
              window.replacingRiderId = null;
              
              // Show success message with budget info
              const budgetDiff = r.price - riderToReplace.price;
              if (budgetDiff > 0) {
                showToast(`${r.name} ersätter ${riderToReplace.name}. Kostar ${budgetDiff.toLocaleString()} kr mer.`, true);
              } else if (budgetDiff < 0) {
                showToast(`${r.name} ersätter ${riderToReplace.name}. Sparar ${Math.abs(budgetDiff).toLocaleString()} kr!`, true);
              } else {
                showToast(`${r.name} ersätter ${riderToReplace.name}. Samma pris.`, true);
              }
              
              validateAndRender();
              
              // Re-render current team to clear highlighting
              renderCurrentTeam();
            })
            .catch(error => {
              console.error("Error checking user points:", error);
              showToast("Ett fel uppstod vid kontroll av poäng. Försök igen.", false);
            });
          return;
        } else if (riderToReplace && r.class === riderToReplace.class && r.price > riderToReplace.price) {
          showToast(`${r.name} kostar ${r.price.toLocaleString()} kr, men ${riderToReplace.name} kostade bara ${riderToReplace.price.toLocaleString()} kr. Du kan inte byta till en dyrare förare!`, false);
          return;
        } else {
          showToast(`Du måste välja en ${riderToReplace?.class || 'annan'} förare`, false);
          return;
        }
      }
      
      // Normal add rider logic
      if (!canAddRider(r)) return;
      if (myTeam.some((x) => x.id === r.id)) return;
      myTeam.push(r);
      budget -= r.price;
      validateAndRender();
    }

    function removeRider(id) {
      const idx = myTeam.findIndex((x) => x.id === id);
      if (idx > -1) {
        budget += myTeam[idx].price;
        myTeam.splice(idx, 1);
        validateAndRender();
      }
    }

    function validateAndRender() {
      console.log("💰 validateAndRender debug:");
      console.log("💰 myTeam riders:", myTeam.map(r => `${r.name}: ${r.price.toLocaleString()} kr`));
      console.log("💰 myTeam total cost:", myTeam.reduce((sum, r) => sum + r.price, 0).toLocaleString());
      console.log("💰 current budget:", budget.toLocaleString());
      
      // Render teamlistan
      const list = document.getElementById("your-team-list");
      list.innerHTML = myTeam.length ? "" : "<p class='text-gray-500'>Välj förare från listan.</p>";

      myTeam.forEach((r) => {
        const row = document.createElement("div");
        row.className = "flex justify-between items-center bg-gradient-to-r from-green-50 to-emerald-50 dark:from-gray-700 dark:to-gray-600 p-3 rounded-lg border border-green-200 dark:border-gray-600";
        row.innerHTML = `
          <div class="flex items-center gap-3">
            ${r.image_url
              ? `<img src="${(r.image_url.startsWith('/') ? '/static' : '/static/') + r.image_url}"
                       alt="${r.name} headshot"
                       class="w-10 h-10 object-cover rounded-full border-2 border-green-300" width="40" height="40"
                       onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                   <div class="w-10 h-10 bg-gradient-to-br from-green-600 to-emerald-600 rounded-full flex items-center justify-center" style="display: none;">
                     ${r.bike_brand 
                       ? `<img src="/static/brand_logos/${r.bike_brand.toLowerCase()}.png" 
                              alt="${r.bike_brand} logo" 
                              class="w-6 h-6 object-contain"
                              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                         <span class="text-white text-xs font-bold" style="display: none;">#${r.rider_number}</span>`
                       : `<span class="text-white text-xs font-bold">#${r.rider_number}</span>`}
                   </div>`
              : (r.bike_brand
                  ? `<img src="{{ url_for('static', filename='brand_logos') }}/${(r.bike_brand || '').toLowerCase()}.png"
                         alt="${r.bike_brand} logo"
                         class="w-10 h-10 object-contain border-2 border-green-300 rounded-full" width="40" height="40" />`
                  : `<div class="w-10 h-10 bg-gradient-to-br from-green-600 to-emerald-600 rounded-full flex items-center justify-center">
                       <span class="text-white text-xs font-bold">#${r.rider_number}</span>
                     </div>`)}
            <div>
              <div class="font-semibold text-gray-800 dark:text-gray-200">${r.name}</div>
              <div class="text-xs text-gray-600 dark:text-gray-300">${r.class === '450cc' ? '🔥' : '⚡'} ${r.class} • #${r.rider_number || "-"}</div>
              <div class="text-xs text-green-600 font-medium">${formatCurrency(r.price)} kr</div>
            </div>
          </div>
          <button class="text-red-500 hover:text-red-700 font-bold text-lg hover:scale-110 transition-transform" onclick="removeRider(${r.id})" title="Ta bort från team">🗑️</button>
        `;
        list.appendChild(row);
      });

      // Regler
      const c450 = myTeam.filter((x) => x.class === "450cc").length;
      const c250 = myTeam.filter((x) => x.class === "250cc").length;
      const total = myTeam.length;

      const rule = (id, ok, txt) => {
        const li = document.getElementById(id);
        li.querySelector("span:last-child").textContent = txt;
        li.className = (ok ? "rule-valid" : "rule-invalid") + " flex justify-between";
      };

      document.getElementById("budget-remaining").textContent = formatCurrency(budget);
      rule("rule-total", total === 4, `${total} / 4`);
      rule("rule-450", c450 === 2, `${c450} / 2`);
      rule("rule-250", c250 === 2, `${c250} / 2`);
      rule("rule-budget", budget >= 0, `${formatCurrency(budget)}`);
      
      // Update budget progress bar
      const spent = totalBudget - budget;
      const percentage = (spent / totalBudget) * 100;
      const progressBar = document.getElementById("budget-progress");
      progressBar.style.width = `${percentage}%`;
      
      // Change color based on budget usage
      if (percentage > 80) {
        progressBar.style.background = "linear-gradient(90deg, #ef4444 0%, #dc2626 100%)";
      } else if (percentage > 60) {
        progressBar.style.background = "linear-gradient(90deg, #f59e0b 0%, #d97706 100%)";
      } else {
        progressBar.style.background = "linear-gradient(90deg, #10b981 0%, #059669 100%)";
      }

      // Uppdatera riderlista (disable knappar)
      renderRiderList();

      // Aktivera Spara om valid
      const save = document.getElementById("save-team-btn");
      const valid =
        total === 4 &&
        c450 === 2 &&
        c250 === 2 &&
        budget >= 0 &&
        document.getElementById("team-name-input").value.trim();
      save.disabled = !valid;
      
      // Update save button text based on riders changed
      updateSaveButtonText();
      
      // Update points preview
      updatePointsPreview();
    }

    function calculateRidersChanged() {
      if (!hasExistingTeam || !existingTeamRiders || existingTeamRiders.length === 0) {
        return 0;
      }
      
      // Get current team rider IDs (what user has selected)
      const currentRiderIds = new Set(myTeam.map(r => r.id.toString()));
      // Get original team rider IDs (what was saved in database)
      const originalRiderIds = new Set(existingTeamRiders);
      
      // Count how many riders are different from the original team
      const ridersChanged = [...originalRiderIds].filter(id => !currentRiderIds.has(id)).length;
      return ridersChanged;
    }

    function updateSaveButtonText() {
      const saveBtn = document.getElementById("save-team-btn");
      if (!hasExistingTeam) {
        saveBtn.textContent = "💾 Spara Team";
        return;
      }
      
      const ridersChanged = calculateRidersChanged();
      if (ridersChanged === 0) {
        saveBtn.textContent = "💾 Uppdatera Team (Inga poängstraff)";
      } else {
        const penaltyPoints = ridersChanged * 50;
        saveBtn.textContent = `⚠️ Uppdatera Team (-${penaltyPoints} poäng)`;
      }
    }

    function loadCurrentTeam() {
      if (!hasExistingTeam || !existingTeamRiders || existingTeamRiders.length === 0) {
        return;
      }
      
      // Find riders that match the existing team rider IDs
      currentTeam = allRiders.filter(rider => 
        existingTeamRiders.includes(rider.id.toString())
      );
      
      // Calculate the cost of the current team and update the budget
      const currentTeamCost = currentTeam.reduce((sum, rider) => sum + rider.price, 0);
      budget = totalBudget - currentTeamCost; // Set initial budget based on current team
      
      console.log("💰 loadCurrentTeam debug:");
      console.log("💰 totalBudget:", totalBudget);
      console.log("💰 currentTeam riders:", currentTeam.map(r => `${r.name}: ${r.price.toLocaleString()} kr`));
      console.log("💰 currentTeamCost:", currentTeamCost.toLocaleString());
      console.log("💰 calculated budget:", budget.toLocaleString());
      
      renderCurrentTeam();
    }

    // Load user's current points
    async function loadUserPoints() {
      try {
        const response = await fetch("/get_user_total_points");
        const data = await response.json();
        
        if (data.total_points !== undefined) {
          document.getElementById("current-points").textContent = `${data.total_points} poäng`;
          window.userTotalPoints = data.total_points;
          updatePointsPreview();
        } else {
          document.getElementById("current-points").textContent = "0 poäng";
          window.userTotalPoints = 0;
        }
      } catch (error) {
        console.error("Error loading user points:", error);
        document.getElementById("current-points").textContent = "Fel vid laddning";
        window.userTotalPoints = 0;
      }
    }

    // Update points preview when team changes
    function updatePointsPreview() {
      const ridersChanged = calculateRidersChanged();
      const penaltyPoints = ridersChanged * 50;
      const pointsAfter = window.userTotalPoints - penaltyPoints;
      
      const penaltyPreview = document.getElementById("penalty-preview");
      const penaltyAmount = document.getElementById("penalty-amount");
      const pointsAfterAmount = document.getElementById("points-after-amount");
      const pointsAfterChange = document.getElementById("points-after-change");
      
      if (penaltyPoints > 0) {
        penaltyAmount.textContent = penaltyPoints;
        penaltyPreview.classList.remove("hidden");
        pointsAfterAmount.textContent = pointsAfter;
        pointsAfterChange.classList.remove("hidden");
        
        // Update penalty text to be more dynamic
        const penaltyText = penaltyPreview.querySelector('.penalty-text');
        if (penaltyText) {
          penaltyText.textContent = ` poäng för ${ridersChanged} byte`;
        }
        
        // Change color based on whether user has enough points
        if (pointsAfter < 0) {
          pointsAfterChange.className = "text-xs text-red-600 font-medium";
          pointsAfterAmount.className = "text-red-600 font-bold";
        } else {
          pointsAfterChange.className = "text-xs text-gray-600 font-medium";
          pointsAfterAmount.className = "text-green-600 font-bold";
        }
      } else {
        penaltyPreview.classList.add("hidden");
        pointsAfterChange.classList.add("hidden");
      }
    }

    function renderCurrentTeam() {
      const list = document.getElementById("current-team-list");
      if (!list) return;
      
      list.innerHTML = "";
      
      currentTeam.forEach((rider) => {
        const card = document.createElement("div");
        // Highlight the rider being replaced
        const isBeingReplaced = window.replacingRiderId === rider.id;
        const baseClasses = "p-2 rounded-lg border text-center";
        const normalClasses = "bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/30 dark:to-orange-900/30 border-yellow-200 dark:border-yellow-700";
        const highlightClasses = "bg-gradient-to-r from-green-100 to-emerald-100 dark:from-green-900/50 dark:to-emerald-900/50 border-green-400 dark:border-green-600 ring-2 ring-green-300";
        
        card.className = `${baseClasses} ${isBeingReplaced ? highlightClasses : normalClasses}`;
        // Bygg HTML för nummer-cirkeln med olika färger för 450cc och 250cc
        const numberBgClass = rider.class === "450cc" 
          ? "bg-gradient-to-br from-orange-500 to-red-600" 
          : "bg-gradient-to-br from-yellow-400 to-orange-500";
        
        const numberHtml = `<div class="w-6 h-6 ${numberBgClass} rounded-full flex items-center justify-center shadow-md">
          <span class="text-white text-xs font-bold">#${rider.rider_number || "-"}</span>
        </div>`;

        card.innerHTML = `
          <div class="flex flex-col items-center space-y-1 mb-2">
            <div class="flex-shrink-0 flex items-center gap-2">
              ${rider.image_url
                ? `<img src="${(rider.image_url.startsWith('/') ? '/static' : '/static/') + rider.image_url}"
                       alt="${rider.name} headshot"
                       class="w-8 h-8 object-cover rounded-full border border-yellow-300" width="32" height="32"
                       onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                 <div class="w-8 h-8 bg-gradient-to-br from-yellow-600 to-orange-600 rounded-full flex items-center justify-center" style="display: none;">
                   ${rider.bike_brand 
                     ? `<img src="/static/brand_logos/${rider.bike_brand.toLowerCase()}.png" 
                            alt="${rider.bike_brand} logo" 
                            class="w-5 h-5 object-contain"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                       <span class="text-white text-xs font-bold" style="display: none;">#${rider.rider_number}</span>`
                     : `<span class="text-white text-xs font-bold">#${rider.rider_number}</span>`}
                 </div>`
                : (rider.bike_brand
                    ? `<img src="/static/brand_logos/${rider.bike_brand.toLowerCase()}.png"
                           alt="${rider.bike_brand} logo"
                           class="w-8 h-8 object-contain border border-yellow-300 rounded-full" width="32" height="32" />`
                    : `<div class="w-8 h-8 bg-gradient-to-br from-yellow-600 to-orange-600 rounded-full flex items-center justify-center">
                         <span class="text-white text-xs font-bold">#${rider.rider_number}</span>
                       </div>`)}
              ${numberHtml}
            </div>
            <div class="w-full">
              <div class="font-semibold text-gray-800 dark:text-gray-200 text-xs truncate">${rider.name}</div>
              <div class="text-xs text-gray-600 dark:text-gray-300">${rider.class === '450cc' ? '🔥' : '⚡'} ${rider.class}</div>
            </div>
          </div>
          <button class="w-full ${isBeingReplaced ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'} text-white px-1 py-1 rounded text-xs font-medium transition-colors" 
                  onclick="event.stopPropagation(); replaceRider(${rider.id})" 
                  title="Byt ut denna förare">
            ${isBeingReplaced ? '🔄 Byter ut...' : 'Byt ut'}
          </button>
        `;
        list.appendChild(card);
      });
    }

    function replaceRider(riderIdToReplace) {
      console.log("🔍 replaceRider called with ID:", riderIdToReplace);
      console.log("🔍 currentTeam:", currentTeam);
      console.log("🔍 currentTeam IDs and names:", currentTeam.map(r => `${r.id}: ${r.name}`));
      console.log("🔍 Looking for rider with ID:", riderIdToReplace);
      console.log("💰 BUDGET BEFORE replaceRider:", budget);
      
      // Find the rider to replace
      const riderToReplace = currentTeam.find(r => r.id === riderIdToReplace);
      console.log("🔍 riderToReplace found:", riderToReplace);
      
      if (!riderToReplace) {
        console.log("❌ No rider found to replace!");
        return;
      }
      
      // If user hasn't started building a new team yet, initialize it with current team
      if (myTeam.length === 0) {
        console.log("💰 Initializing myTeam with current team (excluding rider to replace)");
        console.log("💰 Budget before initialization:", budget);
        
        // Add all other riders from current team to myTeam (without changing budget)
        currentTeam.forEach(rider => {
          if (rider.id !== riderIdToReplace) {
            myTeam.push(rider);
            console.log(`💰 Added ${rider.name} to myTeam (no budget change)`);
          }
        });
        
        // Add the price of the rider being replaced back to budget
        console.log(`💰 Adding back ${riderToReplace.name} price (${riderToReplace.price.toLocaleString()} kr) to budget`);
        budget += riderToReplace.price;
        console.log("💰 BUDGET AFTER adding back rider price:", budget);
      } else {
        // If myTeam already has riders, just add back the price of the rider being replaced
        console.log("💰 myTeam already exists, just adding back rider price");
        console.log(`💰 Adding back ${riderToReplace.name} price (${riderToReplace.price.toLocaleString()} kr) to budget`);
        budget += riderToReplace.price;
        console.log("💰 BUDGET AFTER adding back rider price:", budget);
      }
      
      // Show a message about what we're doing
      showToast(`Välj en ny ${riderToReplace.class} förare att ersätta ${riderToReplace.name}. Du kan välja vilken ${riderToReplace.class} förare som helst. Budget: ${budget.toLocaleString()} kr.`, true);
      
      // Set filter to the same class as the rider being replaced
      setFilter(riderToReplace.class);
      
      // Store which rider we're replacing
      window.replacingRiderId = riderIdToReplace;
      console.log("🔧 Set window.replacingRiderId to:", window.replacingRiderId);
      
      // Update the display
      validateAndRender();
      
      // Re-render current team to show highlighting
      renderCurrentTeam();
      
      // Scroll to rider list
      document.getElementById("rider-list").scrollIntoView({ behavior: 'smooth' });
    }

    function copyCurrentTeam() {
      // Clear current team
      myTeam = [];
      budget = totalBudget;
      
      // Copy all current team riders
      currentTeam.forEach(rider => {
        myTeam.push(rider);
        budget -= rider.price;
      });
      
      showToast(`Nuvarande team kopierat! Budget: ${budget.toLocaleString()} kr kvar. Du kan nu byta ut förarna en i taget.`, true);
      validateAndRender();
    }

    async function saveSeasonTeam() {
      const name = document.getElementById("team-name-input").value.trim();
      if (!name) { showToast("Du måste ange teamnamn", false); return; }
      if (myTeam.length !== 4) { showToast("Du måste välja exakt 4 förare", false); return; }
      const c450 = myTeam.filter((x) => x.class === "450cc").length;
      const c250 = myTeam.filter((x) => x.class === "250cc").length;
      if (c450 !== 2 || c250 !== 2) { showToast("Regel: 2×450cc och 2×250cc", false); return; }

      // Check if this is a team change (user already has a team)
      if (hasExistingTeam) {
        const ridersChanged = calculateRidersChanged();
        const penaltyPoints = ridersChanged * 50;
        
        if (penaltyPoints > 0) {
          // Check if user has enough points
          try {
            const pointsResponse = await fetch("/get_user_total_points");
            const pointsData = await pointsResponse.json();
            
            if (pointsData.total_points < penaltyPoints) {
              showToast(`Du har inte tillräckligt med poäng! Du har ${pointsData.total_points} poäng men behöver ${penaltyPoints} poäng för att byta ${ridersChanged} förare.`, false);
              return;
            }
          } catch (error) {
            console.error("Error checking user points:", error);
            showToast("Kunde inte kontrollera dina poäng. Försök igen.", false);
            return;
          }
        }
        
        let confirmMessage;
        if (ridersChanged === 0) {
          confirmMessage = "⚠️ Du har redan ett team!\n\nInga förare byts ut, så det kostar inga poäng.\n\nÄr du säker på att du vill fortsätta?";
        } else {
          confirmMessage = `⚠️ Du har redan ett team!\n\nDu byter ut ${ridersChanged} förare.\nDetta kommer att kosta ${penaltyPoints} poäng.\n\nÄr du säker på att du vill fortsätta?`;
        }
        
        const confirmed = confirm(confirmMessage);
        if (!confirmed) {
          return;
        }
      }

      const payload = {
        team_name: name,
        team: myTeam.map((r) => ({ id: r.id })),
      };

      try {
        const resp = await fetch("/save_season_team", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        
        // Check if response is JSON
        const contentType = resp.headers.get("content-type");
        if (!contentType || !contentType.includes("application/json")) {
          console.error("Response is not JSON:", await resp.text());
          showToast("Serverfel - fick inte JSON-svar", false);
          return;
        }
        
        const data = await resp.json();
        if (!resp.ok) {
          showToast(data.message || "Kunde inte spara teamet.", false);
          return;
        }
        showToast(data.message || "Team sparat!", true);
        setTimeout(() => (window.location.href = "/season_team"), 600);
      } catch (e) {
        console.error("Error saving team:", e);
        showToast("Nätverksfel vid sparning: " + e.message, false);
      }
    }


    // Init
    document.addEventListener("DOMContentLoaded", () => {
      setFilter("all");
      loadCurrentTeam(); // Load existing team if it exists
      loadUserPoints(); // Load user's current points
      validateAndRender();
    });
  </script>
</body>
</html>