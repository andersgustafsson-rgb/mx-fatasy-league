<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ competition.name }} - Race Picks</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
  .result-correct { border-left: 4px solid #22c55e; }
  .dark .result-correct { background-color: rgba(34, 197, 94, 0.1); }
  .result-close { border-left: 4px solid #eab308; }
  .dark .result-close { background-color: rgba(234, 179, 8, 0.1); }
  .picks-locked { pointer-events: none; opacity: 0.6; }

  /* Smalare rader + st√∂rre preview */
  .pick-row { grid-template-columns: 48px 1fr; gap: 12px; align-items: center; }
  .preview-img {
    width: 44px; height: 44px; border-radius: 9999px;
    object-fit: cover; background: #4b5563; opacity: .85;
    transition: opacity .15s ease, transform .15s ease;
    border: 2px solid #6b7280;
  }
  .preview-img.has-src { opacity: 1; }
  .pick-select-sm {
    padding-top: .4rem; padding-bottom: .4rem;  /* ~py-1.5 */
    font-size: .875rem; /* text-sm */
    line-height: 1.25rem;
  }
  .section-narrow { max-width: 960px; }

  /* Rider Selector Styles */
  .rider-selector {
    position: relative;
    width: 100%;
  }

  .rider-selector-input {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    border: 1px solid #374151;
    border-radius: 6px;
    background: #1f2937;
    color: white;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .rider-selector-input:hover {
    border-color: #4b5563;
  }

  .dropdown-arrow {
    transition: transform 0.2s;
  }

  .clear-selection {
    color: #ef4444;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
    padding: 2px 4px;
    border-radius: 3px;
    transition: background-color 0.2s;
  }

  .clear-selection:hover {
    background-color: #ef4444;
    color: white;
  }

  .rider-selector.open .dropdown-arrow {
    transform: rotate(180deg);
  }

  .rider-selector-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #1f2937;
    border: 1px solid #374151;
    border-radius: 6px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    max-height: 300px;
    overflow: hidden;
  }

  .search-box {
    padding: 8px;
    border-bottom: 1px solid #374151;
  }

  .search-box input {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #4b5563;
    border-radius: 4px;
    background: #111827;
    color: white;
    font-size: 14px;
  }

  .search-box input:focus {
    outline: none;
    border-color: #3b82f6;
  }

  .rider-list {
    max-height: 250px;
    overflow-y: auto;
  }

  .rider-option {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    cursor: pointer;
    transition: background-color 0.2s;
    border-bottom: 1px solid #374151;
  }

  .rider-option:hover {
    background: #374151;
  }

  .rider-option[data-out="true"] {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .rider-option[data-out="true"]:hover {
    background: #dc2626;
  }

  .rider-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    margin-right: 8px;
    object-fit: cover;
    background: #374151;
    border: 1px solid #4b5563;
  }

  .rider-info {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .rider-number {
    font-weight: bold;
    color: #3b82f6;
    font-size: 12px;
  }

  .rider-name {
    color: white;
    font-size: 14px;
    font-weight: 500;
  }

  .rider-brand {
    color: #9ca3af;
    font-size: 12px;
  }

  .out-badge {
    background: #dc2626;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: bold;
  }

  /* Mobile optimizations */
  @media (max-width: 768px) {
    .rider-selector-dropdown {
      max-height: 250px;
    }
    
    .rider-list {
      max-height: 200px;
    }
    
    .rider-option {
      padding: 6px 8px;
    }
    
    .rider-avatar {
      width: 28px;
      height: 28px;
    }
    
    .rider-name {
      font-size: 13px;
    }
  }
</style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-200 font-sans">
  <div class="container mx-auto p-3 sm:p-4 md:p-6">

    <!-- Header - Responsiv layout -->
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 sm:mb-6 gap-4">
  <div>
        <h1 class="text-2xl sm:text-3xl font-bold text-blue-500 break-words">{{ competition.name }}</h1>

    {# Visa datum om du har det #}
    {% if competition.event_date %}
          <p class="text-xs sm:text-sm text-gray-400 mt-1">
        {{ competition.event_date.strftime('%Y-%m-%d') }}
      </p>
    {% endif %}

    {# 250SX East/West label #}
    {% if competition.coast_250 %}
      <div class="mt-2 inline-flex items-center gap-2">
        <span class="text-xs text-gray-400">
          250SX {{ competition.coast_250|capitalize }}
        </span>
        <span class="text-[10px] px-2 py-0.5 rounded bg-blue-600 text-white">
          {{ 'W' if competition.coast_250 == 'west' else 'E' }}
        </span>
      </div>
    {% endif %}
  </div>

      <div class="flex gap-2">
        <a href="{{ url_for('index') }}" class="bg-gray-500 px-3 sm:px-4 py-2 rounded text-white font-bold text-sm sm:text-base self-start sm:self-center">
    ‚¨Ö Tillbaka
  </a>
        <a href="{{ url_for('bulletin_board') }}" class="bg-orange-600 hover:bg-orange-700 px-3 sm:px-4 py-2 rounded text-white font-bold text-sm sm:text-base self-start sm:self-center">
          üìã Anslagstavla
  </a>
      </div>
</div>

    <!-- Trackmap Section with Side Info -->
    {% if trackmap_images and trackmap_images|length > 0 %}
    <div class="mb-6 bg-gray-800 rounded-lg p-4">
      <h2 class="text-xl font-bold text-cyan-400 mb-4 flex items-center">
        üó∫Ô∏è Track Map
      </h2>
      
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
        <!-- Track Map - Smaller -->
        <div class="lg:col-span-2 bg-gray-700 rounded-lg p-4">
          <img id="main-trackmap"
               src="{{ url_for('static', filename=trackmap_images[0].image_url) }}"
               alt="Track Map {{ competition.name }}"
               class="w-full max-h-80 object-contain rounded mb-4 bg-gray-600">
          
          {% if trackmap_images|length > 1 %}
          <div class="flex flex-wrap gap-2 justify-center">
            {% for img in trackmap_images[:5] %}
              <img src="{{ url_for('static', filename=img.image_url) }}"
                   class="thumb w-16 h-12 object-cover rounded cursor-pointer {% if loop.first %}ring-2 ring-cyan-400{% endif %}"
                   onclick="setMainTrackmap(this.src, this)">
            {% endfor %}
          </div>
          {% endif %}
        </div>
        
        <!-- Race Info Sidebar -->
        <div class="lg:col-span-2 space-y-4">
          <!-- Race Details -->
          <div class="bg-gradient-to-br from-blue-600 to-blue-800 rounded-lg p-4">
            <h3 class="text-lg font-bold text-white mb-3 flex items-center">
              üèÅ Race Info
            </h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-blue-200">Bana:</span>
                <span class="text-white font-semibold">{{ competition.name }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-blue-200">Datum:</span>
                <span class="text-white font-semibold">{{ competition.event_date.strftime('%Y-%m-%d') if competition.event_date else 'TBA' }}</span>
              </div>
              {% if competition.coast_250 %}
              <div class="flex justify-between">
                <span class="text-blue-200">250SX:</span>
                <span class="text-white font-semibold">{{ competition.coast_250|capitalize }}</span>
              </div>
              {% endif %}
            </div>
          </div>
          
          <!-- Quick Tips -->
          <div class="bg-gradient-to-br from-green-600 to-green-800 rounded-lg p-4">
            <h3 class="text-lg font-bold text-white mb-3 flex items-center">
              üí° Tips
            </h3>
            <div class="space-y-2 text-sm text-green-100">
              <div class="flex items-start space-x-2">
                <span class="text-green-300">‚Ä¢</span>
                <span>Kolla f√∂rares form fr√•n senaste racen</span>
              </div>
              <div class="flex items-start space-x-2">
                <span class="text-green-300">‚Ä¢</span>
                <span>Holeshot √§r ofta avg√∂rande f√∂r segern</span>
              </div>
              <div class="flex items-start space-x-2">
                <span class="text-green-300">‚Ä¢</span>
                <span>Wildcard kan ge stora po√§ng om du gissar r√§tt</span>
              </div>
            </div>
          </div>
          
          <!-- Stats -->
          <div class="bg-gradient-to-br from-purple-600 to-purple-800 rounded-lg p-4">
            <h3 class="text-lg font-bold text-white mb-3 flex items-center">
              üìä Statistik
            </h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-purple-200">Aktiva f√∂rare:</span>
                <span class="text-white font-semibold">{{ riders_450|length + riders_250|length }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-purple-200">450cc:</span>
                <span class="text-white font-semibold">{{ riders_450|length }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-purple-200">250cc:</span>
                <span class="text-white font-semibold">{{ riders_250|length }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {% if not actual_results %}
    {% set outset = out_ids | default([]) %}
    
    <!-- Picks Status Indicator -->
    <div id="picks-status" class="mb-4 p-4 rounded-lg border-2 border-dashed border-gray-400 dark:border-gray-600 bg-gray-50 dark:bg-gray-800">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div id="status-icon" class="text-2xl">‚è≥</div>
          <div>
            <h3 id="status-title" class="text-lg font-semibold text-gray-700 dark:text-gray-300">Laddar picks-status...</h3>
            <p id="status-message" class="text-sm text-gray-500 dark:text-gray-400">Kontrollerar om du har gjort dina val</p>
          </div>
        </div>
        <div id="status-actions" class="hidden">
          <button onclick="clearAllPicks()" class="text-sm text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">
            Rensa alla val
          </button>
        </div>
      </div>
    </div>
    
    <h2 class="text-xl sm:text-2xl font-semibold mb-3 sm:mb-4">Gissa topp 6, Holeshot & Wildcard</h2>

<!-- START: BYT HELA PICK-FORM-BLOCKET TILL DENNA VERSION -->
<div id="pick-form" class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 items-start">

  <!-- Kolumn: 450cc -->
  <div>
    <h3 class="text-lg sm:text-xl font-bold mb-2 sm:mb-3">450cc</h3>
    {% for i in range(1, 7) %}
      <div class="pick-row mb-1.5">
        <img id="prev-450-{{ i }}" class="preview-img" alt="" />
        <div class="flex items-center gap-2">
          <span class="w-8">{{ i }}.</span>
          <div class="rider-selector" data-class="450cc" data-position="{{ i }}">
            <div class="rider-selector-input" onclick="toggleRiderSelector('450cc', {{ i }})">
              <span class="selected-rider">-- v√§lj f√∂rare --</span>
              <div class="flex items-center gap-2">
                <span class="clear-selection" onclick="clearRiderSelection('450cc', {{ i }}); event.stopPropagation();" style="display: none;">‚úï</span>
                <span class="dropdown-arrow">‚ñº</span>
              </div>
            </div>
            <div class="rider-selector-dropdown" style="display: none;">
              <div class="search-box">
                <input type="text" placeholder="S√∂k f√∂rare..." onkeyup="filterRiders('450cc', {{ i }}, this.value)">
              </div>
              <div class="rider-list">
            {% for rider in riders_450 %}
                  <div class="rider-option" data-rider-id="{{ rider.id }}" data-rider-name="#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})" {% if rider.id in out_ids %}data-out="true"{% endif %} onclick="selectRider('450cc', {{ i }}, {{ rider.id }}, '#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})')">
                    <img alt="" class="rider-avatar" data-rider-id="{{ rider.id }}">
                    <span class="rider-info">
                      <span class="rider-number">#{{ rider.rider_number }}</span>
                      <span class="rider-name">{{ rider.name }}</span>
                      <span class="rider-brand">{{ rider.bike_brand }}</span>
                    </span>
                    {% if rider.id in out_ids %}<span class="out-badge">OUT</span>{% endif %}
                  </div>
            {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Kolumn: 250cc -->
  <div>
    <h3 class="text-lg sm:text-xl font-bold mb-2 sm:mb-3">250cc</h3>
    {% for i in range(1, 7) %}
      <div class="pick-row mb-1.5">
        <img id="prev-250-{{ i }}" class="preview-img" alt="" />
        <div class="flex items-center gap-2">
          <span class="w-8">{{ i }}.</span>
          <div class="rider-selector" data-class="250cc" data-position="{{ i }}">
            <div class="rider-selector-input" onclick="toggleRiderSelector('250cc', {{ i }})">
              <span class="selected-rider">-- v√§lj f√∂rare --</span>
              <div class="flex items-center gap-2">
                <span class="clear-selection" onclick="clearRiderSelection('250cc', {{ i }}); event.stopPropagation();" style="display: none;">‚úï</span>
                <span class="dropdown-arrow">‚ñº</span>
              </div>
            </div>
            <div class="rider-selector-dropdown" style="display: none;">
              <div class="search-box">
                <input type="text" placeholder="S√∂k f√∂rare..." onkeyup="filterRiders('250cc', {{ i }}, this.value)">
              </div>
              <div class="rider-list">
            {% for rider in riders_250 %}
                  <div class="rider-option" data-rider-id="{{ rider.id }}" data-rider-name="#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})" data-coast="{{ rider.coast_250 or '' }}" {% if rider.id in out_ids %}data-out="true"{% endif %} onclick="selectRider('250cc', {{ i }}, {{ rider.id }}, '#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})')">
                    <img alt="" class="rider-avatar" data-rider-id="{{ rider.id }}">
                    <span class="rider-info">
                      <span class="rider-number">#{{ rider.rider_number }}</span>
                      <span class="rider-name">{{ rider.name }}</span>
                      <span class="rider-brand">{{ rider.bike_brand }}</span>
                    </span>
                    {% if rider.id in out_ids %}<span class="out-badge">OUT</span>{% endif %}
                  </div>
            {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

</div>

<!-- Hidden select elements for form submission -->
{% for i in range(1, 7) %}
  <select name="pick_450_{{ i }}" style="display: none;">
    <option value="">-- v√§lj f√∂rare --</option>
    {% for rider in riders_450 %}
      <option value="{{ rider.id }}">#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})</option>
    {% endfor %}
  </select>
  <select name="pick_250_{{ i }}" style="display: none;">
    <option value="">-- v√§lj f√∂rare --</option>
    {% for rider in riders_250 %}
      <option value="{{ rider.id }}">#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})</option>
    {% endfor %}
  </select>
{% endfor %}
<!-- SLUT: BYT HELA PICK-FORM-BLOCKET TILL DENNA VERSION -->




    <div class="mt-4 sm:mt-6">
      <h3 class="text-lg sm:text-xl font-bold mb-2 sm:mb-3">Gissa Holeshot</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
        <div>
          <label class="block text-sm sm:text-base mb-1">450cc:</label>
          <div class="rider-selector" data-class="holeshot-450">
            <div class="rider-selector-input" onclick="toggleRiderSelector('holeshot-450', 0)">
              <span class="selected-rider">-- v√§lj f√∂rare --</span>
              <span class="dropdown-arrow">‚ñº</span>
            </div>
            <div class="rider-selector-dropdown" style="display: none;">
              <div class="search-box">
                <input type="text" placeholder="S√∂k f√∂rare..." onkeyup="filterRiders('holeshot-450', 0, this.value)">
              </div>
              <div class="rider-list">
  {% for rider in riders_450 %}
                  <div class="rider-option" data-rider-id="{{ rider.id }}" data-rider-name="#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})" {% if rider.id in out_ids %}data-out="true"{% endif %} onclick="selectHoleshotRider('450', {{ rider.id }}, '#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})')">
                    <img alt="" class="rider-avatar" data-rider-id="{{ rider.id }}">
                    <span class="rider-info">
                      <span class="rider-number">#{{ rider.rider_number }}</span>
                      <span class="rider-name">{{ rider.name }}</span>
                      <span class="rider-brand">{{ rider.bike_brand }}</span>
                    </span>
                    {% if rider.id in out_ids %}<span class="out-badge">OUT</span>{% endif %}
                  </div>
  {% endfor %}
              </div>
            </div>
          </div>
        </div>
        <div>
          <label class="block text-sm sm:text-base mb-1">250cc:</label>
          <div class="rider-selector" data-class="holeshot-250">
            <div class="rider-selector-input" onclick="toggleRiderSelector('holeshot-250', 0)">
              <span class="selected-rider">-- v√§lj f√∂rare --</span>
              <span class="dropdown-arrow">‚ñº</span>
            </div>
            <div class="rider-selector-dropdown" style="display: none;">
              <div class="search-box">
                <input type="text" placeholder="S√∂k f√∂rare..." onkeyup="filterRiders('holeshot-250', 0, this.value)">
              </div>
              <div class="rider-list">
  {% for rider in riders_250 %}
                  <div class="rider-option" data-rider-id="{{ rider.id }}" data-rider-name="#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})" data-coast="{{ rider.coast_250 or '' }}" {% if rider.id in out_ids %}data-out="true"{% endif %} onclick="selectHoleshotRider('250', {{ rider.id }}, '#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})')">
                    <img alt="" class="rider-avatar" data-rider-id="{{ rider.id }}">
                    <span class="rider-info">
                      <span class="rider-number">#{{ rider.rider_number }}</span>
                      <span class="rider-name">{{ rider.name }}</span>
                      <span class="rider-brand">{{ rider.bike_brand }}</span>
                    </span>
                    {% if rider.id in out_ids %}<span class="out-badge">OUT</span>{% endif %}
                  </div>
  {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Hidden select elements for form submission -->
      <select id="holeshot-450" name="holeshot_450" style="display: none;">
        <option value="">-- v√§lj f√∂rare --</option>
        {% for rider in riders_450 %}
          <option value="{{ rider.id }}">#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})</option>
        {% endfor %}
      </select>
      <select id="holeshot-250" name="holeshot_250" style="display: none;">
        <option value="">-- v√§lj f√∂rare --</option>
        {% for rider in riders_250 %}
          <option value="{{ rider.id }}">#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})</option>
        {% endfor %}
          </select>
        </div>

    <div class="mt-4 sm:mt-6 p-3 sm:p-4 bg-purple-100 dark:bg-purple-800 rounded">
      <h3 class="font-bold text-base sm:text-lg text-purple-900 dark:text-purple-200">üé≤ Wildcard ‚Äì slumpa en plats (10‚Äì20) & v√§lj en 450cc‚Äëf√∂rare</h3>
      <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 mt-2 sm:items-center">
        <button type="button" id="wildcard-roll-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded text-sm sm:text-base" onclick="rollWildcard()">Slumpa plats</button>
        <span id="wildcard-position-label" class="font-bold text-purple-900 dark:text-purple-100 text-sm sm:text-base"></span>
        <input type="hidden" id="wildcard-position" />
        <div class="rider-selector flex-1" data-class="wildcard-pick">
          <div class="rider-selector-input" onclick="toggleRiderSelector('wildcard-pick', 0)">
            <span class="selected-rider">-- v√§lj 450cc f√∂rare --</span>
            <span class="dropdown-arrow">‚ñº</span>
          </div>
          <div class="rider-selector-dropdown" style="display: none;">
            <div class="search-box">
              <input type="text" placeholder="S√∂k f√∂rare..." onkeyup="filterRiders('wildcard-pick', 0, this.value)">
            </div>
            <div class="rider-list">
              {% for rider in riders_450 %}
                <div class="rider-option" data-rider-id="{{ rider.id }}" data-rider-name="#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})" {% if rider.id in out_ids %}data-out="true"{% endif %} onclick="selectWildcardRider({{ rider.id }}, '#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})')">
                  <img alt="" class="rider-avatar" data-rider-id="{{ rider.id }}">
                  <span class="rider-info">
                    <span class="rider-number">#{{ rider.rider_number }}</span>
                    <span class="rider-name">{{ rider.name }}</span>
                    <span class="rider-brand">{{ rider.bike_brand }}</span>
                  </span>
                  {% if rider.id in out_ids %}<span class="out-badge">OUT</span>{% endif %}
                </div>
              {% endfor %}
            </div>
      </div>
    </div>

        <!-- Hidden select element for form submission -->
        <select id="wildcard-pick" name="wildcard_pick" style="display: none;">
  <option value="">-- v√§lj 450cc f√∂rare --</option>
  {% for rider in riders_450 %}
            <option value="{{ rider.id }}">#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})</option>
  {% endfor %}
        </select>
      </div>
    </div>

    <div class="mt-4 sm:mt-6 flex gap-3">
      <button onclick="savePicks()" class="flex-1 bg-green-600 text-white font-bold py-2 sm:py-3 rounded text-sm sm:text-base">üíæ Spara Mina Val</button>
      <button onclick="showOtherUsersPicks()" class="bg-blue-600 text-white font-bold py-2 sm:py-3 rounded text-sm sm:text-base">üë• Visa Andras Picks</button>
    </div>

    {% else %}
    <h2 class="text-xl sm:text-2xl font-semibold mb-3 sm:mb-4">Resultat vs Dina Val</h2>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 lg:gap-8">
      <div>
        <h3 class="text-lg sm:text-xl font-bold mb-2 sm:mb-3">450cc</h3>
        <div id="results-450" class="space-y-1 sm:space-y-2"></div>
      </div>
      <div>
        <h3 class="text-lg sm:text-xl font-bold mb-2 sm:mb-3">250cc</h3>
        <div id="results-250" class="space-y-1 sm:space-y-2"></div>
      </div>
    </div>

    <div class="mt-4 sm:mt-6">
      <h3 class="text-lg sm:text-xl font-bold mb-2 sm:mb-3">Holeshot Resultat</h3>
      <div id="holeshot-results" class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4"></div>
    </div>

    <div class="mt-4 sm:mt-6">
      <h3 class="text-lg sm:text-xl font-bold mb-2 sm:mb-3">Wildcard Resultat</h3>
      <div id="wildcard-result" class="p-3 sm:p-4 bg-purple-100 dark:bg-purple-700 rounded"></div>
    </div>
    {% endif %}
  </div>


<script>
  // Serverdata
  const competitionId = {{ competition.id|tojson }};
  const competitionName = {{ competition.name|tojson }};
  const actualResults = {{ actual_results|tojson }};
  const holeshotResults = {{ holeshot_results|tojson }};
  const allRiders = {{ (riders_450_json + riders_250_json) | tojson }};
  // NYTT: OUT-lista fr√•n servern f√∂r att kunna validera i UI
  const OUT_IDS = {{ out_ids | tojson }};
  // Coast-filtrering f√∂r 250cc
  const competitionCoast = {{ competition.coast_250|tojson }};
  

  // Load saved picks from localStorage on page load
  loadSavedPicksFromStorage();
  
  // Function to clear localStorage picks (for debugging)
  function clearLocalStoragePicks() {
    localStorage.removeItem(`race_picks_${competitionId}`);
    // Reload the page to see empty picks
    location.reload();
  }
  
  // Make it available globally for debugging
  window.clearLocalStoragePicks = clearLocalStoragePicks;

  // Save picks to localStorage
  function savePicksToStorage() {
    const picks = {
      competitionId: competitionId,
      timestamp: Date.now(),
      racePicks: {},
      holeshotPicks: {},
      wildcardPick: null,
      wildcardPosition: null
    };

    // Save race picks (450cc and 250cc)
    ['450cc', '250cc'].forEach(riderClass => {
      picks.racePicks[riderClass] = {};
      for (let i = 1; i <= 6; i++) {
        const selector = document.querySelector(`.rider-selector[data-class="${riderClass}"][data-position="${i}"]`);
        if (selector) {
          const selectedRiderSpan = selector.querySelector('.selected-rider');
          const currentText = selectedRiderSpan.textContent;
          
          if (currentText !== '-- v√§lj f√∂rare --' && currentText !== '-- v√§lj 450cc f√∂rare --') {
            const riderOption = selector.querySelector(`.rider-option[data-rider-name="${currentText}"]`);
            if (riderOption) {
              picks.racePicks[riderClass][i] = {
                riderId: riderOption.dataset.riderId,
                riderName: riderOption.dataset.riderName
              };
            }
          }
        }
      }
    });

    // Save holeshot picks
    ['450', '250'].forEach(classType => {
      const selector = document.querySelector(`.rider-selector[data-class="holeshot-${classType}"]`);
      if (selector) {
        const selectedRiderSpan = selector.querySelector('.selected-rider');
        const currentText = selectedRiderSpan.textContent;
        
        if (currentText !== '-- v√§lj f√∂rare --') {
          const riderOption = selector.querySelector(`.rider-option[data-rider-name="${currentText}"]`);
          if (riderOption) {
            picks.holeshotPicks[classType] = {
              riderId: riderOption.dataset.riderId,
              riderName: riderOption.dataset.riderName
            };
          }
        }
      }
    });

    // Save wildcard pick
    const wildcardSelector = document.querySelector(`.rider-selector[data-class="wildcard-pick"]`);
    if (wildcardSelector) {
      const selectedRiderSpan = wildcardSelector.querySelector('.selected-rider');
      const currentText = selectedRiderSpan.textContent;
      
      if (currentText !== '-- v√§lj 450cc f√∂rare --') {
        const riderOption = wildcardSelector.querySelector(`.rider-option[data-rider-name="${currentText}"]`);
        if (riderOption) {
          picks.wildcardPick = {
            riderId: riderOption.dataset.riderId,
            riderName: riderOption.dataset.riderName
          };
        }
      }
    }

    // Save wildcard position
    const wildcardPosition = document.getElementById('wildcard-position');
    if (wildcardPosition && wildcardPosition.value) {
      picks.wildcardPosition = wildcardPosition.value;
    }

    localStorage.setItem(`race_picks_${competitionId}`, JSON.stringify(picks));
  }

  // Load picks from localStorage
  function loadSavedPicksFromStorage() {
    const savedPicks = localStorage.getItem(`race_picks_${competitionId}`);
    
    if (!savedPicks) {
      return;
    }

    try {
      const picks = JSON.parse(savedPicks);
      // Check if the stored competition ID matches the current competition
      // If not, clear the localStorage for this competition
      if (picks.competitionId && picks.competitionId !== competitionId) {
        localStorage.removeItem(`race_picks_${competitionId}`);
        return;
      }

      // Load race picks
      ['450cc', '250cc'].forEach(riderClass => {
        if (picks.racePicks[riderClass]) {
          Object.keys(picks.racePicks[riderClass]).forEach(position => {
            const pick = picks.racePicks[riderClass][position];
            const selector = document.querySelector(`.rider-selector[data-class="${riderClass}"][data-position="${position}"]`);
            if (selector && pick) {
              const selectedRiderSpan = selector.querySelector('.selected-rider');
              selectedRiderSpan.textContent = pick.riderName;
              
              // Show clear button
              const clearBtn = selector.querySelector('.clear-selection');
              if (clearBtn) {
                clearBtn.style.display = 'block';
              }
              
              // Update hidden select
              const hiddenSelect = document.querySelector(`select[name="pick_${riderClass.replace('cc', '')}_${position}"]`);
              if (hiddenSelect) {
                hiddenSelect.value = pick.riderId;
              }
              
              // Update preview image
              onPickChange(riderClass, position, pick.riderId);
            }
          });
        }
      });

      // Load holeshot picks
      ['450', '250'].forEach(classType => {
        if (picks.holeshotPicks[classType]) {
          const pick = picks.holeshotPicks[classType];
          const selector = document.querySelector(`.rider-selector[data-class="holeshot-${classType}"]`);
          if (selector && pick) {
            const selectedRiderSpan = selector.querySelector('.selected-rider');
            selectedRiderSpan.textContent = pick.riderName;
            
            // Update hidden select
            const hiddenSelect = document.getElementById(`holeshot-${classType}`);
            if (hiddenSelect) {
              hiddenSelect.value = pick.riderId;
            }
          }
        }
      });

      // Load wildcard pick
      if (picks.wildcardPick) {
        const pick = picks.wildcardPick;
        const selector = document.querySelector(`.rider-selector[data-class="wildcard-pick"]`);
        if (selector && pick) {
          const selectedRiderSpan = selector.querySelector('.selected-rider');
          selectedRiderSpan.textContent = pick.riderName;
          
          // Update hidden select
          const hiddenSelect = document.getElementById('wildcard-pick');
          if (hiddenSelect) {
            hiddenSelect.value = pick.riderId;
          }
        }
      }

      // Load wildcard position
      if (picks.wildcardPosition) {
        document.getElementById('wildcard-position').value = picks.wildcardPosition;
        document.getElementById('wildcard-position-label').textContent = `Plats ${picks.wildcardPosition}`;
      }

      // Update rider selectors to hide selected riders
      updateRiderSelectors('450cc');
      updateRiderSelectors('250cc');
      
      // Remove wrong coast selections after loading picks
      removeWrongCoastSelections();

    } catch (error) {
      console.error('Error loading picks from localStorage:', error);
    }
  }

  // Remove wrong coast selections
  function removeWrongCoastSelections() {
    if (competitionCoast && competitionCoast !== 'both') {
      
      // Check all 250cc selectors
      const selectors250 = document.querySelectorAll('.rider-selector[data-class="250cc"]');
      selectors250.forEach(selector => {
        const selectedRiderSpan = selector.querySelector('.selected-rider');
        const currentText = selectedRiderSpan.textContent;
        
        // Skip if no selection made yet
        if (currentText === '-- v√§lj f√∂rare --' || currentText === '-- v√§lj 250cc f√∂rare --') {
          return;
        }
        
        // Find the rider option that matches the selected text
        const riderOption = selector.querySelector(`.rider-option[data-rider-name="${currentText}"]`);
        if (riderOption) {
          const riderCoast = riderOption.dataset.coast;
          if (riderCoast && riderCoast !== competitionCoast && riderCoast !== 'both') {
            // Clear the selection
            selectedRiderSpan.textContent = '-- v√§lj f√∂rare --';
            
            // Clear the preview image
            const position = selector.dataset.position;
            const imgId = `prev-250-${position}`;
            const img = document.getElementById(imgId);
            if (img) {
              img.src = '';
              img.style.background = 'linear-gradient(135deg, #1a1a2e, #16213e)';
            }
            
            // Clear localStorage for this pick
            const savedPicks = JSON.parse(localStorage.getItem(`race_picks_${competitionId}`) || '{}');
            if (savedPicks.racePicks && savedPicks.racePicks['250cc']) {
              delete savedPicks.racePicks['250cc'][position];
              localStorage.setItem(`race_picks_${competitionId}`, JSON.stringify(savedPicks));
            }
          }
        }
      });
    }
  }

  // Rider Selector Functions
  function toggleRiderSelector(riderClass, position) {
    // Handle both regular race picks (with position) and holeshot/wildcard (without position)
    let selector;
    if (position !== undefined && position !== 0) {
      selector = document.querySelector(`.rider-selector[data-class="${riderClass}"][data-position="${position}"]`);
    } else {
      selector = document.querySelector(`.rider-selector[data-class="${riderClass}"]`);
    }
    
    if (!selector) {
      return;
    }
    
    const dropdown = selector.querySelector('.rider-selector-dropdown');
    if (!dropdown) {
      return;
    }
    
    const isOpen = dropdown.style.display !== 'none';
    
    // Close all other dropdowns
    document.querySelectorAll('.rider-selector-dropdown').forEach(dd => {
      dd.style.display = 'none';
    });
    document.querySelectorAll('.rider-selector').forEach(sel => {
      sel.classList.remove('open');
    });
    
    // Toggle current dropdown
    if (!isOpen) {
      dropdown.style.display = 'block';
      selector.classList.add('open');
      
      // Load rider images when dropdown opens
      loadRiderImages(riderClass, position);
      
      // Focus search input
      const searchInput = dropdown.querySelector('input');
      if (searchInput) {
        setTimeout(() => searchInput.focus(), 100);
      }
    }
  }

  // Load rider images for dropdown
  function loadRiderImages(riderClass, position) {
    // Handle both regular race picks (with position) and holeshot/wildcard (without position)
    let selector;
    if (position !== undefined && position !== 0) {
      selector = document.querySelector(`.rider-selector[data-class="${riderClass}"][data-position="${position}"]`);
    } else {
      selector = document.querySelector(`.rider-selector[data-class="${riderClass}"]`);
    }
    
    if (!selector) {
      return;
    }
    
    const riderOptions = selector.querySelectorAll('.rider-option');
    
    riderOptions.forEach(option => {
      const img = option.querySelector('.rider-avatar');
      const riderId = option.dataset.riderId;
      
      if (img && riderId && !img.src) {
        // Set image source using the same logic as imgSrcFor
        const rider = allRiders.find(r => r.id == riderId);
        if (rider && rider.image_url) {
          // Remove 'riders/' prefix if it exists to avoid double path
          const imagePath = rider.image_url.startsWith('riders/') ? rider.image_url : `riders/${rider.image_url}`;
          img.src = `/static/${imagePath}`;
          img.onerror = function() {
            // Use bike brand logo as fallback
            if (rider.bike_brand) {
              this.src = `/static/brand_logos/${rider.bike_brand.toLowerCase()}.png`;
            } else {
              this.src = '/static/brand_logos/honda.png'; // Default to Honda
            }
          };
        } else {
          // Use bike brand logo if no rider image
          if (rider && rider.bike_brand) {
            img.src = `/static/brand_logos/${rider.bike_brand.toLowerCase()}.png`;
          } else {
            img.src = '/static/brand_logos/honda.png'; // Default to Honda
          }
        }
      }
    });
  }

  function selectRider(riderClass, position, riderId, riderName) {
    // Check coast validation for 250cc riders
    if (riderClass === '250cc' && competitionCoast && competitionCoast !== 'both') {
      const riderOption = document.querySelector(`.rider-option[data-rider-id="${riderId}"]`);
      if (riderOption) {
        const riderCoast = riderOption.dataset.coast;
        if (riderCoast && riderCoast !== competitionCoast && riderCoast !== 'both') {
          alert(`Du kan inte v√§lja ${riderName} - denna f√∂rare k√∂r ${riderCoast} coast, men denna t√§vling √§r ${competitionCoast} coast.`);
          return;
        }
      }
    }
    
    const selector = document.querySelector(`.rider-selector[data-class="${riderClass}"][data-position="${position}"]`);
    const selectedRiderSpan = selector.querySelector('.selected-rider');
    
    // Update display
    selectedRiderSpan.textContent = riderName;
    
    // Show clear button
    const clearBtn = selector.querySelector('.clear-selection');
    if (clearBtn) {
      clearBtn.style.display = 'block';
    }
    
    // Close dropdown
    const dropdown = selector.querySelector('.rider-selector-dropdown');
    dropdown.style.display = 'none';
    selector.classList.remove('open');
    
    // Clear search
    const searchInput = dropdown.querySelector('input');
    if (searchInput) {
      searchInput.value = '';
      filterRiders(riderClass, position, '');
    }
    
    // Update the hidden select element for form submission
    const hiddenSelect = document.querySelector(`select[name="pick_${riderClass.replace('cc', '')}_${position}"]`);
    if (hiddenSelect) {
      hiddenSelect.value = riderId;
    }
    
    // Call existing onPickChange function to update preview image
    onPickChange(riderClass, position, riderId);
    
    // Update rider selectors to hide selected riders
    updateRiderSelectors(riderClass);
    
    // Save picks to localStorage
    savePicksToStorage();
  }

  function filterRiders(riderClass, position, searchTerm) {
    const selector = document.querySelector(`.rider-selector[data-class="${riderClass}"][data-position="${position}"]`);
    if (!selector) {
      return;
    }
    const riderOptions = selector.querySelectorAll('.rider-option');
    const searchLower = searchTerm.toLowerCase();
    
    riderOptions.forEach(option => {
      const riderName = option.querySelector('.rider-name').textContent.toLowerCase();
      const riderNumber = option.querySelector('.rider-number').textContent.toLowerCase();
      const riderBrand = option.querySelector('.rider-brand').textContent.toLowerCase();
      
      const matches = riderName.includes(searchLower) || 
                     riderNumber.includes(searchLower) || 
                     riderBrand.includes(searchLower);
      
      option.style.display = matches ? 'flex' : 'none';
    });
  }

  // Close dropdowns when clicking outside
  document.addEventListener('click', function(event) {
    if (!event.target.closest('.rider-selector')) {
      document.querySelectorAll('.rider-selector-dropdown').forEach(dropdown => {
        dropdown.style.display = 'none';
      });
      document.querySelectorAll('.rider-selector').forEach(selector => {
        selector.classList.remove('open');
      });
    }
  });

  // Handle wildcard rider selection
  function selectWildcardRider(riderId, riderName) {
    const selector = document.querySelector(`.rider-selector[data-class="wildcard-pick"]`);
    const selectedRiderSpan = selector.querySelector('.selected-rider');
    
    // Update display
    selectedRiderSpan.textContent = riderName;
    
    // Close dropdown
    const dropdown = selector.querySelector('.rider-selector-dropdown');
    dropdown.style.display = 'none';
    selector.classList.remove('open');
    
    // Clear search
    const searchInput = dropdown.querySelector('input');
    if (searchInput) {
      searchInput.value = '';
      filterRiders('wildcard-pick', 0, '');
    }
    
    // Update the hidden select element for form submission
    const hiddenSelect = document.getElementById('wildcard-pick');
    if (hiddenSelect) {
      hiddenSelect.value = riderId;
    }
    
    // Save picks to localStorage
    savePicksToStorage();
  }

  // Handle holeshot rider selection
  function selectHoleshotRider(classType, riderId, riderName) {
    const selector = document.querySelector(`.rider-selector[data-class="holeshot-${classType}"]`);
    const selectedRiderSpan = selector.querySelector('.selected-rider');
    
    // Update display
    selectedRiderSpan.textContent = riderName;
    
    // Close dropdown
    const dropdown = selector.querySelector('.rider-selector-dropdown');
    dropdown.style.display = 'none';
    selector.classList.remove('open');
    
    // Clear search
    const searchInput = dropdown.querySelector('input');
    if (searchInput) {
      searchInput.value = '';
      filterRiders(`holeshot-${classType}`, 0, '');
    }
    
    // Update the hidden select element for form submission
    const hiddenSelect = document.getElementById(`holeshot-${classType}`);
    if (hiddenSelect) {
      hiddenSelect.value = riderId;
    }
    
    // Save picks to localStorage
    savePicksToStorage();
  }

  // Clear rider selection
  function clearRiderSelection(riderClass, position) {
    const selector = document.querySelector(`.rider-selector[data-class="${riderClass}"][data-position="${position}"]`);
    const selectedRiderSpan = selector.querySelector('.selected-rider');
    const clearBtn = selector.querySelector('.clear-selection');
    
    // Reset display
    selectedRiderSpan.textContent = '-- v√§lj f√∂rare --';
    
    // Hide clear button
    if (clearBtn) {
      clearBtn.style.display = 'none';
    }
    
    // Clear hidden select
    const hiddenSelect = document.querySelector(`select[name="pick_${riderClass.replace('cc', '')}_${position}"]`);
    if (hiddenSelect) {
      hiddenSelect.value = '';
    }
    
    // Clear preview image
    onPickChange(riderClass, position, null);
    
    // Update rider selectors to show all options again
    updateRiderSelectors(riderClass);
    
    // Save picks to localStorage
    savePicksToStorage();
  }

  // Update rider selector options (replaces updateDropdowns for new system)
  function updateRiderSelectors(riderClass) {
    const selectors = document.querySelectorAll(`.rider-selector[data-class="${riderClass}"]`);
    
    // Get currently selected riders in this class
    const chosenRiderIds = Array.from(selectors).map(selector => {
      const selectedRiderSpan = selector.querySelector('.selected-rider');
      const currentText = selectedRiderSpan.textContent;
      
      // Skip if no selection made yet
      if (currentText === '-- v√§lj f√∂rare --' || currentText === '-- v√§lj 450cc f√∂rare --') {
        return null;
      }
      
      // Find the rider option that matches the selected text
      const riderOption = selector.querySelector(`.rider-option[data-rider-name="${currentText}"]`);
      return riderOption ? riderOption.dataset.riderId : null;
    }).filter(Boolean);
    
    
    // Update each selector
    selectors.forEach(selector => {
      const riderOptions = selector.querySelectorAll('.rider-option');
      const currentSelected = selector.querySelector('.selected-rider').textContent;
      
      riderOptions.forEach(option => {
        const riderId = option.dataset.riderId;
        const isChosenElsewhere = chosenRiderIds.includes(riderId) && 
                                 option.dataset.riderName !== currentSelected;
        const isOut = option.dataset.out === 'true';
        
        // Check coast for 250cc riders
        let isWrongCoast = false;
        if (riderClass === '250cc' && competitionCoast && competitionCoast !== 'both') {
          const riderCoast = option.dataset.coast;
          if (riderCoast) {
            isWrongCoast = riderCoast !== competitionCoast && riderCoast !== 'both';
          }
        }
        
        // Hide if chosen elsewhere, out, or wrong coast
        if (isChosenElsewhere || isOut || isWrongCoast) {
          option.style.display = 'none';
        } else {
          option.style.display = 'flex';
        }
      });
    });
  }

  function updateDropdowns(riderClass) {
    const selects = document.querySelectorAll(
      `.pick-select[data-class="${riderClass}"]`
    );

    // 1) Nollst√§ll om n√•gon r√•kar ha en OUT vald i denna klass
    selects.forEach((sel) => {
      const val = sel.value;
      if (val && OUT_IDS.includes(Number(val))) {
        sel.value = "";
      }
    });

    // 2) H√§mta alla valda riders i denna klass
    const chosenRiderIds = Array.from(selects)
      .map((s) => s.value)
      .filter(Boolean);

    // 3) Uppdatera varje dropdown - TA BORT valda riders helt ist√§llet f√∂r att bara disablea
    selects.forEach((sel) => {
      const currentValue = sel.value;
      const optionsToRemove = [];
      
      for (const opt of sel.options) {
        if (!opt.value) continue;
        
        const isChosenElsewhere =
          chosenRiderIds.includes(opt.value) && sel.value !== opt.value;
        const isOut = OUT_IDS.includes(Number(opt.value));
        
        // Coast-filtrering f√∂r 250cc
        let isWrongCoast = false;
        if (riderClass === "250cc" && competitionCoast && competitionCoast !== "both") {
          const rider = allRiders.find(r => String(r.id) === String(opt.value));
          if (rider && rider.class === "250cc") {
            // Till√•t endast samma coast eller 'both'
            isWrongCoast = rider.coast_250 && rider.coast_250 !== competitionCoast && rider.coast_250 !== "both";
          }
        }
        
        // Ta bort option helt om den √§r vald n√•gon annanstans, OUT, eller fel coast
        if (isChosenElsewhere || isOut || isWrongCoast) {
          optionsToRemove.push(opt);
        }
      }
      
      // Ta bort options som inte ska visas
      optionsToRemove.forEach(opt => {
        if (opt.value !== currentValue) { // Beh√•ll den som √§r vald
          opt.remove();
        }
      });
    });
  }

  // Uppdatera holeshot-dropdowns med coast-filtrering
  function updateHoleshotDropdowns() {
    const holeshot250 = document.getElementById('holeshot-250');
    if (holeshot250 && competitionCoast && competitionCoast !== "both") {
      const currentValue = holeshot250.value;
      const optionsToRemove = [];
      
      for (const opt of holeshot250.options) {
        if (!opt.value) continue;
        const rider = allRiders.find(r => String(r.id) === String(opt.value));
        if (rider && rider.class === "250cc") {
          const isWrongCoast = rider.coast_250 && rider.coast_250 !== competitionCoast && rider.coast_250 !== "both";
          const isOut = OUT_IDS.includes(Number(opt.value));
          
          // Ta bort option helt om den har fel coast eller √§r OUT
          if (isWrongCoast || isOut) {
            optionsToRemove.push(opt);
          }
        }
      }
      
      // Ta bort options som inte ska visas
      optionsToRemove.forEach(opt => {
        if (opt.value !== currentValue) { // Beh√•ll den som √§r vald
          opt.remove();
        }
      });
    }
  }

  const findRiderName = (id) => {
    const r = allRiders.find((x) => String(x.id) === String(id));
    return r ? r.name : "Ok√§nd";
  };

  // Bygg bild-URL fr√•n rider-data: headshot f√∂rst, annars brand-logga
function imgSrcFor(riderId) {
  const r = allRiders.find((x) => Number(x.id) === Number(riderId));
  if (!r) {
  return null;
}
  
  
  // Try rider image first (check both PNG and JPG)
  if (r.image_url) {
    // Remove 'riders/' prefix if it exists to avoid double path
    const imagePath = r.image_url.startsWith('riders/') ? r.image_url : `riders/${r.image_url}`;
    const url = `/static/${imagePath}`;
    return url;
  }
  
  // Fall back to bike brand logo if no rider image
  if (r.bike_brand) {
    const url = `/static/brand_logos/${(r.bike_brand || "").toLowerCase()}.png`;
    return url;
  }
  
  // Final fallback to Honda logo
  return '/static/brand_logos/honda.png';
}

  // Function to handle image loading errors
function handleImageError(img) {
  
  // Replace the image with a simple placeholder that doesn't break layout
  img.style.display = 'none';
  
  // Create a small placeholder that fits in the same space
  const placeholder = document.createElement('div');
  placeholder.className = 'w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center flex-shrink-0';
  placeholder.innerHTML = '<span class="text-white text-xs">üèçÔ∏è</span>';
  
  // Replace the image with placeholder
  img.parentNode.replaceChild(placeholder, img);
}

// Function to update picks status indicator
function updatePicksStatus(myPicks) {
  const statusIcon = document.getElementById('status-icon');
  const statusTitle = document.getElementById('status-title');
  const statusMessage = document.getElementById('status-message');
  const statusActions = document.getElementById('status-actions');
  const statusContainer = document.getElementById('picks-status');
  
  if (!statusIcon || !statusTitle || !statusMessage) return;
  
  const hasTop6Picks = myPicks.top6_picks && myPicks.top6_picks.length > 0;
  const hasHoleshotPicks = myPicks.holeshot_picks && 
    (myPicks.holeshot_picks['450cc'] || myPicks.holeshot_picks['250cc']);
  const hasWildcardPick = myPicks.wildcard_pick;
  
  const totalPicks = (myPicks.top6_picks?.length || 0) + 
    (hasHoleshotPicks ? 1 : 0) + 
    (hasWildcardPick ? 1 : 0);
  
  if (totalPicks === 0) {
    // No picks made
    statusIcon.textContent = 'üìù';
    statusTitle.textContent = 'Inga val gjorda √§n';
    statusMessage.textContent = 'G√∂r dina val f√∂r topp 6, holeshot och wildcard';
    statusContainer.className = 'mb-4 p-4 rounded-lg border-2 border-dashed border-yellow-400 dark:border-yellow-600 bg-yellow-50 dark:bg-yellow-900/20';
    statusActions.classList.add('hidden');
  } else if (totalPicks < 8) {
    // Partial picks
    statusIcon.textContent = '‚ö†Ô∏è';
    statusTitle.textContent = `Delvis klart (${totalPicks}/8 val)`;
    statusMessage.textContent = 'Du har gjort n√•gra val, men inte alla. Komplettera dina picks!';
    statusContainer.className = 'mb-4 p-4 rounded-lg border-2 border-dashed border-orange-400 dark:border-orange-600 bg-orange-50 dark:bg-orange-900/20';
    statusActions.classList.remove('hidden');
  } else {
    // All picks made
    statusIcon.textContent = '‚úÖ';
    statusTitle.textContent = 'Alla val gjorda!';
    statusMessage.textContent = 'Du har gjort alla dina val f√∂r detta race. Lycka till!';
    statusContainer.className = 'mb-4 p-4 rounded-lg border-2 border-dashed border-green-400 dark:border-green-600 bg-green-50 dark:bg-green-900/20';
    statusActions.classList.remove('hidden');
  }
}

// Function to clear all picks
async function clearAllPicks() {
  if (!confirm('√Ñr du s√§ker p√• att du vill rensa alla dina val f√∂r detta race?')) {
    return;
  }
  
  try {
    const response = await fetch(`/clear_my_picks_for_competition/${competitionId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    if (response.ok) {
      // Don't clear form fields - keep picks visible
      
      // Update status
      updatePicksStatus({ top6_picks: [], holeshot_picks: {}, wildcard_pick: null });
      
      alert('Alla val har rensats!');
    } else {
      alert('Kunde inte rensa valen. F√∂rs√∂k igen.');
    }
  } catch (error) {
    console.error('Error clearing picks:', error);
    alert('Ett fel uppstod vid rensning av val.');
  }
}
function onPickChange(cls, pos, riderId = null) {
  
  // Handle both old select elements and new rider-selector
  let val = riderId;
  if (!val) {
  const sel = document.querySelector(
    `.pick-select[data-class="${cls}"][data-position="${pos}"]`
  );
    val = sel?.value;
  }
  
  const imgId = cls.startsWith("450") ? `prev-450-${pos}` : `prev-250-${pos}`;
  const img = document.getElementById(imgId);


  const src = val ? imgSrcFor(val) : null;
  
  
  if (img) {
    if (src) {
      img.src = src;
      img.classList.add("has-src"); // g√∂r preview tydligare
      img.style.background = "transparent";
      img.onerror = function() { handleImageError(this); };
    } else {
      img.removeAttribute("src");
      img.classList.remove("has-src");
      img.style.background = "#4b5563";
    }
  }

  updateDropdowns(cls);
}

  function initializePreviewImages() {
    
    // Initialize rider selectors to filter out wrong coast riders
    updateRiderSelectors('450cc');
    updateRiderSelectors('250cc');
}

  async function displayResults(myPicks) {
    if (!actualResults || actualResults.length === 0) return;

    ["450", "250"].forEach((cls) => {
      const container = document.getElementById(`results-${cls}`);
      let html = "";
      for (let i = 1; i <= 6; i++) {
        const result = actualResults.find(
          (r) => r.class && r.class.startsWith(cls) && r.position === i
        );
        const pick = myPicks.top6_picks.find(
          (p) =>
            p.class && p.class.startsWith(cls) && p.predicted_position === i
        );

        if (!result && !pick) continue;

        const resultName = result ? `${findRiderName(result.id)}` : "Inget resultat";
        const pickName = pick ? `${findRiderName(pick.rider_id)}` : "Inget val";

        let cardClass = "bg-gray-50 dark:bg-gray-700";
        if (pick && result && String(pick.rider_id) === String(result.id)) {
          cardClass += " result-correct";
        } else if (
          pick &&
          actualResults.some(
            (r) =>
              String(r.id) === String(pick.rider_id) &&
              r.class &&
              r.class.startsWith(cls) &&
              r.position <= 6
          )
        ) {
          cardClass += " result-close";
        }

        html += `
          <div class="p-3 rounded ${cardClass}">
            <p class="font-bold">${i}. ${resultName}</p>
            <p class="text-sm text-gray-500 dark:text-gray-400 pl-4">Ditt val: ${pickName}</p>
          </div>`;
      }
      if (container) container.innerHTML = html;
    });

    const hsContainer = document.getElementById("holeshot-results");
    if (hsContainer) {
      hsContainer.innerHTML = ["450cc", "250cc"]
        .map((cls) => {
          const result = holeshotResults.find((r) => r.class === cls);
          const pickId = myPicks.holeshot_picks[cls];
          const pickName = pickId ? findRiderName(pickId) : "Inget val";
          const resultName = result ? findRiderName(result.rider_id) : "Inget resultat";

          let cardClass = "bg-gray-50 dark:bg-gray-700";
          if (result && pickId && String(result.rider_id) === String(pickId)) {
            cardClass += " result-correct";
          }
          return `
            <div class="p-3 rounded ${cardClass}">
              <p class="font-bold">${cls}: ${resultName}</p>
              <p class="text-sm text-gray-500 dark:text-gray-400 pl-4">Ditt val: ${pickName}</p>
            </div>`;
        })
        .join("");
    }
  }


  async function fetchAndDisplayMyPicks() {
    try {
      const res = await fetch(`/get_my_picks/${competitionId}`);
      if (!res.ok) throw new Error("Kunde inte h√§mta dina val");
      const myPicks = await res.json();
      
      // Update picks status
      updatePicksStatus(myPicks);

      if (!actualResults || actualResults.length === 0) {
        // √Öterst√§ll tidigare val i UI
        (myPicks.top6_picks || []).forEach((p) => {
          const selector = document.querySelector(
            `.rider-selector[data-class="${p.class}"][data-position="${p.predicted_position}"]`
          );
          if (selector) {
            const selectedRiderSpan = selector.querySelector('.selected-rider');
            // Find the rider name from the rider ID
            const rider = allRiders.find(r => r.id === p.rider_id);
            if (rider && selectedRiderSpan) {
              const riderText = `#${rider.rider_number} ${rider.name} (${rider.bike_brand})`;
              selectedRiderSpan.textContent = riderText;
              
              // Update preview image
const imgId = p.class.startsWith("450")
  ? `prev-450-${p.predicted_position}`
  : `prev-250-${p.predicted_position}`;
const img = document.getElementById(imgId);
const src = imgSrcFor(p.rider_id);
if (img && src) {
  img.src = src;
  img.style.background = "transparent";
              }
            }
          }
        });
        // Update holeshot picks - both hidden selects and visual elements
        if (myPicks.holeshot_picks?.["450cc"]) {
          const riderId = myPicks.holeshot_picks["450cc"];
          document.getElementById("holeshot-450").value = riderId;
          
          // Update visual selector
          const selector = document.querySelector('.rider-selector[data-class="holeshot-450"]');
          if (selector) {
            const riderOption = selector.querySelector(`.rider-option[data-rider-id="${riderId}"]`);
            if (riderOption) {
              const selectedRiderSpan = selector.querySelector('.selected-rider');
              selectedRiderSpan.textContent = riderOption.dataset.riderName;
            }
          }
        }
        
        if (myPicks.holeshot_picks?.["250cc"]) {
          const riderId = myPicks.holeshot_picks["250cc"];
          document.getElementById("holeshot-250").value = riderId;
          
          // Update visual selector
          const selector = document.querySelector('.rider-selector[data-class="holeshot-250"]');
          if (selector) {
            const riderOption = selector.querySelector(`.rider-option[data-rider-id="${riderId}"]`);
            if (riderOption) {
              const selectedRiderSpan = selector.querySelector('.selected-rider');
              selectedRiderSpan.textContent = riderOption.dataset.riderName;
            }
          }
        }
        
        // Update wildcard pick - both hidden select and visual element
        if (myPicks.wildcard_pick) {
          const riderId = myPicks.wildcard_pick;
          document.getElementById("wildcard-pick").value = riderId;
          
          // Update visual selector
          const selector = document.querySelector('.rider-selector[data-class="wildcard-pick"]');
          if (selector) {
            const riderOption = selector.querySelector(`.rider-option[data-rider-id="${riderId}"]`);
            if (riderOption) {
              const selectedRiderSpan = selector.querySelector('.selected-rider');
              selectedRiderSpan.textContent = riderOption.dataset.riderName;
            }
          }
        }

        // Wildcard-knapp: l√•s endast om position faktiskt finns
        const btn = document.getElementById("wildcard-roll-btn");
        const posVal = myPicks.wildcard_pos;
        if (posVal !== null && posVal !== undefined && String(posVal).trim() !== "") {
          document.getElementById("wildcard-position").value = posVal;
          document.getElementById("wildcard-position-label").textContent =
            `Din plats: ${posVal}`;
          btn.disabled = true;
          btn.classList.add("opacity-50", "cursor-not-allowed");
        } else {
          btn.disabled = false;
          btn.classList.remove("opacity-50", "cursor-not-allowed");
          document.getElementById("wildcard-position").value = "";
          document.getElementById("wildcard-position-label").textContent = "";
        }

        // Holeshot: rensa om OUT
const hs450Sel = document.getElementById("holeshot-450");
if (hs450Sel && hs450Sel.value && OUT_IDS.includes(Number(hs450Sel.value))) {
  hs450Sel.value = "";
}
const hs250Sel = document.getElementById("holeshot-250");
if (hs250Sel && hs250Sel.value && OUT_IDS.includes(Number(hs250Sel.value))) {
  hs250Sel.value = "";
}

// Wildcard: rensa om OUT
const wcSel = document.getElementById("wildcard-pick");
if (wcSel && wcSel.value && OUT_IDS.includes(Number(wcSel.value))) {
  wcSel.value = "";
}

        // NYTT: Rensa bort OUT som r√•kat ligga kvar som "vald"
        document.querySelectorAll(".pick-select").forEach((sel) => {
          const chosen = sel.value;
          if (chosen && OUT_IDS.includes(Number(chosen))) {
            sel.value = "";
          }
        });

        

        // Applicera disable-regler och OUT disable
        updateDropdowns("450cc");
        updateDropdowns("250cc");
  updateHoleshotDropdowns();
      }

      if (actualResults && actualResults.length > 0) {
        displayResults(myPicks);
      }
      
      // Remove wrong coast selections after loading picks from server
      removeWrongCoastSelections();
      
    } catch (e) {
      console.error(e);
    }
  }

  


  async function rollWildcard() {
    const btn = document.getElementById("wildcard-roll-btn");
    if (btn.disabled) return;
    const pos = Math.floor(Math.random() * 11) + 10; // 10-20
    try {
      const resp = await fetch("/lock_wildcard_pos", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ competition_id: competitionId, position: pos }),
      });
      const data = await resp.json();
      if (!resp.ok) {
        alert(data.error || "Kunde inte l√•sa wildcard");
        return;
      }
      if (data.status === "locked") {
        document.getElementById("wildcard-position").value = pos;
        document.getElementById("wildcard-position-label").textContent =
          `Din plats: ${pos}`;
        btn.disabled = true;
        btn.classList.add("opacity-50", "cursor-not-allowed");
        
        // Save picks to localStorage
        savePicksToStorage();
      } else {
        alert(data.error || "Kunde inte l√•sa wildcard");
      }
    } catch (e) {
      console.error(e);
      alert("N√§tverksfel vid l√•sning av wildcard");
    }
  }

  // Show other users' picks
  async function showOtherUsersPicks() {
    try {
      const response = await fetch(`/get_other_users_picks/${competitionId}`);
      if (!response.ok) throw new Error('Kunde inte h√§mta andra anv√§ndares picks');
      
      const usersPicks = await response.json();
      
      // Create modal to display picks
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-gray-800 rounded-lg p-6 max-w-4xl max-h-[80vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-white">Andra Anv√§ndares Picks</h3>
            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
          </div>
          <div class="space-y-4">
            ${usersPicks.map(user => `
              <div class="bg-gray-700 rounded p-4">
                <h4 class="font-semibold text-blue-400 mb-2">${user.username}</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <h5 class="text-sm font-medium text-gray-300 mb-1">450cc:</h5>
                    <div class="space-y-1">
                      ${user.picks.filter(p => p.class === '450cc').map(p => `
                        <div class="text-sm text-white">${p.position}. ${p.rider_name}</div>
                      `).join('')}
                    </div>
                  </div>
                  <div>
                    <h5 class="text-sm font-medium text-gray-300 mb-1">250cc:</h5>
                    <div class="space-y-1">
                      ${user.picks.filter(p => p.class === '250cc').map(p => `
                        <div class="text-sm text-white">${p.position}. ${p.rider_name}</div>
                      `).join('')}
                    </div>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    } catch (error) {
      alert('Fel vid h√§mtning av andra anv√§ndares picks: ' + error.message);
    }
  }

  // Helper function to get rider ID from selected rider
  function getRiderIdFromSelector(selector) {
    const selectedRiderSpan = selector.querySelector('.selected-rider');
    const riderText = selectedRiderSpan.textContent;
    
    if (riderText && riderText !== '-- v√§lj f√∂rare --') {
      // Find the rider option that matches the selected text
      const riderOptions = selector.querySelectorAll('.rider-option');
      
      for (const option of riderOptions) {
        const optionText = option.textContent.trim().replace(/\s+/g, ' ');
        const normalizedRiderText = riderText.replace(/\s+/g, ' ');
        
        // Try exact match first
        if (optionText === normalizedRiderText) {
          const riderId = parseInt(option.dataset.riderId);
          return riderId;
        }
        
        // Try match without parentheses (e.g., "Husqvarna" vs "(Husqvarna)")
        const optionTextNoParens = optionText.replace(/[()]/g, '');
        const normalizedRiderTextNoParens = normalizedRiderText.replace(/[()]/g, '');
        if (optionTextNoParens === normalizedRiderTextNoParens) {
          const riderId = parseInt(option.dataset.riderId);
          return riderId;
        }
      }
    }
    return null;
  }

  async function savePicks() {
    
    // Get race picks from rider-selector elements
    const picks = [];
    
    // Get 450cc picks
    for (let i = 1; i <= 6; i++) {
      const selector = document.querySelector(`.rider-selector[data-class="450cc"][data-position="${i}"]`);
      if (selector) {
        const riderId = getRiderIdFromSelector(selector);
        if (riderId) {
          picks.push({
            position: i,
            rider_id: riderId,
            class: '450cc'
          });
        }
      }
    }
    
    // Get 250cc picks
    for (let i = 1; i <= 6; i++) {
      const selector = document.querySelector(`.rider-selector[data-class="250cc"][data-position="${i}"]`);
      if (selector) {
        const riderId = getRiderIdFromSelector(selector);
        if (riderId) {
          picks.push({
            position: i,
            rider_id: riderId,
            class: '250cc'
          });
        }
      }
    }


    // Kontrollera dubletter
    const riderIds = picks.map(p => p.rider_id);
    const uniqueRiderIds = [...new Set(riderIds)];
    if (riderIds.length !== uniqueRiderIds.length) {
      alert("Du kan inte v√§lja samma f√∂rare flera g√•nger. V√§lj olika f√∂rare f√∂r varje position.");
      return;
    }

    // Kontrollera att exakt 6 f√∂rare √§r valda f√∂r varje klass
    const picks450 = picks.filter(p => p.class === '450cc');
    const picks250 = picks.filter(p => p.class === '250cc');
    
    
    if (picks450.length !== 6) {
      alert("Du m√•ste v√§lja exakt 6 f√∂rare f√∂r 450cc (Top 6).");
      return;
    }
    
    if (picks250.length !== 6) {
      alert("Du m√•ste v√§lja exakt 6 f√∂rare f√∂r 250cc (Top 6).");
      return;
    }

    // Extra s√§kerhet: client-side filter bort OUT
    for (const p of picks) {
      if (OUT_IDS.includes(Number(p.rider_id))) {
        alert("En vald f√∂rare √§r OUT. V√§lj en annan.");
        return;
      }
    }

    const payload = {
      competition_id: competitionId,
      picks: picks,
      holeshot_450: document.getElementById("holeshot-450")?.value,
      holeshot_250: document.getElementById("holeshot-250")?.value,
      wildcard_pick: document.getElementById("wildcard-pick")?.value,
      wildcard_pos: document.getElementById("wildcard-position")?.value,
    };


    try {
      const resp = await fetch("/save_picks", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const data = await resp.json();
      alert(data.message || data.error || "Ok");
      
      // Clear localStorage since picks are now saved to server
      localStorage.removeItem(`race_picks_${competitionId}`);
      
      // Update picks status after saving
      setTimeout(() => {
        fetchAndDisplayMyPicks();
      }, 500);
    } catch (e) {
      alert("Ett fel uppstod vid sparning.");
    }
  }

  ["holeshot-450", "holeshot-250", "wildcard-pick"].forEach((id) => {
  const sel = document.getElementById(id);
  if (!sel) return;
  sel.addEventListener("change", () => {
    const val = sel.value;
    if (val && OUT_IDS.includes(Number(val))) {
      sel.value = "";
      alert("F√∂raren √§r OUT f√∂r detta race.");
    }
  });
});


  


    document.addEventListener("DOMContentLoaded", async () => {
      // Initialize rider selectors with coast filtering
      updateRiderSelectors("450cc");
      updateRiderSelectors("250cc");
      updateHoleshotDropdowns();
      
      // Initialize all preview images
      initializePreviewImages();
      
      // Load user picks (don't clear them automatically)
      fetchAndDisplayMyPicks();
      
  // Re-apply coast filtering after picks are loaded
  setTimeout(() => {
    updateRiderSelectors("450cc");
    updateRiderSelectors("250cc");
    removeWrongCoastSelections();
  }, 100);
    });

window.addEventListener("focus", () => {
  if (localStorage.getItem("out-updated")) {
    location.reload();
  }
});

// Trackmap functionality
function setMainTrackmap(src, thumbEl) {
  const main = document.getElementById('main-trackmap');
  if (main) main.src = src;
  const container = thumbEl.parentElement;
  container.querySelectorAll('.thumb').forEach(t => t.classList.remove('ring-2', 'ring-cyan-400'));
  thumbEl.classList.add('ring-2', 'ring-cyan-400');
}

</script>

</body>
</html>