<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ competition.name }} - Race Picks</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    /* Dark background like leagues page */
    body {
      font-family: 'Rajdhani', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%) !important;
      background-attachment: fixed !important;
      min-height: 100vh !important;
    }
  .result-correct { border-left: 4px solid #22c55e; }
  .dark .result-correct { background-color: rgba(34, 197, 94, 0.1); }
  .result-close { border-left: 4px solid #eab308; }
  .dark .result-close { background-color: rgba(234, 179, 8, 0.1); }
  .picks-locked { pointer-events: none; opacity: 0.6; }

  .track-background {
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }

  /* Smalare rader + st√∂rre preview */
  .pick-row { grid-template-columns: 72px 1fr; gap: 14px; align-items: center; }
  .preview-img {
    width: 64px; height: 64px; border-radius: 9999px;
    object-fit: cover; 
    object-position: center 25%;
    background: #4b5563; opacity: .85;
    transition: opacity .15s ease, transform .15s ease;
    border: 2px solid #6b7280;
    flex-shrink: 0;
  }
  .preview-img.has-src { opacity: 1; }
  .pick-select-sm {
    padding-top: .4rem; padding-bottom: .4rem;  /* ~py-1.5 */
    font-size: .875rem; /* text-sm */
    line-height: 1.25rem;
  }
  .section-narrow { max-width: 960px; }

  /* Rider Selector Styles */
  .rider-selector {
    position: relative;
    width: 100%;
  }

  .rider-selector-input {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    border: 1px solid #374151;
    border-radius: 6px;
    background: #1f2937;
    color: white;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .rider-selector-input:hover {
    border-color: #4b5563;
  }

  .dropdown-arrow {
    transition: transform 0.2s;
  }

  .clear-selection {
    color: #ef4444;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
    padding: 2px 4px;
    border-radius: 3px;
    transition: background-color 0.2s;
  }

  .clear-selection:hover {
    background-color: #ef4444;
    color: white;
  }

  .rider-selector.open .dropdown-arrow {
    transform: rotate(180deg);
  }

  .rider-selector-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #1f2937;
    border: 1px solid #374151;
    border-radius: 6px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    max-height: 300px;
    overflow: hidden;
  }

  .search-box {
    padding: 8px;
    border-bottom: 1px solid #374151;
  }

  .search-box input {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #4b5563;
    border-radius: 4px;
    background: #111827;
    color: white;
    font-size: 14px;
  }

  .search-box input:focus {
    outline: none;
    border-color: #3b82f6;
  }

  .rider-list {
    max-height: 250px;
    overflow-y: auto;
  }

  .rider-option {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    cursor: pointer;
    transition: background-color 0.2s;
    border-bottom: 1px solid #374151;
  }

  .rider-option:hover {
    background: #374151;
  }

  .rider-option[data-out="true"] {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .rider-option[data-out="true"]:hover {
    background: #dc2626;
  }

  .rider-avatar {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    margin-right: 10px;
    object-fit: cover;
    object-position: center 25%;
    background: #374151;
    border: 2px solid #4b5563;
    flex-shrink: 0;
  }

  .rider-info {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .rider-number {
    font-weight: bold;
    color: #3b82f6;
    font-size: 12px;
  }

  .rider-name {
    color: white;
    font-size: 14px;
    font-weight: 500;
  }

  .rider-brand {
    color: #9ca3af;
    font-size: 12px;
  }

  .out-badge {
    background: #dc2626;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: bold;
  }

  /* Mobile optimizations */
  @media (max-width: 768px) {
    .rider-selector-dropdown {
      max-height: calc(100vh - 200px);
    }
    
    .rider-list {
      max-height: calc(100vh - 260px);
    }
    
    .rider-option {
      padding: 6px 8px;
    }
    
    .rider-avatar {
      width: 48px;
      height: 48px;
    }
    
    .rider-name {
      font-size: 13px;
    }
  }
</style>
</head>
<body class="text-gray-200 font-sans min-h-screen">
  <div class="container mx-auto p-3 sm:p-4 md:p-6">

    <!-- Header - Responsiv layout -->
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 sm:mb-6 gap-4">
  <div>
        <h1 class="text-2xl sm:text-3xl font-bold text-blue-500 break-words">{{ competition.name }}</h1>

    {# Visa datum om du har det #}
    {% if competition.event_date %}
          <p class="text-xs sm:text-sm text-gray-300 mt-1">
        {{ competition.event_date.strftime('%Y-%m-%d') }}
      </p>
    {% endif %}

    {# 250SX East/West label #}
    {% if competition.coast_250 %}
      <div class="mt-2 inline-flex items-center gap-2">
        <span class="text-xs text-gray-300">
          250SX {{ competition.coast_250|capitalize }}
        </span>
        <span class="text-[10px] px-2 py-0.5 rounded bg-blue-600 text-white">
          {{ 'W' if competition.coast_250 == 'west' else 'E' }}
        </span>
      </div>
    {% endif %}
  </div>

      <div class="flex gap-2">
        <a href="{{ url_for('index') }}" class="bg-gray-500 px-3 sm:px-4 py-2 rounded text-white font-bold text-sm sm:text-base self-start sm:self-center">
    ‚¨Ö Tillbaka
  </a>
        <a href="{{ url_for('bulletin_board') }}" class="bg-orange-600 hover:bg-orange-700 px-3 sm:px-4 py-2 rounded text-white font-bold text-sm sm:text-base self-start sm:self-center">
          üìã Trash Talk Br√§dan
  </a>
      </div>
</div>

    <!-- WSX Background Banner -->
    {% if competition.series == "WSX" %}
      {% set race_name_lower = competition.name.lower() %}
      {% if "buenos aires" in race_name_lower %}
        {% set wsx_bg_image = "trackmaps/compressed/buenosaireacitygp.png" %}
      {% elif "canadian" in race_name_lower %}
        {% set wsx_bg_image = "trackmaps/compressed/canadiangp.png" %}
      {% elif "australian" in race_name_lower %}
        {% set wsx_bg_image = "trackmaps/compressed/australiangp.jpg" %}
      {% elif "swedish" in race_name_lower %}
        {% set wsx_bg_image = "trackmaps/compressed/swedishgp.jpg" %}
      {% elif "south african" in race_name_lower %}
        {% set wsx_bg_image = "trackmaps/compressed/southafricangp.png" %}
      {% else %}
        {% set race_name_slug = race_name_lower.replace(" ", "").replace("national", "").replace("classic", "") %}
        {% set wsx_bg_image = "trackmaps/compressed/" + race_name_slug + ".jpg" %}
      {% endif %}
    <div class="mb-6 rounded-lg shadow-lg relative overflow-hidden track-background" 
         style="background-image: url('{{ url_for("static", filename=wsx_bg_image) }}'); background-size: cover; background-position: center; min-height: 200px;">
      <div class="absolute inset-0 bg-black bg-opacity-50"></div>
      <div class="relative z-10 p-6 text-center">
        <h2 class="text-2xl sm:text-3xl font-bold text-white mb-2">
          üèÅ {{ competition.name }}
        </h2>
        {% if competition.event_date %}
        <p class="text-cyan-300 text-lg">
          {{ competition.event_date.strftime('%d %B %Y') }}
        </p>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <!-- Trackmap Section with Side Info -->
    {% if trackmap_images and trackmap_images|length > 0 %}
    <div class="mb-6 bg-gray-800 rounded-lg p-4 border border-cyan-500">
      <h2 class="text-xl font-bold text-cyan-400 mb-4 flex items-center">
        üó∫Ô∏è Track Map
      </h2>
      
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
        <!-- Track Map - Smaller -->
        <div class="lg:col-span-2 bg-gray-700 rounded-lg p-4 border border-cyan-500">
          <img id="main-trackmap"
               src="{{ url_for('static', filename=trackmap_images[0].image_url) }}"
               alt="Track Map {{ competition.name }}"
               class="w-full max-h-80 object-contain rounded mb-4 bg-gray-600">
          
          {% if trackmap_images|length > 1 %}
          <div class="flex flex-wrap gap-2 justify-center">
            {% for img in trackmap_images[:5] %}
              <img src="{{ url_for('static', filename=img.image_url) }}"
                   class="thumb w-16 h-12 object-cover rounded cursor-pointer {% if loop.first %}ring-2 ring-cyan-400{% endif %}"
                   onclick="setMainTrackmap(this.src, this)">
            {% endfor %}
          </div>
          {% endif %}
        </div>
        
        <!-- Race Info Sidebar -->
        <div class="lg:col-span-2 space-y-4">
          <!-- Race Details -->
          <div class="bg-gradient-to-br from-blue-600 to-blue-800 rounded-lg p-4">
            <h3 class="text-lg font-bold text-white mb-3 flex items-center">
              üèÅ Race Info
            </h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-blue-200">Bana:</span>
                <span class="text-white font-semibold">{{ competition.name }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-blue-200">Datum:</span>
                <span class="text-white font-semibold">{{ competition.event_date.strftime('%Y-%m-%d') if competition.event_date else 'TBA' }}</span>
              </div>
              {% if competition.coast_250 %}
              <div class="flex justify-between">
                <span class="text-blue-200">250SX:</span>
                <span class="text-white font-semibold">{{ competition.coast_250|capitalize }}</span>
              </div>
              {% endif %}
            </div>
          </div>
          
          <!-- Quick Tips -->
          <div class="bg-gradient-to-br from-green-600 to-green-800 rounded-lg p-4">
            <h3 class="text-lg font-bold text-white mb-3 flex items-center">
              üí° Tips
            </h3>
            <div class="space-y-2 text-sm text-green-100">
              <div class="flex items-start space-x-2">
                <span class="text-green-300">‚Ä¢</span>
                <span>Kolla f√∂rares form fr√•n senaste racen</span>
              </div>
              <div class="flex items-start space-x-2">
                <span class="text-green-300">‚Ä¢</span>
                <span>Holeshot √§r ofta avg√∂rande f√∂r segern</span>
              </div>
              {% if competition.series != 'WSX' %}
              <div class="flex items-start space-x-2">
                <span class="text-green-300">‚Ä¢</span>
                <span>Wildcard kan ge stora po√§ng om du gissar r√§tt</span>
              </div>
              {% endif %}
            </div>
          </div>
          
          <!-- Stats -->
          <div class="bg-gradient-to-br from-purple-600 to-purple-800 rounded-lg p-4">
            <h3 class="text-lg font-bold text-white mb-3 flex items-center">
              üìä Statistik
            </h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-purple-200">Aktiva f√∂rare:</span>
                <span class="text-white font-semibold">{{ riders_450|length + riders_250|length }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-purple-200">{{ class_450_label }}:</span>
                <span class="text-white font-semibold">{{ riders_450|length }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-purple-200">{{ class_250_label }}:</span>
                <span class="text-white font-semibold">{{ riders_250|length }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {% if not actual_results %}
    {% set outset = out_ids | default([]) %}
    
    <!-- Picks Status Indicator -->
    <div id="picks-status" class="mb-4 p-4 rounded-lg border-2 border-dashed border-cyan-500 bg-gray-800">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div id="status-icon" class="text-2xl">‚è≥</div>
          <div>
            <h3 id="status-title" class="text-lg font-semibold text-cyan-400">Laddar picks-status...</h3>
            <p id="status-message" class="text-sm text-gray-300">Kontrollerar om du har gjort dina val</p>
          </div>
        </div>
        <div id="status-actions" class="hidden">
          <button onclick="clearAllPicks()" class="text-sm text-red-400 hover:text-red-300">
            Rensa alla val
          </button>
        </div>
      </div>
    </div>
    
    <!-- OUT Riders List -->
    {% if out_ids %}
    <div class="mb-4 p-3 bg-red-900/20 border border-red-500/30 rounded-lg">
      <h3 class="text-sm font-semibold text-red-400 mb-2">‚ö†Ô∏è OUT-f√∂rare (kan inte v√§ljas)</h3>
      <div class="flex flex-wrap gap-2">
        {% for rider in riders_450 + riders_250 %}
          {% if rider.id in out_ids %}
            <span class="inline-flex items-center gap-1 px-2 py-1 bg-red-800/40 text-red-200 text-xs rounded border border-red-600/50">
              <span class="w-2 h-2 bg-red-500 rounded-full"></span>
              #{{ rider.rider_number }} {{ rider.name }}
              <span class="text-red-300">({{ rider.class_name }})</span>
            </span>
          {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <h2 class="text-xl sm:text-2xl font-semibold mb-3 sm:mb-4 text-cyan-400 border-b border-cyan-500 pb-2">{% if competition.series == 'WSX' %}Gissa topp 6 & Holeshot{% else %}Gissa topp 6, Holeshot & Wildcard{% endif %}</h2>

<!-- START: BYT HELA PICK-FORM-BLOCKET TILL DENNA VERSION -->
<div id="pick-form" class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 items-start">
  {% set is_wsx = competition.series == 'WSX' %}
  {% set class_450_label = 'SX1' if is_wsx else '450cc' %}
  {% set class_250_label = 'SX2' if is_wsx else '250cc' %}
  {% set class_450_data = 'wsx_sx1' if is_wsx else '450cc' %}
  {% set class_250_data = 'wsx_sx2' if is_wsx else '250cc' %}

  <!-- Kolumn: 450cc / SX1 -->
  <div>
    <h3 class="text-lg sm:text-xl font-bold mb-2 sm:mb-3 text-cyan-400 bg-gray-800 border border-cyan-500 px-3 py-2 rounded-md">{{ class_450_label }}</h3>
    {% for i in range(1, 7) %}
      <div class="pick-row mb-1.5">
        <img id="prev-450-{{ i }}" class="preview-img" alt="" />
        <div class="flex items-center gap-2">
          <span class="w-8 text-cyan-400 font-semibold">{{ i }}.</span>
          <div class="rider-selector" data-class="{{ class_450_data }}" data-position="{{ i }}">
            <div class="rider-selector-input" onclick="toggleRiderSelector('{{ class_450_data }}', {{ i }})">
              <span class="selected-rider">-- v√§lj f√∂rare --</span>
              <div class="flex items-center gap-2">
                <span class="clear-selection" onclick="clearRiderSelection('{{ class_450_data }}', {{ i }}); event.stopPropagation();" style="display: none;">‚úï</span>
                <span class="dropdown-arrow">‚ñº</span>
              </div>
            </div>
            <div class="rider-selector-dropdown" style="display: none;">
              <div class="search-box">
                <input type="text" placeholder="S√∂k f√∂rare..." onkeyup="filterRiders('{{ class_450_data }}', {{ i }}, this.value)">
              </div>
              <div class="rider-list">
            {% for rider in riders_450 %}
                  <div class="rider-option" data-rider-id="{{ rider.id }}" data-rider-name="#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})" {% if rider.id in out_ids %}data-out="true"{% endif %} onclick="selectRider('{{ class_450_data }}', {{ i }}, {{ rider.id }}, '#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})')">
                    <img alt="" class="rider-avatar" data-rider-id="{{ rider.id }}">
                    <span class="rider-info">
                      <span class="rider-number">#{{ rider.rider_number }}</span>
                      <span class="rider-name">{{ rider.name }}</span>
                      <span class="rider-brand">{{ rider.bike_brand }}</span>
                    </span>
                    {% if rider.id in out_ids %}<span class="out-badge">OUT</span>{% endif %}
                  </div>
            {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Kolumn: 250cc / SX2 -->
  <div>
    <h3 class="text-lg sm:text-xl font-bold mb-2 sm:mb-3 text-cyan-400 bg-gray-800 border border-cyan-500 px-3 py-2 rounded-md">{{ class_250_label }}</h3>
    {% for i in range(1, 7) %}
      <div class="pick-row mb-1.5">
        <img id="prev-250-{{ i }}" class="preview-img" alt="" />
        <div class="flex items-center gap-2">
          <span class="w-8 text-cyan-400 font-semibold">{{ i }}.</span>
          <div class="rider-selector" data-class="{{ class_250_data }}" data-position="{{ i }}">
            <div class="rider-selector-input" onclick="toggleRiderSelector('{{ class_250_data }}', {{ i }})">
              <span class="selected-rider">-- v√§lj f√∂rare --</span>
              <div class="flex items-center gap-2">
                <span class="clear-selection" onclick="clearRiderSelection('{{ class_250_data }}', {{ i }}); event.stopPropagation();" style="display: none;">‚úï</span>
                <span class="dropdown-arrow">‚ñº</span>
              </div>
            </div>
            <div class="rider-selector-dropdown" style="display: none;">
              <div class="search-box">
                <input type="text" placeholder="S√∂k f√∂rare..." onkeyup="filterRiders('{{ class_250_data }}', {{ i }}, this.value)">
              </div>
              <div class="rider-list">
            {% for rider in riders_250 %}
                  <div class="rider-option" data-rider-id="{{ rider.id }}" data-rider-name="#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})" data-coast="{{ rider.coast_250 or '' }}" {% if rider.id in out_ids %}data-out="true"{% endif %} onclick="selectRider('{{ class_250_data }}', {{ i }}, {{ rider.id }}, '#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})')">
                    <img alt="" class="rider-avatar" data-rider-id="{{ rider.id }}">
                    <span class="rider-info">
                      <span class="rider-number">#{{ rider.rider_number }}</span>
                      <span class="rider-name">{{ rider.name }}</span>
                      <span class="rider-brand">{{ rider.bike_brand }}</span>
                    </span>
                    {% if rider.id in out_ids %}<span class="out-badge">OUT</span>{% endif %}
                  </div>
            {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

</div>

<!-- Hidden select elements for form submission -->
{% for i in range(1, 7) %}
  <select name="pick_450_{{ i }}" style="display: none;">
    <option value="">-- v√§lj f√∂rare --</option>
    {% for rider in riders_450 %}
      <option value="{{ rider.id }}">#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})</option>
    {% endfor %}
  </select>
  <select name="pick_250_{{ i }}" style="display: none;">
    <option value="">-- v√§lj f√∂rare --</option>
    {% for rider in riders_250 %}
      <option value="{{ rider.id }}">#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})</option>
    {% endfor %}
  </select>
{% endfor %}
<!-- SLUT: BYT HELA PICK-FORM-BLOCKET TILL DENNA VERSION -->




    <div class="mt-4 sm:mt-6">
      <h3 class="text-lg sm:text-xl font-bold mb-2 sm:mb-3 text-cyan-400 bg-gray-800 border border-cyan-500 px-3 py-2 rounded-md">Gissa Holeshot</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
        <div>
          <label class="block text-sm sm:text-base mb-1 text-cyan-300 font-semibold">{{ class_450_label }}:</label>
          <div class="rider-selector" data-class="holeshot-450">
            <div class="rider-selector-input" onclick="toggleRiderSelector('holeshot-450', 0)">
              <span class="selected-rider">-- v√§lj f√∂rare --</span>
              <span class="dropdown-arrow">‚ñº</span>
            </div>
            <div class="rider-selector-dropdown" style="display: none;">
              <div class="search-box">
                <input type="text" placeholder="S√∂k f√∂rare..." onkeyup="filterRiders('holeshot-450', 0, this.value)">
              </div>
              <div class="rider-list">
  {% for rider in riders_450 %}
                  <div class="rider-option" data-rider-id="{{ rider.id }}" data-rider-name="#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})" {% if rider.id in out_ids %}data-out="true"{% endif %} onclick="selectHoleshotRider('450', {{ rider.id }}, '#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})')">
                    <img alt="" class="rider-avatar" data-rider-id="{{ rider.id }}">
                    <span class="rider-info">
                      <span class="rider-number">#{{ rider.rider_number }}</span>
                      <span class="rider-name">{{ rider.name }}</span>
                      <span class="rider-brand">{{ rider.bike_brand }}</span>
                    </span>
                    {% if rider.id in out_ids %}<span class="out-badge">OUT</span>{% endif %}
                  </div>
  {% endfor %}
              </div>
            </div>
          </div>
        </div>
        <div>
          <label class="block text-sm sm:text-base mb-1 text-cyan-300 font-semibold">{{ class_250_label }}:</label>
          <div class="rider-selector" data-class="holeshot-250">
            <div class="rider-selector-input" onclick="toggleRiderSelector('holeshot-250', 0)">
              <span class="selected-rider">-- v√§lj f√∂rare --</span>
              <span class="dropdown-arrow">‚ñº</span>
            </div>
            <div class="rider-selector-dropdown" style="display: none;">
              <div class="search-box">
                <input type="text" placeholder="S√∂k f√∂rare..." onkeyup="filterRiders('holeshot-250', 0, this.value)">
              </div>
              <div class="rider-list">
  {% for rider in riders_250 %}
                  <div class="rider-option" data-rider-id="{{ rider.id }}" data-rider-name="#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})" data-coast="{{ rider.coast_250 or '' }}" {% if rider.id in out_ids %}data-out="true"{% endif %} onclick="selectHoleshotRider('250', {{ rider.id }}, '#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})')">
                    <img alt="" class="rider-avatar" data-rider-id="{{ rider.id }}">
                    <span class="rider-info">
                      <span class="rider-number">#{{ rider.rider_number }}</span>
                      <span class="rider-name">{{ rider.name }}</span>
                      <span class="rider-brand">{{ rider.bike_brand }}</span>
                    </span>
                    {% if rider.id in out_ids %}<span class="out-badge">OUT</span>{% endif %}
                  </div>
  {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Hidden select elements for form submission -->
      <select id="holeshot-450" name="holeshot_450" style="display: none;">
        <option value="">-- v√§lj f√∂rare --</option>
        {% for rider in riders_450 %}
          <option value="{{ rider.id }}">#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})</option>
        {% endfor %}
      </select>
      <select id="holeshot-250" name="holeshot_250" style="display: none;">
        <option value="">-- v√§lj f√∂rare --</option>
        {% for rider in riders_250 %}
          <option value="{{ rider.id }}">#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})</option>
        {% endfor %}
          </select>
        </div>

    {% if competition.series != 'WSX' %}
    <div class="mt-4 sm:mt-6 p-3 sm:p-4 bg-purple-100 dark:bg-purple-800 rounded">
      <h3 class="font-bold text-base sm:text-lg text-purple-900 dark:text-purple-200">üé≤ Wildcard ‚Äì slumpa en plats (10‚Äì20) & v√§lj en 450cc‚Äëf√∂rare</h3>
      <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 mt-2 sm:items-center">
        <button type="button" id="wildcard-roll-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded text-sm sm:text-base" onclick="rollWildcard()">Slumpa plats</button>
        <span id="wildcard-position-label" class="font-bold text-purple-900 dark:text-purple-100 text-sm sm:text-base"></span>
        <input type="hidden" id="wildcard-position" />
        <div class="rider-selector flex-1" data-class="wildcard-pick">
          <div class="rider-selector-input" onclick="toggleRiderSelector('wildcard-pick', 0)">
            <span class="selected-rider">-- v√§lj 450cc f√∂rare --</span>
            <span class="dropdown-arrow">‚ñº</span>
          </div>
          <div class="rider-selector-dropdown" style="display: none;">
            <div class="search-box">
              <input type="text" placeholder="S√∂k f√∂rare..." onkeyup="filterRiders('wildcard-pick', 0, this.value)">
            </div>
            <div class="rider-list">
              {% for rider in riders_450 %}
                <div class="rider-option" data-rider-id="{{ rider.id }}" data-rider-name="#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})" {% if rider.id in out_ids %}data-out="true"{% endif %} onclick="selectWildcardRider({{ rider.id }}, '#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})')">
                  <img alt="" class="rider-avatar" data-rider-id="{{ rider.id }}">
                  <span class="rider-info">
                    <span class="rider-number">#{{ rider.rider_number }}</span>
                    <span class="rider-name">{{ rider.name }}</span>
                    <span class="rider-brand">{{ rider.bike_brand }}</span>
                  </span>
                  {% if rider.id in out_ids %}<span class="out-badge">OUT</span>{% endif %}
                </div>
              {% endfor %}
            </div>
      </div>
    </div>

        <!-- Hidden select element for form submission -->
        <select id="wildcard-pick" name="wildcard_pick" style="display: none;">
  <option value="">-- v√§lj 450cc f√∂rare --</option>
  {% for rider in riders_450 %}
            <option value="{{ rider.id }}">#{{ rider.rider_number }} {{ rider.name }} ({{ rider.bike_brand }})</option>
  {% endfor %}
        </select>
      </div>
    </div>
    {% endif %}

    <div class="mt-4 sm:mt-6 flex gap-3">
      <button onclick="savePicks()" class="flex-1 bg-green-600 text-white font-bold py-2 sm:py-3 rounded text-sm sm:text-base">üíæ Spara Mina Val</button>
      {% if picks_locked %}
      <button onclick="showOtherUsersPicks()" class="bg-blue-600 text-white font-bold py-2 sm:py-3 rounded text-sm sm:text-base">üë• Visa Andras Picks</button>
      {% endif %}
    </div>

    {% else %}
    <h2 class="text-xl sm:text-2xl font-semibold mb-3 sm:mb-4 text-cyan-400 border-b border-cyan-500 pb-2">Resultat vs Dina Val</h2>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 lg:gap-8">
      <div>
        <h3 class="text-lg sm:text-xl font-bold mb-2 sm:mb-3 text-cyan-400 bg-gray-800 border border-cyan-500 px-3 py-2 rounded-md">{{ class_450_label }}</h3>
        <div id="results-450" class="space-y-1 sm:space-y-2"></div>
      </div>
      <div>
        <h3 class="text-lg sm:text-xl font-bold mb-2 sm:mb-3 text-cyan-400 bg-gray-800 border border-cyan-500 px-3 py-2 rounded-md">{{ class_250_label }}</h3>
        <div id="results-250" class="space-y-1 sm:space-y-2"></div>
      </div>
    </div>

    <div class="mt-4 sm:mt-6">
      <h3 class="text-lg sm:text-xl font-bold mb-2 sm:mb-3 text-cyan-400 bg-gray-800 border border-cyan-500 px-3 py-2 rounded-md">Holeshot Resultat</h3>
      <div id="holeshot-results" class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4"></div>
    </div>

    {% if competition.series != 'WSX' %}
    <div class="mt-4 sm:mt-6">
      <h3 class="text-lg sm:text-xl font-bold mb-2 sm:mb-3 text-cyan-400 bg-gray-800 border border-cyan-500 px-3 py-2 rounded-md">Wildcard Resultat</h3>
      <div id="wildcard-result" class="p-3 sm:p-4 bg-purple-900/40 border border-purple-500 rounded"></div>
    </div>
    {% endif %}
    {% endif %}
  </div>


<script>
  // Serverdata
  const competitionId = {{ competition.id|tojson }};
  const competitionName = {{ competition.name|tojson }};
  const competitionSeries = {{ competition.series|tojson }};
  const isWSXSeries = competitionSeries === 'WSX';
  const actualResults = {{ actual_results|tojson }};
  const holeshotResults = {{ holeshot_results|tojson }};
  const allRiders = {{ (riders_450_json + riders_250_json) | tojson }};
  // NYTT: OUT-lista fr√•n servern f√∂r att kunna validera i UI
  const OUT_IDS = {{ out_ids | tojson }};
  // Coast-filtrering f√∂r 250cc
  const competitionCoast = {{ competition.coast_250|tojson }};
  

  // Load saved picks from localStorage on page load
  loadSavedPicksFromStorage();
  
  // Function to clear localStorage picks (for debugging)
  function clearLocalStoragePicks() {
    localStorage.removeItem(`race_picks_${competitionId}`);
    // Reload the page to see empty picks
    location.reload();
  }
  
  // Make it available globally for debugging
  window.clearLocalStoragePicks = clearLocalStoragePicks;

  // Save picks to localStorage
  function savePicksToStorage() {
    const picks = {
      competitionId: competitionId,
      timestamp: Date.now(),
      racePicks: {},
      holeshotPicks: {},
      wildcardPick: null,
      wildcardPosition: null
    };

    // Save race picks (450cc/wsx_sx1 and 250cc/wsx_sx2)
    const riderClasses = isWSXSeries ? ['wsx_sx1', 'wsx_sx2'] : ['450cc', '250cc'];
    riderClasses.forEach(riderClass => {
      picks.racePicks[riderClass] = {};
      for (let i = 1; i <= 6; i++) {
        const selector = document.querySelector(`.rider-selector[data-class="${riderClass}"][data-position="${i}"]`);
        if (selector) {
          const selectedRiderSpan = selector.querySelector('.selected-rider');
          const currentText = selectedRiderSpan.textContent;
          
          if (currentText !== '-- v√§lj f√∂rare --' && currentText !== '-- v√§lj 450cc f√∂rare --') {
            const riderOption = selector.querySelector(`.rider-option[data-rider-name="${currentText}"]`);
            if (riderOption) {
              picks.racePicks[riderClass][i] = {
                riderId: riderOption.dataset.riderId,
                riderName: riderOption.dataset.riderName
              };
            }
          }
        }
      }
    });

    // Save holeshot picks
    ['450', '250'].forEach(classType => {
      const selector = document.querySelector(`.rider-selector[data-class="holeshot-${classType}"]`);
      if (selector) {
        const selectedRiderSpan = selector.querySelector('.selected-rider');
        const currentText = selectedRiderSpan.textContent;
        
        if (currentText !== '-- v√§lj f√∂rare --') {
          const riderOption = selector.querySelector(`.rider-option[data-rider-name="${currentText}"]`);
          if (riderOption) {
            picks.holeshotPicks[classType] = {
              riderId: riderOption.dataset.riderId,
              riderName: riderOption.dataset.riderName
            };
          }
        }
      }
    });

    // Save wildcard pick (only for non-WSX series)
    if (!isWSXSeries) {
      const wildcardSelector = document.querySelector(`.rider-selector[data-class="wildcard-pick"]`);
      if (wildcardSelector) {
        const selectedRiderSpan = wildcardSelector.querySelector('.selected-rider');
        const currentText = selectedRiderSpan.textContent;
        
        if (currentText !== '-- v√§lj 450cc f√∂rare --') {
          const riderOption = wildcardSelector.querySelector(`.rider-option[data-rider-name="${currentText}"]`);
          if (riderOption) {
            picks.wildcardPick = {
              riderId: riderOption.dataset.riderId,
              riderName: riderOption.dataset.riderName
            };
          }
        }
      }

      // Save wildcard position
      const wildcardPosition = document.getElementById('wildcard-position');
      if (wildcardPosition && wildcardPosition.value) {
        picks.wildcardPosition = wildcardPosition.value;
      }
    }

    localStorage.setItem(`race_picks_${competitionId}`, JSON.stringify(picks));
  }

  // Load picks from localStorage
  function loadSavedPicksFromStorage() {
    const savedPicks = localStorage.getItem(`race_picks_${competitionId}`);
    
    if (!savedPicks) {
      return;
    }

    try {
      const picks = JSON.parse(savedPicks);
      // Check if the stored competition ID matches the current competition
      // If not, clear the localStorage for this competition
      if (picks.competitionId && picks.competitionId !== competitionId) {
        localStorage.removeItem(`race_picks_${competitionId}`);
        return;
      }

      // Load race picks
      const riderClasses = isWSXSeries ? ['wsx_sx1', 'wsx_sx2'] : ['450cc', '250cc'];
      riderClasses.forEach(riderClass => {
        if (picks.racePicks[riderClass]) {
          Object.keys(picks.racePicks[riderClass]).forEach(position => {
            const pick = picks.racePicks[riderClass][position];
            const selector = document.querySelector(`.rider-selector[data-class="${riderClass}"][data-position="${position}"]`);
            if (selector && pick) {
              const selectedRiderSpan = selector.querySelector('.selected-rider');
              selectedRiderSpan.textContent = pick.riderName;
              
              // Show clear button
              const clearBtn = selector.querySelector('.clear-selection');
              if (clearBtn) {
                clearBtn.style.display = 'block';
              }
              
              // Update hidden select
              const hiddenSelect = document.querySelector(`select[name="pick_${riderClass.replace('cc', '')}_${position}"]`);
              if (hiddenSelect) {
                hiddenSelect.value = pick.riderId;
              }
              
              // Update preview image
              onPickChange(riderClass, position, pick.riderId);
            }
          });
        }
      });

      // Load holeshot picks
      ['450', '250'].forEach(classType => {
        if (picks.holeshotPicks[classType]) {
          const pick = picks.holeshotPicks[classType];
          const selector = document.querySelector(`.rider-selector[data-class="holeshot-${classType}"]`);
          if (selector && pick) {
            const selectedRiderSpan = selector.querySelector('.selected-rider');
            selectedRiderSpan.textContent = pick.riderName;
            
            // Update hidden select
            const hiddenSelect = document.getElementById(`holeshot-${classType}`);
            if (hiddenSelect) {
              hiddenSelect.value = pick.riderId;
            }
          }
        }
      });

      // Load wildcard pick (only for non-WSX series)
      if (!isWSXSeries && picks.wildcardPick) {
        const pick = picks.wildcardPick;
        const selector = document.querySelector(`.rider-selector[data-class="wildcard-pick"]`);
        if (selector && pick) {
          const selectedRiderSpan = selector.querySelector('.selected-rider');
          selectedRiderSpan.textContent = pick.riderName;
          
          // Update hidden select
          const hiddenSelect = document.getElementById('wildcard-pick');
          if (hiddenSelect) {
            hiddenSelect.value = pick.riderId;
          }
        }
      }

      // Load wildcard position (only for non-WSX series)
      if (!isWSXSeries && picks.wildcardPosition) {
        const wildcardPosEl = document.getElementById('wildcard-position');
        const wildcardLabelEl = document.getElementById('wildcard-position-label');
        if (wildcardPosEl) wildcardPosEl.value = picks.wildcardPosition;
        if (wildcardLabelEl) wildcardLabelEl.textContent = `Plats ${picks.wildcardPosition}`;
      }

      // Update rider selectors to hide selected riders
      const riderClassesForUpdate = isWSXSeries ? ['wsx_sx1', 'wsx_sx2'] : ['450cc', '250cc'];
      riderClassesForUpdate.forEach(cls => updateRiderSelectors(cls));
      
      // Remove wrong coast selections after loading picks
      removeWrongCoastSelections();

    } catch (error) {
      console.error('Error loading picks from localStorage:', error);
    }
  }

  // Remove wrong coast selections
  function removeWrongCoastSelections() {
    if (competitionCoast && competitionCoast !== 'both') {
      
      // Check all 250cc selectors
      const selectors250 = document.querySelectorAll('.rider-selector[data-class="250cc"]');
      selectors250.forEach(selector => {
        const selectedRiderSpan = selector.querySelector('.selected-rider');
        const currentText = selectedRiderSpan.textContent;
        
        // Skip if no selection made yet
        if (currentText === '-- v√§lj f√∂rare --' || currentText === '-- v√§lj 250cc f√∂rare --') {
          return;
        }
        
        // Find the rider option that matches the selected text
        const riderOption = selector.querySelector(`.rider-option[data-rider-name="${currentText}"]`);
        if (riderOption) {
          const riderCoast = riderOption.dataset.coast;
          if (riderCoast && riderCoast !== competitionCoast && riderCoast !== 'both') {
            // Clear the selection
            selectedRiderSpan.textContent = '-- v√§lj f√∂rare --';
            
            // Clear the preview image
            const position = selector.dataset.position;
            const imgId = `prev-250-${position}`;
            const img = document.getElementById(imgId);
            if (img) {
              img.src = '';
              img.style.background = 'linear-gradient(135deg, #1a1a2e, #16213e)';
            }
            
            // Clear localStorage for this pick
            const savedPicks = JSON.parse(localStorage.getItem(`race_picks_${competitionId}`) || '{}');
            if (savedPicks.racePicks && savedPicks.racePicks['250cc']) {
              delete savedPicks.racePicks['250cc'][position];
              localStorage.setItem(`race_picks_${competitionId}`, JSON.stringify(savedPicks));
            }
          }
        }
      });
    }
  }

  // Rider Selector Functions
  function toggleRiderSelector(riderClass, position) {
    // Handle both regular race picks (with position) and holeshot/wildcard (without position)
    let selector;
    if (position !== undefined && position !== 0) {
      selector = document.querySelector(`.rider-selector[data-class="${riderClass}"][data-position="${position}"]`);
    } else {
      selector = document.querySelector(`.rider-selector[data-class="${riderClass}"]`);
    }
    
    if (!selector) {
      return;
    }
    
    const dropdown = selector.querySelector('.rider-selector-dropdown');
    if (!dropdown) {
      return;
    }
    
    const isOpen = dropdown.style.display !== 'none';
    
    // Close all other dropdowns
    document.querySelectorAll('.rider-selector-dropdown').forEach(dd => {
      dd.style.display = 'none';
    });
    document.querySelectorAll('.rider-selector').forEach(sel => {
      sel.classList.remove('open');
    });
    
    // Toggle current dropdown
    if (!isOpen) {
      dropdown.style.display = 'block';
      selector.classList.add('open');
      
      // Update rider selectors to hide already selected riders
      if (riderClass === '450cc' || riderClass === '250cc' || riderClass === 'wsx_sx1' || riderClass === 'wsx_sx2') {
        updateRiderSelectors(riderClass);
      }
      
      // Load rider images when dropdown opens
      loadRiderImages(riderClass, position);
      
      // Don't focus search input on mobile to prevent keyboard from appearing
      // This allows scrolling without keyboard blocking the view
      const isMobile = window.innerWidth <= 768;
      if (!isMobile) {
        const searchInput = dropdown.querySelector('input');
        if (searchInput) {
          setTimeout(() => searchInput.focus(), 100);
        }
      }
    }
  }

  // Load rider images for dropdown
  function loadRiderImages(riderClass, position) {
    // Handle both regular race picks (with position) and holeshot/wildcard (without position)
    let selector;
    if (position !== undefined && position !== 0) {
      selector = document.querySelector(`.rider-selector[data-class="${riderClass}"][data-position="${position}"]`);
    } else {
      selector = document.querySelector(`.rider-selector[data-class="${riderClass}"]`);
    }
    
    if (!selector) {
      return;
    }
    
    const riderOptions = selector.querySelectorAll('.rider-option');
    
    riderOptions.forEach(option => {
      const img = option.querySelector('.rider-avatar');
      const riderId = option.dataset.riderId;
      
      if (img && riderId && !img.src) {
        // Set image source using the same logic as imgSrcFor
        const rider = allRiders.find(r => r.id == riderId);
        // Use imgSrcFor to get the correct image source (handles all cases including brand logos)
        const imageSrc = imgSrcFor(riderId);
        if (imageSrc) {
          img.src = imageSrc;
          img.onerror = function() {
            // If image fails to load, try JPG if we tried PNG (for constructed filenames)
            if (imageSrc.endsWith('.png') && rider && rider.rider_number && rider.name) {
              const nameSlug = (rider.name || '').toLowerCase().trim().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
              const jpgPath = `riders/${rider.rider_number}_${nameSlug}.jpg`;
              this.src = `/static/${jpgPath}`;
              this.onerror = function() {
                // If JPG also fails, try brand logo
                if (rider && rider.bike_brand) {
                  const brandName = (rider.bike_brand || "").toLowerCase().trim();
                  const brandMap = {
                    'honda': 'honda',
                    'ktm': 'ktm',
                    'yamaha': 'yamaha',
                    'kawasaki': 'kawasaki',
                    'suzuki': 'suzuki',
                    'husqvarna': 'husqvarna',
                    'gasgas': 'gasgas',
                    'beta': 'beta',
                    'triumph': 'triumph'
                  };
                  const logoName = brandMap[brandName] || brandName;
                  this.src = `/static/brand_logos/${logoName}.png`;
                  this.onerror = function() {
                    // Final fallback
                    this.src = '/static/brand_logos/honda.png';
                  };
                } else {
                  this.src = '/static/brand_logos/honda.png';
                }
              };
              return;
            }
            // If not a constructed filename or JPG already tried, try brand logo
            if (rider && rider.bike_brand) {
              const brandName = (rider.bike_brand || "").toLowerCase().trim();
              const brandMap = {
                'honda': 'honda',
                'ktm': 'ktm',
                'yamaha': 'yamaha',
                'kawasaki': 'kawasaki',
                'suzuki': 'suzuki',
                'husqvarna': 'husqvarna',
                'gasgas': 'gasgas',
                'beta': 'beta',
                'triumph': 'triumph'
              };
              const logoName = brandMap[brandName] || brandName;
              this.src = `/static/brand_logos/${logoName}.png`;
              this.onerror = function() {
                // Final fallback
                this.src = '/static/brand_logos/honda.png';
              };
            } else {
              this.src = '/static/brand_logos/honda.png';
            }
          };
        } else {
          // No image found, use brand logo directly
          if (rider && rider.bike_brand) {
            const brandName = (rider.bike_brand || "").toLowerCase().trim();
            const brandMap = {
              'honda': 'honda',
              'ktm': 'ktm',
              'yamaha': 'yamaha',
              'kawasaki': 'kawasaki',
              'suzuki': 'suzuki',
              'husqvarna': 'husqvarna',
              'gasgas': 'gasgas',
              'beta': 'beta',
              'triumph': 'triumph'
            };
            const logoName = brandMap[brandName] || brandName;
            img.src = `/static/brand_logos/${logoName}.png`;
          } else {
            img.src = '/static/brand_logos/honda.png';
          }
        }
      }
    });
  }

  function selectRider(riderClass, position, riderId, riderName) {
    // Check coast validation for 250cc riders
    if (riderClass === '250cc' && competitionCoast && competitionCoast !== 'both') {
      const riderOption = document.querySelector(`.rider-option[data-rider-id="${riderId}"]`);
      if (riderOption) {
        const riderCoast = riderOption.dataset.coast;
        if (riderCoast && riderCoast !== competitionCoast && riderCoast !== 'both') {
          alert(`Du kan inte v√§lja ${riderName} - denna f√∂rare k√∂r ${riderCoast} coast, men denna t√§vling √§r ${competitionCoast} coast.`);
          return;
        }
      }
    }
    
    const selector = document.querySelector(`.rider-selector[data-class="${riderClass}"][data-position="${position}"]`);
    const selectedRiderSpan = selector.querySelector('.selected-rider');
    
    // Update display
    selectedRiderSpan.textContent = riderName;
    
    // Show clear button
    const clearBtn = selector.querySelector('.clear-selection');
    if (clearBtn) {
      clearBtn.style.display = 'block';
    }
    
    // Close dropdown
    const dropdown = selector.querySelector('.rider-selector-dropdown');
    dropdown.style.display = 'none';
    selector.classList.remove('open');
    
    // Clear search
    const searchInput = dropdown.querySelector('input');
    if (searchInput) {
      searchInput.value = '';
      filterRiders(riderClass, position, '');
    }
    
    // Update the hidden select element for form submission
    const hiddenSelect = document.querySelector(`select[name="pick_${riderClass.replace('cc', '')}_${position}"]`);
    if (hiddenSelect) {
      hiddenSelect.value = riderId;
    }
    
    // Call existing onPickChange function to update preview image
    onPickChange(riderClass, position, riderId);
    
    // Update rider selectors to hide selected riders
    updateRiderSelectors(riderClass);
    
    // Save picks to localStorage
    savePicksToStorage();
  }

  function filterRiders(riderClass, position, searchTerm) {
    // Handle both regular race picks (with position) and holeshot/wildcard (without position)
    let selector;
    if (position !== undefined && position !== 0) {
      selector = document.querySelector(`.rider-selector[data-class="${riderClass}"][data-position="${position}"]`);
    } else {
      selector = document.querySelector(`.rider-selector[data-class="${riderClass}"]`);
    }
    
    if (!selector) {
      return;
    }
    const riderOptions = selector.querySelectorAll('.rider-option');
    const searchLower = searchTerm.toLowerCase();
    
    // Get currently selected riders in this class (excluding current position)
    // For wildcard and holeshot, we don't need to check for duplicates since they're independent
    let chosenRiderIds = [];
    if (riderClass === '450cc' || riderClass === '250cc') {
      const selectors = document.querySelectorAll(`.rider-selector[data-class="${riderClass}"]`);
      chosenRiderIds = Array.from(selectors).map(sel => {
        if (sel === selector) return null; // Skip current selector
        const selectedRiderSpan = sel.querySelector('.selected-rider');
        const currentText = selectedRiderSpan.textContent;
        
        // Skip if no selection made yet
        if (currentText === '-- v√§lj f√∂rare --' || currentText === '-- v√§lj 450cc f√∂rare --') {
          return null;
        }
        
        // Find the rider option that matches the selected text
        const riderOption = sel.querySelector(`.rider-option[data-rider-name="${currentText}"]`);
        return riderOption ? riderOption.dataset.riderId : null;
      }).filter(Boolean);
    }
    
    riderOptions.forEach(option => {
      const riderName = option.querySelector('.rider-name').textContent.toLowerCase();
      const riderNumber = option.querySelector('.rider-number').textContent.toLowerCase();
      const riderBrand = option.querySelector('.rider-brand').textContent.toLowerCase();
      const riderId = option.dataset.riderId;
      
      const matchesSearch = riderName.includes(searchLower) || 
                           riderNumber.includes(searchLower) || 
                           riderBrand.includes(searchLower);
      
      const isAlreadySelected = chosenRiderIds.includes(riderId);
      const isOut = option.dataset.out === 'true';
      
      // Check coast for 250cc race picks (not holeshot)
      let isWrongCoast = false;
      if (riderClass === '250cc' && competitionCoast && competitionCoast !== 'both') {
        const riderCoast = option.dataset.coast;
        if (riderCoast) {
          isWrongCoast = riderCoast !== competitionCoast && riderCoast !== 'both';
        }
      }
      
      // Show only if matches search AND not already selected AND not out AND not wrong coast
      option.style.display = (matchesSearch && !isAlreadySelected && !isOut && !isWrongCoast) ? 'flex' : 'none';
    });
  }

  // Close dropdowns when clicking outside
  document.addEventListener('click', function(event) {
    if (!event.target.closest('.rider-selector')) {
      document.querySelectorAll('.rider-selector-dropdown').forEach(dropdown => {
        dropdown.style.display = 'none';
      });
      document.querySelectorAll('.rider-selector').forEach(selector => {
        selector.classList.remove('open');
      });
    }
  });

  // Handle wildcard rider selection
  function selectWildcardRider(riderId, riderName) {
    const selector = document.querySelector(`.rider-selector[data-class="wildcard-pick"]`);
    const selectedRiderSpan = selector.querySelector('.selected-rider');
    
    // Update display
    selectedRiderSpan.textContent = riderName;
    
    // Close dropdown
    const dropdown = selector.querySelector('.rider-selector-dropdown');
    dropdown.style.display = 'none';
    selector.classList.remove('open');
    
    // Clear search
    const searchInput = dropdown.querySelector('input');
    if (searchInput) {
      searchInput.value = '';
      filterRiders('wildcard-pick', 0, '');
    }
    
    // Update the hidden select element for form submission
    const hiddenSelect = document.getElementById('wildcard-pick');
    if (hiddenSelect) {
      hiddenSelect.value = riderId;
    }
    
    // Save picks to localStorage
    savePicksToStorage();
  }

  // Handle holeshot rider selection
  function selectHoleshotRider(classType, riderId, riderName) {
    const selector = document.querySelector(`.rider-selector[data-class="holeshot-${classType}"]`);
    const selectedRiderSpan = selector.querySelector('.selected-rider');
    
    // Update display
    selectedRiderSpan.textContent = riderName;
    
    // Close dropdown
    const dropdown = selector.querySelector('.rider-selector-dropdown');
    dropdown.style.display = 'none';
    selector.classList.remove('open');
    
    // Clear search
    const searchInput = dropdown.querySelector('input');
    if (searchInput) {
      searchInput.value = '';
      filterRiders(`holeshot-${classType}`, 0, '');
    }
    
    // Update the hidden select element for form submission
    const hiddenSelect = document.getElementById(`holeshot-${classType}`);
    if (hiddenSelect) {
      hiddenSelect.value = riderId;
    }
    
    // Save picks to localStorage
    savePicksToStorage();
  }

  // Clear rider selection
  function clearRiderSelection(riderClass, position) {
    const selector = document.querySelector(`.rider-selector[data-class="${riderClass}"][data-position="${position}"]`);
    const selectedRiderSpan = selector.querySelector('.selected-rider');
    const clearBtn = selector.querySelector('.clear-selection');
    
    // Reset display
    selectedRiderSpan.textContent = '-- v√§lj f√∂rare --';
    
    // Hide clear button
    if (clearBtn) {
      clearBtn.style.display = 'none';
    }
    
    // Clear hidden select
    const hiddenSelect = document.querySelector(`select[name="pick_${riderClass.replace('cc', '')}_${position}"]`);
    if (hiddenSelect) {
      hiddenSelect.value = '';
    }
    
    // Clear preview image
    onPickChange(riderClass, position, null);
    
    // Update rider selectors to show all options again
    updateRiderSelectors(riderClass);
    
    // Save picks to localStorage
    savePicksToStorage();
  }

  // Update rider selector options (replaces updateDropdowns for new system)
  function updateRiderSelectors(riderClass) {
    const selectors = document.querySelectorAll(`.rider-selector[data-class="${riderClass}"]`);
    
    // Get currently selected riders in this class
    const chosenRiderIds = Array.from(selectors).map(selector => {
      const selectedRiderSpan = selector.querySelector('.selected-rider');
      const currentText = selectedRiderSpan.textContent;
      
      // Skip if no selection made yet
      if (currentText === '-- v√§lj f√∂rare --' || currentText === '-- v√§lj 450cc f√∂rare --') {
        return null;
      }
      
      // Find the rider option that matches the selected text
      const riderOption = selector.querySelector(`.rider-option[data-rider-name="${currentText}"]`);
      return riderOption ? riderOption.dataset.riderId : null;
    }).filter(Boolean);
    
    
    // Update each selector
    selectors.forEach(selector => {
      const riderOptions = selector.querySelectorAll('.rider-option');
      const currentSelected = selector.querySelector('.selected-rider').textContent;
      
      riderOptions.forEach(option => {
        const riderId = option.dataset.riderId;
        const isChosenElsewhere = chosenRiderIds.includes(riderId) && 
                                 option.dataset.riderName !== currentSelected;
        const isOut = option.dataset.out === 'true';
        
        // Check coast for 250cc riders
        let isWrongCoast = false;
        if (riderClass === '250cc' && competitionCoast && competitionCoast !== 'both') {
          const riderCoast = option.dataset.coast;
          if (riderCoast) {
            isWrongCoast = riderCoast !== competitionCoast && riderCoast !== 'both';
          }
        }
        
        // Hide if chosen elsewhere, out, or wrong coast
        if (isChosenElsewhere || isOut || isWrongCoast) {
          option.style.display = 'none';
        } else {
          option.style.display = 'flex';
        }
      });
    });
  }

  function updateDropdowns(riderClass) {
    const selects = document.querySelectorAll(
      `.pick-select[data-class="${riderClass}"]`
    );

    // 1) Nollst√§ll om n√•gon r√•kar ha en OUT vald i denna klass
    selects.forEach((sel) => {
      const val = sel.value;
      if (val && OUT_IDS.includes(Number(val))) {
        sel.value = "";
      }
    });

    // 2) H√§mta alla valda riders i denna klass
    const chosenRiderIds = Array.from(selects)
      .map((s) => s.value)
      .filter(Boolean);

    // 3) Uppdatera varje dropdown - TA BORT valda riders helt ist√§llet f√∂r att bara disablea
    selects.forEach((sel) => {
      const currentValue = sel.value;
      const optionsToRemove = [];
      
      for (const opt of sel.options) {
        if (!opt.value) continue;
        
        const isChosenElsewhere =
          chosenRiderIds.includes(opt.value) && sel.value !== opt.value;
        const isOut = OUT_IDS.includes(Number(opt.value));
        
        // Coast-filtrering f√∂r 250cc
        let isWrongCoast = false;
        if (riderClass === "250cc" && competitionCoast && competitionCoast !== "both") {
          const rider = allRiders.find(r => String(r.id) === String(opt.value));
          if (rider && rider.class === "250cc") {
            // Till√•t endast samma coast eller 'both'
            isWrongCoast = rider.coast_250 && rider.coast_250 !== competitionCoast && rider.coast_250 !== "both";
          }
        }
        
        // Ta bort option helt om den √§r vald n√•gon annanstans, OUT, eller fel coast
        if (isChosenElsewhere || isOut || isWrongCoast) {
          optionsToRemove.push(opt);
        }
      }
      
      // Ta bort options som inte ska visas
      optionsToRemove.forEach(opt => {
        if (opt.value !== currentValue) { // Beh√•ll den som √§r vald
          opt.remove();
        }
      });
    });
  }

  // Uppdatera holeshot-dropdowns med coast-filtrering
  function updateHoleshotDropdowns() {
    const holeshot250 = document.getElementById('holeshot-250');
    if (holeshot250 && competitionCoast && competitionCoast !== "both") {
      const currentValue = holeshot250.value;
      const optionsToRemove = [];
      
      for (const opt of holeshot250.options) {
        if (!opt.value) continue;
        const rider = allRiders.find(r => String(r.id) === String(opt.value));
        if (rider && rider.class === "250cc") {
          const isWrongCoast = rider.coast_250 && rider.coast_250 !== competitionCoast && rider.coast_250 !== "both";
          const isOut = OUT_IDS.includes(Number(opt.value));
          
          // Ta bort option helt om den har fel coast eller √§r OUT
          if (isWrongCoast || isOut) {
            optionsToRemove.push(opt);
          }
        }
      }
      
      // Ta bort options som inte ska visas
      optionsToRemove.forEach(opt => {
        if (opt.value !== currentValue) { // Beh√•ll den som √§r vald
          opt.remove();
        }
      });
    }
  }

  const findRiderName = (id) => {
    const r = allRiders.find((x) => String(x.id) === String(id));
    return r ? r.name : "Ok√§nd";
  };

  // Bygg bild-URL fr√•n rider-data: headshot f√∂rst, annars brand-logga
function wsxSlug(name) {
  return (name || "").toLowerCase().trim().replace(/\./g, "").replace(/\s+/g, "_").replace(/[^a-z0-9_]/g, "");
}

function imgSrcFor(riderId) {
  const r = allRiders.find((x) => Number(x.id) === Number(riderId));
  if (!r) {
    return '/static/brand_logos/honda.png'; // Default fallback
  }
  
  // Try rider image first (check both PNG and JPG)
  if (r.image_url) {
    // Remove 'riders/' prefix if it exists to avoid double path
    const imagePath = r.image_url.startsWith('riders/') ? r.image_url : `riders/${r.image_url}`;
    const url = `/static/${imagePath}`;
    return url;
  }
  
  // If WSX rider without image_url in DB, construct path same way as other riders
  const isWSX = (r.class === 'wsx_sx1' || r.class === 'wsx_sx2' || (r.series_participation && r.series_participation && r.series_participation.toLowerCase() === 'wsx'));
  if (isWSX && r.name) {
    // Files are: name (1).jpg (without underscores, just lowercase with space before (1))
    // Remove spaces and special chars for filename matching
    const fileSlug = (r.name || '').toLowerCase().trim().replace(/\./g, '').replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');
    // Build path same as other riders: riders/wsx/filename
    const imagePath = `riders/wsx/${fileSlug} (1).jpg`;
    const url = `/static/${imagePath}`;
    return url;
  }

  // If no image_url, try to construct filename from rider_number and name (standard format: 50_enzo_lopes.png)
  if (r.rider_number && r.name) {
    const nameSlug = (r.name || '').toLowerCase().trim().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
    // Try PNG first
    const pngPath = `riders/${r.rider_number}_${nameSlug}.png`;
    const jpgPath = `riders/${r.rider_number}_${nameSlug}.jpg`;
    // Return PNG path (we'll handle fallback to JPG in onerror handler)
    return `/static/${pngPath}`;
  }

  // If no rider image, use bike brand logo directly
  if (r.bike_brand) {
    const brandName = (r.bike_brand || "").toLowerCase().trim();
    // Map common brand names to logo files
    const brandMap = {
      'honda': 'honda',
      'ktm': 'ktm',
      'yamaha': 'yamaha',
      'kawasaki': 'kawasaki',
      'suzuki': 'suzuki',
      'husqvarna': 'husqvarna',
      'gasgas': 'gasgas',
      'beta': 'beta',
      'triumph': 'triumph'
    };
    const logoName = brandMap[brandName] || brandName;
    return `/static/brand_logos/${logoName}.png`;
  }
  
  // Final fallback to Honda logo
  return '/static/brand_logos/honda.png';
}

  // Function to handle image loading errors
function handleImageError(img) {
  // If we tried jpg from wsx folder, try variations
  const src = img.getAttribute('src') || '';
  if (src.includes('/static/riders/wsx/')) {
    // Try variations: _(1).jpg -> _(2).jpg -> space version (1).jpg -> .jpg -> .png
    if (src.includes('_(1).jpg')) {
      // Try (2) suffix with underscore
      const withTwo = src.replace('_(1).jpg', '_(2).jpg');
      img.onerror = function() {
        // Try with space instead of underscore
        const withSpace = src.replace('_(1).jpg', ' (1).jpg');
        img.onerror = function() {
          // Try without suffix
          const withoutSuffix = src.replace('_(1).jpg', '.jpg');
          img.onerror = function() {
            // Try png
            const png = src.replace('_(1).jpg', '.png');
            img.onerror = function() {
              // Fall back to brand logo
              const riderId = img.getAttribute('data-rider-id');
              const r = allRiders.find((x) => String(x.id) === String(riderId));
              if (r && r.bike_brand) {
                img.src = `/static/brand_logos/${(r.bike_brand || "").toLowerCase().replace(/\s+/g, '_')}.png`;
              } else {
                img.src = '/static/brand_logos/honda.png';
              }
            };
            img.src = png;
          };
          img.src = withoutSuffix;
        };
        img.src = withSpace;
      };
      img.src = withTwo;
      return;
    }
    // Try without (1) suffix if it had one (with space)
    if (src.includes(' (1).jpg')) {
      const withoutSuffix = src.replace(' (1).jpg', '.jpg');
      img.onerror = function() {
        // Try (2) suffix
        const withTwo = src.replace(' (1).jpg', ' (2).jpg');
        img.onerror = function() {
          // Try png
          const png = src.replace(' (1).jpg', '.png');
          img.onerror = function() {
            // Fall back to brand logo
            const riderId = img.getAttribute('data-rider-id');
            const r = allRiders.find((x) => String(x.id) === String(riderId));
            if (r && r.bike_brand) {
              img.src = `/static/brand_logos/${(r.bike_brand || "").toLowerCase().replace(/\s+/g, '_')}.png`;
            } else {
              img.src = '/static/brand_logos/honda.png';
            }
          };
          img.src = png;
        };
        img.src = withTwo;
      };
      img.src = withoutSuffix;
      return;
    }
    // Try png if it was regular jpg
    if (src.endsWith('.jpg')) {
      const png = src.replace(/\.jpg$/i, '.png');
      img.onerror = function() {
        // Fall back to brand logo
        const riderId = img.getAttribute('data-rider-id');
        const r = allRiders.find((x) => String(x.id) === String(riderId));
        if (r && r.bike_brand) {
          img.src = `/static/brand_logos/${(r.bike_brand || "").toLowerCase()}.png`;
        } else {
          img.src = '/static/brand_logos/honda.png';
        }
      };
      img.src = png;
      return;
    }
  }

  // Replace with minimal placeholder
  img.style.display = 'none';
  const placeholder = document.createElement('div');
  placeholder.className = 'w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center flex-shrink-0';
  placeholder.innerHTML = '<span class="text-white text-xs">üèçÔ∏è</span>';
  img.parentNode.replaceChild(placeholder, img);
}

// Function to update picks status indicator
function updatePicksStatus(myPicks) {
  const statusIcon = document.getElementById('status-icon');
  const statusTitle = document.getElementById('status-title');
  const statusMessage = document.getElementById('status-message');
  const statusActions = document.getElementById('status-actions');
  const statusContainer = document.getElementById('picks-status');
  
  if (!statusIcon || !statusTitle || !statusMessage) return;
  
  const hasTop6Picks = myPicks.top6_picks && myPicks.top6_picks.length > 0;
  // Check for holeshot picks - backend may return '450cc'/'250cc' or 'wsx_sx1'/'wsx_sx2'
  const holeshot450 = myPicks.holeshot_picks?.['450cc'] || myPicks.holeshot_picks?.['wsx_sx1'];
  const holeshot250 = myPicks.holeshot_picks?.['250cc'] || myPicks.holeshot_picks?.['wsx_sx2'];
  const hasHoleshotPicks = myPicks.holeshot_picks && (holeshot450 || holeshot250);
  const hasWildcardPick = myPicks.wildcard_pick && !isWSXSeries; // Wildcard not for WSX
  
  // Count picks: top6_picks is array of all picks (12 total: 6 for 450cc/wsx_sx1 + 6 for 250cc/wsx_sx2)
  // For holeshot: count 2 if both 450cc and 250cc are picked, 1 if only one
  const holeshotCount = myPicks.holeshot_picks ? 
    ((holeshot450 ? 1 : 0) + (holeshot250 ? 1 : 0)) : 0;
  
  const totalPicks = (myPicks.top6_picks?.length || 0) + holeshotCount + (hasWildcardPick ? 1 : 0);
  
  // Required picks: 12 top picks (6+6) + 2 holeshots + (0 for WSX, 1 wildcard for others) = 14 for WSX, 15 for others
  const totalRequired = isWSXSeries ? 14 : 15;
  
  if (totalPicks === 0) {
    // No picks made
    statusIcon.textContent = 'üìù';
    statusTitle.textContent = 'Inga val gjorda √§n';
    statusMessage.textContent = isWSXSeries ? 'G√∂r dina val f√∂r topp 6 och holeshot' : 'G√∂r dina val f√∂r topp 6, holeshot och wildcard';
    statusContainer.className = 'mb-4 p-4 rounded-lg border-2 border-dashed border-yellow-400 bg-yellow-900/30';
    statusActions.classList.add('hidden');
  } else if (totalPicks < totalRequired) {
    // Partial picks
    statusIcon.textContent = '‚ö†Ô∏è';
    statusTitle.textContent = `Delvis klart (${totalPicks}/${totalRequired} val)`;
    statusMessage.textContent = 'Du har gjort n√•gra val, men inte alla. Komplettera dina picks!';
    statusContainer.className = 'mb-4 p-4 rounded-lg border-2 border-dashed border-orange-400 bg-orange-900/30';
    statusActions.classList.remove('hidden');
  } else {
    // All picks made
    statusIcon.textContent = '‚úÖ';
    statusTitle.textContent = 'Alla val gjorda!';
    statusMessage.textContent = 'Du har gjort alla dina val f√∂r detta race. Lycka till!';
    statusContainer.className = 'mb-4 p-4 rounded-lg border-2 border-dashed border-green-400 bg-green-900/30';
    statusActions.classList.remove('hidden');
  }
}

// Function to clear all picks
async function clearAllPicks() {
  if (!confirm('√Ñr du s√§ker p√• att du vill rensa alla dina val f√∂r detta race?')) {
    return;
  }
  
  try {
    const response = await fetch(`/clear_my_picks_for_competition/${competitionId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    if (response.ok) {
      // Don't clear form fields - keep picks visible
      
      // Update status
      updatePicksStatus({ top6_picks: [], holeshot_picks: {}, wildcard_pick: null });
      
      alert('Alla val har rensats!');
    } else {
      alert('Kunde inte rensa valen. F√∂rs√∂k igen.');
    }
  } catch (error) {
    console.error('Error clearing picks:', error);
    alert('Ett fel uppstod vid rensning av val.');
  }
}
function onPickChange(cls, pos, riderId = null) {
  
  // Handle both old select elements and new rider-selector
  let val = riderId;
  if (!val) {
  const sel = document.querySelector(
    `.pick-select[data-class="${cls}"][data-position="${pos}"]`
  );
    val = sel?.value;
  }
  
  const imgId = cls.startsWith("450") ? `prev-450-${pos}` : `prev-250-${pos}`;
  const img = document.getElementById(imgId);


  const src = val ? imgSrcFor(val) : null;
  
  
  if (img) {
    if (src) {
      img.src = src;
      if (val) img.setAttribute('data-rider-id', String(val));
      img.classList.add("has-src"); // g√∂r preview tydligare
      img.style.background = "transparent";
      img.onerror = function() { handleImageError(this); };
    } else {
      img.removeAttribute("src");
      img.classList.remove("has-src");
      img.style.background = "#4b5563";
    }
  }

  updateDropdowns(cls);
}

  function initializePreviewImages() {
    
    // Initialize rider selectors to filter out wrong coast riders
    updateRiderSelectors('450cc');
    updateRiderSelectors('250cc');
}

  async function displayResults(myPicks) {
    if (!actualResults || actualResults.length === 0) return;

    ["450", "250"].forEach((cls) => {
      const container = document.getElementById(`results-${cls}`);
      let html = "";
      for (let i = 1; i <= 6; i++) {
        const result = actualResults.find(
          (r) => r.class && r.class.startsWith(cls) && r.position === i
        );
        const pick = myPicks.top6_picks.find(
          (p) =>
            p.class && p.class.startsWith(cls) && p.predicted_position === i
        );

        if (!result && !pick) continue;

        const resultName = result ? `${findRiderName(result.id)}` : "Inget resultat";
        const pickName = pick ? `${findRiderName(pick.rider_id)}` : "Inget val";

        let cardClass = "bg-gray-700";
        if (pick && result && String(pick.rider_id) === String(result.id)) {
          cardClass += " result-correct";
        } else if (
          pick &&
          actualResults.some(
            (r) =>
              String(r.id) === String(pick.rider_id) &&
              r.class &&
              r.class.startsWith(cls) &&
              r.position <= 6
          )
        ) {
          cardClass += " result-close";
        }

        html += `
          <div class="p-3 rounded ${cardClass}">
            <p class="font-bold">${i}. ${resultName}</p>
            <p class="text-sm text-gray-300 pl-4">Ditt val: ${pickName}</p>
          </div>`;
      }
      if (container) container.innerHTML = html;
    });

    const hsContainer = document.getElementById("holeshot-results");
    if (hsContainer) {
      // Use correct class names based on series
      const holeshotClasses = isWSXSeries ? ['wsx_sx1', 'wsx_sx2'] : ['450cc', '250cc'];
      const holeshotLabels = isWSXSeries ? ['SX1', 'SX2'] : ['450cc', '250cc'];
      
      hsContainer.innerHTML = holeshotClasses
        .map((cls, index) => {
          // Also check for legacy keys
          const pickId = myPicks.holeshot_picks?.[cls] || 
                        (cls === 'wsx_sx1' ? myPicks.holeshot_picks?.['450cc'] : null) ||
                        (cls === 'wsx_sx2' ? myPicks.holeshot_picks?.['250cc'] : null);
          const pickName = pickId ? findRiderName(pickId) : "Inget val";
          // Check both new and legacy class names for results
          const result = holeshotResults.find((r) => r.class === cls || 
            (cls === 'wsx_sx1' && r.class === '450cc') ||
            (cls === 'wsx_sx2' && r.class === '250cc'));
          const resultName = result ? findRiderName(result.rider_id) : "Inget resultat";
          const label = holeshotLabels[index];

          let cardClass = "bg-gray-700";
          if (result && pickId && String(result.rider_id) === String(pickId)) {
            cardClass += " result-correct";
          }
          return `
            <div class="p-3 rounded ${cardClass}">
              <p class="font-bold">${label}: ${resultName}</p>
              <p class="text-sm text-gray-300 pl-4">Ditt val: ${pickName}</p>
            </div>`;
        })
        .join("");
    }
  }


  async function fetchAndDisplayMyPicks() {
    try {
      const res = await fetch(`/get_my_picks/${competitionId}`);
      if (!res.ok) throw new Error("Kunde inte h√§mta dina val");
      const myPicks = await res.json();
      
      // Update picks status
      updatePicksStatus(myPicks);

      if (!actualResults || actualResults.length === 0) {
        // √Öterst√§ll tidigare val i UI - samma logik som holeshot picksen
        (myPicks.top6_picks || []).forEach((p) => {
          // Map WSX classes to data-class attributes in HTML
          let dataClass = p.class;
          if (dataClass === 'wsx_sx1') {
            dataClass = 'wsx_sx1'; // Match the data-class we set in HTML
          } else if (dataClass === 'wsx_sx2') {
            dataClass = 'wsx_sx2'; // Match the data-class we set in HTML
          }
          
          // Find the rider name from the rider ID (same logic as holeshot uses)
          const rider = allRiders.find(r => Number(r.id) === Number(p.rider_id));
          
          if (!rider) {
            console.log(`DEBUG: Rider not found for ID ${p.rider_id}, class ${p.class}. Available rider IDs:`, allRiders.map(r => r.id));
            return;
          }
          
          console.log(`DEBUG: Found rider for pick: ${rider.name} (ID: ${p.rider_id}, class: ${p.class}), position: ${p.predicted_position}`);
          
          const selector = document.querySelector(
            `.rider-selector[data-class="${dataClass}"][data-position="${p.predicted_position}"]`
          );
          
          if (!selector) {
            console.log(`DEBUG: Selector not found for class ${dataClass}, position ${p.predicted_position}`);
            return;
          }
          
          const selectedRiderSpan = selector.querySelector('.selected-rider');
          if (!selectedRiderSpan) {
            console.log(`DEBUG: Selected rider span not found`);
            return;
          }
          
          // Update visual selector (same as holeshot does)
          const riderText = `#${rider.rider_number} ${rider.name} (${rider.bike_brand})`;
          selectedRiderSpan.textContent = riderText;
          
          // Show clear button
          const clearBtn = selector.querySelector('.clear-selection');
          if (clearBtn) {
            clearBtn.style.display = 'block';
          }
          
          // Update hidden select element - use 450/250 for hidden selects regardless of WSX
          const hiddenSelectClass = (p.class === 'wsx_sx1' || p.class === '450cc') ? '450' : '250';
          const hiddenSelect = document.querySelector(`select[name="pick_${hiddenSelectClass}_${p.predicted_position}"]`);
          if (hiddenSelect) {
            hiddenSelect.value = p.rider_id;
          } else {
            console.log(`DEBUG: Hidden select not found: pick_${hiddenSelectClass}_${p.predicted_position}`);
          }
          
          // Update preview image
          const imgId = (p.class === 'wsx_sx1' || p.class === '450cc' || p.class.startsWith("450"))
            ? `prev-450-${p.predicted_position}`
            : `prev-250-${p.predicted_position}`;
          const img = document.getElementById(imgId);
          if (img) {
            const src = imgSrcFor(p.rider_id);
            if (src) {
              img.src = src;
              img.style.background = "transparent";
            }
          }
        });
        
        // Update rider selectors to reflect loaded picks (hide selected riders in other dropdowns)
        // For WSX, use wsx_sx1 and wsx_sx2, otherwise use 450cc and 250cc
        const isWSX = competitionSeries === 'WSX';
        const class450 = isWSX ? 'wsx_sx1' : '450cc';
        const class250 = isWSX ? 'wsx_sx2' : '250cc';
        updateRiderSelectors(class450);
        updateRiderSelectors(class250);
        
        // Update holeshot picks - both hidden selects and visual elements
        // Backend may return '450cc'/'250cc' or 'wsx_sx1'/'wsx_sx2' for holeshot
        const holeshot450Id = myPicks.holeshot_picks?.["450cc"] || myPicks.holeshot_picks?.["wsx_sx1"];
        const holeshot250Id = myPicks.holeshot_picks?.["250cc"] || myPicks.holeshot_picks?.["wsx_sx2"];
        
        if (holeshot450Id) {
          document.getElementById("holeshot-450").value = holeshot450Id;
          
          // Update visual selector
          const selector = document.querySelector('.rider-selector[data-class="holeshot-450"]');
          if (selector) {
            const rider = allRiders.find(r => r.id === holeshot450Id);
            if (rider) {
              const selectedRiderSpan = selector.querySelector('.selected-rider');
              const riderText = `#${rider.rider_number} ${rider.name} (${rider.bike_brand})`;
              selectedRiderSpan.textContent = riderText;
              
              // Show clear button
              const clearBtn = selector.querySelector('.clear-selection');
              if (clearBtn) {
                clearBtn.style.display = 'block';
              }
            }
          }
        }
        
        if (holeshot250Id) {
          document.getElementById("holeshot-250").value = holeshot250Id;
          
          // Update visual selector
          const selector = document.querySelector('.rider-selector[data-class="holeshot-250"]');
          if (selector) {
            const rider = allRiders.find(r => r.id === holeshot250Id);
            if (rider) {
              const selectedRiderSpan = selector.querySelector('.selected-rider');
              const riderText = `#${rider.rider_number} ${rider.name} (${rider.bike_brand})`;
              selectedRiderSpan.textContent = riderText;
              
              // Show clear button
              const clearBtn = selector.querySelector('.clear-selection');
              if (clearBtn) {
                clearBtn.style.display = 'block';
              }
            }
          }
        }
        
        // Update wildcard pick - both hidden select and visual element
        if (myPicks.wildcard_pick) {
          const riderId = myPicks.wildcard_pick;
          document.getElementById("wildcard-pick").value = riderId;
          
          // Update visual selector
          const selector = document.querySelector('.rider-selector[data-class="wildcard-pick"]');
          if (selector) {
            const rider = allRiders.find(r => r.id === riderId);
            if (rider) {
              const selectedRiderSpan = selector.querySelector('.selected-rider');
              const riderText = `#${rider.rider_number} ${rider.name} (${rider.bike_brand})`;
              selectedRiderSpan.textContent = riderText;
              
              // Show clear button
              const clearBtn = selector.querySelector('.clear-selection');
              if (clearBtn) {
                clearBtn.style.display = 'block';
              }
            }
          }
        }

        // Wildcard-knapp: l√•s endast om position faktiskt finns
        const btn = document.getElementById("wildcard-roll-btn");
        const posVal = myPicks.wildcard_pos;
        if (posVal !== null && posVal !== undefined && String(posVal).trim() !== "") {
          document.getElementById("wildcard-position").value = posVal;
          document.getElementById("wildcard-position-label").textContent =
            `Din plats: ${posVal}`;
          btn.disabled = true;
          btn.classList.add("opacity-50", "cursor-not-allowed");
        } else {
          btn.disabled = false;
          btn.classList.remove("opacity-50", "cursor-not-allowed");
          document.getElementById("wildcard-position").value = "";
          document.getElementById("wildcard-position-label").textContent = "";
        }

        // Holeshot: rensa om OUT
const hs450Sel = document.getElementById("holeshot-450");
if (hs450Sel && hs450Sel.value && OUT_IDS.includes(Number(hs450Sel.value))) {
  hs450Sel.value = "";
}
const hs250Sel = document.getElementById("holeshot-250");
if (hs250Sel && hs250Sel.value && OUT_IDS.includes(Number(hs250Sel.value))) {
  hs250Sel.value = "";
}

// Wildcard: rensa om OUT
const wcSel = document.getElementById("wildcard-pick");
if (wcSel && wcSel.value && OUT_IDS.includes(Number(wcSel.value))) {
  wcSel.value = "";
}

        // NYTT: Rensa bort OUT som r√•kat ligga kvar som "vald"
        document.querySelectorAll(".pick-select").forEach((sel) => {
          const chosen = sel.value;
          if (chosen && OUT_IDS.includes(Number(chosen))) {
            sel.value = "";
          }
        });

        

        // Applicera disable-regler och OUT disable
        updateDropdowns("450cc");
        updateDropdowns("250cc");
  updateHoleshotDropdowns();
      }

      if (actualResults && actualResults.length > 0) {
        displayResults(myPicks);
      }
      
      // Remove wrong coast selections after loading picks from server
      removeWrongCoastSelections();
      
    } catch (e) {
      console.error(e);
    }
  }

  


  async function rollWildcard() {
    const btn = document.getElementById("wildcard-roll-btn");
    if (btn.disabled) return;
    const pos = Math.floor(Math.random() * 11) + 10; // 10-20
    try {
      const resp = await fetch("/lock_wildcard_pos", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ competition_id: competitionId, position: pos }),
      });
      const data = await resp.json();
      if (!resp.ok) {
        alert(data.error || "Kunde inte l√•sa wildcard");
        return;
      }
      if (data.status === "locked") {
        document.getElementById("wildcard-position").value = pos;
        document.getElementById("wildcard-position-label").textContent =
          `Din plats: ${pos}`;
        btn.disabled = true;
        btn.classList.add("opacity-50", "cursor-not-allowed");
        
        // Save picks to localStorage
        savePicksToStorage();
      } else {
        alert(data.error || "Kunde inte l√•sa wildcard");
      }
    } catch (e) {
      console.error(e);
      alert("N√§tverksfel vid l√•sning av wildcard");
    }
  }

  // Show other users' picks
  async function showOtherUsersPicks() {
    try {
      const response = await fetch(`/get_other_users_picks/${competitionId}`);
      if (!response.ok) throw new Error('Kunde inte h√§mta andra anv√§ndares picks');
      
      const usersPicks = await response.json();
      console.log('DEBUG: usersPicks received:', usersPicks);
      console.log('DEBUG: First user picks_450:', usersPicks[0]?.picks_450);
      console.log('DEBUG: First user picks_250:', usersPicks[0]?.picks_250);
      
      // Create modal to display picks
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-gray-800 rounded-lg p-6 max-w-4xl max-h-[80vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-white">Andra Anv√§ndares Picks</h3>
            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-3xl font-bold bg-gray-700 hover:bg-gray-600 rounded-full w-10 h-10 flex items-center justify-center transition-colors">&times;</button>
          </div>
          <div class="space-y-4">
            ${usersPicks.map(user => `
              <div class="bg-gray-700 rounded-lg p-4">
                <h4 class="text-lg font-semibold text-white mb-3">${user.display_name || user.username}</h4>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                  <div>
                    <h5 class="text-sm font-medium text-yellow-400 mb-2">${isWSXSeries ? 'SX1' : '450cc'} Picks</h5>
                    <div class="space-y-1">
                      ${user.picks_450.map((pick, index) => `
                        <div class="flex items-center gap-2 text-sm">
                          <span class="text-gray-400 w-6">${index + 1}.</span>
                          <span class="text-white">${pick.rider_name}</span>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                  <div>
                    <h5 class="text-sm font-medium text-blue-400 mb-2">${isWSXSeries ? 'SX2' : '250cc'} Picks</h5>
                    <div class="space-y-1">
                      ${user.picks_250.map((pick, index) => `
                        <div class="flex items-center gap-2 text-sm">
                          <span class="text-gray-400 w-6">${index + 1}.</span>
                          <span class="text-white">${pick.rider_name}</span>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                </div>
                ${user.holeshot_450 || user.holeshot_250 ? `
                  <div class="mt-3 pt-3 border-t border-gray-600">
                    <h5 class="text-sm font-medium text-green-400 mb-2">Holeshot Picks</h5>
                    <div class="flex gap-4 text-sm">
                      ${user.holeshot_450 ? `<span class="text-white">${isWSXSeries ? 'SX1' : '450cc'}: #${user.holeshot_450.rider_number} ${user.holeshot_450.rider_name}</span>` : ''}
                      ${user.holeshot_250 ? `<span class="text-white">${isWSXSeries ? 'SX2' : '250cc'}: #${user.holeshot_250.rider_number} ${user.holeshot_250.rider_name}</span>` : ''}
                    </div>
                  </div>
                ` : ''}
                ${user.wildcard && !isWSXSeries ? `
                  <div class="mt-3 pt-3 border-t border-gray-600">
                    <h5 class="text-sm font-medium text-purple-400 mb-2">Wildcard</h5>
                    <span class="text-white text-sm">Position ${user.wildcard.position}: #${user.wildcard.rider_number} ${user.wildcard.rider_name}</span>
                  </div>
                ` : ''}
              </div>
            `).join('')}
          </div>
          <div class="mt-6 flex justify-end">
            <button onclick="this.closest('.fixed').remove()" class="bg-gray-600 hover:bg-gray-500 text-white px-6 py-2 rounded-lg transition-colors">St√§ng</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    } catch (error) {
      alert('Fel vid h√§mtning av andra anv√§ndares picks: ' + error.message);
    }
  }

  // Helper function to get rider ID from selected rider
  function getRiderIdFromSelector(selector) {
    const selectedRiderSpan = selector.querySelector('.selected-rider');
    const riderText = selectedRiderSpan.textContent;
    
    if (riderText && riderText !== '-- v√§lj f√∂rare --') {
      // Find the rider option that matches the selected text
      const riderOptions = selector.querySelectorAll('.rider-option');
      
      for (const option of riderOptions) {
        const optionText = option.textContent.trim().replace(/\s+/g, ' ');
        const normalizedRiderText = riderText.replace(/\s+/g, ' ');
        
        // Try exact match first
        if (optionText === normalizedRiderText) {
          const riderId = parseInt(option.dataset.riderId);
          return riderId;
        }
        
        // Try match without parentheses (e.g., "Husqvarna" vs "(Husqvarna)")
        const optionTextNoParens = optionText.replace(/[()]/g, '');
        const normalizedRiderTextNoParens = normalizedRiderText.replace(/[()]/g, '');
        if (optionTextNoParens === normalizedRiderTextNoParens) {
          const riderId = parseInt(option.dataset.riderId);
          return riderId;
        }
      }
    }
    return null;
  }

  async function savePicks() {
    
    // Get race picks from rider-selector elements
    const picks = [];
    
    // Get 450cc/wsx_sx1 picks
    const class450 = isWSXSeries ? 'wsx_sx1' : '450cc';
    for (let i = 1; i <= 6; i++) {
      const selector = document.querySelector(`.rider-selector[data-class="${class450}"][data-position="${i}"]`);
      if (selector) {
        const riderId = getRiderIdFromSelector(selector);
        if (riderId) {
          picks.push({
            position: i,
            rider_id: riderId,
            class: class450
          });
        }
      }
    }
    
    // Get 250cc/wsx_sx2 picks
    const class250 = isWSXSeries ? 'wsx_sx2' : '250cc';
    for (let i = 1; i <= 6; i++) {
      const selector = document.querySelector(`.rider-selector[data-class="${class250}"][data-position="${i}"]`);
      if (selector) {
        const riderId = getRiderIdFromSelector(selector);
        if (riderId) {
          picks.push({
            position: i,
            rider_id: riderId,
            class: class250
          });
        }
      }
    }


    // Kontrollera dubletter
    const riderIds = picks.map(p => p.rider_id);
    const uniqueRiderIds = [...new Set(riderIds)];
    if (riderIds.length !== uniqueRiderIds.length) {
      alert("Du kan inte v√§lja samma f√∂rare flera g√•nger. V√§lj olika f√∂rare f√∂r varje position.");
      return;
    }

    // Kontrollera att exakt 6 f√∂rare √§r valda f√∂r varje klass
    const picks450 = picks.filter(p => p.class === '450cc');
    const picks250 = picks.filter(p => p.class === '250cc');
    
    
    if (picks450.length !== 6) {
      alert("Du m√•ste v√§lja exakt 6 f√∂rare f√∂r 450cc (Top 6).");
      return;
    }
    
    if (picks250.length !== 6) {
      alert("Du m√•ste v√§lja exakt 6 f√∂rare f√∂r 250cc (Top 6).");
      return;
    }

    // Extra s√§kerhet: client-side filter bort OUT
    for (const p of picks) {
      if (OUT_IDS.includes(Number(p.rider_id))) {
        alert("En vald f√∂rare √§r OUT. V√§lj en annan.");
        return;
      }
    }

    const payload = {
      competition_id: competitionId,
      picks: picks,
      holeshot_450: document.getElementById("holeshot-450")?.value,
      holeshot_250: document.getElementById("holeshot-250")?.value,
      wildcard_pick: isWSXSeries ? null : (document.getElementById("wildcard-pick")?.value || null),
      wildcard_pos: isWSXSeries ? null : (document.getElementById("wildcard-position")?.value || null),
    };


    try {
      const resp = await fetch("/save_picks", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const data = await resp.json();
      alert(data.message || data.error || "Ok");
      
      // Clear localStorage since picks are now saved to server
      localStorage.removeItem(`race_picks_${competitionId}`);
      
      // Picks are already displayed correctly in UI, no need to reload from server
    } catch (e) {
      alert("Ett fel uppstod vid sparning.");
    }
  }

  ["holeshot-450", "holeshot-250", "wildcard-pick"].forEach((id) => {
  const sel = document.getElementById(id);
  if (!sel) return;
  sel.addEventListener("change", () => {
    const val = sel.value;
    if (val && OUT_IDS.includes(Number(val))) {
      sel.value = "";
      alert("F√∂raren √§r OUT f√∂r detta race.");
    }
  });
});


  


    document.addEventListener("DOMContentLoaded", async () => {
      // Initialize rider selectors with coast filtering
      const riderClassesForInit = isWSXSeries ? ['wsx_sx1', 'wsx_sx2'] : ['450cc', '250cc'];
      riderClassesForInit.forEach(cls => updateRiderSelectors(cls));
      updateHoleshotDropdowns();
      
      // Initialize all preview images
      initializePreviewImages();
      
      // Load user picks (don't clear them automatically)
      fetchAndDisplayMyPicks();
      
  // Re-apply coast filtering after picks are loaded
  setTimeout(() => {
    riderClassesForInit.forEach(cls => updateRiderSelectors(cls));
    removeWrongCoastSelections();
  }, 100);
    });

window.addEventListener("focus", () => {
  if (localStorage.getItem("out-updated")) {
    location.reload();
  }
});

// Trackmap functionality
function setMainTrackmap(src, thumbEl) {
  const main = document.getElementById('main-trackmap');
  if (main) main.src = src;
  const container = thumbEl.parentElement;
  container.querySelectorAll('.thumb').forEach(t => t.classList.remove('ring-2', 'ring-cyan-400'));
  thumbEl.classList.add('ring-2', 'ring-cyan-400');
}

</script>

</body>
</html>