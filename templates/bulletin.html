<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anslagstavla - MX Fantasy League</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Suppress Tailwind CDN warning in production
        if (window.location.hostname !== 'localhost') {
            console.clear();
        }
    </script>
    <style>
        /* Import vintage fonts */
        @import url('https://fonts.googleapis.com/css2?family=Kalam:wght@300;400;700&family=Caveat:wght@400;600;700&family=Indie+Flower&display=swap');
        
        /* TEST STYLE - Should make everything red if CSS is loading */
        body { border: 5px solid red !important; }
        /* Force deployment trigger */
        
        /* Cork board background */
        body {
            background: 
                radial-gradient(circle at 20% 20%, rgba(139, 69, 19, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(160, 82, 45, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 60%, rgba(139, 69, 19, 0.05) 0%, transparent 50%),
                linear-gradient(135deg, #8B4513 0%, #A0522D 25%, #CD853F 50%, #DEB887 75%, #F5DEB3 100%) !important;
            background-attachment: fixed !important;
            min-height: 100vh !important;
        }
        
        /* Wooden frame */
        .bulletin-frame {
            background: 
                linear-gradient(45deg, #8B4513 0%, #A0522D 25%, #CD853F 50%, #DEB887 75%, #8B4513 100%) !important;
            border: 8px solid !important;
            border-image: linear-gradient(45deg, #654321, #8B4513, #A0522D, #8B4513, #654321) 1 !important;
            border-radius: 12px !important;
            box-shadow: 
                inset 0 0 20px rgba(0,0,0,0.3),
                0 0 30px rgba(0,0,0,0.5),
                0 10px 40px rgba(0,0,0,0.3) !important;
            position: relative !important;
            margin: 20px !important;
            padding: 30px !important;
        }
        
        .bulletin-frame::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            background: linear-gradient(45deg, #654321, #8B4513, #A0522D, #8B4513, #654321);
            border-radius: 16px;
            z-index: -1;
        }
        
        /* Cork texture overlay */
        .bulletin-frame::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 25% 25%, rgba(139, 69, 19, 0.1) 0%, transparent 2px),
                radial-gradient(circle at 75% 75%, rgba(160, 82, 45, 0.1) 0%, transparent 2px),
                radial-gradient(circle at 50% 50%, rgba(139, 69, 19, 0.05) 0%, transparent 1px);
            background-size: 20px 20px, 15px 15px, 10px 10px;
            border-radius: 4px;
            pointer-events: none;
        }
        
        /* Vintage note papers */
        .vintage-note {
            background: 
                linear-gradient(135deg, #FFF8DC 0%, #F5F5DC 50%, #FFFACD 100%) !important;
            border: 1px solid #D2B48C !important;
            border-radius: 2px !important;
            box-shadow: 
                0 2px 8px rgba(0,0,0,0.15),
                0 1px 3px rgba(0,0,0,0.1),
                inset 0 1px 0 rgba(255,255,255,0.3) !important;
            position: relative !important;
            margin: 15px !important;
            padding: 20px !important;
            transform: rotate(0deg) !important;
            transition: all 0.3s ease !important;
            font-family: 'Kalam', cursive !important;
        }
        
        .vintage-note:hover {
            transform: rotate(0deg) scale(1.02);
            box-shadow: 
                0 4px 15px rgba(0,0,0,0.2),
                0 2px 6px rgba(0,0,0,0.15),
                inset 0 1px 0 rgba(255,255,255,0.4);
        }
        
        /* Random rotation for notes */
        .vintage-note:nth-child(odd) { transform: rotate(-0.5deg); }
        .vintage-note:nth-child(even) { transform: rotate(0.3deg); }
        .vintage-note:nth-child(3n) { transform: rotate(0.8deg); }
        .vintage-note:nth-child(4n) { transform: rotate(-0.2deg); }
        .vintage-note:nth-child(5n) { transform: rotate(0.6deg); }
        
        /* Different paper colors */
        .note-yellow { background: linear-gradient(135deg, #FFF8DC 0%, #F5F5DC 50%, #FFFACD 100%); }
        .note-pink { background: linear-gradient(135deg, #FFE4E1 0%, #FFB6C1 50%, #FFC0CB 100%); }
        .note-blue { background: linear-gradient(135deg, #E6F3FF 0%, #B0E0E6 50%, #ADD8E6 100%); }
        .note-green { background: linear-gradient(135deg, #F0FFF0 0%, #E0FFE0 50%, #F5FFFA 100%); }
        
        /* Pins and tape */
        .note-pin {
            position: absolute;
            top: -8px;
            left: 20px;
            width: 12px;
            height: 12px;
            background: radial-gradient(circle, #C0C0C0 30%, #A0A0A0 70%);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            z-index: 10;
        }
        
        .note-tape {
            position: absolute;
            top: 10px;
            right: -5px;
            width: 30px;
            height: 8px;
            background: rgba(255, 255, 255, 0.7);
            transform: rotate(15deg);
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        /* Handwritten text */
        .handwritten {
            font-family: 'Kalam', cursive;
            font-weight: 400;
            line-height: 1.4;
            color: #2F4F4F;
        }
        
        .handwritten-title {
            font-family: 'Caveat', cursive;
            font-weight: 600;
            font-size: 1.2em;
            color: #8B4513;
            margin-bottom: 8px;
        }
        
        /* Vintage buttons */
        .vintage-btn {
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            border: 2px solid #654321;
            border-radius: 4px;
            color: #FFF8DC;
            font-family: 'Kalam', cursive;
            font-weight: 600;
            padding: 8px 16px;
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.2);
            transition: all 0.2s ease;
        }
        
        .vintage-btn:hover {
            background: linear-gradient(135deg, #A0522D 0%, #CD853F 100%);
            transform: translateY(-1px);
            box-shadow: 
                0 3px 6px rgba(0,0,0,0.4),
                inset 0 1px 0 rgba(255,255,255,0.3);
        }
        
        /* Reaction buttons - vintage style */
        .reaction-btn {
            padding: 6px 10px;
            border-radius: 20px;
            background: linear-gradient(135deg, #FFF8DC 0%, #F5F5DC 100%);
            border: 1px solid #D2B48C;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .reaction-btn:hover {
            background: linear-gradient(135deg, #F5F5DC 0%, #FFFACD 100%);
            transform: scale(1.1) rotate(2deg);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        .reaction-display {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: linear-gradient(135deg, #FFF8DC 0%, #F5F5DC 100%);
            border: 1px solid #D2B48C;
            border-radius: 15px;
            font-size: 14px;
            font-family: 'Kalam', cursive;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .reaction-display .emoji {
            font-size: 14px;
        }
        
        .reaction-display .count {
            font-weight: 600;
            color: #8B4513;
        }
        
        /* Category badges - vintage style */
        .vintage-badge {
            font-family: 'Indie Flower', cursive;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            border: 1px solid;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .badge-tips { 
            background: linear-gradient(135deg, #FFF8DC 0%, #FFE4B5 100%); 
            border-color: #DAA520;
            color: #B8860B;
        }
        .badge-question { 
            background: linear-gradient(135deg, #E6F3FF 0%, #B0E0E6 100%); 
            border-color: #4682B4;
            color: #2F4F4F;
        }
        .badge-discussion { 
            background: linear-gradient(135deg, #F0FFF0 0%, #E0FFE0 100%); 
            border-color: #9ACD32;
            color: #556B2F;
        }
        .badge-general { 
            background: linear-gradient(135deg, #FFF8DC 0%, #F5F5DC 100%); 
            border-color: #D2B48C;
            color: #8B4513;
        }
        
        /* Header styling */
        .vintage-header {
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            border: 3px solid #654321;
            border-radius: 8px;
            box-shadow: 
                0 4px 8px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.2);
            margin-bottom: 20px;
        }
        
        .vintage-header h1 {
            font-family: 'Caveat', cursive;
            font-weight: 700;
            color: #FFF8DC;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        /* Form styling */
        .vintage-form {
            background: linear-gradient(135deg, #FFF8DC 0%, #F5F5DC 100%);
            border: 2px solid #D2B48C;
            border-radius: 8px;
            box-shadow: 
                0 3px 10px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255,255,255,0.3);
            padding: 25px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .vintage-form::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 20px;
            width: 15px;
            height: 15px;
            background: radial-gradient(circle, #C0C0C0 30%, #A0A0A0 70%);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .vintage-textarea {
            background: #FFF8DC;
            border: 1px solid #D2B48C;
            border-radius: 4px;
            font-family: 'Kalam', cursive;
            color: #2F4F4F;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .vintage-textarea:focus {
            outline: none;
            border-color: #8B4513;
            box-shadow: 
                inset 0 1px 3px rgba(0,0,0,0.1),
                0 0 0 2px rgba(139, 69, 19, 0.2);
        }
        
        /* Dark mode adjustments */
        .dark body {
            background: 
                radial-gradient(circle at 20% 20%, rgba(139, 69, 19, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(160, 82, 45, 0.2) 0%, transparent 50%),
                linear-gradient(135deg, #2D1810 0%, #3D2315 25%, #4D2E1A 50%, #5D3920 75%, #6D4425 100%);
        }
        
        .dark .vintage-note {
            background: linear-gradient(135deg, #3D2F1F 0%, #4D3F2F 50%, #5D4F3F 100%);
            border-color: #8B7355;
            color: #F5DEB3;
        }
        
        .dark .handwritten {
            color: #F5DEB3;
        }
        
        .dark .handwritten-title {
            color: #DEB887;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Vintage Bulletin Board -->
    <div class="bulletin-frame">
        <!-- Header -->
        <header class="vintage-header p-6 text-center">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-2xl font-bold text-yellow-200 hover:text-yellow-100 transition-colors">üèÅ MX Fantasy</a>
                    <span class="text-yellow-200">|</span>
                    <h1 class="handwritten-title text-2xl">üìã Anslagstavla</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-yellow-200 hover:text-yellow-100 transition-colors handwritten">‚Üê Tillbaka</a>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="relative z-10">
            <!-- Post Form -->
            <div class="vintage-form">
                <h2 class="handwritten-title mb-4">‚úçÔ∏è Skriv ett meddelande</h2>
                <form id="post-form" class="space-y-4">
                    <div>
                        <!-- Category Selection -->
                        <div class="mb-3">
                            <label class="block text-sm font-medium handwritten mb-2">Kategori:</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center">
                                    <input type="radio" name="category" value="general" checked class="mr-2">
                                    <span class="text-sm handwritten">üí¨ Allm√§nt</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="category" value="tips" class="mr-2">
                                    <span class="text-sm handwritten">üí° Tips</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="category" value="question" class="mr-2">
                                    <span class="text-sm handwritten">‚ùì Fr√•ga</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="category" value="discussion" class="mr-2">
                                    <span class="text-sm handwritten">üó£Ô∏è Diskussion</span>
                                </label>
                            </div>
                        </div>
                        
                        <textarea 
                            id="post-content" 
                            name="content" 
                            rows="3" 
                            maxlength="500"
                            placeholder="Dela dina tankar, tips eller fr√•gor med andra anv√§ndare..."
                            class="w-full px-3 py-2 vintage-textarea resize-none"
                            required
                        ></textarea>
                        <div class="flex justify-between items-center mt-2">
                            <span id="char-count" class="text-sm handwritten">0/500 tecken</span>
                            <button 
                                type="submit" 
                                class="vintage-btn disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                üì§ Publicera
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Posts -->
            <div class="space-y-4">
                <h2 class="handwritten-title mb-4">üí¨ Senaste meddelanden</h2>
                
                <div id="posts-container">
                    {% if posts %}
                        {% for post in posts %}
                        {% set note_colors = ['note-yellow', 'note-pink', 'note-blue', 'note-green'] %}
                        {% set note_color = note_colors[loop.index0 % 4] %}
                        <div class="vintage-note {{ note_color }} group" data-post-id="{{ post.id }}">
                            <div class="note-pin"></div>
                            <div class="note-tape"></div>
                            
                            <!-- Post Header -->
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center space-x-2 flex-wrap">
                                    <span class="font-semibold handwritten-title">
                                        {{ post.author_display_name }}
                                    </span>
                                    <span class="text-sm handwritten">
                                        {{ post.created_at.strftime('%d/%m %H:%M') }}
                                    </span>
                                    <!-- Category Badge -->
                                    {% if post.category == 'tips' %}
                                        <span class="vintage-badge badge-tips">üí° Tips</span>
                                    {% elif post.category == 'question' %}
                                        <span class="vintage-badge badge-question">‚ùì Fr√•ga</span>
                                    {% elif post.category == 'discussion' %}
                                        <span class="vintage-badge badge-discussion">üó£Ô∏è Diskussion</span>
                                    {% else %}
                                        <span class="vintage-badge badge-general">üí¨ Allm√§nt</span>
                                    {% endif %}
                                </div>
                                {% if post.is_own_post or post.is_admin %}
                                <button 
                                    class="delete-post-btn text-red-600 hover:text-red-800 text-sm opacity-0 group-hover:opacity-100 transition-opacity duration-200 handwritten"
                                    data-post-id="{{ post.id }}"
                                    title="Ta bort post"
                                >
                                    üóëÔ∏è
                                </button>
                                {% endif %}
                            </div>
                            
                            <!-- Post Content -->
                            <div class="post-content handwritten whitespace-pre-wrap mb-3">{{ post.content }}</div>
                        
                        <!-- Reactions -->
                        <div class="flex items-center space-x-2 mb-3">
                            <div class="flex items-center space-x-1">
                                <button class="reaction-btn" data-post-id="{{ post.id }}" data-emoji="üöÄ" title="Klicka f√∂r att reagera">üöÄ</button>
                                <button class="reaction-btn" data-post-id="{{ post.id }}" data-emoji="üòÇ" title="Klicka f√∂r att reagera">üòÇ</button>
                                <button class="reaction-btn" data-post-id="{{ post.id }}" data-emoji="üëç" title="Klicka f√∂r att reagera">üëç</button>
                                <button class="reaction-btn" data-post-id="{{ post.id }}" data-emoji="‚ù§Ô∏è" title="Klicka f√∂r att reagera">‚ù§Ô∏è</button>
                                <button class="reaction-btn" data-post-id="{{ post.id }}" data-emoji="üî•" title="Klicka f√∂r att reagera">üî•</button>
                            </div>
                            <div id="reactions-{{ post.id }}" class="flex items-center space-x-2">
                                {% for emoji, users in post.reactions.items() %}
                                <span class="reaction-display" data-emoji="{{ emoji }}">
                                    <span class="emoji">{{ emoji }}</span>
                                    <span class="count">{{ users|length }}</span>
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        
                            <!-- Reply Button -->
                            <div class="flex items-center justify-between">
                                <button class="reply-btn text-blue-700 hover:text-blue-900 text-sm font-medium handwritten" data-post-id="{{ post.id }}">
                                    üí¨ Svara
                                </button>
                                {% if post.replies %}
                                <span class="text-sm handwritten">
                                    {{ post.replies|length }} svar
                                </span>
                                {% endif %}
                            </div>
                            
                            <!-- Replies Section -->
                            {% if post.replies %}
                            <div class="replies-section mt-3 ml-4 border-l-2 border-amber-300 pl-4">
                                {% for reply in post.replies %}
                                <div class="reply-item mb-2 p-2 bg-amber-50 rounded border border-amber-200">
                                    <div class="flex justify-between items-start mb-1">
                                        <div class="flex items-center space-x-2">
                                            <span class="font-medium text-sm handwritten-title">
                                                {{ reply.author_display_name }}
                                            </span>
                                            <span class="text-xs handwritten">
                                                {{ reply.created_at.strftime('%d/%m %H:%M') }}
                                            </span>
                                        </div>
                                        {% if reply.is_own_post or post.is_admin %}
                                        <button 
                                            class="delete-reply-btn text-red-600 hover:text-red-800 text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200 handwritten"
                                            data-reply-id="{{ reply.id }}"
                                            title="Ta bort svar"
                                        >
                                            üóëÔ∏è
                                        </button>
                                        {% endif %}
                                    </div>
                                    <div class="text-sm handwritten whitespace-pre-wrap">{{ reply.content }}</div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <!-- Reply Form (Hidden by default) -->
                            <div class="reply-form hidden mt-3 ml-4 border-l-2 border-amber-400 pl-4">
                                <form class="reply-form-element">
                                    <textarea 
                                        class="w-full px-3 py-2 vintage-textarea resize-none text-sm"
                                        rows="2"
                                        maxlength="300"
                                        placeholder="Skriv ditt svar..."
                                        required
                                    ></textarea>
                                    <div class="flex justify-end space-x-2 mt-2">
                                        <button type="button" class="cancel-reply-btn text-amber-700 hover:text-amber-900 text-sm handwritten">
                                            Avbryt
                                        </button>
                                        <button type="submit" class="vintage-btn text-sm">
                                            Skicka
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-8 handwritten">
                            <div class="text-4xl mb-2">üìù</div>
                            <p>Inga meddelanden √§n. Bli den f√∂rsta att skriva n√•got!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50">
        <div class="flex items-center space-x-2">
            <span>‚úÖ</span>
            <span id="toast-message">Meddelande skickat!</span>
        </div>
    </div>

    <script>
        // Character counter
        const contentTextarea = document.getElementById('post-content');
        const charCount = document.getElementById('char-count');
        
        contentTextarea.addEventListener('input', function() {
            const length = this.value.length;
            charCount.textContent = `${length}/500 tecken`;
            
            if (length > 450) {
                charCount.classList.add('text-red-500');
            } else {
                charCount.classList.remove('text-red-500');
            }
        });

        // Post form submission
        document.getElementById('post-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const content = contentTextarea.value.trim();
            if (!content) return;
            
            const category = this.querySelector('input[name="category"]:checked').value;
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'üì§ Skickar...';
            
            try {
                const response = await fetch('/bulletin/post', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        content: content,
                        category: category
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Clear form
                    contentTextarea.value = '';
                    charCount.textContent = '0/500 tecken';
                    charCount.classList.remove('text-red-500');
                    
                    // Add new post to top of list
                    addPostToTop(result.post);
                    
                    // Show success toast
                    showToast('Meddelande skickat!', 'success');
                } else {
                    showToast(result.error || 'Ett fel uppstod', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Ett fel uppstod', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'üì§ Publicera';
            }
        });

        // Delete post functionality
        document.addEventListener('click', async function(e) {
            if (e.target.classList.contains('delete-post-btn')) {
                const postId = e.target.getAttribute('data-post-id');
                const postElement = e.target.closest('.post-item');
                
                if (confirm('√Ñr du s√§ker p√• att du vill ta bort detta meddelande?')) {
                    try {
                        const response = await fetch(`/bulletin/post/${postId}`, {
                            method: 'DELETE'
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            postElement.remove();
                            showToast('Meddelande borttaget!', 'success');
                        } else {
                            showToast(result.error || 'Ett fel uppstod', 'error');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showToast('Ett fel uppstod', 'error');
                    }
                }
            }
            
            // Reaction functionality
            if (e.target.classList.contains('reaction-btn')) {
                const postId = e.target.getAttribute('data-post-id');
                const emoji = e.target.getAttribute('data-emoji');
                
                try {
                    const response = await fetch(`/bulletin/post/${postId}/reaction`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ emoji: emoji })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        updateReactions(postId, result.reactions);
                        showToast(result.message, 'success');
                    } else {
                        showToast(result.error || 'Ett fel uppstod', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showToast('Ett fel uppstod', 'error');
                }
            }
            
            // Reply button functionality
            if (e.target.classList.contains('reply-btn')) {
                const postId = e.target.getAttribute('data-post-id');
                const replyForm = document.querySelector(`[data-post-id="${postId}"] .reply-form`);
                replyForm.classList.remove('hidden');
                e.target.style.display = 'none';
            }
            
            // Cancel reply functionality
            if (e.target.classList.contains('cancel-reply-btn')) {
                const replyForm = e.target.closest('.reply-form');
                const postId = replyForm.closest('.post-item').getAttribute('data-post-id');
                replyForm.classList.add('hidden');
                document.querySelector(`[data-post-id="${postId}"] .reply-btn`).style.display = 'inline';
            }
        });
        
        // Reply form submission
        document.addEventListener('submit', async function(e) {
            if (e.target.classList.contains('reply-form-element')) {
                e.preventDefault();
                
                const content = e.target.querySelector('textarea').value.trim();
                if (!content) return;
                
                const postId = e.target.closest('.post-item').getAttribute('data-post-id');
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                
                submitBtn.disabled = true;
                submitBtn.textContent = 'Skickar...';
                
                try {
                    const response = await fetch('/bulletin/post', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            content: content,
                            parent_id: parseInt(postId)
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        // Clear form and hide it
                        e.target.querySelector('textarea').value = '';
                        e.target.closest('.reply-form').classList.add('hidden');
                        document.querySelector(`[data-post-id="${postId}"] .reply-btn`).style.display = 'inline';
                        
                        // Add reply to the post
                        addReplyToPost(postId, result.post);
                        
                        showToast('Svar skickat!', 'success');
                    } else {
                        showToast(result.error || 'Ett fel uppstod', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showToast('Ett fel uppstod', 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            }
        });

        // Add post to top of list
        function addPostToTop(post) {
            const postsContainer = document.getElementById('posts-container');
            const emptyState = postsContainer.querySelector('.text-center');
            
            if (emptyState) {
                emptyState.remove();
            }
            
            const now = new Date();
            const timeString = now.toLocaleDateString('sv-SE', { 
                day: '2-digit', 
                month: '2-digit' 
            }) + ' ' + now.toLocaleTimeString('sv-SE', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // Get category badge and random note color
            const categoryBadge = getCategoryBadge(post.category);
            const noteColor = getRandomNoteColor();
            
            const postHtml = `
                <div class="vintage-note ${noteColor} group" data-post-id="${post.id}">
                    <div class="note-pin"></div>
                    <div class="note-tape"></div>
                    
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center space-x-2 flex-wrap">
                            <span class="font-semibold handwritten-title">
                                ${post.author_display_name}
                            </span>
                            <span class="text-sm handwritten">
                                ${timeString}
                            </span>
                            ${categoryBadge}
                        </div>
                        <button 
                            class="delete-post-btn text-red-600 hover:text-red-800 text-sm opacity-0 group-hover:opacity-100 transition-opacity duration-200 handwritten"
                            data-post-id="${post.id}"
                            title="Ta bort post"
                        >
                            üóëÔ∏è
                        </button>
                    </div>
                    <div class="post-content handwritten whitespace-pre-wrap mb-3">${post.content}</div>
                    
                    <!-- Reactions -->
                    <div class="flex items-center space-x-2 mb-3">
                        <div class="flex items-center space-x-1">
                            <button class="reaction-btn" data-post-id="${post.id}" data-emoji="üöÄ" title="Klicka f√∂r att reagera">üöÄ</button>
                            <button class="reaction-btn" data-post-id="${post.id}" data-emoji="üòÇ" title="Klicka f√∂r att reagera">üòÇ</button>
                            <button class="reaction-btn" data-post-id="${post.id}" data-emoji="üëç" title="Klicka f√∂r att reagera">üëç</button>
                            <button class="reaction-btn" data-post-id="${post.id}" data-emoji="‚ù§Ô∏è" title="Klicka f√∂r att reagera">‚ù§Ô∏è</button>
                            <button class="reaction-btn" data-post-id="${post.id}" data-emoji="üî•" title="Klicka f√∂r att reagera">üî•</button>
                        </div>
                        <div id="reactions-${post.id}" class="flex items-center space-x-2">
                        </div>
                    </div>
                    
                    <!-- Reply Button -->
                    <div class="flex items-center justify-between">
                        <button class="reply-btn text-blue-700 hover:text-blue-900 text-sm font-medium handwritten" data-post-id="${post.id}">
                            üí¨ Svara
                        </button>
                    </div>
                    
                    <!-- Reply Form (Hidden by default) -->
                    <div class="reply-form hidden mt-3 ml-4 border-l-2 border-amber-400 pl-4">
                        <form class="reply-form-element">
                            <textarea 
                                class="w-full px-3 py-2 vintage-textarea resize-none text-sm"
                                rows="2"
                                maxlength="300"
                                placeholder="Skriv ditt svar..."
                                required
                            ></textarea>
                            <div class="flex justify-end space-x-2 mt-2">
                                <button type="button" class="cancel-reply-btn text-amber-700 hover:text-amber-900 text-sm handwritten">
                                    Avbryt
                                </button>
                                <button type="submit" class="vintage-btn text-sm">
                                    Skicka
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            postsContainer.insertAdjacentHTML('afterbegin', postHtml);
        }
        
        // Get category badge HTML
        function getCategoryBadge(category) {
            switch(category) {
                case 'tips':
                    return '<span class="vintage-badge badge-tips">üí° Tips</span>';
                case 'question':
                    return '<span class="vintage-badge badge-question">‚ùì Fr√•ga</span>';
                case 'discussion':
                    return '<span class="vintage-badge badge-discussion">üó£Ô∏è Diskussion</span>';
                default:
                    return '<span class="vintage-badge badge-general">üí¨ Allm√§nt</span>';
            }
        }
        
        // Get random note color
        function getRandomNoteColor() {
            const colors = ['note-yellow', 'note-pink', 'note-blue', 'note-green'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // Update reactions display
        function updateReactions(postId, reactions) {
            const reactionsContainer = document.getElementById(`reactions-${postId}`);
            reactionsContainer.innerHTML = '';
            
            for (const [emoji, users] of Object.entries(reactions)) {
                const reactionHtml = `
                    <span class="reaction-display" data-emoji="${emoji}">
                        <span class="emoji">${emoji}</span>
                        <span class="count">${users.length}</span>
                    </span>
                `;
                reactionsContainer.insertAdjacentHTML('beforeend', reactionHtml);
            }
        }
        
        // Add reply to post
        function addReplyToPost(postId, reply) {
            const postElement = document.querySelector(`[data-post-id="${postId}"]`);
            let repliesSection = postElement.querySelector('.replies-section');
            
            if (!repliesSection) {
                // Create replies section if it doesn't exist
                const replyButton = postElement.querySelector('.reply-btn').parentElement;
                repliesSection = document.createElement('div');
                repliesSection.className = 'replies-section mt-3 ml-4 border-l-2 border-gray-200 dark:border-gray-600 pl-4';
                replyButton.parentElement.insertBefore(repliesSection, replyButton.nextSibling);
            }
            
            const now = new Date();
            const timeString = now.toLocaleDateString('sv-SE', { 
                day: '2-digit', 
                month: '2-digit' 
            }) + ' ' + now.toLocaleTimeString('sv-SE', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            const replyHtml = `
                <div class="reply-item mb-2 p-2 bg-amber-50 rounded border border-amber-200">
                    <div class="flex justify-between items-start mb-1">
                        <div class="flex items-center space-x-2">
                            <span class="font-medium text-sm handwritten-title">
                                ${reply.author_display_name}
                            </span>
                            <span class="text-xs handwritten">
                                ${timeString}
                            </span>
                        </div>
                        <button 
                            class="delete-reply-btn text-red-600 hover:text-red-800 text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200 handwritten"
                            data-reply-id="${reply.id}"
                            title="Ta bort svar"
                        >
                            üóëÔ∏è
                        </button>
                    </div>
                    <div class="text-sm handwritten whitespace-pre-wrap">${reply.content}</div>
                </div>
            `;
            
            repliesSection.insertAdjacentHTML('beforeend', replyHtml);
            
            // Update reply count
            const replyCount = repliesSection.querySelectorAll('.reply-item').length;
            const replyCountSpan = postElement.querySelector('.reply-btn').parentElement.querySelector('span');
            if (replyCountSpan) {
                replyCountSpan.textContent = `${replyCount} svar`;
            } else {
                const replyButton = postElement.querySelector('.reply-btn').parentElement;
                replyButton.insertAdjacentHTML('beforeend', `<span class="text-sm text-gray-500 dark:text-gray-400">${replyCount} svar</span>`);
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            
            // Set color based on type
            toast.className = `fixed top-4 right-4 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`;
            
            // Show toast
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Hide toast after 3 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 3000);
        }

        // Add hover effects to posts
        document.addEventListener('DOMContentLoaded', function() {
            const posts = document.querySelectorAll('.post-item');
            posts.forEach(post => {
                post.classList.add('group');
            });
        });
    </script>
</body>
</html>
