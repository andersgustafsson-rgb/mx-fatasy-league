<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rider Management - MX Fantasy League</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { 
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-color: #22d3ee;
            color: #22d3ee;
            box-shadow: 0 0 10px rgba(34, 211, 238, 0.3);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen">
    <div class="container mx-auto p-4 sm:p-6">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center space-x-4">
                <a href="/" class="text-2xl font-bold text-cyan-400 hover:text-cyan-300 transition-colors">üèÅ MX Fantasy</a>
                <span class="text-cyan-400">|</span>
                <h1 class="text-2xl font-bold text-cyan-400">üë• Rider Management</h1>
            </div>
            <div class="flex items-center space-x-4">
                <a href="/admin" class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded transition-colors">‚Üê Tillbaka till Admin</a>
            </div>
        </div>

        <!-- Search Function -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">üîç S√∂k F√∂rare</h3>
            <div class="flex flex-col sm:flex-row gap-3">
                <input 
                    type="text" 
                    id="riderSearch" 
                    placeholder="S√∂k efter namn, nummer, team eller pris..." 
                    class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                    oninput="searchRiders()"
                >
                <button 
                    onclick="searchRiders()" 
                    class="bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-2 rounded-lg transition-colors"
                >
                    S√∂k
                </button>
                <button 
                    onclick="clearSearch()" 
                    class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors"
                >
                    Rensa
                </button>
            </div>
            <div id="searchResults" class="mt-4 hidden">
                <h4 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-2">S√∂kresultat:</h4>
                <div id="searchResultsList" class="space-y-2"></div>
            </div>
        </div>

        <!-- Entry List Import Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">üìã Entry List Import - F√∂rare</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Upload CSV Files -->
                <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4">
                    <h4 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-2">1. Ladda upp CSV-filer</h4>
                    <form id="upload-entry-lists-form" enctype="multipart/form-data">
                        <input type="file" id="entry-csv-files" accept=".csv" multiple class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg mb-3">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            Ladda upp
                        </button>
                    </form>
                    <div id="upload-entry-status" class="mt-2 text-sm"></div>
                </div>

                <!-- Preview Entry Lists -->
                <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4">
                    <h4 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-2">2. F√∂rhandsvisa Entry Lists</h4>
                    <button id="preview-entry-lists-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        F√∂rhandsvisa Entry Lists
                    </button>
                    <div id="preview-status" class="mt-2 text-sm"></div>
                    
                    <!-- Preview Table -->
                    <div id="preview-table" class="mt-4 hidden">
                        <h5 class="text-sm font-semibold text-gray-600 dark:text-gray-400 mb-2">F√∂rhandsvisning av f√∂rare:</h5>
                        <div class="max-h-60 overflow-y-auto border border-gray-200 dark:border-gray-600 rounded-lg">
                            <table class="w-full text-xs">
                                <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0">
                                    <tr>
                                        <th class="px-2 py-1 text-left">#</th>
                                        <th class="px-2 py-1 text-left">Namn</th>
                                        <th class="px-2 py-1 text-left">M√§rke</th>
                                        <th class="px-2 py-1 text-left">Klass</th>
                                        <th class="px-2 py-1 text-left">Kust</th>
                                    </tr>
                                </thead>
                                <tbody id="preview-riders-list">
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2 text-xs text-gray-600 dark:text-gray-400">
                            <span id="preview-summary"></span>
                        </div>
                    </div>
                </div>

                <!-- Import Entry Lists -->
                <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4">
                    <h4 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-2">3. Ers√§tt alla f√∂rare</h4>
                    <button id="import-entry-lists-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors" disabled>
                        Ers√§tt alla f√∂rare
                    </button>
                    <div id="import-entry-status" class="mt-2 text-sm"></div>
                </div>
            </div>
            
            <!-- Entry List Info -->
            <div class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900 rounded-lg">
                <h5 class="text-sm font-semibold text-yellow-800 dark:text-yellow-200 mb-2">‚ö†Ô∏è Varning:</h5>
                <p class="text-xs text-yellow-700 dark:text-yellow-300">
                    Detta kommer att <strong>ta bort alla befintliga f√∂rare</strong> och ers√§tta dem med de fr√•n officiella entry lists.
                    Kontrollera att CSV-filerna finns i data-mappen f√∂rst.
                </p>
            </div>
        </div>

        <!-- Restore Images Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">üñºÔ∏è √Öterst√§ll F√∂rarbilder</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Restore Images -->
                <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4">
                    <h4 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-2">√Öterst√§ll bilder fr√•n static/riders/</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                        Detta kommer att matcha bildfiler i static/riders/ mappen med f√∂rarna i databasen baserat p√• nummer och namn.
                    </p>
                    <button id="restore-images-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        √Öterst√§ll bilder
                    </button>
                    <div id="restore-images-status" class="mt-2 text-sm"></div>
                </div>

                <!-- Debug Images -->
                <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4">
                    <h4 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-2">Debug bilder</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                        Kolla status p√• f√∂rarbilder i databasen.
                    </p>
                    <button id="debug-images-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        Debug bilder
                    </button>
                    <div id="debug-images-status" class="mt-2 text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Race Results Import Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">üèÅ Race Results Import</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <!-- Upload 250 Results -->
                <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4">
                    <h4 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-2">250cc Resultat</h4>
                    <form id="upload-250-results-form" enctype="multipart/form-data">
                        <input type="file" id="results-250-file" accept=".csv" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg mb-3">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            Ladda upp 250cc
                        </button>
                    </form>
                    <div id="upload-250-status" class="mt-2 text-sm"></div>
                </div>

                <!-- Upload 450 Results -->
                <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4">
                    <h4 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-2">450cc Resultat</h4>
                    <form id="upload-450-results-form" enctype="multipart/form-data">
                        <input type="file" id="results-450-file" accept=".csv" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg mb-3">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            Ladda upp 450cc
                        </button>
                    </form>
                    <div id="upload-450-status" class="mt-2 text-sm"></div>
                </div>
            </div>

            <!-- Manual Picks Section -->
            <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4 mb-4">
                <h4 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-3">üéØ Holeshot & Wildcard Picks</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Holeshot Picks -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">250cc Holeshot:</label>
                        <select id="holeshot-250" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                            <option value="">V√§lj f√∂rare...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">450cc Holeshot:</label>
                        <select id="holeshot-450" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                            <option value="">V√§lj f√∂rare...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Wildcard Info:</label>
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                            Wildcard r√§knas automatiskt fr√•n hela 450cc resultatet. Ladda bara upp hela 450cc resultatet s√• fungerar det.
                        </p>
                    </div>
                    <div>
                        <!-- Empty div for layout -->
                    </div>
                </div>
            </div>

            <!-- Competition Selection -->
            <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4 mb-4">
                <h4 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-2">üèÜ V√§lj T√§vling</h4>
                <select id="competition-select-results" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                    <option value="">Laddar t√§vlingar...</option>
                </select>
            </div>
            
            <!-- Preview Button -->
            <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4 mb-4 text-center">
                <button id="preview-results-btn" onclick="previewRaceResults()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg transition-colors" disabled>
                    üëÅÔ∏è F√∂rhandsvisa Resultat
                </button>
                <div id="preview-status" class="mt-2 text-sm text-gray-600 dark:text-gray-400"></div>
            </div>
            
            <!-- Preview Table -->
            <div id="preview-results-table" class="border border-gray-300 dark:border-gray-600 rounded-lg p-4 mb-4 hidden">
                <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">üìã F√∂rhandsvisning av Resultat</h4>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- 250cc Preview -->
                    <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4">
                        <h5 class="text-md font-semibold text-blue-600 dark:text-blue-400 mb-2">250cc Results</h5>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 max-h-64 overflow-y-auto">
                            <div id="preview-250-results" class="space-y-1 text-sm">
                                <!-- Results will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 450cc Preview -->
                    <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4">
                        <h5 class="text-md font-semibold text-orange-600 dark:text-orange-400 mb-2">450cc Results</h5>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 max-h-64 overflow-y-auto">
                            <div id="preview-450-results" class="space-y-1 text-sm">
                                <!-- Results will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Import Button -->
            <div class="text-center">
                <button id="import-race-results-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-colors text-lg font-semibold" disabled>
                    üèÅ Importera Race Results
                </button>
                <div id="import-results-status" class="mt-2 text-sm"></div>
            </div>
        </div>

        <!-- CSV Import Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">üìä CSV Import - Resultat (Gammal)</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Upload CSV -->
                <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4">
                    <h4 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-2">1. Ladda upp CSV-fil</h4>
                    <form id="upload-results-form" enctype="multipart/form-data">
                        <input type="file" id="results-csv-file" accept=".csv" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg mb-3">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                            Ladda upp
                        </button>
                    </form>
                    <div id="upload-status" class="mt-2 text-sm"></div>
                </div>

                <!-- Import Results -->
                <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4">
                    <h4 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-2">2. Importera till t√§vling</h4>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">V√§lj t√§vling:</label>
                        <select id="competition-select" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                            <option value="">Laddar t√§vlingar...</option>
                        </select>
                    </div>
                    <button id="import-results-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" disabled>
                        Importera resultat
                    </button>
                    <div id="import-status" class="mt-2 text-sm"></div>
                </div>
            </div>
            
            <!-- CSV Format Info -->
            <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900 rounded-lg">
                <h5 class="text-sm font-semibold text-blue-800 dark:text-blue-200 mb-2">CSV Format:</h5>
                <p class="text-xs text-blue-700 dark:text-blue-300">
                    Kolumner: position, rider_number, rider_name, points, class<br>
                    Exempel: 1, 1, "Cooper Webb", 25, "450cc"
                </p>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="flex flex-wrap gap-2 mb-6">
            <button class="tab-button active px-4 py-2 rounded border-2 border-gray-600 bg-gray-800 text-white transition-all" data-tab="250">
                250cc
            </button>
            <button class="tab-button px-4 py-2 rounded border-2 border-gray-600 bg-gray-800 text-white transition-all" data-tab="450">
                450cc
            </button>
        </div>

        <!-- 250cc Tab -->
        <div id="250" class="tab-content active">
            <div class="bg-gradient-to-r from-gray-900 to-black rounded-lg shadow-2xl border-2 border-cyan-400 overflow-hidden" style="box-shadow: 0 0 20px rgba(34, 211, 238, 0.3);">
                <div class="bg-gradient-to-r from-cyan-500 to-blue-500 px-4 py-3" style="box-shadow: 0 0 15px rgba(34, 211, 238, 0.5);">
                    <h2 class="text-xl font-bold text-center text-white" style="text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);">üèçÔ∏è 250cc Riders</h2>
                </div>
                <div class="p-4 bg-gray-900">
                    <!-- Add New Rider Form -->
                    <div class="mb-6 p-4 bg-gray-800 rounded border border-cyan-400" style="box-shadow: 0 0 10px rgba(34, 211, 238, 0.2);">
                        <h3 class="text-lg font-semibold text-cyan-400 mb-4">‚ûï L√§gg till ny f√∂rare</h3>
                        <form id="add-rider-form-250" class="grid grid-cols-1 md:grid-cols-6 gap-4">
                            <input type="hidden" name="class_name" value="250cc">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Nummer</label>
                                <input type="number" name="rider_number" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Namn</label>
                                <input type="text" name="name" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Coast</label>
                                <select name="coast_250" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white" required>
                                    <option value="">V√§lj coast</option>
                                    <option value="east">East</option>
                                    <option value="west">West</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">M√§rke</label>
                                <select name="bike_brand" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white" required onchange="handleBikeBrandChange(this)">
                                    <option value="">V√§lj m√§rke</option>
                                    <option value="Honda">Honda</option>
                                    <option value="Yamaha">Yamaha</option>
                                    <option value="KTM">KTM</option>
                                    <option value="Kawasaki">Kawasaki</option>
                                    <option value="Suzuki">Suzuki</option>
                                    <option value="Husqvarna">Husqvarna</option>
                                    <option value="GasGas">GasGas</option>
                                    <option value="Beta">Beta</option>
                                    <option value="custom">Annan...</option>
                                </select>
                                <input type="text" name="bike_brand_custom" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white mt-2 hidden" placeholder="Ange m√§rke">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Pris (kr)</label>
                                <input type="number" name="price" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white" required min="0" step="1000">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">F√∂rare-bild</label>
                                <input type="file" name="rider_image" accept="image/*" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-600 file:text-white hover:file:bg-cyan-700">
                            </div>
                            <div class="flex items-end">
                                <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded transition-colors">
                                    L√§gg till
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Riders Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-gray-800 border-b border-cyan-400">
                                    <th class="px-4 py-3 text-left text-cyan-400 font-semibold">Nummer</th>
                                    <th class="px-4 py-3 text-left text-cyan-400 font-semibold">Namn</th>
                                    <th class="px-4 py-3 text-left text-cyan-400 font-semibold">Coast</th>
                                    <th class="px-4 py-3 text-left text-cyan-400 font-semibold">M√§rke</th>
                                    <th class="px-4 py-3 text-left text-cyan-400 font-semibold">Pris (kr)</th>
                                    <th class="px-4 py-3 text-center text-cyan-400 font-semibold">√Ötg√§rder</th>
                                </tr>
                            </thead>
                            <tbody id="riders-250">
                                {% for rider in riders_250_east %}
                                <tr class="rider-item border-b border-gray-700 hover:bg-gray-800">
                                    <td class="rider-number px-4 py-3 text-white">{{ rider.rider_number }}</td>
                                    <td class="rider-name px-4 py-3 text-white">{{ rider.name }}</td>
                                    <td class="px-4 py-3">
                                        <span class="px-2 py-1 rounded text-xs font-semibold bg-green-600 text-white">East</span>
                                    </td>
                                    <td class="rider-bike px-4 py-3 text-white">{{ rider.bike_brand }}</td>
                                    <td class="rider-price px-4 py-3 text-white">{{ "{:,.0f}".format(rider.price) }}</td>
                                    <td class="px-4 py-3 text-center">
                                        <button onclick="editRider({{ rider.id }}, '{{ rider.name }}', {{ rider.rider_number }}, '{{ rider.bike_brand }}', '250cc', 'east', {{ rider.price }})" 
                                                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs mr-2">
                                            Redigera
                                        </button>
                                        <button onclick="deleteRider({{ rider.id }}, '{{ rider.name }}')" 
                                                class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">
                                            Ta bort
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% for rider in riders_250_west %}
                                <tr class="rider-item border-b border-gray-700 hover:bg-gray-800">
                                    <td class="rider-number px-4 py-3 text-white">{{ rider.rider_number }}</td>
                                    <td class="rider-name px-4 py-3 text-white">{{ rider.name }}</td>
                                    <td class="px-4 py-3">
                                        <span class="px-2 py-1 rounded text-xs font-semibold bg-orange-600 text-white">West</span>
                                    </td>
                                    <td class="rider-bike px-4 py-3 text-white">{{ rider.bike_brand }}</td>
                                    <td class="rider-price px-4 py-3 text-white">{{ "{:,.0f}".format(rider.price) }}</td>
                                    <td class="px-4 py-3 text-center">
                                        <button onclick="editRider({{ rider.id }}, '{{ rider.name }}', {{ rider.rider_number }}, '{{ rider.bike_brand }}', '250cc', 'west', {{ rider.price }})" 
                                                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs mr-2">
                                            Redigera
                                        </button>
                                        <button onclick="deleteRider({{ rider.id }}, '{{ rider.name }}')" 
                                                class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">
                                            Ta bort
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 450cc Tab -->
        <div id="450" class="tab-content">
            <div class="bg-gradient-to-r from-gray-900 to-black rounded-lg shadow-2xl border-2 border-cyan-400 overflow-hidden" style="box-shadow: 0 0 20px rgba(34, 211, 238, 0.3);">
                <div class="bg-gradient-to-r from-cyan-500 to-blue-500 px-4 py-3" style="box-shadow: 0 0 15px rgba(34, 211, 238, 0.5);">
                    <h2 class="text-xl font-bold text-center text-white" style="text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);">üèçÔ∏è 450cc Riders</h2>
                </div>
                <div class="p-4 bg-gray-900">
                    <!-- Add New Rider Form -->
                    <div class="mb-6 p-4 bg-gray-800 rounded border border-cyan-400" style="box-shadow: 0 0 10px rgba(34, 211, 238, 0.2);">
                        <h3 class="text-lg font-semibold text-cyan-400 mb-4">‚ûï L√§gg till ny f√∂rare</h3>
                        <form id="add-rider-form-450" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <input type="hidden" name="class_name" value="450cc">
                            <input type="hidden" name="coast_250" value="">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Nummer</label>
                                <input type="number" name="rider_number" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Namn</label>
                                <input type="text" name="name" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">M√§rke</label>
                                <select name="bike_brand" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white" required onchange="handleBikeBrandChange(this)">
                                    <option value="">V√§lj m√§rke</option>
                                    <option value="Honda">Honda</option>
                                    <option value="Yamaha">Yamaha</option>
                                    <option value="KTM">KTM</option>
                                    <option value="Kawasaki">Kawasaki</option>
                                    <option value="Suzuki">Suzuki</option>
                                    <option value="Husqvarna">Husqvarna</option>
                                    <option value="GasGas">GasGas</option>
                                    <option value="Beta">Beta</option>
                                    <option value="custom">Annan...</option>
                                </select>
                                <input type="text" name="bike_brand_custom" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white mt-2 hidden" placeholder="Ange m√§rke">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Pris (kr)</label>
                                <input type="number" name="price" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white" required min="0" step="1000">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">F√∂rare-bild</label>
                                <input type="file" name="rider_image" accept="image/*" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-600 file:text-white hover:file:bg-cyan-700">
                            </div>
                            <div class="flex items-end">
                                <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded transition-colors">
                                    L√§gg till
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Riders Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-gray-800 border-b border-cyan-400">
                                    <th class="px-4 py-3 text-left text-cyan-400 font-semibold">Nummer</th>
                                    <th class="px-4 py-3 text-left text-cyan-400 font-semibold">Namn</th>
                                    <th class="px-4 py-3 text-left text-cyan-400 font-semibold">M√§rke</th>
                                    <th class="px-4 py-3 text-left text-cyan-400 font-semibold">Pris (kr)</th>
                                    <th class="px-4 py-3 text-center text-cyan-400 font-semibold">√Ötg√§rder</th>
                                </tr>
                            </thead>
                            <tbody id="riders-450">
                                {% for rider in riders_450 %}
                                <tr class="rider-item border-b border-gray-700 hover:bg-gray-800">
                                    <td class="rider-number px-4 py-3 text-white">{{ rider.rider_number }}</td>
                                    <td class="rider-name px-4 py-3 text-white">{{ rider.name }}</td>
                                    <td class="rider-bike px-4 py-3 text-white">{{ rider.bike_brand }}</td>
                                    <td class="rider-price px-4 py-3 text-white">{{ "{:,.0f}".format(rider.price) }}</td>
                                    <td class="px-4 py-3 text-center">
                                        <button onclick="editRider({{ rider.id }}, '{{ rider.name }}', {{ rider.rider_number }}, '{{ rider.bike_brand }}', '450cc', '', {{ rider.price }})" 
                                                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs mr-2">
                                            Redigera
                                        </button>
                                        <button onclick="deleteRider({{ rider.id }}, '{{ rider.name }}')" 
                                                class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">
                                            Ta bort
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-gray-900 rounded-lg border-2 border-cyan-400 p-6 w-full max-w-md max-h-[85vh] overflow-y-auto" style="box-shadow: 0 0 20px rgba(34, 211, 238, 0.3);">
                <h3 class="text-lg font-semibold text-cyan-400 mb-4">Redigera f√∂rare</h3>
                <form id="edit-rider-form">
                    <input type="hidden" id="edit-rider-id">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Nummer</label>
                            <input type="number" id="edit-rider-number" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white" required>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Smeknamn</label>
                                <input type="text" id="edit-rider-nickname" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">F√∂dd (YYYY-MM-DD)</label>
                                <input type="text" id="edit-rider-birthdate" placeholder="1992-03-25" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Hometown</label>
                                <input type="text" id="edit-rider-hometown" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Boende</label>
                                <input type="text" id="edit-rider-residence" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">L√§ngd (cm)</label>
                                <input type="number" id="edit-rider-height" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Vikt (kg)</label>
                                <input type="number" id="edit-rider-weight" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Team</label>
                                <input type="text" id="edit-rider-team" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Manufacturer</label>
                                <input type="text" id="edit-rider-manufacturer" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Team Manager</label>
                                <input type="text" id="edit-rider-teammanager" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Mechanic</label>
                                <input type="text" id="edit-rider-mechanic" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Turned Pro (√•r)</label>
                                <input type="number" id="edit-rider-turnedpro" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Bild URL</label>
                                <input type="text" id="edit-rider-imageurl" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Instagram (@namn)</label>
                                <input type="text" id="edit-rider-instagram" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Twitter (@namn)</label>
                                <input type="text" id="edit-rider-twitter" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Facebook (@namn)</label>
                                <input type="text" id="edit-rider-facebook" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Webb</label>
                                <input type="text" id="edit-rider-website" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Biografi</label>
                            <textarea id="edit-rider-bio" rows="4" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Meriter</label>
                            <textarea id="edit-rider-achievements" rows="4" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Namn</label>
                            <input type="text" id="edit-rider-name" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Klasser</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" id="edit-rider-class-250" class="mr-2 text-cyan-400" value="250cc">
                                    <span class="text-white">250cc</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="edit-rider-class-450" class="mr-2 text-cyan-400" value="450cc">
                                    <span class="text-white">450cc</span>
                                </label>
                            </div>
                            <p class="text-xs text-yellow-400 mt-1">‚ö†Ô∏è √Ñndring av klasser kan p√•verka befintliga picks och s√§songsteam</p>
                            <p class="text-xs text-blue-400 mt-1">üí° F√∂rare kan k√∂ra b√•da klasserna samtidigt (t.ex. wildcards)</p>
                        </div>
                        <div id="edit-coast-section" style="display: none;">
                            <label class="block text-sm font-medium text-gray-300 mb-1">Coast</label>
                            <select id="edit-rider-coast" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white">
                                <option value="">V√§lj coast</option>
                                <option value="east">East</option>
                                <option value="west">West</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">M√§rke</label>
                            <select id="edit-rider-brand" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white" required onchange="handleBikeBrandChange(this)">
                                <option value="">V√§lj m√§rke</option>
                                <option value="Honda">Honda</option>
                                <option value="Yamaha">Yamaha</option>
                                <option value="KTM">KTM</option>
                                <option value="Kawasaki">Kawasaki</option>
                                <option value="Suzuki">Suzuki</option>
                                <option value="Husqvarna">Husqvarna</option>
                                <option value="GasGas">GasGas</option>
                                <option value="Beta">Beta</option>
                                <option value="custom">Annan...</option>
                            </select>
                            <input type="text" id="edit-rider-brand-custom" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white mt-2 hidden" placeholder="Ange m√§rke">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Pris (kr)</label>
                            <input type="number" id="edit-rider-price" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white" required min="0" step="1000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">F√∂rare-bild</label>
                            <div class="space-y-2">
                                <input type="file" id="edit-rider-image" accept="image/*" class="w-full px-3 py-2 bg-gray-700 border border-cyan-400 rounded text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-600 file:text-white hover:file:bg-cyan-700">
                                <div id="edit-current-image" class="hidden">
                                    <p class="text-sm text-gray-400 mb-1">Nuvarande bild:</p>
                                    <img id="edit-image-preview" class="w-16 h-16 object-cover rounded-full border-2 border-cyan-400" alt="Current rider image">
                                    <button type="button" id="edit-remove-image" class="ml-2 px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded">Ta bort</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded transition-colors">
                            Avbryt
                        </button>
                        <button type="submit" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded transition-colors">
                            Spara
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Search functionality
        function searchRiders() {
            const searchTerm = document.getElementById('riderSearch').value.toLowerCase().trim();
            const resultsDiv = document.getElementById('searchResults');
            const resultsList = document.getElementById('searchResultsList');
            
            if (!searchTerm) {
                resultsDiv.classList.add('hidden');
                return;
            }
            
            // Get all riders from both tabs
            const allRiders = [];
            document.querySelectorAll('.rider-item').forEach(item => {
                const name = item.querySelector('.rider-name')?.textContent?.toLowerCase() || '';
                const number = item.querySelector('.rider-number')?.textContent?.toLowerCase() || '';
                const team = item.querySelector('.rider-team')?.textContent?.toLowerCase() || '';
                const bike = item.querySelector('.rider-bike')?.textContent?.toLowerCase() || '';
                const price = item.querySelector('.rider-price')?.textContent?.toLowerCase() || '';
                
                if (name.includes(searchTerm) || number.includes(searchTerm) || team.includes(searchTerm) || bike.includes(searchTerm) || price.includes(searchTerm)) {
                    // Extract rider ID and other data from the edit button's onclick attribute
                    const editButton = item.querySelector('button[onclick*="editRider"]');
                    const deleteButton = item.querySelector('button[onclick*="deleteRider"]');
                    
                    let riderId = '';
                    let className = '';
                    let coast = '';
                    
                    if (editButton) {
                        const onclickAttr = editButton.getAttribute('onclick');
                        console.log('DEBUG: onclickAttr:', onclickAttr);
                        const match = onclickAttr.match(/editRider\((\d+),\s*'([^']+)',\s*(\d+),\s*'([^']+)',\s*'([^']+)',\s*'([^']*)',\s*(\d+)\)/);
                        console.log('DEBUG: match:', match);
                        if (match) {
                            riderId = match[1];
                            className = match[5];
                            coast = match[6];
                            console.log('DEBUG: extracted riderId:', riderId, 'className:', className, 'coast:', coast);
                        } else {
                            // Try without price parameter
                            const match2 = onclickAttr.match(/editRider\((\d+),\s*'([^']+)',\s*(\d+),\s*'([^']+)',\s*'([^']+)',\s*'([^']*)'\)/);
                            console.log('DEBUG: match2 (without price):', match2);
                            if (match2) {
                                riderId = match2[1];
                                className = match2[5];
                                coast = match2[6];
                                console.log('DEBUG: extracted (no price) riderId:', riderId, 'className:', className, 'coast:', coast);
                            }
                        }
                    }
                    
                    allRiders.push({
                        element: item,
                        name: item.querySelector('.rider-name')?.textContent || '',
                        number: item.querySelector('.rider-number')?.textContent || '',
                        team: item.querySelector('.rider-team')?.textContent || '',
                        bike: item.querySelector('.rider-bike')?.textContent || '',
                        price: item.querySelector('.rider-price')?.textContent || '',
                        riderId: riderId,
                        className: className,
                        coast: coast
                    });
                }
            });
            
            if (allRiders.length === 0) {
                resultsList.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Inga f√∂rare hittades</p>';
            } else {
                resultsList.innerHTML = allRiders.map(rider => `
                    <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="font-semibold text-gray-800 dark:text-white">${rider.name}</span>
                                <span class="text-gray-600 dark:text-gray-400 ml-2">#${rider.number}</span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <div class="text-sm text-gray-600 dark:text-gray-400">
                                    ${rider.team} ‚Ä¢ ${rider.bike} ‚Ä¢ ${rider.price} kr
                                </div>
                                ${rider.riderId ? `
                                    <button onclick="editRider(${rider.riderId}, '${rider.name}', ${rider.number}, '${rider.bike}', '${rider.className}', '${rider.coast}', ${rider.price.replace(/,/g, '')})" 
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs">
                                        Redigera
                                    </button>
                                    <button onclick="deleteRider(${rider.riderId}, '${rider.name}')" 
                                            class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">
                                        Ta bort
                                    </button>
                                ` : '<span class="text-red-500 text-xs">No ID</span>'}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            resultsDiv.classList.remove('hidden');
        }
        
        function clearSearch() {
            document.getElementById('riderSearch').value = '';
            document.getElementById('searchResults').classList.add('hidden');
        }
        
        // Show conflict dialog
        function showConflictDialog(errorData) {
            const existingRider = errorData.existing_rider;
            const conflictModal = document.createElement('div');
            conflictModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            conflictModal.innerHTML = `
                <div class="bg-gray-900 rounded-lg border-2 border-red-400 p-6 w-full max-w-md" style="box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);">
                    <h3 class="text-lg font-semibold text-red-400 mb-4">‚ö†Ô∏è Nummer-konflikt</h3>
                    <p class="text-white mb-4">${errorData.message}</p>
                    <div class="bg-gray-800 p-3 rounded mb-4">
                        <p class="text-gray-300 text-sm">Befintlig f√∂rare:</p>
                        <p class="text-white font-semibold">${existingRider.name} #${existingRider.rider_number}</p>
                        <p class="text-gray-400 text-sm">${existingRider.class_name} ‚Ä¢ ${existingRider.bike_brand}</p>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="this.closest('.fixed').remove()" 
                                class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded transition-colors">
                            Avbryt
                        </button>
                        <button onclick="replaceExistingRider(${existingRider.id}, '${existingRider.name}')" 
                                class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition-colors">
                            Ers√§tt befintlig
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(conflictModal);
        }
        
        // Replace existing rider
        function replaceExistingRider(riderId, riderName) {
            if (confirm(`√Ñr du s√§ker p√• att du vill ta bort ${riderName} och ers√§tta med den nya f√∂raren?`)) {
                // Close conflict modal
                document.querySelector('.fixed.inset-0').remove();
                
                // Delete existing rider and retry adding new one
                fetch(`/api/riders/${riderId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .then(data => {
                    if (data.success) {
                        // Retry the form submission
                        const forms = document.querySelectorAll('[id^="add-rider-form-"]');
                        forms.forEach(form => {
                            if (form.querySelector('input[name="rider_number"]').value) {
                                form.dispatchEvent(new Event('submit'));
                            }
                        });
                    } else {
                        alert('Fel vid borttagning av befintlig f√∂rare: ' + (data.error || 'Ok√§nt fel'));
                    }
                })
                .catch(error => {
                    console.error('Error deleting rider:', error);
                    alert('Fel vid borttagning av befintlig f√∂rare: ' + error.message);
                });
            }
        }
        
        // Allow search on Enter key
        document.getElementById('riderSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchRiders();
            }
        });

        // Tab functionality
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                
                // Remove active class from all buttons and content
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked button and corresponding content
                button.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Add rider forms
        document.querySelectorAll('[id^="add-rider-form-"]').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(form);
                
                // Handle image upload and resizing
                const imageFile = formData.get('rider_image');
                if (imageFile && imageFile.size > 0) {
                    try {
                        const resizedImage = await resizeImage(imageFile, 200, 200, 0.8);
                        formData.set('rider_image', resizedImage, 'rider_image.jpg');
                    } catch (error) {
                        console.error('Error resizing image:', error);
                    }
                }
                
                const data = Object.fromEntries(formData);
                
                // Handle custom bike brand
                if (data.bike_brand === 'custom') {
                    data.bike_brand = data.bike_brand_custom;
                }
                delete data.bike_brand_custom;
                
                try {
                    const response = await fetch('/api/riders', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.warning) {
                            alert(data.warning);
                        }
                        location.reload();
                    } else {
                        const errorData = await response.json();
                        if (errorData.error === 'conflict') {
                            showConflictDialog(errorData);
                        } else {
                            alert('Fel vid till√§gg av f√∂rare: ' + (errorData.message || 'Ok√§nt fel'));
                        }
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Fel vid till√§gg av f√∂rare');
                }
            });
        });

        // Edit rider
        function editRider(id, name, number, brand, className, coast, price) {
            document.getElementById('edit-rider-id').value = id;
            document.getElementById('edit-rider-name').value = name;
            document.getElementById('edit-rider-number').value = number;
            document.getElementById('edit-rider-price').value = price;
            
            // Handle bike brand - check if it's a custom brand
            const predefinedBrands = ['Honda', 'Yamaha', 'KTM', 'Kawasaki', 'Suzuki', 'Husqvarna', 'GasGas', 'Beta'];
            if (predefinedBrands.includes(brand)) {
                document.getElementById('edit-rider-brand').value = brand;
                document.getElementById('edit-rider-brand-custom').classList.add('hidden');
            } else {
                document.getElementById('edit-rider-brand').value = 'custom';
                document.getElementById('edit-rider-brand-custom').value = brand;
                document.getElementById('edit-rider-brand-custom').classList.remove('hidden');
            }
            
            // Handle multiple classes - parse comma-separated classes
            const classes = className.split(',').map(c => c.trim());
            document.getElementById('edit-rider-class-250').checked = classes.includes('250cc');
            document.getElementById('edit-rider-class-450').checked = classes.includes('450cc');
            
            // Show/hide coast section based on 250cc class
            const coastSection = document.getElementById('edit-coast-section');
            if (classes.includes('250cc')) {
                coastSection.style.display = 'block';
                document.getElementById('edit-rider-coast').value = coast;
            } else {
                coastSection.style.display = 'none';
            }
            
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        // Handle class changes in edit modal
        document.getElementById('edit-rider-class-250').addEventListener('change', function() {
            const coastSection = document.getElementById('edit-coast-section');
            if (this.checked) {
                coastSection.style.display = 'block';
            } else {
                coastSection.style.display = 'none';
            }
        });

        // Handle bike brand changes
        function handleBikeBrandChange(selectElement) {
            const customInput = selectElement.parentNode.querySelector('input[name="bike_brand_custom"], #edit-rider-brand-custom');
            if (selectElement.value === 'custom') {
                customInput.classList.remove('hidden');
                customInput.required = true;
                selectElement.required = false;
            } else {
                customInput.classList.add('hidden');
                customInput.required = false;
                selectElement.required = true;
                customInput.value = '';
            }
        }

        // Handle image upload and resizing
        function resizeImage(file, maxWidth = 200, maxHeight = 200, quality = 0.8) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calculate new dimensions maintaining aspect ratio
                    let { width, height } = img;
                    if (width > height) {
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = (width * maxHeight) / height;
                            height = maxHeight;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob(resolve, 'image/jpeg', quality);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        // Handle image preview in edit modal
        document.getElementById('edit-rider-image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('edit-image-preview');
                    preview.src = e.target.result;
                    document.getElementById('edit-current-image').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // Handle remove image button
        document.getElementById('edit-remove-image').addEventListener('click', function() {
            document.getElementById('edit-rider-image').value = '';
            document.getElementById('edit-current-image').classList.add('hidden');
        });

        // Edit rider form
        document.getElementById('edit-rider-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('edit-rider-id').value;
            // Collect selected classes
            const selectedClasses = [];
            if (document.getElementById('edit-rider-class-250').checked) {
                selectedClasses.push('250cc');
            }
            if (document.getElementById('edit-rider-class-450').checked) {
                selectedClasses.push('450cc');
            }
            
            // Handle custom bike brand
            let bikeBrand = document.getElementById('edit-rider-brand').value;
            if (bikeBrand === 'custom') {
                bikeBrand = document.getElementById('edit-rider-brand-custom').value;
            }
            
            const data = {
                name: document.getElementById('edit-rider-name').value,
                rider_number: parseInt(document.getElementById('edit-rider-number').value),
                bike_brand: bikeBrand,
                classes: selectedClasses.join(','),
                price: parseInt(document.getElementById('edit-rider-price').value),
                nickname: document.getElementById('edit-rider-nickname').value,
                birthdate: document.getElementById('edit-rider-birthdate').value,
                hometown: document.getElementById('edit-rider-hometown').value,
                residence: document.getElementById('edit-rider-residence').value,
                height_cm: document.getElementById('edit-rider-height').value,
                weight_kg: document.getElementById('edit-rider-weight').value,
                team: document.getElementById('edit-rider-team').value,
                manufacturer: document.getElementById('edit-rider-manufacturer').value,
                team_manager: document.getElementById('edit-rider-teammanager').value,
                mechanic: document.getElementById('edit-rider-mechanic').value,
                turned_pro: document.getElementById('edit-rider-turnedpro').value,
                image_url: document.getElementById('edit-rider-imageurl').value,
                instagram: document.getElementById('edit-rider-instagram').value,
                twitter: document.getElementById('edit-rider-twitter').value,
                facebook: document.getElementById('edit-rider-facebook').value,
                website: document.getElementById('edit-rider-website').value,
                bio: document.getElementById('edit-rider-bio').value,
                achievements: document.getElementById('edit-rider-achievements').value
            };
            
            // Add coast if it's a 250cc rider
            const coastSection = document.getElementById('edit-coast-section');
            if (coastSection.style.display !== 'none') {
                data.coast_250 = document.getElementById('edit-rider-coast').value;
            }
            
                try {
                    // Create FormData for image upload
                    const formData = new FormData();
                    Object.keys(data).forEach(key => {
                        if (data[key] !== null && data[key] !== undefined) {
                            formData.append(key, data[key]);
                        }
                    });
                    
                    // Add image file if selected
                    const imageFile = document.getElementById('edit-rider-image').files[0];
                    if (imageFile && imageFile.size > 0) {
                        try {
                            const resizedImage = await resizeImage(imageFile, 200, 200, 0.8);
                            formData.append('rider_image', resizedImage, 'rider_image.jpg');
                        } catch (error) {
                            console.error('Error resizing image:', error);
                        }
                    }
                    
                    const response = await fetch(`/api/riders/${id}`, {
                        method: 'PUT',
                        body: formData
                    });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.warning) {
                        alert(data.warning);
                    }
                    location.reload();
                } else {
                    const errorData = await response.json();
                    if (errorData.error === 'conflict') {
                        showConflictDialog(errorData);
                    } else {
                        alert('Fel vid uppdatering av f√∂rare: ' + (errorData.message || 'Ok√§nt fel'));
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Fel vid uppdatering av f√∂rare');
            }
        });

        // Delete rider
        function deleteRider(id, name) {
            if (confirm(`√Ñr du s√§ker p√• att du vill ta bort ${name}?`)) {
                fetch(`/api/riders/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.warning) {
                            alert(data.warning);
                        }
                        location.reload();
                    } else {
                        alert('Fel vid borttagning av f√∂rare: ' + (data.message || 'Ok√§nt fel'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Fel vid borttagning av f√∂rare');
                });
            }
        }

        // Entry List Import functionality
        let entryListPreview = null;

        // Function to show preview table
        function showPreviewTable(sampleRiders, totalRiders, byClass) {
            const previewTable = document.getElementById('preview-table');
            const previewList = document.getElementById('preview-riders-list');
            const previewSummary = document.getElementById('preview-summary');
            
            // Clear previous content
            previewList.innerHTML = '';
            
            // Show sample riders (first 20)
            const ridersToShow = sampleRiders.slice(0, 20);
            ridersToShow.forEach(rider => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 dark:border-gray-600';
                
                // Determine coast for 250cc riders
                let coast = '';
                if (rider.class === '250cc') {
                    // This is a simplified approach - in reality you'd need to track which file each rider came from
                    coast = 'East/West';
                }
                
                row.innerHTML = `
                    <td class="px-2 py-1 font-mono">${rider.number}</td>
                    <td class="px-2 py-1">${rider.name}</td>
                    <td class="px-2 py-1">${rider.bike_brand}</td>
                    <td class="px-2 py-1">${rider.class}</td>
                    <td class="px-2 py-1">${coast}</td>
                `;
                previewList.appendChild(row);
            });
            
            // Show summary
            previewSummary.innerHTML = `
                <strong>Sammanfattning:</strong> ${totalRiders} f√∂rare totalt 
                (250cc: ${byClass['250cc']}, 450cc: ${byClass['450cc']})
                ${sampleRiders.length > 20 ? ` - Visar f√∂rsta 20 av ${sampleRiders.length} f√∂rare` : ''}
            `;
            
            // Show the table
            previewTable.classList.remove('hidden');
        }

        // Upload entry lists form handler
        document.getElementById('upload-entry-lists-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('entry-csv-files');
            const files = fileInput.files;
            
            if (files.length === 0) {
                document.getElementById('upload-entry-status').innerHTML = '<span class="text-red-600">V√§lj CSV-filer</span>';
                return;
            }
            
            let uploadedCount = 0;
            let errors = [];
            
            for (let file of files) {
                if (file.name.endsWith('.csv')) {
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    try {
                        const response = await fetch('/upload_entry_list', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            uploadedCount++;
                        } else {
                            errors.push(`${file.name}: ${result.error}`);
                        }
                    } catch (error) {
                        errors.push(`${file.name}: Upload error`);
                    }
                } else {
                    errors.push(`${file.name}: Not a CSV file`);
                }
            }
            
            if (uploadedCount > 0) {
                document.getElementById('upload-entry-status').innerHTML = 
                    '<span class="text-green-600">‚úì Laddade upp ' + uploadedCount + ' filer</span>';
            }
            
            if (errors.length > 0) {
                document.getElementById('upload-entry-status').innerHTML += 
                    '<br><span class="text-red-600">Fel: ' + errors.join(', ') + '</span>';
            }
        });

        // Preview entry lists button handler
        document.getElementById('preview-entry-lists-btn').addEventListener('click', async function() {
            try {
                const response = await fetch('/import_entry_lists_new');
                const result = await response.json();
                
                if (result.success) {
                    entryListPreview = result;
                    document.getElementById('preview-status').innerHTML = 
                        '<span class="text-green-600">‚úì Hittade ' + result.preview.total_riders + ' f√∂rare</span><br>' +
                        '<span class="text-blue-600">250cc: ' + result.preview.by_class['250cc'] + ' f√∂rare</span><br>' +
                        '<span class="text-blue-600">450cc: ' + result.preview.by_class['450cc'] + ' f√∂rare</span>';
                    
                    // Show preview table
                    showPreviewTable(result.preview.sample_riders, result.preview.total_riders, result.preview.by_class);
                    
                    document.getElementById('import-entry-lists-btn').disabled = false;
                } else {
                    document.getElementById('preview-status').innerHTML = 
                        '<span class="text-red-600">Fel: ' + result.error + '</span>';
                }
            } catch (error) {
                console.error('Preview error:', error);
                document.getElementById('preview-status').innerHTML = 
                    '<span class="text-red-600">Fel vid f√∂rhandsvisning</span>';
            }
        });

        // Import entry lists button handler
        document.getElementById('import-entry-lists-btn').addEventListener('click', async function() {
            if (!entryListPreview) {
                document.getElementById('import-entry-status').innerHTML = 
                    '<span class="text-red-600">F√∂rhandsvisa entry lists f√∂rst</span>';
                return;
            }
            
            const confirmImport = confirm(
                `Detta kommer att TA BORT ALLA befintliga f√∂rare och ers√§tta dem med ${entryListPreview.preview.total_riders} f√∂rare fr√•n entry lists.\n\n` +
                `250cc: ${entryListPreview.preview.by_class['250cc']} f√∂rare\n` +
                `450cc: ${entryListPreview.preview.by_class['450cc']} f√∂rare\n\n` +
                `√Ñr du s√§ker p√• att du vill forts√§tta?`
            );
            
            if (confirmImport) {
                try {
                    const response = await fetch('/confirm_import_entry_lists', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        document.getElementById('import-entry-status').innerHTML = 
                            '<span class="text-green-600">‚úì Importerade ' + result.imported_count + ' f√∂rare</span>';
                        
                        if (result.errors.length > 0) {
                            document.getElementById('import-entry-status').innerHTML += 
                                '<br><span class="text-yellow-600">Varningar: ' + result.errors.length + ' fel</span>';
                        }
                        
                        // Reload page to show new riders
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    } else {
                        document.getElementById('import-entry-status').innerHTML = 
                            '<span class="text-red-600">Fel: ' + result.error + '</span>';
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    document.getElementById('import-entry-status').innerHTML = 
                        '<span class="text-red-600">Fel vid import</span>';
                }
            }
        });

        // CSV Import functionality
        let uploadedCsvFile = null;

        // Restore Images functionality
        document.getElementById('restore-images-btn').addEventListener('click', async function() {
            try {
                const response = await fetch('/restore_rider_images');
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('restore-images-status').innerHTML = 
                        '<span class="text-green-600">‚úì √Öterst√§llde bilder f√∂r ' + result.updated + ' f√∂rare</span>';
                    
                    if (result.skipped > 0) {
                        document.getElementById('restore-images-status').innerHTML += 
                            '<br><span class="text-yellow-600">Hoppade √∂ver ' + result.skipped + ' bilder (ingen match)</span>';
                    }
                } else {
                    document.getElementById('restore-images-status').innerHTML = 
                        '<span class="text-red-600">Fel: ' + result.error + '</span>';
                }
            } catch (error) {
                console.error('Restore images error:', error);
                document.getElementById('restore-images-status').innerHTML = 
                    '<span class="text-red-600">Fel vid √•terst√§llning av bilder</span>';
            }
        });

        // Debug Images functionality
        document.getElementById('debug-images-btn').addEventListener('click', async function() {
            try {
                const response = await fetch('/debug_rider_images');
                const result = await response.json();
                
                if (result.total_riders) {
                    document.getElementById('debug-images-status').innerHTML = 
                        '<span class="text-blue-600">Totalt: ' + result.total_riders + ' f√∂rare</span><br>' +
                        '<span class="text-green-600">Med bilder: ' + result.riders_with_images + '</span><br>' +
                        '<span class="text-yellow-600">Med existerande filer: ' + result.riders_with_existing_files + '</span>';
                } else {
                    document.getElementById('debug-images-status').innerHTML = 
                        '<span class="text-red-600">Fel: ' + result.error + '</span>';
                }
            } catch (error) {
                console.error('Debug images error:', error);
                document.getElementById('debug-images-status').innerHTML = 
                    '<span class="text-red-600">Fel vid debug av bilder</span>';
            }
        });

        // Race Results Import functionality
        let uploaded250Results = null;
        let uploaded450Results = null;

        // Load riders for holeshot/wildcard dropdowns
        function loadRidersForPicks() {
            fetch('/api/riders')
                .then(response => response.json())
                .then(riders => {
                    const holeshot250 = document.getElementById('holeshot-250');
                    const holeshot450 = document.getElementById('holeshot-450');
                    
                    // Clear existing options
                    [holeshot250, holeshot450].forEach(select => {
                        select.innerHTML = '<option value="">V√§lj f√∂rare...</option>';
                    });
                    
                    // Add riders to dropdowns
                    riders.forEach(rider => {
                        const option = document.createElement('option');
                        option.value = rider.id;
                        option.textContent = `#${rider.number} ${rider.name} (${rider.class})`;
                        
                        if (rider.class === '250') {
                            holeshot250.appendChild(option.cloneNode(true));
                        } else if (rider.class === '450') {
                            holeshot450.appendChild(option.cloneNode(true));
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading riders:', error);
                });
        }

        // Upload 250 results
        document.getElementById('upload-250-results-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('results-250-file');
            const file = fileInput.files[0];
            
            if (!file) {
                document.getElementById('upload-250-status').innerHTML = '<span class="text-red-600">V√§lj en CSV-fil</span>';
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/upload_race_results', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    uploaded250Results = result.filename;
                    console.log('‚úÖ 250cc uploaded:', uploaded250Results);
                    document.getElementById('upload-250-status').innerHTML = '<span class="text-green-600">‚úì 250cc resultat uppladdat</span>';
                    checkImportReady();
                } else {
                    console.log('‚ùå 250cc upload failed:', result.error);
                    document.getElementById('upload-250-status').innerHTML = '<span class="text-red-600">Fel: ' + result.error + '</span>';
                }
            } catch (error) {
                console.error('Upload error:', error);
                document.getElementById('upload-250-status').innerHTML = '<span class="text-red-600">Fel vid uppladdning</span>';
            }
        });

        // Upload 450 results
        document.getElementById('upload-450-results-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('results-450-file');
            const file = fileInput.files[0];
            
            if (!file) {
                document.getElementById('upload-450-status').innerHTML = '<span class="text-red-600">V√§lj en CSV-fil</span>';
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/upload_race_results', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    uploaded450Results = result.filename;
                    console.log('‚úÖ 450cc uploaded:', uploaded450Results);
                    document.getElementById('upload-450-status').innerHTML = '<span class="text-green-600">‚úì 450cc resultat uppladdat</span>';
                    checkImportReady();
                } else {
                    console.log('‚ùå 450cc upload failed:', result.error);
                    document.getElementById('upload-450-status').innerHTML = '<span class="text-red-600">Fel: ' + result.error + '</span>';
                }
            } catch (error) {
                console.error('Upload error:', error);
                document.getElementById('upload-450-status').innerHTML = '<span class="text-red-600">Fel vid uppladdning</span>';
            }
        });

        // Check if ready to import
        function checkImportReady() {
            const competition = document.getElementById('competition-select-results').value;
            const holeshot250 = document.getElementById('holeshot-250').value;
            const holeshot450 = document.getElementById('holeshot-450').value;
            
            console.log('Checking import readiness:', {
                uploaded250Results,
                uploaded450Results,
                competition,
                holeshot250,
                holeshot450
            });
            
            const isReady = uploaded250Results && uploaded450Results && competition && holeshot250 && holeshot450;
            const isPreviewReady = uploaded250Results && uploaded450Results && competition;
            
            // Enable/disable import button
            if (isReady) {
                document.getElementById('import-race-results-btn').disabled = false;
                console.log('Import button enabled!');
            } else {
                document.getElementById('import-race-results-btn').disabled = true;
            }
            
            // Enable/disable preview button
            if (isPreviewReady) {
                document.getElementById('preview-results-btn').disabled = false;
                console.log('Preview button enabled!');
            } else {
                document.getElementById('preview-results-btn').disabled = true;
            }
        }

        // Import race results
        document.getElementById('import-race-results-btn').addEventListener('click', async function() {
            console.log('Import button clicked!');
            const competition = document.getElementById('competition-select-results').value;
            const holeshot250 = document.getElementById('holeshot-250').value;
            const holeshot450 = document.getElementById('holeshot-450').value;
            
            console.log('Import data:', {
                competition,
                holeshot250,
                holeshot450,
                uploaded250Results,
                uploaded450Results
            });
            
            try {
                const response = await fetch('/import_race_results_complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        competition_id: competition,
                        results_250: uploaded250Results,
                        results_450: uploaded450Results,
                        holeshot_250: holeshot250,
                        holeshot_450: holeshot450
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('import-results-status').innerHTML = 
                        '<span class="text-green-600">‚úì Importerade race results f√∂r ' + result.imported_count + ' f√∂rare</span>';
                } else {
                    document.getElementById('import-results-status').innerHTML = 
                        '<span class="text-red-600">Fel: ' + result.error + '</span>';
                }
            } catch (error) {
                console.error('Import error:', error);
                document.getElementById('import-results-status').innerHTML = '<span class="text-red-600">Fel vid import</span>';
            }
        });

        // Preview race results before importing
        function previewRaceResults() {
            console.log('üîç previewRaceResults called');
            const competitionId = document.getElementById('competition-select-results').value;
            
            console.log('üîç Data check:', {
                competitionId,
                uploaded250Results,
                uploaded450Results
            });
            
            if (!competitionId || !uploaded250Results || !uploaded450Results) {
                alert('‚ùå V√§lj t√§vling och ladda upp b√•da resultatfiler f√∂rst!');
                return;
            }
            
            document.getElementById('preview-status').innerHTML = 'Laddar f√∂rhandsvisning...';
            
            const requestData = {
                competition_id: competitionId,
                results_250: uploaded250Results,
                results_450: uploaded450Results
            };
            
            console.log('üîç Sending request:', requestData);
            
            fetch('/preview_race_results', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                console.log('üîç Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('üîç Response data:', data);
                if (data.success) {
                    showPreviewResults(data.preview);
                    document.getElementById('preview-status').innerHTML = '‚úÖ F√∂rhandsvisning klar!';
                } else {
                    document.getElementById('preview-status').innerHTML = '‚ùå Fel: ' + data.error;
                }
            })
            .catch(error => {
                console.error('üîç Error:', error);
                document.getElementById('preview-status').innerHTML = '‚ùå Fel vid f√∂rhandsvisning';
            });
        }
        
        // Show preview results
        function showPreviewResults(preview) {
            console.log('üîç showPreviewResults called with:', preview);
            
            const previewTable = document.getElementById('preview-results-table');
            const preview250 = document.getElementById('preview-250-results');
            const preview450 = document.getElementById('preview-450-results');
            
            console.log('üîç 250cc results:', preview['250cc_results']);
            console.log('üîç 450cc results:', preview['450cc_results']);
            console.log('üîç Errors:', preview['errors']);
            
            // Show 250cc results
            preview250.innerHTML = '';
            if (preview['250cc_results'] && preview['250cc_results'].length > 0) {
                preview['250cc_results'].forEach(result => {
                    const statusIcon = result.found_in_db ? '‚úÖ' : '‚ùå';
                    const statusText = result.found_in_db ? 'Hittad' : 'Saknas i DB';
                    preview250.innerHTML += `
                        <div class="flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-600 rounded">
                            <span class="font-semibold">${result.position}.</span>
                            <span>#${result.rider_number} ${result.rider_name}</span>
                            <span class="text-xs ${result.found_in_db ? 'text-green-600' : 'text-red-600'}">${statusIcon} ${statusText}</span>
                        </div>
                    `;
                });
            } else {
                preview250.innerHTML = '<div class="text-gray-500 text-sm">Inga 250cc resultat hittades</div>';
            }
            
            // Show 450cc results
            preview450.innerHTML = '';
            if (preview['450cc_results'] && preview['450cc_results'].length > 0) {
                preview['450cc_results'].forEach(result => {
                    const statusIcon = result.found_in_db ? '‚úÖ' : '‚ùå';
                    const statusText = result.found_in_db ? 'Hittad' : 'Saknas i DB';
                    preview450.innerHTML += `
                        <div class="flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-600 rounded">
                            <span class="font-semibold">${result.position}.</span>
                            <span>#${result.rider_number} ${result.rider_name}</span>
                            <span class="text-xs ${result.found_in_db ? 'text-green-600' : 'text-red-600'}">${statusIcon} ${statusText}</span>
                        </div>
                    `;
                });
            } else {
                preview450.innerHTML = '<div class="text-gray-500 text-sm">Inga 450cc resultat hittades</div>';
            }
            
            // Show errors if any
            if (preview['errors'] && preview['errors'].length > 0) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'mt-4 p-3 bg-red-100 dark:bg-red-900 rounded-lg';
                errorDiv.innerHTML = '<h6 class="font-semibold text-red-800 dark:text-red-200">‚ö†Ô∏è Varningar:</h6>' +
                    preview['errors'].map(error => `<div class="text-sm text-red-700 dark:text-red-300">${error}</div>`).join('');
                previewTable.appendChild(errorDiv);
            }
            
            // Show missing riders warning
            if (preview['missing_riders']) {
                const missing250 = preview['missing_riders']['250cc'] || [];
                const missing450 = preview['missing_riders']['450cc'] || [];
                
                if (missing250.length > 0 || missing450.length > 0) {
                    const missingDiv = document.createElement('div');
                    missingDiv.className = 'mt-4 p-3 bg-yellow-100 dark:bg-yellow-900 rounded-lg';
                    let missingHTML = '<h6 class="font-semibold text-yellow-800 dark:text-yellow-200">‚ö†Ô∏è F√∂rare saknas i databasen:</h6>';
                    
                    if (missing250.length > 0) {
                        missingHTML += '<div class="mt-2"><strong>250cc:</strong>';
                        missing250.forEach(rider => {
                            missingHTML += `<div class="text-sm text-yellow-700 dark:text-yellow-300">‚Ä¢ Pos ${rider.position}: #${rider.rider_number} ${rider.rider_name}</div>`;
                        });
                        missingHTML += '</div>';
                    }
                    
                    if (missing450.length > 0) {
                        missingHTML += '<div class="mt-2"><strong>450cc:</strong>';
                        missing450.forEach(rider => {
                            missingHTML += `<div class="text-sm text-yellow-700 dark:text-yellow-300">‚Ä¢ Pos ${rider.position}: #${rider.rider_number} ${rider.rider_name}</div>`;
                        });
                        missingHTML += '</div>';
                    }
                    
                    missingHTML += '<div class="mt-2 text-xs text-yellow-600 dark:text-yellow-400">L√§gg till dessa f√∂rare i databasen f√∂rst innan du importerar resultat.</div>';
                    missingDiv.innerHTML = missingHTML;
                    previewTable.appendChild(missingDiv);
                }
            }
            
            previewTable.classList.remove('hidden');
        }

        // Load competitions on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadCompetitions();
            loadRidersForPicks();
            
            // Add event listeners for import readiness
            document.getElementById('competition-select-results').addEventListener('change', checkImportReady);
            document.getElementById('holeshot-250').addEventListener('change', checkImportReady);
            document.getElementById('holeshot-450').addEventListener('change', checkImportReady);
        });

        function loadCompetitions() {
            fetch('/get_competitions_for_import')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Load competitions for old CSV import
                        const select = document.getElementById('competition-select');
                        select.innerHTML = '<option value="">V√§lj t√§vling...</option>';
                        
                        // Load competitions for new race results import
                        const selectResults = document.getElementById('competition-select-results');
                        selectResults.innerHTML = '<option value="">V√§lj t√§vling...</option>';
                        
                        data.competitions.forEach(comp => {
                            const option = document.createElement('option');
                            option.value = comp.id;
                            option.textContent = `${comp.name} - ${comp.event_date} ${comp.has_results ? '(har resultat)' : ''}`;
                            select.appendChild(option);
                            
                            const optionResults = option.cloneNode(true);
                            selectResults.appendChild(optionResults);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading competitions:', error);
                    document.getElementById('competition-select').innerHTML = '<option value="">Fel vid laddning av t√§vlingar</option>';
                    document.getElementById('competition-select-results').innerHTML = '<option value="">Fel vid laddning av t√§vlingar</option>';
                });
        }

        // Upload CSV form handler
        document.getElementById('upload-results-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('results-csv-file');
            const file = fileInput.files[0];
            
            if (!file) {
                document.getElementById('upload-status').innerHTML = '<span class="text-red-600">V√§lj en CSV-fil</span>';
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/upload_results_csv', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    uploadedCsvFile = result.message.split(' ')[2]; // Extract filename
                    document.getElementById('upload-status').innerHTML = '<span class="text-green-600">‚úì Fil uppladdad: ' + uploadedCsvFile + '</span>';
                    document.getElementById('import-results-btn').disabled = false;
                } else {
                    document.getElementById('upload-status').innerHTML = '<span class="text-red-600">Fel: ' + result.error + '</span>';
                }
            } catch (error) {
                console.error('Upload error:', error);
                document.getElementById('upload-status').innerHTML = '<span class="text-red-600">Fel vid uppladdning</span>';
            }
        });

        // Import results button handler
        document.getElementById('import-results-btn').addEventListener('click', async function() {
            const competitionId = document.getElementById('competition-select').value;
            
            if (!competitionId) {
                document.getElementById('import-status').innerHTML = '<span class="text-red-600">V√§lj en t√§vling</span>';
                return;
            }
            
            if (!uploadedCsvFile) {
                document.getElementById('import-status').innerHTML = '<span class="text-red-600">Ladda upp en CSV-fil f√∂rst</span>';
                return;
            }
            
            // First, preview the import
            try {
                const previewResponse = await fetch('/import_results_csv', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        csv_file: uploadedCsvFile
                    })
                });
                
                const previewResult = await previewResponse.json();
                
                if (previewResult.success) {
                    const confirmImport = confirm(
                        `Hittade ${previewResult.preview.total_results} resultat.\n` +
                        `Klasser: ${previewResult.preview.classes.join(', ')}\n\n` +
                        `Vill du importera dessa resultat till t√§vlingen?`
                    );
                    
                    if (confirmImport) {
                        // Confirm the import
                        const importResponse = await fetch('/confirm_import_results', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                csv_file: uploadedCsvFile,
                                competition_id: competitionId
                            })
                        });
                        
                        const importResult = await importResponse.json();
                        
                        if (importResult.success) {
                            document.getElementById('import-status').innerHTML = 
                                '<span class="text-green-600">‚úì Importerade ' + importResult.imported_count + ' resultat</span>';
                            
                            if (importResult.errors.length > 0) {
                                document.getElementById('import-status').innerHTML += 
                                    '<br><span class="text-yellow-600">Varningar: ' + importResult.errors.length + ' fel</span>';
                            }
                        } else {
                            document.getElementById('import-status').innerHTML = 
                                '<span class="text-red-600">Fel: ' + importResult.error + '</span>';
                        }
                    }
                } else {
                    document.getElementById('import-status').innerHTML = 
                        '<span class="text-red-600">Fel vid f√∂rhandsvisning: ' + previewResult.error + '</span>';
                }
            } catch (error) {
                console.error('Import error:', error);
                document.getElementById('import-status').innerHTML = '<span class="text-red-600">Fel vid import</span>';
            }
        });
    </script>
</body>
</html>
