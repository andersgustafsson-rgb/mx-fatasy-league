<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ target_user.username }}'s Profil - MX Fantasy League</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Suppress Tailwind CDN warning in production
    if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
      console.warn = function() {}; // Suppress console warnings in production
    }
  </script>
</head>
<body class="relative font-sans min-h-screen text-gray-200">
  <!-- Bakgrund -->
  <div
    class="absolute inset-0 bg-cover bg-center"
    style="background-image: url('{{ url_for("static", filename="images/huvudsida.jpg") }}');"
  ></div>
  <div class="absolute inset-0 bg-black bg-opacity-70"></div>

  <!-- Inneh√•ll -->
  <div class="relative z-10">
    <div class="container mx-auto p-4 md:p-8">
      <!-- Header -->
      <div class="mb-6 md:mb-8">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
          <header class="text-center sm:text-left">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-yellow-400">MX Fantasy League</h1>
            <p class="text-base md:text-lg text-gray-200 mt-2">
              {{ target_user.username }}'s Profil
            </p>
          </header>
          
          <!-- Navigation -->
          <div class="flex flex-wrap justify-center sm:justify-end gap-2 sm:gap-4">
            <a
              href="{{ url_for('index') }}"
              class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 sm:px-4 rounded shadow nav-sound text-sm sm:text-base"
            >
              Tillbaka till Huvudsidan
            </a>
            <a
              href="{{ url_for('profile_page') }}"
              class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-3 sm:px-4 rounded shadow nav-sound text-sm sm:text-base"
            >
              Min Profil
            </a>
          </div>
        </div>
      </div>

      <!-- Flash Messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="mb-6">
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} p-4 rounded-lg mb-2
                {% if category == 'success' %}bg-green-600 text-white
                {% elif category == 'error' %}bg-red-600 text-white
                {% elif category == 'warning' %}bg-yellow-600 text-white
                {% else %}bg-blue-600 text-white{% endif %}">
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8">
        <!-- Profilinformation -->
        <div class="bg-white bg-opacity-90 dark:bg-gray-800 dark:bg-opacity-90 p-6 rounded-lg shadow-lg">
          <h2 class="text-2xl font-bold text-blue-500 mb-4">Profilinformation</h2>
          
          <!-- Profilbild -->
          <div class="flex items-center gap-4 mb-6">
            {% if target_user.profile_picture_url %}
              {% if target_user.profile_picture_url.startswith('data:') %}
                <img src="{{ target_user.profile_picture_url }}" 
                     alt="Profilbild" 
                     class="w-20 h-20 rounded-full object-cover border-4 border-blue-400">
              {% else %}
                <img src="{{ url_for('static', filename=target_user.profile_picture_url) }}" 
                     alt="Profilbild" 
                     class="w-20 h-20 rounded-full object-cover border-4 border-blue-400"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="w-20 h-20 rounded-full bg-gray-600 flex items-center justify-center border-4 border-blue-400" style="display:none;">
                  <span class="text-blue-400 text-2xl font-bold">{{ target_user.username[0].upper() }}</span>
                </div>
              {% endif %}
            {% else %}
              <div class="w-20 h-20 rounded-full bg-gray-600 flex items-center justify-center border-4 border-blue-400">
                <span class="text-blue-400 text-2xl font-bold">{{ target_user.username[0].upper() }}</span>
              </div>
            {% endif %}
            <div>
              <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200">{{ target_user.username }}</h3>
              {% if target_user.display_name %}
                <p class="text-gray-600 dark:text-gray-400">{{ target_user.display_name }}</p>
              {% endif %}
            </div>
          </div>

          <!-- Anv√§ndarinfo -->
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Anv√§ndarnamn</label>
              <p class="text-gray-800 dark:text-gray-200 font-medium">{{ target_user.username }}</p>
            </div>
            
            {% if target_user.display_name %}
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Visningsnamn</label>
              <p class="text-gray-800 dark:text-gray-200">{{ target_user.display_name }}</p>
            </div>
            {% endif %}
            
            {% if target_user.bio %}
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Om mig</label>
              <p class="text-gray-800 dark:text-gray-200">{{ target_user.bio }}</p>
            </div>
            {% endif %}
            
            {% if target_user.favorite_rider %}
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Favoritf√∂rare</label>
              <p class="text-gray-800 dark:text-gray-200">{{ target_user.favorite_rider }}</p>
            </div>
            {% endif %}
            
            {% if target_user.favorite_team %}
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Favoritlag</label>
              <p class="text-gray-800 dark:text-gray-200">{{ target_user.favorite_team }}</p>
            </div>
            {% endif %}
            
            {% if target_user.created_at %}
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Medlem sedan</label>
              <p class="text-gray-800 dark:text-gray-200">{{ target_user.created_at.strftime('%d %B %Y') }}</p>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- S√§songsteam -->
        <div class="bg-white bg-opacity-90 dark:bg-gray-800 dark:bg-opacity-90 p-6 rounded-lg shadow-lg">
          <h2 class="text-2xl font-bold text-green-500 mb-4">S√§songsteam</h2>
          
          {% if season_team %}
            <div class="mb-4">
              <p class="text-lg font-semibold text-gray-800 dark:text-gray-200">
                Teamnamn: <span class="text-green-600">{{ season_team.team_name }}</span>
              </p>
              <p class="text-xl font-bold text-green-600 dark:text-green-400">
                Totala po√§ng: {{ season_team.total_points or 0 }}
              </p>
            </div>

            {% if team_riders %}
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4">
                {% for r in team_riders %}
                <div class="flex items-center gap-3 bg-gradient-to-r from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800 rounded-lg px-4 py-3 shadow-md hover:shadow-lg transition-shadow">
                  <div class="flex items-center gap-2 flex-shrink-0">
                    {% if r.image_url %}
                      <img src="{{ url_for('static', filename=r.image_url) }}"
                           alt="{{ r.name }} headshot"
                           class="w-10 h-10 rounded-full object-cover border-2 {% if r.class == '450cc' %}border-orange-500{% else %}border-yellow-500{% endif %}"
                           onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                      <div class="w-10 h-10 rounded-full {% if r.class == '450cc' %}bg-orange-600{% else %}bg-yellow-600{% endif %} flex items-center justify-center border-2 {% if r.class == '450cc' %}border-orange-500{% else %}border-yellow-500{% endif %}" style="display:none;">
                        <span class="text-white text-xs font-bold">#{{ r.number }}</span>
                      </div>
                    {% else %}
                      <div class="w-10 h-10 rounded-full {% if r.class == '450cc' %}bg-orange-600{% else %}bg-yellow-600{% endif %} flex items-center justify-center border-2 {% if r.class == '450cc' %}border-orange-500{% else %}border-yellow-500{% endif %}">
                        <span class="text-white text-xs font-bold">#{{ r.number }}</span>
                      </div>
                    {% endif %}
                    {% if r.brand %}
                      <img src="{{ url_for('static', filename='brand_logos/' ~ r.brand ~ '.png') }}"
                           alt="{{ r.brand }} logo"
                           class="w-6 h-6 object-contain"
                           onerror="this.style.display='none';">
                    {% endif %}
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="font-semibold text-gray-800 dark:text-gray-200 truncate">#{{ r.number }} {{ r.name }}</div>
                    <div class="text-xs text-gray-600 dark:text-gray-400">
                      <span class="inline-block px-2 py-0.5 rounded {% if r.class == '450cc' %}bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200{% else %}bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200{% endif %}">
                        {{ r.class }}
                      </span>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-gray-600 dark:text-gray-400">Inga riders i teamet √§n.</p>
            {% endif %}
          {% else %}
            <p class="text-gray-600 dark:text-gray-400">Inget s√§songsteam skapat √§n.</p>
          {% endif %}
        </div>
      </div>

      <!-- Aktuella picks -->
      {% if current_picks_450 or current_picks_250 %}
      <div class="mt-6">
        <div class="bg-white bg-opacity-90 dark:bg-gray-800 dark:bg-opacity-90 p-6 rounded-lg shadow-lg">
          <h2 class="text-2xl font-bold text-purple-500 mb-4">Aktuella Race Picks</h2>
          
          {% if upcoming_race %}
            <p class="text-gray-600 dark:text-gray-400 mb-4">
              F√∂r {{ upcoming_race.name }} ({{ upcoming_race.event_date.strftime('%Y-%m-%d') if upcoming_race.event_date else '' }})
            </p>
          {% endif %}
          
          {% if picks_locked %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- 450cc picks -->
              {% if current_picks_450 %}
              <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                <h4 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">450cc Picks</h4>
                <div class="space-y-2">
                  {% for pick in current_picks_450 %}
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600 dark:text-gray-400 font-medium">{{ pick.position }}.</span>
                    <span class="text-gray-800 dark:text-gray-200">#{{ pick.rider_number }} {{ pick.rider_name }}</span>
                  </div>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
              
              <!-- 250cc picks -->
              {% if current_picks_250 %}
              <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                <h4 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">250cc Picks</h4>
                <div class="space-y-2">
                  {% for pick in current_picks_250 %}
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600 dark:text-gray-400 font-medium">{{ pick.position }}.</span>
                    <span class="text-gray-800 dark:text-gray-200">#{{ pick.rider_number }} {{ pick.rider_name }}</span>
                  </div>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
            </div>
          {% else %}
            <div class="text-center py-8">
              <div class="text-4xl mb-4">üîí</div>
              <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">Picks dolda</h3>
              <p class="text-gray-600 dark:text-gray-400">
                Picks visas efter deadline f√∂r att f√∂rhindra tjuvkikning.
              </p>
            </div>
          {% endif %}
          
          <!-- Show deadline status -->
          {% if picks_locked %}
            <div class="mt-4 p-3 bg-red-100 dark:bg-red-900 rounded-lg">
              <p class="text-sm text-red-700 dark:text-red-300">
                üîí <strong>Picks l√•sta!</strong> Andra anv√§ndares picks visas nu.
              </p>
            </div>
          {% else %}
            <div class="mt-4 p-3 bg-blue-100 dark:bg-blue-900 rounded-lg">
              <p class="text-sm text-blue-700 dark:text-blue-300">
                ‚è∞ <strong>Picks √∂ppna.</strong> Andra anv√§ndares picks √§r dolda tills deadline.
              </p>
            </div>
          {% endif %}
        </div>

      </div>
      {% endif %}

      <!-- Race Resultat -->
      {% if race_results is defined and race_results %}
      <div class="mt-8">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center">
              üèÅ Race Resultat
              <span class="ml-2 text-lg text-gray-600 dark:text-gray-400">({{ total_points }} po√§ng totalt)</span>
            </h2>
            <a href="{{ url_for('user_scores_page', username=target_user.username) }}" 
               class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow">
              üìä Detaljerad po√§nghistorik
            </a>
          </div>
          
          <div class="space-y-4">
            {% for result in race_results %}
            <div onclick="showDetails({{ result.competition.id }})" 
                 class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 border-l-4 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors
                        {% if result.has_results and result.points > 0 %} border-green-500
                        {% elif result.has_results and result.points == 0 %} border-red-500
                        {% else %} border-gray-400 {% endif %}">
              
              <div class="flex justify-between items-start mb-3">
                <div>
                  <h3 class="text-lg font-semibold text-gray-800 dark:text-white">
                    {{ result.competition.name }}
                  </h3>
                  <p class="text-sm text-gray-600 dark:text-gray-400">
                    {{ result.competition.event_date.strftime('%d %B %Y') if result.competition.event_date }}
                  </p>
                </div>
                
                <div class="text-right">
                  {% if result.has_results %}
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                      ‚úÖ K√∂rt
                    </span>
                  {% else %}
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">
                      ‚è≥ V√§ntar
                    </span>
                  {% endif %}
                </div>
              </div>
              
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm">
                <div class="text-center">
                  <p class="text-gray-600 dark:text-gray-400">Race</p>
                  <p class="font-semibold text-gray-800 dark:text-white">{{ result.race_points }}</p>
                </div>
                <div class="text-center">
                  <p class="text-gray-600 dark:text-gray-400">Holeshot</p>
                  <p class="font-semibold text-gray-800 dark:text-white">{{ result.holeshot_points }}</p>
                </div>
                {% if result.competition.series != 'WSX' %}
                <div class="text-center">
                  <p class="text-gray-600 dark:text-gray-400">Wildcard</p>
                  <p class="font-semibold text-gray-800 dark:text-white">{{ result.wildcard_points }}</p>
                </div>
                {% endif %}
                <div class="text-center">
                  <p class="text-gray-600 dark:text-gray-400">Total</p>
                  <p class="font-bold text-lg 
                             {% if result.has_results and result.points > 0 %} text-green-500
                             {% elif result.has_results and result.points == 0 %} text-red-500
                             {% else %} text-gray-400 {% endif %}">
                    {{ result.points }}
                  </p>
                </div>
              </div>
              {% if result.has_results %}
              <p class="text-xs text-blue-600 dark:text-blue-400 mt-2 text-center">Klicka f√∂r detaljerad po√§ngf√∂rdelning</p>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          
          <!-- Sammanfattning -->
          <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-900 rounded-lg">
            <h3 class="text-lg font-semibold text-blue-800 dark:text-blue-200 mb-3">üìä Sammanfattning</h3>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm">
              <div class="text-center">
                <p class="text-blue-600 dark:text-blue-400">T√§vlingar</p>
                <p class="font-bold text-blue-800 dark:text-blue-200">{{ race_results|length }}</p>
              </div>
              <div class="text-center">
                <p class="text-blue-600 dark:text-blue-400">Totala po√§ng</p>
                <p class="font-bold text-blue-800 dark:text-blue-200">{{ total_points }}</p>
              </div>
              <div class="text-center">
                <p class="text-blue-600 dark:text-blue-400">Holeshot po√§ng</p>
                <p class="font-bold text-blue-800 dark:text-blue-200">{{ race_results|sum(attribute='holeshot_points') }}</p>
              </div>
              <div class="text-center">
                <p class="text-blue-600 dark:text-blue-400">Wildcard po√§ng</p>
                <p class="font-bold text-blue-800 dark:text-blue-200">{{ race_results|sum(attribute='wildcard_points') }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Navigation Sound -->
  <audio id="navSound" preload="auto">
    <source src="{{ url_for('static', filename='sfx/moto.mp3') }}" type="audio/mpeg">
  </audio>

  <!-- Modal f√∂r detaljvy -->
  <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="z-index: 9999;">
    <div class="bg-white dark:bg-gray-800 p-6 rounded shadow-lg max-w-lg w-full mx-4" style="z-index: 10000;">
      <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">Detaljerad po√§ng</h3>
      <ul id="detail-list" class="space-y-1 mb-4 text-sm text-gray-800 dark:text-gray-200 max-h-96 overflow-y-auto"></ul>
      <button onclick="closeModal()" class="bg-red-600 text-white px-4 py-2 rounded">St√§ng</button>
    </div>
  </div>

  <script>
    const viewingUser = '{{ target_user.username }}';
    
    async function showDetails(compId){
      try{
        const url = `/get_user_race_results/${viewingUser}/${compId}`;
        const res = await fetch(url);
        if (!res.ok) {
          throw new Error('Kunde inte h√§mta detaljer');
        }
        const data = await res.json();
        const ul = document.getElementById("detail-list");
        ul.innerHTML = "";
        data.breakdown.forEach(item => {
          const li = document.createElement("li");
          li.textContent = item;
          // f√§rgs√§ttning
          if(item.startsWith("‚úÖ")) li.className = "text-green-600 dark:text-green-400";
          else if(item.startsWith("‚ùå")) li.className = "text-red-500 dark:text-red-400";
          else if(item.startsWith("‚ñ≤") || item.startsWith("‚ö†")) li.className = "text-orange-500 dark:text-orange-400";
          else if(item.startsWith("üéØ")) li.className = "text-yellow-600 dark:text-yellow-400 font-bold";
          ul.appendChild(li);
        });
        // Visa totalpo√§ng
        const total = document.createElement("li");
        total.className = "font-bold mt-2 text-gray-800 dark:text-white";
        total.textContent = "Totalt: " + data.total + "p";
        ul.appendChild(total);

        document.getElementById("detail-modal").classList.remove("hidden");
        document.getElementById("detail-modal").classList.add("flex");
      }catch(e){
        alert("Kunde inte h√§mta detaljer: " + e.message);
        console.error(e);
      }
    }

    function closeModal(){
      const m = document.getElementById("detail-modal");
      m.classList.add("hidden");
      m.classList.remove("flex");
    }
    
    // Navigation sound
    document.addEventListener('DOMContentLoaded', function() {
      const navSound = document.getElementById('navSound');
      const navLinks = document.querySelectorAll('.nav-sound');
      
      navLinks.forEach(link => {
        link.addEventListener('click', function() {
          if (navSound) {
            navSound.currentTime = 0;
            navSound.play().catch(e => console.log('Could not play sound:', e));
          }
        });
      });
    });
  </script>
</body>
</html>
