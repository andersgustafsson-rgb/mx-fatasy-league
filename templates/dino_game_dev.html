<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cross Dino Dev - Excitebike Style</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 100%);
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 10px;
        }

        #gameContainer {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 60vh;
            min-height: 300px;
            max-height: 400px;
            background: linear-gradient(to bottom, #87CEEB 0%, #98FB98 70%, #8FBC8F 100%);
            border: 3px solid #2F4F2F;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin: 0 10px;
        }

        #gameCanvas {
            display: block;
            background: transparent;
        }

        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
            z-index: 10;
        }

        #startScreen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            z-index: 10;
        }

        #score {
            position: absolute;
            top: 20px;
            right: 20px;
            color: #2F4F2F;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
            z-index: 5;
        }

        #highScore {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #2F4F2F;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
            z-index: 5;
        }

        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            transition: background 0.3s;
        }

        .button:hover {
            background: #45a049;
        }

        .button:active {
            background: #3d8b40;
        }

        #leaderboard {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            max-height: 150px;
            overflow-y: auto;
        }

        #leaderboard h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #FFD700;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
            font-size: 12px;
        }

        .instructions {
            font-size: 12px;
            color: #ccc;
            margin-top: 10px;
        }

        /* Mobile touch controls */
        #touchControls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: none;
            z-index: 5;
        }

        .touch-button {
            background: rgba(76, 175, 80, 0.8);
            color: white;
            border: none;
            padding: 15px 20px;
            font-size: 18px;
            border-radius: 50%;
            cursor: pointer;
            margin: 5px;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .touch-button:active {
            background: rgba(69, 160, 73, 0.9);
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            #gameContainer {
                height: 50vh;
                min-height: 250px;
                margin: 0 5px;
            }

            #startScreen {
                padding: 20px;
                max-width: 90%;
            }

            .button {
                padding: 16px 32px;
                font-size: 18px;
                min-width: 150px;
                margin: 20px auto;
                display: block;
                background: #4CAF50 !important;
                color: white !important;
                border: 3px solid #2E7D32 !important;
                border-radius: 12px !important;
                font-weight: bold !important;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3) !important;
                z-index: 1000 !important;
                position: relative !important;
            }

            #leaderboard {
                margin: 5px 0;
                padding: 4px;
                max-height: 120px;
                overflow-y: auto;
            }

            #leaderboard h3 {
                font-size: 10px;
                margin: 0 0 4px 0;
            }

            .leaderboard-item {
                padding: 1px 0;
                font-size: 9px;
            }

            .instructions {
                font-size: 10px;
                margin-top: 5px;
            }

            #touchControls {
                display: block;
            }

            #score, #highScore {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <div id="score">Po√§ng: 0</div>
        <div id="highScore">B√§sta: 0</div>
        
        <div id="startScreen">
            <h2>üèçÔ∏è Cross Dino Dev</h2>
            <p>Excitebike Style</p>
            <div id="leaderboard">
                <h3>üèÜ Topp 5</h3>
                <div id="leaderboard-content">
                    <div class="leaderboard-item">1. Laddar...</div>
                </div>
            </div>
            <button class="button" onclick="startGame()">Starta Spel</button>
            <div class="instructions">
                Tryck SPACE eller ‚Üë f√∂r att hoppa<br>
                (Mobil: Tryck p√• sk√§rmen eller knappen)
            </div>
        </div>
        
        <div id="gameOver">
            <h2>Game Over!</h2>
            <p>Po√§ng: <span id="finalScore">0</span></p>
            <button class="button" onclick="restartGame()">Spela Igen</button>
        </div>
        
        <div id="touchControls">
            <button class="touch-button" id="jumpButton">‚Üë</button>
            <button class="touch-button" id="pauseButton">‚è∏Ô∏è</button>
        </div>
    </div>

    <script>
        class CrossDinoGameDev {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.width = 0;
                this.height = 0;
                this.gameRunning = false;
                this.gamePaused = false;
                this.score = 0;
                this.highScore = parseInt(localStorage.getItem('crossDinoGlobalHighScore') || 0);
                console.log('DEBUG: Loaded highscore from localStorage:', this.highScore);
                console.log('DEBUG: localStorage crossDinoGlobalHighScore:', localStorage.getItem('crossDinoGlobalHighScore'));
                this.gameSpeed = 2;
                this.gravity = 0.7;
                this.jumpPower = -12; // Excitebike style - much lower jump
                this.jumpCooldown = 0;
                this.spacePressed = false;
                this.touchPressed = false;
                
                // Cross (player) - Excitebike style
                this.cross = {
                    x: 50,
                    y: 0,
                    width: 20,
                    height: 20,
                    velocityY: 0,
                    isJumping: false,
                    groundY: 0
                };
                
                this.obstacles = [];
                this.obstacleInterval = 0;
                this.lastObstacleTime = 0;
                
                this.resizeCanvas();
                this.setupInput();
                this.loadLeaderboard();
                
                // Handle window resize
                window.addEventListener('resize', () => this.resizeCanvas());
            }
            
            resizeCanvas() {
                const container = document.getElementById('gameContainer');
                this.width = container.clientWidth;
                this.height = container.clientHeight;
                this.canvas.width = this.width;
                this.canvas.height = this.height;
                
                if (this.cross) {
                    this.cross.groundY = this.height - 40;
                    this.cross.y = this.cross.groundY - this.cross.height;
                }
            }
            
            setupInput() {
                // Keyboard input
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space' || e.code === 'ArrowUp') {
                        e.preventDefault();
                        if (!this.spacePressed && this.gameRunning && !this.gamePaused) {
                            this.jump();
                            this.spacePressed = true;
                        }
                    } else if (e.code === 'Escape') {
                        this.togglePause();
                    }
                });
                
                document.addEventListener('keyup', (e) => {
                    if (e.code === 'Space' || e.code === 'ArrowUp') {
                        this.spacePressed = false;
                    }
                });
                
                // Touch controls
                this.setupTouchControls();
            }
            
            setupTouchControls() {
                const jumpButton = document.getElementById('jumpButton');
                const pauseButton = document.getElementById('pauseButton');
                
                jumpButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (!this.touchPressed && this.gameRunning && !this.gamePaused) {
                        this.jump();
                        this.touchPressed = true;
                    }
                });
                
                jumpButton.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.touchPressed = false;
                });
                
                pauseButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.togglePause();
                });
                
                // Tap to jump on canvas
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (!this.touchPressed && this.gameRunning && !this.gamePaused) {
                        this.jump();
                        this.touchPressed = true;
                    }
                });
                
                this.canvas.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.touchPressed = false;
                });
            }
            
            async start() {
                this.gameRunning = true;
                this.gamePaused = false;
                this.score = 0;
                this.obstacles = [];
                this.obstacleInterval = 0;
                this.lastObstacleTime = 0;
                
                this.cross.velocityY = 0;
                this.cross.isJumping = false;
                this.cross.y = this.cross.groundY - this.cross.height;
                
                document.getElementById('startScreen').style.display = 'none';
                document.getElementById('gameOver').style.display = 'none';
                
                await this.syncHighscore();
                this.gameLoop();
            }
            
            update() {
                if (this.gamePaused) return;
                
                // Update jump cooldown
                if (this.jumpCooldown > 0) {
                    this.jumpCooldown--;
                }
                
                // Update cross (player)
                this.cross.velocityY += this.gravity;
                this.cross.y += this.cross.velocityY;
                
                // Ground collision
                if (this.cross.y >= this.cross.groundY - this.cross.height) {
                    this.cross.y = this.cross.groundY - this.cross.height;
                    this.cross.velocityY = 0;
                    this.cross.isJumping = false;
                }
                
                // Generate obstacles
                this.obstacleInterval++;
                if (this.obstacleInterval >= 120 - (this.score * 2)) {
                    this.obstacleInterval = 0;
                    this.obstacles.push({
                        x: this.width,
                        y: this.cross.groundY - 30,
                        width: 20,
                        height: 30,
                        speed: this.gameSpeed
                    });
                }
                
                // Update obstacles
                this.obstacles.forEach((obstacle, index) => {
                    obstacle.x -= obstacle.speed;
                    
                    // Remove obstacles that are off screen
                    if (obstacle.x + obstacle.width < 0) {
                        this.obstacles.splice(index, 1);
                        this.score++;
                        document.getElementById('score').textContent = `Po√§ng: ${this.score}`;
                    }
                });
                
                // Collision detection
                this.obstacles.forEach(obstacle => {
                    if (this.cross.x < obstacle.x + obstacle.width &&
                        this.cross.x + this.cross.width > obstacle.x &&
                        this.cross.y < obstacle.y + obstacle.height &&
                        this.cross.y + this.cross.height > obstacle.y) {
                        this.gameOver();
                    }
                });
                
                // Increase game speed
                this.gameSpeed += 0.001;
            }
            
            draw() {
                // Clear canvas
                this.ctx.clearRect(0, 0, this.width, this.height);
                
                // Draw Excitebike-style background (simple blue sky)
                this.ctx.fillStyle = '#87CEEB';
                this.ctx.fillRect(0, 0, this.width, this.height * 0.7);
                
                // Draw ground (simple brown)
                this.ctx.fillStyle = '#8B4513';
                this.ctx.fillRect(0, this.height * 0.7, this.width, this.height * 0.3);
                
                // Draw ground line
                this.ctx.strokeStyle = '#654321';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                this.ctx.moveTo(0, this.height * 0.7);
                this.ctx.lineTo(this.width, this.height * 0.7);
                this.ctx.stroke();
                
                // Draw Excitebike-style motocross bike and rider (pixel art style)
                this.ctx.save();
                this.ctx.translate(
                    this.cross.x + this.cross.width/2, 
                    this.cross.y + this.cross.height/2
                );
                
                // === EXCITEBIKE STYLE MOTORCYCLE ===
                
                // Front wheel (simple black circle)
                this.ctx.fillStyle = '#000000';
                this.ctx.beginPath();
                this.ctx.arc(-12, 8, 6, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Rear wheel (simple black circle)
                this.ctx.fillStyle = '#000000';
                this.ctx.beginPath();
                this.ctx.arc(12, 8, 6, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Main frame (simple red rectangle)
                this.ctx.fillStyle = '#FF0000';
                this.ctx.fillRect(-10, 2, 20, 6);
                
                // Front fork (simple black lines)
                this.ctx.strokeStyle = '#000000';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                this.ctx.moveTo(-12, 2);
                this.ctx.lineTo(-12, 8);
                this.ctx.stroke();
                
                // Rear swingarm (simple black line)
                this.ctx.beginPath();
                this.ctx.moveTo(12, 2);
                this.ctx.lineTo(12, 8);
                this.ctx.stroke();
                
                // Handlebars (simple black line)
                this.ctx.beginPath();
                this.ctx.moveTo(-12, 2);
                this.ctx.lineTo(-16, -1);
                this.ctx.stroke();
                
                // === EXCITEBIKE STYLE RIDER ===
                
                // Helmet (simple white circle with red stripe)
                this.ctx.fillStyle = '#FFFFFF';
                this.ctx.beginPath();
                this.ctx.arc(0, -8, 5, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Helmet stripe
                this.ctx.fillStyle = '#FF0000';
                this.ctx.fillRect(-4, -10, 8, 2);
                
                // Body (simple blue rectangle)
                this.ctx.fillStyle = '#0000FF';
                this.ctx.fillRect(-3, -3, 6, 5);
                
                // Arms (simple blue lines)
                this.ctx.strokeStyle = '#0000FF';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                this.ctx.moveTo(-3, -3);
                this.ctx.lineTo(-10, 2);
                this.ctx.moveTo(3, -3);
                this.ctx.lineTo(-6, 2);
                this.ctx.stroke();
                
                // Legs (simple black lines)
                this.ctx.strokeStyle = '#000000';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                this.ctx.moveTo(-2, 2);
                this.ctx.lineTo(-4, 8);
                this.ctx.moveTo(2, 2);
                this.ctx.lineTo(4, 8);
                this.ctx.stroke();
                
                this.ctx.restore();
                
                // Draw obstacles (simple brown rectangles - Excitebike style)
                this.obstacles.forEach(obstacle => {
                    this.ctx.fillStyle = '#8B4513';
                    this.ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                    
                    // Simple outline
                    this.ctx.strokeStyle = '#654321';
                    this.ctx.lineWidth = 1;
                    this.ctx.strokeRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                });
                
                // Draw pause indicator
                if (this.gamePaused) {
                    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    this.ctx.fillRect(0, 0, this.width, this.height);
                    
                    this.ctx.fillStyle = '#FFFFFF';
                    this.ctx.font = 'bold 24px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('PAUSAD', this.width / 2, this.height / 2);
                    this.ctx.font = '16px Arial';
                    this.ctx.fillText('Tryck ESC f√∂r att forts√§tta', this.width / 2, this.height / 2 + 30);
                }
            }
            
            jump() {
                if (this.jumpCooldown > 0) return;
                
                this.cross.velocityY = this.jumpPower;
                this.cross.isJumping = true;
                this.jumpCooldown = 10;
            }
            
            togglePause() {
                if (!this.gameRunning) return;
                
                this.gamePaused = !this.gamePaused;
            }
            
            gameOver() {
                this.gameRunning = false;
                document.getElementById('finalScore').textContent = this.score;
                document.getElementById('gameOver').style.display = 'block';
                
                // Update highscore
                if (this.score > this.highScore) {
                    this.highScore = this.score;
                    localStorage.setItem('crossDinoGlobalHighScore', this.highScore.toString());
                    console.log('DEBUG: Saved new highscore to localStorage:', this.highScore);
                }
                
                document.getElementById('highScore').textContent = `B√§sta: ${this.highScore}`;
                this.updateLeaderboard(this.score);
            }
            
            async loadLeaderboard() {
                try {
                    const response = await fetch('/api/cross_dino/highscores');
                    const leaderboard = await response.json();
                    this.displayLeaderboard(leaderboard);
                } catch (error) {
                    console.error('Error loading leaderboard:', error);
                    this.displayLeaderboard([]);
                }
            }
            
            async updateLeaderboard(score) {
                try {
                    const response = await fetch('/api/cross_dino/highscores');
                    const currentLeaderboard = await response.json();
                    const minScore = currentLeaderboard.length < 5 ? 0 : currentLeaderboard[4].score;
                    
                    if (score > minScore) {
                        const playerName = prompt('Grattis! Du fick ett nytt rekord! Vad heter du?') || 'Anonym';
                        
                        const submitResponse = await fetch('/api/cross_dino/highscores', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                player_name: playerName,
                                score: score
                            })
                        });
                        
                        if (submitResponse.ok) {
                            const newLeaderboard = await submitResponse.json();
                            this.displayLeaderboard(newLeaderboard);
                        }
                    }
                } catch (error) {
                    console.error('Error updating leaderboard:', error);
                }
            }
            
            displayLeaderboard(leaderboard) {
                const content = document.getElementById('leaderboard-content');
                if (leaderboard.length === 0) {
                    content.innerHTML = '<div class="leaderboard-item">Inga rekord √§n</div>';
                } else {
                    content.innerHTML = leaderboard.map((entry, index) => 
                        `<div class="leaderboard-item">
                            ${index + 1}. ${entry.name}: ${entry.score}
                        </div>`
                    ).join('');
                }
            }
            
            async syncHighscore() {
                try {
                    const response = await fetch('/api/cross_dino/highscores');
                    const leaderboard = await response.json();
                    
                    if (leaderboard.length > 0) {
                        const globalHighscore = leaderboard[0].score;
                        if (globalHighscore > this.highScore) {
                            this.highScore = globalHighscore;
                            console.log('DEBUG: Synced highscore from backend:', this.highScore);
                        }
                    }
                    
                    document.getElementById('highScore').textContent = `B√§sta: ${this.highScore}`;
                } catch (error) {
                    console.error('Error syncing highscore:', error);
                    const storedHighscore = parseInt(localStorage.getItem('crossDinoGlobalHighScore') || 0);
                    if (storedHighscore > this.highScore) {
                        this.highScore = storedHighscore;
                    }
                    document.getElementById('highScore').textContent = `B√§sta: ${this.highScore}`;
                }
            }
            
            gameLoop() {
                if (this.gameRunning) {
                    this.update();
                    this.draw();
                    requestAnimationFrame(() => this.gameLoop());
                }
            }
        }
        
        let game;
        
        function startGame() {
            if (!game) {
                game = new CrossDinoGameDev();
            }
            game.start();
        }
        
        function restartGame() {
            if (game) {
                game.start();
            }
        }
        
        // Initialize game when page loads
        window.addEventListener('load', () => {
            game = new CrossDinoGameDev();
        });
    </script>
</body>
</html>
